----++++src/daemon/plugin.c
@@ -389,50 +389,44 @@ static int plugin_unregister(llist_t *list, const char *name) /* {{{ */
   return 0;
 } /* }}} int plugin_unregister */
 
-/*
- * (Try to) load the shared object `file&#39;. Won&#39;t complain if it isn&#39;t a shared
- * object, but it will bitch about a shared object not having a
- * ``module_register&#39;&#39; symbol..
- */
-static int plugin_load_file(const char *file, _Bool global) {
-  void (*reg_handle)(void);
-
+/* plugin_load_file loads the shared object &quot;file&quot; and calls its
+ * &quot;module_register&quot; function. Returns zero on success, non-zero otherwise. */
+static int plugin_load_file(char const *file, _Bool global) {
   int flags = RTLD_NOW;
   if (global)
     flags |= RTLD_GLOBAL;
 
   void *dlh = dlopen(file, flags);
-
   if (dlh == NULL) {
     char errbuf[1024] = &quot;&quot;;
 
     snprintf(errbuf, sizeof(errbuf),
-             &quot;dlopen (\&quot;%s\&quot;) failed: %s. &quot;
-             &quot;The most common cause for this problem is &quot;
-             &quot;missing dependencies. Use ldd(1) to check &quot;
-             &quot;the dependencies of the plugin &quot;
-             &quot;/ shared object.&quot;,
+             &quot;dlopen(\&quot;%s\&quot;) failed: %s. &quot;
+             &quot;The most common cause for this problem is missing dependencies. &quot;
+             &quot;Use ldd(1) to check the dependencies of the plugin / shared &quot;
+             &quot;object.&quot;,
              file, dlerror());
 
-    ERROR(&quot;%s&quot;, errbuf);
-    /* Make sure this is printed to STDERR in any case, but also
-     * make sure it&#39;s printed only once. */
-    if (list_log != NULL)
-      fprintf(stderr, &quot;ERROR: %s\n&quot;, errbuf);
+    /* This error is printed to STDERR unconditionally. If list_log is NULL,
+     * plugin_log() will also print to STDERR. We avoid duplicate output by
+     * checking that the list of log handlers, list_log, is not NULL. */
+    fprintf(stderr, &quot;ERROR: %s\n&quot;, errbuf);
+    if (list_log != NULL) {
+      ERROR(&quot;%s&quot;, errbuf);
+    }
 
-    return 1;
+    return ENOENT;
   }
 
-  reg_handle = (void (*)(void))dlsym(dlh, "module_register");
+  void (*reg_handle)(void) = dlsym(dlh, "module_register");
   if (reg_handle == NULL) {
-    WARNING("Couldn't find symbol \"module_register\" in \"%s\": %s\n", file,
-            dlerror());
+    ERROR("Couldn't find symbol \"module_register\" in \"%s\": %s\n", file,
+          dlerror());
     dlclose(dlh);
-    return -1;
+    return ENOENT;
   }
 
   (*reg_handle)();
-
   return 0;
 }
 
----++++GitHub
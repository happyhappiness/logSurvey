@@ -224,6 +224,7 @@ Thank you!
     Pedro Lineu Orso <orso@pop.hsbcbamerindus.com.br>
     Pedro Ribeiro <pribeiro@isel.pt>
     Pete Bentley <pete@demon.net>
+    Peter Eisenhauer <pe@pipetronix.de>
     Peter Hidas <peter.hidas@safeland.hu>
     Peter Pramberger <peter@pramberger.at>
     Philip Allison <philip.allison@smoothwall.net>
@@ -687,29 +687,6 @@ helpers/basic_auth/LDAP/:
 
 ==============================================================================
 
-helpers/basic_auth/MSNT/:
-
- * (C) 2000 Antonino Iannella, Stellar-X Pty Ltd
- * Released under GPL, see COPYING-2.0 for details.
-
- * Released under GNU Public License
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-
-==============================================================================
-
 helpers/basic_auth/NCSA/basic_ncsa_auth.8:
 
 This file is distributed in the hope that it will be useful,
@@ -956,6 +933,29 @@ helpers/basic_auth/SMB/:
 
 ==============================================================================
 
+helpers/basic_auth/SMB_LM/:
+
+ * (C) 2000 Antonino Iannella, Stellar-X Pty Ltd
+ * Released under GPL, see COPYING-2.0 for details.
+
+ * Released under GNU Public License
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+==============================================================================
+
 helpers/basic_auth/SSPI/:
 
   Guido Serassio, Torino - Italy
@@ -1387,6 +1387,13 @@ Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.
 
 ==============================================================================
 
+helpers/url_rewrite/LFS/rredir.cc:
+
+ * version 0.1, 7 sep 1996
+ * - initial version (Richard Huveneers <Richard.Huveneers@hekkihek.hacom.nl>)
+
+==============================================================================
+
 icons/silk/:
 
   Silk icon set 1.3
@@ -1475,6 +1482,41 @@ lib/snmplib/snmp_vars.c:
 
 ==============================================================================
 
+include/base64.h:
+lib/base64.c:
+
+/*
+   Copyright (C) 2002 Niels MÃ¶ller, Dan Egnor
+
+   This file is part of GNU Nettle.
+
+   GNU Nettle is free software: you can redistribute it and/or
+   modify it under the terms of either:
+
+     * the GNU Lesser General Public License as published by the Free
+       Software Foundation; either version 3 of the License, or (at your
+       option) any later version.
+
+   or
+
+     * the GNU General Public License as published by the Free
+       Software Foundation; either version 2 of the License, or (at your
+       option) any later version.
+
+   or both in parallel, as here.
+
+   GNU Nettle is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+   General Public License for more details.
+
+   You should have received copies of the GNU General Public License and
+   the GNU Lesser General Public License along with this program.  If
+   not, see http://www.gnu.org/licenses/.
+*/
+
+==============================================================================
+
 include/heap.h,
 lib/heap.cc:
 
@@ -1,3 +1,32 @@
+Changes to squid-3.5.1 (13 Jan 2015):
+
+	- Fix handling of invalid SSL server certificates when splicing connections
+	- basic_smb_lm_auth: Simplified MSNT basic auth helper
+	- squidclient: Fix -A and -P options
+	- ... and several portability fixes
+	- ... and all fixes from squid 3.4.11
+	- ... and a lot of documentation updates
+
+Changes to squid-3.5.0.4 (21 Dec 2014):
+
+	- Bug 3826: pt 2: Provide a systemd .service file for Squid
+	- Support http_access denials of SslBump "peeked" connections.
+	- Fix DONT_VERIFY_DOMAIN ssl flag
+	- Fix peek-and-splice mode: certificate validation for domain mismatched errors
+	- negotiate_kerberos_auth: MEMORY keytab and replay cache support
+	- ... and some documentation updates
+	- ... and a large amount of code polishing (non-logic changes)
+
+Changes to squid-3.5.0.3 (09 Dec 2014):
+
+	- Bug 4146: workaround SSL Bump crash on Linux
+	- Bug 4135: Support \-escaped characters in regex patterns
+	- Bug 4131: SIGSEGV at store.cc:962 content_length > store_maxobjsize
+	- Fix delay_parameters parsing
+	- HTTP/2: handle 'PRI' method found in HTTP/1.x traffic
+	- ... and all changes from squid 3.4.10
+	- ... and a lot of documentation updates
+
 Changes to squid-3.5.0.2 (31 Oct 2014):
 
 	- Fix FTP socket opening during reconfigure
@@ -71,6 +100,28 @@ Changes to squid-3.5.0.1 (17 Oct 2014):
 	- ... and many error page translation updates
 	- ... and much code cleanup and polishing
 
+Changes to squid-3.4.11 (13 Jan 2015):
+
+	- Bug 4164: SEGFAULT when %W formating code used in errorpages
+	- Bug 4057: Avoid on-exit crashes when adaptation is enabled.
+	- Bug 3760: squidclient ignores --disable-ipv6
+	- Bug 3754: configure doesnt detect IPFilter 5.1.2 system headers
+	- Bug 3664: ssl_crtd fails to build on OpenSolaris/OpenIndiana/Solaris 11
+	- cachemgr.cgi: memory leak in request parser
+	- Deleting first fs left psstate->servers pointing to uninitialized memory
+	- ... and some build issues
+
+Changes to squid-3.4.10 (09 Dec 2014):
+
+	- Bug 4148: external_acl_type header format does not accept the new libformat syntax
+	- Bug 4145: squid_endian.h compile errors with OpenBSD 5.6
+	- Bug 4033: Rebuild corrupted ssl_db/size file
+	- Bug 3902: Docs: external_acl_type cache hash key
+	- Fix segmentation fault in ACL urlpath_regex
+	- Fix bootstrap.sh dependency on SPONSORS.list
+	- Alternate-Protocol is a hop-by-hop header
+	- HTTP/2: Support 421 (Misdirected Request) status code
+
 Changes to squid-3.4.9 (31 Oct 2014):
 
 	- Regression fix: ext_kerberos_ldap_group_acl typo in 3.4.7 update
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -2,7 +2,7 @@
 SQUID Web Proxy Cache                         http://www.squid-cache.org/
 -------------------------------------------------------------------------
 
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 
 Squid software is distributed under GPLv2+ license and includes 
 contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -41,15 +41,14 @@ AC_DEFUN([SQUID_CC_REQUIRE_ARGUMENT],[
     SAVED_FLAGS="$CFLAGS"
     SAVED_CXXFLAGS="$CXXFLAGS"
     AC_COMPILE_IFELSE([AC_LANG_PROGRAM($3,$4)],[$1=no],[],[$1=no])
-    if test "$1" != "no" ; then
-      CFLAGS="$CXXFLAGS $2"
+    if test "x$1" != "xno" ; then
+      CFLAGS="$CFLAGS $2"
       CXXFLAGS="$CXXFLAGS $2"
       AC_COMPILE_IFELSE([AC_LANG_PROGRAM($3,$4)],[$1=yes],[$1=no],[$1=no])
     fi
     CFLAGS="$SAVED_CFLAGS"
     CXXFLAGS="$SAVED_CXXFLAGS"
   }])
-  AC_MSG_RESULT([$1])
 ])
 
 # detect what kind of compiler we're using, either by using hints from
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -114,6 +114,33 @@ int main(int argc, char *argv[])
   ])
 ])
 
+dnl check whether the kerberos context has a memory keytab. Sets
+dnl squid_cv_memory_keytab if that's the case.
+AC_DEFUN([SQUID_CHECK_KRB5_CONTEXT_MEMORY_KEYTAB],[
+  AC_CACHE_CHECK([for memory keytab], squid_cv_memory_keytab, [
+    AC_RUN_IFELSE([
+      AC_LANG_SOURCE([[
+#if HAVE_BROKEN_SOLARIS_KRB5_H
+#if defined(__cplusplus)
+#define KRB5INT_BEGIN_DECLS     extern "C" {
+#define KRB5INT_END_DECLS
+KRB5INT_BEGIN_DECLS
+#endif
+#endif
+#include <krb5.h>
+int main(int argc, char *argv[])
+{
+    krb5_context context;
+    krb5_keytab kt;
+
+    krb5_init_context(&context);
+    return krb5_kt_resolve(context, "MEMORY:test_keytab", &kt);
+}
+      ]])
+    ], [ squid_cv_memory_keytab=yes ], [ squid_cv_memory_keytab=no ], [:])
+  ])
+])
+
 
 dnl checks that gssapi is ok, and sets squid_cv_working_gssapi accordingly
 AC_DEFUN([SQUID_CHECK_WORKING_GSSAPI], [
@@ -331,6 +358,10 @@ AC_DEFUN([SQUID_CHECK_KRB5_FUNCS],[
   SQUID_DEFINE_BOOL(HAVE_KRB5_MEMORY_CACHE,$squid_cv_memory_cache,
        [Define if kerberos has MEMORY: cache support])
 
+  SQUID_CHECK_KRB5_CONTEXT_MEMORY_KEYTAB
+  SQUID_DEFINE_BOOL(HAVE_KRB5_MEMORY_KEYTAB,$squid_cv_memory_keytab,
+       [Define if kerberos has MEMORY: keytab support])
+
   SQUID_CHECK_WORKING_GSSAPI
   SQUID_DEFINE_BOOL(HAVE_GSSAPI,$squid_cv_working_gssapi,[GSSAPI support])
 
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -881,3 +881,86 @@ int main (int argc, char ** argv) {
   AC_DEFINE_UNQUOTED(RECV_ARG_TYPE,$squid_cv_recv_second_arg_type,
     [Base type of the second argument to recv(2)])
 ])
+
+
+dnl check whether Solaris has broken IPFilter headers (Solaris 10 at least does)
+AC_DEFUN([SQUID_CHECK_BROKEN_SOLARIS_IPFILTER],[
+  if test "x$squid_cv_broken_ipfilter_minor_t" = "x"; then
+    AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
+#     include <sys/types.h>
+#     include <sys/ioccom.h>
+#     include <netinet/in.h>
+
+#     include <netinet/ip_compat.h>
+#     include <netinet/ip_fil.h>
+#     include <netinet/ip_nat.h>
+    ]])],[
+      AC_MSG_RESULT(no)
+      squid_cv_broken_ipfilter_minor_t=0
+    ],[
+      ## on fail, test the hack
+      AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
+#define minor_t fubaar
+#       include <sys/types.h>
+#       include <sys/ioccom.h>
+#       include <netinet/in.h>
+#undef minor_t
+#       include <netinet/ip_compat.h>
+#       include <netinet/ip_fil.h>
+#       include <netinet/ip_nat.h>
+      ]])],[
+        AC_MSG_RESULT(yes)
+        squid_cv_broken_ipfilter_minor_t=1
+      ],[
+        AC_MSG_RESULT(unable to make IPFilter work with netinet/ headers)
+      ])
+    ])
+  fi
+
+  AC_DEFINE_UNQUOTED(USE_SOLARIS_IPFILTER_MINOR_T_HACK,$squid_cv_broken_ipfilter_minor_t,
+    [Workaround IPFilter minor_t breakage])
+
+## check for IPFilter headers that require this hack
+## (but first netinet/in.h and sys/ioccom.h which they depend on)
+  AC_CHECK_HEADERS( \
+	netinet/in.h \
+	sys/ioccom.h \
+	ip_compat.h \
+	ip_fil_compat.h \
+	ip_fil.h \
+	ip_nat.h \
+	netinet/ip_compat.h \
+	netinet/ip_fil_compat.h \
+	netinet/ip_fil.h \
+	netinet/ip_nat.h \
+  ,,,[
+#if USE_SOLARIS_IPFILTER_MINOR_T_HACK
+#define minor_t fubar
+#endif
+#if HAVE_SYS_TYPES_H
+#include <sys/types.h>
+#endif
+#if HAVE_NETINET_IN_H
+#include <netinet/in.h>
+#endif
+#if HAVE_SYS_IOCCOM_H
+#include <sys/ioccom.h>
+#endif
+#if USE_SOLARIS_IPFILTER_MINOR_T_HACK
+#undef minor_t
+#endif
+#if HAVE_IP_COMPAT_H
+#include <ip_compat.h>
+#elif HAVE_NETINET_IP_COMPAT_H
+#include <netinet/ip_compat.h>
+#endif
+#if HAVE_IP_FIL_H
+#include <ip_fil.h>
+#elif HAVE_NETINET_IP_FIL_H
+#include <netinet/ip_fil.h>
+#endif
+#if !defined(IPFILTER_VERSION)
+#define IPFILTER_VERSION        5000004
+#endif
+  ])
+])
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,6 +1,6 @@
 #!/bin/sh
 #
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -164,7 +164,9 @@ do
 done
 
 # Make a copy of SPONSORS we can package
-sed -e 's/@Squid-[0-9\.]*://' <SPONSORS.list > SPONSORS || (rm -f SPONSORS && exit 1)
+if test -f SPONSORS.list; then
+  sed -e 's/@Squid-[0-9\.]*://' <SPONSORS.list > SPONSORS || (rm -f SPONSORS && exit 1)
+fi
 
 # Fixup autoconf recursion using --silent/--quiet option
 # autoconf should inherit this option whe recursing into subdirectories
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -194,7 +194,7 @@ static int re_match_2(struct re_pattern_buffer * buffer, const char *string1,
 #if HAVE_ALLOCA_H
 #include <alloca.h>
 #else /* not __GNUC__ or HAVE_ALLOCA_H */
-#ifndef _AIX			/* Already did AIX, up at the top.  */
+#ifndef _AIX            /* Already did AIX, up at the top.  */
 char *alloca();
 #endif /* not _AIX */
 #endif /* not HAVE_ALLOCA_H */
@@ -205,29 +205,29 @@ char *alloca();
 #define REGEX_ALLOCATE alloca
 
 /* Assumes a `char *destination' variable.  */
-#define REGEX_REALLOCATE(source, osize, nsize)				\
-  (destination = (char *) alloca (nsize),				\
-   memcpy (destination, source, osize),				\
+#define REGEX_REALLOCATE(source, osize, nsize)              \
+  (destination = (char *) alloca (nsize),               \
+   memcpy (destination, source, osize),             \
    destination)
 
 #endif /* not REGEX_MALLOC */
 
 /* True if `size1' is non-NULL and PTR is pointing anywhere inside
  * `string1' or just past its end.  This works if PTR is NULL, which is
  * a good thing.  */
-#define FIRST_STRING_P(ptr) 					\
+#define FIRST_STRING_P(ptr)                     \
   (size1 && string1 <= (ptr) && (ptr) <= string1 + size1)
 
 /* (Re)Allocate N items of type T using malloc, or fail.  */
 #define TALLOC(n, t) ((t *) malloc ((n) * sizeof (t)))
 #define RETALLOC(addr, n, t) ((addr) = (t *) realloc (addr, (n) * sizeof (t)))
 #define REGEX_TALLOC(n, t) ((t *) REGEX_ALLOCATE ((n) * sizeof (t)))
 
-#define BYTEWIDTH 8		/* In bits.  */
+#define BYTEWIDTH 8     /* In bits.  */
 
 #define STREQ(s1, s2) ((strcmp (s1, s2) == 0))
 
-#if !defined(__MINGW32__)	/* MinGW defines boolean */
+#if !defined(__MINGW32__)   /* MinGW defines boolean */
 typedef char boolean;
 #endif
 #define false 0
@@ -348,44 +348,44 @@ typedef enum {
      * bytes of number.  */
     set_number_at,
 
-    wordchar,			/* Matches any word-constituent character.  */
-    notwordchar,		/* Matches any char that is not a word-constituent.  */
+    wordchar,           /* Matches any word-constituent character.  */
+    notwordchar,        /* Matches any char that is not a word-constituent.  */
 
-    wordbeg,			/* Succeeds if at word beginning.  */
-    wordend,			/* Succeeds if at word end.  */
+    wordbeg,            /* Succeeds if at word beginning.  */
+    wordend,            /* Succeeds if at word end.  */
 
-    wordbound,			/* Succeeds if at a word boundary.  */
-    notwordbound		/* Succeeds if not at a word boundary.  */
+    wordbound,          /* Succeeds if at a word boundary.  */
+    notwordbound        /* Succeeds if not at a word boundary.  */
 
 } re_opcode_t;
 
 /* Common operations on the compiled pattern.  */
 
 /* Store NUMBER in two contiguous bytes starting at DESTINATION.  */
 
-#define STORE_NUMBER(destination, number)				\
-  do {									\
-    (destination)[0] = (number) & 0377;					\
-    (destination)[1] = (number) >> 8;					\
+#define STORE_NUMBER(destination, number)               \
+  do {                                  \
+    (destination)[0] = (number) & 0377;                 \
+    (destination)[1] = (number) >> 8;                   \
   } while (0)
 
 /* Same as STORE_NUMBER, except increment DESTINATION to
  * the byte after where the number is stored.  Therefore, DESTINATION
  * must be an lvalue.  */
 
-#define STORE_NUMBER_AND_INCR(destination, number)			\
-  do {									\
-    STORE_NUMBER (destination, number);					\
-    (destination) += 2;							\
+#define STORE_NUMBER_AND_INCR(destination, number)          \
+  do {                                  \
+    STORE_NUMBER (destination, number);                 \
+    (destination) += 2;                         \
   } while (0)
 
 /* Put into DESTINATION a number stored in two contiguous bytes starting
  * at SOURCE.  */
 
-#define EXTRACT_NUMBER(destination, source)				\
-  do {									\
-    (destination) = *(source) & 0377;					\
-    (destination) += SIGN_EXTEND_CHAR (*((source) + 1)) << 8;		\
+#define EXTRACT_NUMBER(destination, source)             \
+  do {                                  \
+    (destination) = *(source) & 0377;                   \
+    (destination) += SIGN_EXTEND_CHAR (*((source) + 1)) << 8;       \
   } while (0)
 
 #ifdef DEBUG
@@ -399,7 +399,7 @@ unsigned char *source;
     *dest += temp << 8;
 }
 
-#ifndef EXTRACT_MACROS		/* To debug the macros.  */
+#ifndef EXTRACT_MACROS      /* To debug the macros.  */
 #undef EXTRACT_NUMBER
 #define EXTRACT_NUMBER(dest, src) extract_number (&dest, src)
 #endif /* not EXTRACT_MACROS */
@@ -409,10 +409,10 @@ unsigned char *source;
 /* Same as EXTRACT_NUMBER, except increment SOURCE to after the number.
  * SOURCE must be an lvalue.  */
 
-#define EXTRACT_NUMBER_AND_INCR(destination, source)			\
-  do {									\
-    EXTRACT_NUMBER (destination, source);				\
-    (source) += 2; 							\
+#define EXTRACT_NUMBER_AND_INCR(destination, source)            \
+  do {                                  \
+    EXTRACT_NUMBER (destination, source);               \
+    (source) += 2;                          \
   } while (0)
 
 #ifdef DEBUG
@@ -448,9 +448,9 @@ static int debug = 0;
 #define DEBUG_PRINT2(x1, x2) if (debug) printf (x1, x2)
 #define DEBUG_PRINT3(x1, x2, x3) if (debug) printf (x1, x2, x3)
 #define DEBUG_PRINT4(x1, x2, x3, x4) if (debug) printf (x1, x2, x3, x4)
-#define DEBUG_PRINT_COMPILED_PATTERN(p, s, e) 				\
+#define DEBUG_PRINT_COMPILED_PATTERN(p, s, e)               \
   if (debug) print_partial_compiled_pattern (s, e)
-#define DEBUG_PRINT_DOUBLE_STRING(w, s1, sz1, s2, sz2)			\
+#define DEBUG_PRINT_DOUBLE_STRING(w, s1, sz1, s2, sz2)          \
   if (debug) print_double_string (w, s1, sz1, s2, sz2)
 
 extern void printchar();
@@ -723,23 +723,23 @@ int size2;
 /* This table gives an error message for each of the error codes listed
  * in regex.h.  Obviously the order here has to be same as there.  */
 
-static const char *re_error_msg[] = {NULL,				/* REG_NOERROR */
-                                     "No match",			/* REG_NOMATCH */
-                                     "Invalid regular expression",	/* REG_BADPAT */
-                                     "Invalid collation character",	/* REG_ECOLLATE */
-                                     "Invalid character class name",	/* REG_ECTYPE */
-                                     "Trailing backslash",	/* REG_EESCAPE */
-                                     "Invalid back reference",	/* REG_ESUBREG */
-                                     "Unmatched [ or [^",	/* REG_EBRACK */
-                                     "Unmatched ( or \\(",	/* REG_EPAREN */
-                                     "Unmatched \\{",		/* REG_EBRACE */
-                                     "Invalid content of \\{\\}",	/* REG_BADBR */
-                                     "Invalid range end",	/* REG_ERANGE */
-                                     "Memory exhausted",		/* REG_ESPACE */
-                                     "Invalid preceding regular expression",	/* REG_BADRPT */
-                                     "Premature end of regular expression",	/* REG_EEND */
-                                     "Regular expression too big",	/* REG_ESIZE */
-                                     "Unmatched ) or \\)",	/* REG_ERPAREN */
+static const char *re_error_msg[] = {NULL,              /* REG_NOERROR */
+                                     "No match",            /* REG_NOMATCH */
+                                     "Invalid regular expression",  /* REG_BADPAT */
+                                     "Invalid collation character", /* REG_ECOLLATE */
+                                     "Invalid character class name",    /* REG_ECTYPE */
+                                     "Trailing backslash",  /* REG_EESCAPE */
+                                     "Invalid back reference",  /* REG_ESUBREG */
+                                     "Unmatched [ or [^",   /* REG_EBRACK */
+                                     "Unmatched ( or \\(",  /* REG_EPAREN */
+                                     "Unmatched \\{",       /* REG_EBRACE */
+                                     "Invalid content of \\{\\}",   /* REG_BADBR */
+                                     "Invalid range end",   /* REG_ERANGE */
+                                     "Memory exhausted",        /* REG_ESPACE */
+                                     "Invalid preceding regular expression",    /* REG_BADRPT */
+                                     "Premature end of regular expression", /* REG_EEND */
+                                     "Regular expression too big",  /* REG_ESIZE */
+                                     "Unmatched ) or \\)",  /* REG_ERPAREN */
                                     };
 
 /* Subroutine declarations and macros for regex_compile.  */
@@ -748,17 +748,17 @@ static const char *re_error_msg[] = {NULL,				/* REG_NOERROR */
  * if necessary.  Also cast from a signed character in the constant
  * string passed to us by the user to an unsigned char that we can use
  * as an array index (in, e.g., `translate').  */
-#define PATFETCH(c)							\
-  do {if (p == pend) return REG_EEND;					\
-    c = (unsigned char) *p++;						\
-    if (translate) c = translate[c]; 					\
+#define PATFETCH(c)                         \
+  do {if (p == pend) return REG_EEND;                   \
+    c = (unsigned char) *p++;                       \
+    if (translate) c = translate[c];                    \
   } while (0)
 
 /* Fetch the next character in the uncompiled pattern, with no
  * translation.  */
-#define PATFETCH_RAW(c)							\
-  do {if (p == pend) return REG_EEND;					\
-    c = (unsigned char) *p++; 						\
+#define PATFETCH_RAW(c)                         \
+  do {if (p == pend) return REG_EEND;                   \
+    c = (unsigned char) *p++;                       \
   } while (0)
 
 /* Go backwards one character in the pattern.  */
@@ -776,32 +776,32 @@ static const char *re_error_msg[] = {NULL,				/* REG_NOERROR */
 #define INIT_BUF_SIZE  32
 
 /* Make sure we have at least N more bytes of space in buffer.  */
-#define GET_BUFFER_SPACE(n)						\
-    while (b - bufp->buffer + (n) > bufp->allocated)			\
+#define GET_BUFFER_SPACE(n)                     \
+    while (b - bufp->buffer + (n) > bufp->allocated)            \
       EXTEND_BUFFER ()
 
 /* Make sure we have one more byte of buffer space and then add C to it.  */
-#define BUF_PUSH(c)							\
-  do {									\
-    GET_BUFFER_SPACE (1);						\
-    *b++ = (unsigned char) (c);						\
+#define BUF_PUSH(c)                         \
+  do {                                  \
+    GET_BUFFER_SPACE (1);                       \
+    *b++ = (unsigned char) (c);                     \
   } while (0)
 
 /* Ensure we have two more bytes of buffer space and then append C1 and C2.  */
-#define BUF_PUSH_2(c1, c2)						\
-  do {									\
-    GET_BUFFER_SPACE (2);						\
-    *b++ = (unsigned char) (c1);					\
-    *b++ = (unsigned char) (c2);					\
+#define BUF_PUSH_2(c1, c2)                      \
+  do {                                  \
+    GET_BUFFER_SPACE (2);                       \
+    *b++ = (unsigned char) (c1);                    \
+    *b++ = (unsigned char) (c2);                    \
   } while (0)
 
 /* As with BUF_PUSH_2, except for three bytes.  */
-#define BUF_PUSH_3(c1, c2, c3)						\
-  do {									\
-    GET_BUFFER_SPACE (3);						\
-    *b++ = (unsigned char) (c1);					\
-    *b++ = (unsigned char) (c2);					\
-    *b++ = (unsigned char) (c3);					\
+#define BUF_PUSH_3(c1, c2, c3)                      \
+  do {                                  \
+    GET_BUFFER_SPACE (3);                       \
+    *b++ = (unsigned char) (c1);                    \
+    *b++ = (unsigned char) (c2);                    \
+    *b++ = (unsigned char) (c3);                    \
   } while (0)
 
 /* Store a jump with opcode OP at LOC to location TO.  We store a
@@ -830,29 +830,29 @@ static const char *re_error_msg[] = {NULL,				/* REG_NOERROR */
  * reset the pointers that pointed into the old block to point to the
  * correct places in the new one.  If extending the buffer results in it
  * being larger than MAX_BUF_SIZE, then flag memory exhausted.  */
-#define EXTEND_BUFFER()							\
-  do { 									\
-    unsigned char *old_buffer = bufp->buffer;				\
-    if (bufp->allocated == MAX_BUF_SIZE) 				\
-      return REG_ESIZE;							\
-    bufp->allocated <<= 1;						\
-    if (bufp->allocated > MAX_BUF_SIZE)					\
-      bufp->allocated = MAX_BUF_SIZE; 					\
+#define EXTEND_BUFFER()                         \
+  do {                                  \
+    unsigned char *old_buffer = bufp->buffer;               \
+    if (bufp->allocated == MAX_BUF_SIZE)                \
+      return REG_ESIZE;                         \
+    bufp->allocated <<= 1;                      \
+    if (bufp->allocated > MAX_BUF_SIZE)                 \
+      bufp->allocated = MAX_BUF_SIZE;                   \
     bufp->buffer = (unsigned char *) realloc (bufp->buffer, bufp->allocated);\
-    if (bufp->buffer == NULL)						\
-      return REG_ESPACE;						\
-    /* If the buffer moved, move all the pointers into it.  */		\
-    if (old_buffer != bufp->buffer)					\
-      {									\
-        b = (b - old_buffer) + bufp->buffer;				\
-        begalt = (begalt - old_buffer) + bufp->buffer;			\
-        if (fixup_alt_jump)						\
+    if (bufp->buffer == NULL)                       \
+      return REG_ESPACE;                        \
+    /* If the buffer moved, move all the pointers into it.  */      \
+    if (old_buffer != bufp->buffer)                 \
+      {                                 \
+        b = (b - old_buffer) + bufp->buffer;                \
+        begalt = (begalt - old_buffer) + bufp->buffer;          \
+        if (fixup_alt_jump)                     \
           fixup_alt_jump = (fixup_alt_jump - old_buffer) + bufp->buffer;\
-        if (laststart)							\
-          laststart = (laststart - old_buffer) + bufp->buffer;		\
-        if (pending_exact)						\
-          pending_exact = (pending_exact - old_buffer) + bufp->buffer;	\
-      }									\
+        if (laststart)                          \
+          laststart = (laststart - old_buffer) + bufp->buffer;      \
+        if (pending_exact)                      \
+          pending_exact = (pending_exact - old_buffer) + bufp->buffer;  \
+      }                                 \
   } while (0)
 
 /* Since we have one byte reserved for the register number argument to
@@ -881,7 +881,7 @@ typedef struct {
 typedef struct {
     compile_stack_elt_t *stack;
     unsigned size;
-    unsigned avail;		/* Offset of next open position.  */
+    unsigned avail;     /* Offset of next open position.  */
 } compile_stack_type;
 
 static void store_op1(re_opcode_t op, unsigned char *loc, int arg);
@@ -904,30 +904,30 @@ static reg_errcode_t compile_range(const char **p_ptr, const char *pend, char *t
    |= 1 << (((unsigned char) c) % BYTEWIDTH))
 
 /* Get the next unsigned number in the uncompiled pattern.  */
-#define GET_UNSIGNED_NUMBER(num) 					\
-  { if (p != pend)							\
-     {									\
-       PATFETCH (c); 							\
-       while (ISDIGIT (c)) 						\
-         { 								\
-           if (num < 0)							\
-              num = 0;							\
-           num = num * 10 + c - '0'; 					\
-           if (p == pend) 						\
-              break; 							\
-           PATFETCH (c);						\
-         } 								\
-       } 								\
+#define GET_UNSIGNED_NUMBER(num)                    \
+  { if (p != pend)                          \
+     {                                  \
+       PATFETCH (c);                            \
+       while (ISDIGIT (c))                      \
+         {                              \
+           if (num < 0)                         \
+              num = 0;                          \
+           num = num * 10 + c - '0';                    \
+           if (p == pend)                       \
+              break;                            \
+           PATFETCH (c);                        \
+         }                              \
+       }                                \
     }
 
-#define CHAR_CLASS_MAX_LENGTH  6	/* Namely, `xdigit'.  */
+#define CHAR_CLASS_MAX_LENGTH  6    /* Namely, `xdigit'.  */
 
-#define IS_CHAR_CLASS(string)						\
-   (STREQ (string, "alpha") || STREQ (string, "upper")			\
-    || STREQ (string, "lower") || STREQ (string, "digit")		\
-    || STREQ (string, "alnum") || STREQ (string, "xdigit")		\
-    || STREQ (string, "space") || STREQ (string, "print")		\
-    || STREQ (string, "punct") || STREQ (string, "graph")		\
+#define IS_CHAR_CLASS(string)                       \
+   (STREQ (string, "alpha") || STREQ (string, "upper")          \
+    || STREQ (string, "lower") || STREQ (string, "digit")       \
+    || STREQ (string, "alnum") || STREQ (string, "xdigit")      \
+    || STREQ (string, "space") || STREQ (string, "print")       \
+    || STREQ (string, "punct") || STREQ (string, "graph")       \
     || STREQ (string, "cntrl") || STREQ (string, "blank"))
 
 /* `regex_compile' compiles PATTERN (of length SIZE) according to SYNTAX.
@@ -1038,11 +1038,12 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
 #endif
 
     if (bufp->allocated == 0) {
-        if (bufp->buffer) {	/* If zero allocated, but buffer is non-null, try to realloc
-				 * enough space.  This loses if buffer's address is bogus, but
-				 * that is the user's responsibility.  */
+        if (bufp->buffer) {
+            /* If zero allocated, but buffer is non-null, try to realloc
+                     * enough space.  This loses if buffer's address is bogus, but
+                     * that is the user's responsibility.  */
             RETALLOC(bufp->buffer, INIT_BUF_SIZE, unsigned char);
-        } else {		/* Caller did not allocate a buffer.  Do it for them.  */
+        } else {        /* Caller did not allocate a buffer.  Do it for them.  */
             bufp->buffer = TALLOC(INIT_BUF_SIZE, unsigned char);
         }
         if (!bufp->buffer)
@@ -1058,7 +1059,7 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
 
         switch (c) {
         case '^': {
-            if (		/* If at start of pattern, it's an operator.  */
+            if (        /* If at start of pattern, it's an operator.  */
                 p == pattern + 1
                 /* If context independent, it's an operator.  */
                 || syntax & RE_CONTEXT_INDEP_ANCHORS
@@ -1071,7 +1072,7 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
         break;
 
         case '$': {
-            if (		/* If at end of pattern, it's an operator.  */
+            if (        /* If at end of pattern, it's an operator.  */
                 p == pend
                 /* If context independent, it's an operator.  */
                 || syntax & RE_CONTEXT_INDEP_ANCHORS
@@ -1146,16 +1147,17 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
 
                 /* Now we know whether or not zero matches is allowed
                  * and also whether or not two or more matches is allowed.  */
-                if (many_times_ok) {	/* More than one repetition is allowed, so put in at the
-					 * end a backward relative jump from `b' to before the next
-					 * jump we're going to put in below (which jumps from
-					 * laststart to after this jump).
-					 *
-					 * But if we are at the `*' in the exact sequence `.*\n',
-					 * insert an unconditional jump backwards to the .,
-					 * instead of the beginning of the loop.  This way we only
-					 * push a failure point once, instead of every time
-					 * through the loop.  */
+                if (many_times_ok) {
+                    /* More than one repetition is allowed, so put in at the
+                         * end a backward relative jump from `b' to before the next
+                         * jump we're going to put in below (which jumps from
+                         * laststart to after this jump).
+                         *
+                         * But if we are at the `*' in the exact sequence `.*\n',
+                         * insert an unconditional jump backwards to the .,
+                         * instead of the beginning of the loop.  This way we only
+                         * push a failure point once, instead of every time
+                         * through the loop.  */
                     assert(p - 1 > pattern);
 
                     /* Allocate the space for the jump.  */
@@ -1169,7 +1171,7 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                     if (TRANSLATE(*(p - 2)) == TRANSLATE('.')
                             && zero_times_ok
                             && p < pend && TRANSLATE(*p) == TRANSLATE('\n')
-                            && !(syntax & RE_DOT_NEWLINE)) {	/* We have .*\n.  */
+                            && !(syntax & RE_DOT_NEWLINE)) {    /* We have .*\n.  */
                         STORE_JUMP(jump, b, laststart);
                         keep_string_p = true;
                     } else
@@ -1274,10 +1276,10 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                         && !(p - 3 >= pattern && p[-3] == '[' && p[-2] == '^')
                         && *p != ']') {
                     reg_errcode_t ret
-                    = compile_range(&p, pend, translate, syntax, b);
+                        = compile_range(&p, pend, translate, syntax, b);
                     if (ret != REG_NOERROR)
                         return ret;
-                } else if (p[0] == '-' && p[1] != ']') {	/* This handles ranges made up of characters only.  */
+                } else if (p[0] == '-' && p[1] != ']') {    /* This handles ranges made up of characters only.  */
                     reg_errcode_t ret;
 
                     /* Move past the `-'.  */
@@ -1290,7 +1292,7 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                 /* See if we're at the beginning of a possible character
                  * class.  */
 
-                else if (syntax & RE_CHAR_CLASSES && c == '[' && *p == ':') {	/* Leave room for the null.  */
+                else if (syntax & RE_CHAR_CLASSES && c == '[' && *p == ':') {   /* Leave room for the null.  */
                     char str[CHAR_CLASS_MAX_LENGTH + 1];
 
                     PATFETCH(c);
@@ -1437,7 +1439,7 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                  * be valid.  */
                 COMPILE_STACK_TOP.begalt_offset = begalt - bufp->buffer;
                 COMPILE_STACK_TOP.fixup_alt_jump
-                = fixup_alt_jump ? fixup_alt_jump - bufp->buffer + 1 : 0;
+                    = fixup_alt_jump ? fixup_alt_jump - bufp->buffer + 1 : 0;
                 COMPILE_STACK_TOP.laststart_offset = b - bufp->buffer;
                 COMPILE_STACK_TOP.regnum = regnum;
 
@@ -1471,10 +1473,11 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                         return REG_ERPAREN;
                 }
 handle_close:
-                if (fixup_alt_jump) {	/* Push a dummy failure point at the end of the
-					 * alternative for a possible future
-					 * `pop_failure_jump' to pop.  See comments at
-					 * `push_dummy_failure' in `re_match_2'.  */
+                if (fixup_alt_jump) {
+                    /* Push a dummy failure point at the end of the
+                         * alternative for a possible future
+                         * `pop_failure_jump' to pop.  See comments at
+                         * `push_dummy_failure' in `re_match_2'.  */
                     BUF_PUSH(push_dummy_failure);
 
                     /* We allocated space for this jump when we assigned
@@ -1500,9 +1503,9 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                     compile_stack.avail--;
                     begalt = bufp->buffer + COMPILE_STACK_TOP.begalt_offset;
                     fixup_alt_jump
-                    = COMPILE_STACK_TOP.fixup_alt_jump
-                      ? bufp->buffer + COMPILE_STACK_TOP.fixup_alt_jump - 1
-                      : 0;
+                        = COMPILE_STACK_TOP.fixup_alt_jump
+                          ? bufp->buffer + COMPILE_STACK_TOP.fixup_alt_jump - 1
+                          : 0;
                     laststart = bufp->buffer + COMPILE_STACK_TOP.laststart_offset;
                     this_group_regnum = COMPILE_STACK_TOP.regnum;
                     /* If we've reached MAX_REGNUM groups, then this open
@@ -1514,7 +1517,7 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                      * groups were inside this one.  */
                     if (this_group_regnum <= MAX_REGNUM) {
                         unsigned char *inner_group_loc
-                        = bufp->buffer + COMPILE_STACK_TOP.inner_group_offset;
+                            = bufp->buffer + COMPILE_STACK_TOP.inner_group_offset;
 
                         *inner_group_loc = regnum - this_group_regnum;
                         BUF_PUSH_3(stop_memory, this_group_regnum,
@@ -1523,7 +1526,7 @@ regex_compile(const char *pattern, int size, reg_syntax_t syntax, struct re_patt
                 }
                 break;
 
-            case '|':		/* `\|'.  */
+            case '|':       /* `\|'.  */
                 if (syntax & RE_LIMITED_OPS || syntax & RE_NO_BK_VBAR)
                     goto normal_backslash;
 handle_alt:
@@ -1647,8 +1650,9 @@ handle_interval: {
                      * jump_n <succeed_n addr> <jump count>
                      * (The upper bound and `jump_n' are omitted if
                      * `upper_bound' is 1, though.)  */
-                    else {	/* If the upper bound is > 1, we need to insert
-				 * more at the end of the loop.  */
+                    else {
+                        /* If the upper bound is > 1, we need to insert
+                        * more at the end of the loop.  */
                         unsigned nbytes = 10 + (upper_bound > 1) * 10;
 
                         GET_BUFFER_SPACE(nbytes);
@@ -1670,13 +1674,14 @@ handle_interval: {
                         insert_op2(set_number_at, laststart, 5, lower_bound, b);
                         b += 5;
 
-                        if (upper_bound > 1) {	/* More than one repetition is allowed, so
-						 * append a backward jump to the `succeed_n'
-						 * that starts this interval.
-						 *
-						 * When we've reached this during matching,
-						 * we'll have matched the interval once, so
-						 * jump back only `upper_bound - 1' times.  */
+                        if (upper_bound > 1) {
+                            /* More than one repetition is allowed, so
+                             * append a backward jump to the `succeed_n'
+                             * that starts this interval.
+                             *
+                             * When we've reached this during matching,
+                             * we'll have matched the interval once, so
+                             * jump back only `upper_bound - 1' times.  */
                             STORE_JUMP2(jump_n, b, laststart + 5,
                                         upper_bound - 1);
                             b += 5;
@@ -1827,8 +1832,8 @@ handle_interval: {
             BUF_PUSH(c);
             (*pending_exact)++;
             break;
-        }			/* switch (c) */
-    }				/* while p != pend */
+        }           /* switch (c) */
+    }               /* while p != pend */
 
     /* Through the pattern now.  */
 
@@ -1851,7 +1856,7 @@ handle_interval: {
 #endif /* DEBUG */
 
     return REG_NOERROR;
-}				/* regex_compile */
+}               /* regex_compile */
 
 /* Subroutines for `regex_compile'.  */
 
@@ -2028,7 +2033,7 @@ typedef const unsigned char *fail_stack_elt_t;
 typedef struct {
     fail_stack_elt_t *stack;
     unsigned size;
-    unsigned avail;		/* Offset of next open position.  */
+    unsigned avail;     /* Offset of next open position.  */
 } fail_stack_type;
 
 #define FAIL_STACK_EMPTY()     (fail_stack.avail == 0)
@@ -2038,16 +2043,16 @@ typedef struct {
 
 /* Initialize `fail_stack'.  Do `return -2' if the alloc fails.  */
 
-#define INIT_FAIL_STACK()						\
-  do {									\
-    fail_stack.stack = (fail_stack_elt_t *)				\
-      REGEX_ALLOCATE (INIT_FAILURE_ALLOC * sizeof (fail_stack_elt_t));	\
-									\
-    if (fail_stack.stack == NULL)					\
-      return -2;							\
-									\
-    fail_stack.size = INIT_FAILURE_ALLOC;				\
-    fail_stack.avail = 0;						\
+#define INIT_FAIL_STACK()                       \
+  do {                                  \
+    fail_stack.stack = (fail_stack_elt_t *)             \
+      REGEX_ALLOCATE (INIT_FAILURE_ALLOC * sizeof (fail_stack_elt_t));  \
+                                    \
+    if (fail_stack.stack == NULL)                   \
+      return -2;                            \
+                                    \
+    fail_stack.size = INIT_FAILURE_ALLOC;               \
+    fail_stack.avail = 0;                       \
   } while (0)
 
 /* Double the size of FAIL_STACK, up to approximately `re_max_failures' items.
@@ -2057,34 +2062,34 @@ typedef struct {
  *
  * REGEX_REALLOCATE requires `destination' be declared.   */
 
-#define DOUBLE_FAIL_STACK(fail_stack)					\
-  ((fail_stack).size > re_max_failures * MAX_FAILURE_ITEMS		\
-   ? 0									\
-   : ((fail_stack).stack = (fail_stack_elt_t *)				\
-        REGEX_REALLOCATE ((fail_stack).stack, 				\
-          (fail_stack).size * sizeof (fail_stack_elt_t),		\
-          ((fail_stack).size << 1) * sizeof (fail_stack_elt_t)),	\
-									\
-      (fail_stack).stack == NULL					\
-      ? 0								\
-      : ((fail_stack).size <<= 1, 					\
+#define DOUBLE_FAIL_STACK(fail_stack)                   \
+  ((fail_stack).size > re_max_failures * MAX_FAILURE_ITEMS      \
+   ? 0                                  \
+   : ((fail_stack).stack = (fail_stack_elt_t *)             \
+        REGEX_REALLOCATE ((fail_stack).stack,               \
+          (fail_stack).size * sizeof (fail_stack_elt_t),        \
+          ((fail_stack).size << 1) * sizeof (fail_stack_elt_t)),    \
+                                    \
+      (fail_stack).stack == NULL                    \
+      ? 0                               \
+      : ((fail_stack).size <<= 1,                   \
          1)))
 
 /* Push PATTERN_OP on FAIL_STACK.
  *
  * Return 1 if was able to do so and 0 if ran out of memory allocating
  * space to do so.  */
-#define PUSH_PATTERN_OP(pattern_op, fail_stack)				\
-  ((FAIL_STACK_FULL ()							\
-    && !DOUBLE_FAIL_STACK (fail_stack))					\
-    ? 0									\
-    : ((fail_stack).stack[(fail_stack).avail++] = pattern_op,		\
+#define PUSH_PATTERN_OP(pattern_op, fail_stack)             \
+  ((FAIL_STACK_FULL ()                          \
+    && !DOUBLE_FAIL_STACK (fail_stack))                 \
+    ? 0                                 \
+    : ((fail_stack).stack[(fail_stack).avail++] = pattern_op,       \
        1))
 
 /* This pushes an item onto the failure stack.  Must be a four-byte
  * value.  Assumes the variable `fail_stack'.  Probably should only
  * be called from within `PUSH_FAILURE_POINT'.  */
-#define PUSH_FAILURE_ITEM(item)						\
+#define PUSH_FAILURE_ITEM(item)                     \
   fail_stack.stack[fail_stack.avail++] = (fail_stack_elt_t) item
 
 /* The complement operation.  Assumes `fail_stack' is nonempty.  */
@@ -2108,78 +2113,78 @@ typedef struct {
  *
  * Does `return FAILURE_CODE' if runs out of memory.  */
 
-#define PUSH_FAILURE_POINT(pattern_place, string_place, failure_code)	\
-  do {									\
-    char *destination;							\
-    /* Must be int, so when we don't save any registers, the arithmetic	\
-       of 0 + -1 isn't done as unsigned.  */				\
-    int this_reg;							\
-    									\
-    DEBUG_STATEMENT (failure_id++);					\
-    DEBUG_STATEMENT (nfailure_points_pushed++);				\
-    DEBUG_PRINT2 ("\nPUSH_FAILURE_POINT #%u:\n", failure_id);		\
+#define PUSH_FAILURE_POINT(pattern_place, string_place, failure_code)   \
+  do {                                  \
+    char *destination;                          \
+    /* Must be int, so when we don't save any registers, the arithmetic \
+       of 0 + -1 isn't done as unsigned.  */                \
+    int this_reg;                           \
+                                        \
+    DEBUG_STATEMENT (failure_id++);                 \
+    DEBUG_STATEMENT (nfailure_points_pushed++);             \
+    DEBUG_PRINT2 ("\nPUSH_FAILURE_POINT #%u:\n", failure_id);       \
     DEBUG_PRINT2 ("  Before push, next avail: %d\n", (fail_stack).avail);\
     DEBUG_PRINT2 ("                     size: %d\n", (fail_stack).size);\
-									\
-    DEBUG_PRINT2 ("  slots needed: %d\n", NUM_FAILURE_ITEMS);		\
-    DEBUG_PRINT2 ("     available: %d\n", REMAINING_AVAIL_SLOTS);	\
-									\
-    /* Ensure we have enough space allocated for what we will push.  */	\
-    while (REMAINING_AVAIL_SLOTS < NUM_FAILURE_ITEMS)			\
-      {									\
-        if (!DOUBLE_FAIL_STACK (fail_stack))			\
-          return failure_code;						\
-									\
-        DEBUG_PRINT2 ("\n  Doubled stack; size now: %d\n",		\
-		       (fail_stack).size);				\
+                                    \
+    DEBUG_PRINT2 ("  slots needed: %d\n", NUM_FAILURE_ITEMS);       \
+    DEBUG_PRINT2 ("     available: %d\n", REMAINING_AVAIL_SLOTS);   \
+                                    \
+    /* Ensure we have enough space allocated for what we will push.  */ \
+    while (REMAINING_AVAIL_SLOTS < NUM_FAILURE_ITEMS)           \
+      {                                 \
+        if (!DOUBLE_FAIL_STACK (fail_stack))            \
+          return failure_code;                      \
+                                    \
+        DEBUG_PRINT2 ("\n  Doubled stack; size now: %d\n",      \
+               (fail_stack).size);              \
         DEBUG_PRINT2 ("  slots available: %d\n", REMAINING_AVAIL_SLOTS);\
-      }									\
-									\
-    /* Push the info, starting with the registers.  */			\
-    DEBUG_PRINT1 ("\n");						\
-									\
-    for (this_reg = lowest_active_reg; this_reg <= highest_active_reg;	\
-         this_reg++)							\
-      {									\
-	DEBUG_PRINT2 ("  Pushing reg: %d\n", this_reg);			\
-        DEBUG_STATEMENT (num_regs_pushed++);				\
-									\
-	DEBUG_PRINT2 ("    start: 0x%x\n", regstart[this_reg]);		\
-        PUSH_FAILURE_ITEM (regstart[this_reg]);				\
+      }                                 \
+                                    \
+    /* Push the info, starting with the registers.  */          \
+    DEBUG_PRINT1 ("\n");                        \
+                                    \
+    for (this_reg = lowest_active_reg; this_reg <= highest_active_reg;  \
+         this_reg++)                            \
+      {                                 \
+    DEBUG_PRINT2 ("  Pushing reg: %d\n", this_reg);         \
+        DEBUG_STATEMENT (num_regs_pushed++);                \
+                                    \
+    DEBUG_PRINT2 ("    start: 0x%x\n", regstart[this_reg]);     \
+        PUSH_FAILURE_ITEM (regstart[this_reg]);             \
                                                                         \
-	DEBUG_PRINT2 ("    end: 0x%x\n", regend[this_reg]);		\
-        PUSH_FAILURE_ITEM (regend[this_reg]);				\
-									\
-	DEBUG_PRINT2 ("    info: 0x%x\n      ", reg_info[this_reg]);	\
-        DEBUG_PRINT2 (" match_null=%d",					\
-                      REG_MATCH_NULL_STRING_P (reg_info[this_reg]));	\
-        DEBUG_PRINT2 (" active=%d", IS_ACTIVE (reg_info[this_reg]));	\
-        DEBUG_PRINT2 (" matched_something=%d",				\
-                      MATCHED_SOMETHING (reg_info[this_reg]));		\
-        DEBUG_PRINT2 (" ever_matched=%d",				\
-                      EVER_MATCHED_SOMETHING (reg_info[this_reg]));	\
-	DEBUG_PRINT1 ("\n");						\
-        PUSH_FAILURE_ITEM (reg_info[this_reg].word);			\
-      }									\
-									\
+    DEBUG_PRINT2 ("    end: 0x%x\n", regend[this_reg]);     \
+        PUSH_FAILURE_ITEM (regend[this_reg]);               \
+                                    \
+    DEBUG_PRINT2 ("    info: 0x%x\n      ", reg_info[this_reg]);    \
+        DEBUG_PRINT2 (" match_null=%d",                 \
+                      REG_MATCH_NULL_STRING_P (reg_info[this_reg]));    \
+        DEBUG_PRINT2 (" active=%d", IS_ACTIVE (reg_info[this_reg]));    \
+        DEBUG_PRINT2 (" matched_something=%d",              \
+                      MATCHED_SOMETHING (reg_info[this_reg]));      \
+        DEBUG_PRINT2 (" ever_matched=%d",               \
+                      EVER_MATCHED_SOMETHING (reg_info[this_reg])); \
+    DEBUG_PRINT1 ("\n");                        \
+        PUSH_FAILURE_ITEM (reg_info[this_reg].word);            \
+      }                                 \
+                                    \
     DEBUG_PRINT2 ("  Pushing  low active reg: %d\n", lowest_active_reg);\
-    PUSH_FAILURE_ITEM (lowest_active_reg);				\
-									\
+    PUSH_FAILURE_ITEM (lowest_active_reg);              \
+                                    \
     DEBUG_PRINT2 ("  Pushing high active reg: %d\n", highest_active_reg);\
-    PUSH_FAILURE_ITEM (highest_active_reg);				\
-									\
-    DEBUG_PRINT2 ("  Pushing pattern 0x%x: ", pattern_place);		\
-    DEBUG_PRINT_COMPILED_PATTERN (bufp, pattern_place, pend);		\
-    PUSH_FAILURE_ITEM (pattern_place);					\
-									\
-    DEBUG_PRINT2 ("  Pushing string 0x%x: `", string_place);		\
+    PUSH_FAILURE_ITEM (highest_active_reg);             \
+                                    \
+    DEBUG_PRINT2 ("  Pushing pattern 0x%x: ", pattern_place);       \
+    DEBUG_PRINT_COMPILED_PATTERN (bufp, pattern_place, pend);       \
+    PUSH_FAILURE_ITEM (pattern_place);                  \
+                                    \
+    DEBUG_PRINT2 ("  Pushing string 0x%x: `", string_place);        \
     DEBUG_PRINT_DOUBLE_STRING (string_place, string1, size1, string2,   \
-				 size2);				\
-    DEBUG_PRINT1 ("'\n");						\
-    PUSH_FAILURE_ITEM (string_place);					\
-									\
-    DEBUG_PRINT2 ("  Pushing failure id: %u\n", failure_id);		\
-    DEBUG_PUSH (failure_id);						\
+                 size2);                \
+    DEBUG_PRINT1 ("'\n");                       \
+    PUSH_FAILURE_ITEM (string_place);                   \
+                                    \
+    DEBUG_PRINT2 ("  Pushing failure id: %u\n", failure_id);        \
+    DEBUG_PUSH (failure_id);                        \
   } while (0)
 
 /* This is the number of items that are pushed and popped on the stack
@@ -2188,7 +2193,7 @@ typedef struct {
 
 /* Individual items aside from the registers.  */
 #ifdef DEBUG
-#define NUM_NONREG_ITEMS 5	/* Includes failure point id.  */
+#define NUM_NONREG_ITEMS 5  /* Includes failure point id.  */
 #else
 #define NUM_NONREG_ITEMS 4
 #endif
@@ -2197,8 +2202,8 @@ typedef struct {
 #define MAX_FAILURE_ITEMS ((num_regs - 1) * NUM_REG_ITEMS + NUM_NONREG_ITEMS)
 
 /* We actually push this many items.  */
-#define NUM_FAILURE_ITEMS						\
-  ((highest_active_reg - lowest_active_reg + 1) * NUM_REG_ITEMS 	\
+#define NUM_FAILURE_ITEMS                       \
+  ((highest_active_reg - lowest_active_reg + 1) * NUM_REG_ITEMS     \
     + NUM_NONREG_ITEMS)
 
 /* How many items can still be added to the stack without overflowing it.  */
@@ -2217,61 +2222,61 @@ typedef struct {
  * `pend', `string1', `size1', `string2', and `size2'.  */
 
 #define POP_FAILURE_POINT(str, pat, low_reg, high_reg, regstart, regend, reg_info)\
-{									\
-  DEBUG_STATEMENT (fail_stack_elt_t failure_id;)			\
-  int this_reg;								\
-  const unsigned char *string_temp;					\
-									\
-  assert (!FAIL_STACK_EMPTY ());					\
-									\
-  /* Remove failure points and point to how many regs pushed.  */	\
-  DEBUG_PRINT1 ("POP_FAILURE_POINT:\n");				\
-  DEBUG_PRINT2 ("  Before pop, next avail: %d\n", fail_stack.avail);	\
-  DEBUG_PRINT2 ("                    size: %d\n", fail_stack.size);	\
-									\
-  assert (fail_stack.avail >= NUM_NONREG_ITEMS);			\
-									\
-  DEBUG_POP (&failure_id);						\
-  DEBUG_PRINT2 ("  Popping failure id: %u\n", failure_id);		\
-									\
-  /* If the saved string location is NULL, it came from an		\
-     on_failure_keep_string_jump opcode, and we want to throw away the	\
-     saved NULL, thus retaining our current position in the string.  */	\
-  string_temp = POP_FAILURE_ITEM ();					\
-  if (string_temp != NULL)						\
-    str = (const char *) string_temp;					\
-									\
-  DEBUG_PRINT2 ("  Popping string 0x%x: `", str);			\
-  DEBUG_PRINT_DOUBLE_STRING (str, string1, size1, string2, size2);	\
-  DEBUG_PRINT1 ("'\n");							\
-									\
-  pat = (unsigned char *) POP_FAILURE_ITEM ();				\
-  DEBUG_PRINT2 ("  Popping pattern 0x%x: ", pat);			\
-  DEBUG_PRINT_COMPILED_PATTERN (bufp, pat, pend);			\
-									\
-  /* Restore register info.  */						\
-  high_reg = (unsigned long) POP_FAILURE_ITEM ();			\
-  DEBUG_PRINT2 ("  Popping high active reg: %d\n", high_reg);		\
-									\
-  low_reg = (unsigned long) POP_FAILURE_ITEM ();			\
-  DEBUG_PRINT2 ("  Popping  low active reg: %d\n", low_reg);		\
-									\
-  for (this_reg = high_reg; this_reg >= low_reg; this_reg--)		\
-    {									\
-      DEBUG_PRINT2 ("    Popping reg: %d\n", this_reg);			\
-									\
-      reg_info[this_reg].word = POP_FAILURE_ITEM ();			\
-      DEBUG_PRINT2 ("      info: 0x%x\n", reg_info[this_reg]);		\
-									\
-      regend[this_reg] = (const char *) POP_FAILURE_ITEM ();		\
-      DEBUG_PRINT2 ("      end: 0x%x\n", regend[this_reg]);		\
-									\
-      regstart[this_reg] = (const char *) POP_FAILURE_ITEM ();		\
-      DEBUG_PRINT2 ("      start: 0x%x\n", regstart[this_reg]);		\
-    }									\
-									\
-  DEBUG_STATEMENT (nfailure_points_popped++);				\
-}				/* POP_FAILURE_POINT */
+{                                   \
+  DEBUG_STATEMENT (fail_stack_elt_t failure_id;)            \
+  int this_reg;                             \
+  const unsigned char *string_temp;                 \
+                                    \
+  assert (!FAIL_STACK_EMPTY ());                    \
+                                    \
+  /* Remove failure points and point to how many regs pushed.  */   \
+  DEBUG_PRINT1 ("POP_FAILURE_POINT:\n");                \
+  DEBUG_PRINT2 ("  Before pop, next avail: %d\n", fail_stack.avail);    \
+  DEBUG_PRINT2 ("                    size: %d\n", fail_stack.size); \
+                                    \
+  assert (fail_stack.avail >= NUM_NONREG_ITEMS);            \
+                                    \
+  DEBUG_POP (&failure_id);                      \
+  DEBUG_PRINT2 ("  Popping failure id: %u\n", failure_id);      \
+                                    \
+  /* If the saved string location is NULL, it came from an      \
+     on_failure_keep_string_jump opcode, and we want to throw away the  \
+     saved NULL, thus retaining our current position in the string.  */ \
+  string_temp = POP_FAILURE_ITEM ();                    \
+  if (string_temp != NULL)                      \
+    str = (const char *) string_temp;                   \
+                                    \
+  DEBUG_PRINT2 ("  Popping string 0x%x: `", str);           \
+  DEBUG_PRINT_DOUBLE_STRING (str, string1, size1, string2, size2);  \
+  DEBUG_PRINT1 ("'\n");                         \
+                                    \
+  pat = (unsigned char *) POP_FAILURE_ITEM ();              \
+  DEBUG_PRINT2 ("  Popping pattern 0x%x: ", pat);           \
+  DEBUG_PRINT_COMPILED_PATTERN (bufp, pat, pend);           \
+                                    \
+  /* Restore register info.  */                     \
+  high_reg = (unsigned long) POP_FAILURE_ITEM ();           \
+  DEBUG_PRINT2 ("  Popping high active reg: %d\n", high_reg);       \
+                                    \
+  low_reg = (unsigned long) POP_FAILURE_ITEM ();            \
+  DEBUG_PRINT2 ("  Popping  low active reg: %d\n", low_reg);        \
+                                    \
+  for (this_reg = high_reg; this_reg >= low_reg; this_reg--)        \
+    {                                   \
+      DEBUG_PRINT2 ("    Popping reg: %d\n", this_reg);         \
+                                    \
+      reg_info[this_reg].word = POP_FAILURE_ITEM ();            \
+      DEBUG_PRINT2 ("      info: 0x%x\n", reg_info[this_reg]);      \
+                                    \
+      regend[this_reg] = (const char *) POP_FAILURE_ITEM ();        \
+      DEBUG_PRINT2 ("      end: 0x%x\n", regend[this_reg]);     \
+                                    \
+      regstart[this_reg] = (const char *) POP_FAILURE_ITEM ();      \
+      DEBUG_PRINT2 ("      start: 0x%x\n", regstart[this_reg]);     \
+    }                                   \
+                                    \
+  DEBUG_STATEMENT (nfailure_points_popped++);               \
+}               /* POP_FAILURE_POINT */
 
 /* re_compile_fastmap computes a ``fastmap'' for the compiled pattern in
  * BUFP.  A fastmap records which of the (1 << BYTEWIDTH) possible
@@ -2320,8 +2325,8 @@ struct re_pattern_buffer *bufp;
     assert(fastmap != NULL && p != NULL);
 
     INIT_FAIL_STACK();
-    memset(fastmap, 0, 1 << BYTEWIDTH);		/* Assume nothing's valid.  */
-    bufp->fastmap_accurate = 1;	/* It will be when we're done.  */
+    memset(fastmap, 0, 1 << BYTEWIDTH);     /* Assume nothing's valid.  */
+    bufp->fastmap_accurate = 1; /* It will be when we're done.  */
     bufp->can_be_null = 0;
 
     while (p != pend || !FAIL_STACK_EMPTY()) {
@@ -2343,17 +2348,17 @@ struct re_pattern_buffer *bufp;
 #endif
         {
 
-            /* I guess the idea here is to simply not bother with a fastmap
-             * if a backreference is used, since it's too hard to figure out
-             * the fastmap for the corresponding group.  Setting
-             * `can_be_null' stops `re_search_2' from using the fastmap, so
-             * that is all we do.  */
+        /* I guess the idea here is to simply not bother with a fastmap
+         * if a backreference is used, since it's too hard to figure out
+         * the fastmap for the corresponding group.  Setting
+         * `can_be_null' stops `re_search_2' from using the fastmap, so
+         * that is all we do.  */
         case duplicate:
             bufp->can_be_null = 1;
             return 0;
 
-            /* Following are the cases which match a character.  These end
-             * with `break'.  */
+        /* Following are the cases which match a character.  These end
+         * with `break'.  */
 
         case exactn:
             fastmap[p[1]] = 1;
@@ -2466,7 +2471,7 @@ struct re_pattern_buffer *bufp;
                 bufp->can_be_null = 1;
 
             if (succeed_n_p) {
-                EXTRACT_NUMBER_AND_INCR(k, p);	/* Skip the n.  */
+                EXTRACT_NUMBER_AND_INCR(k, p);  /* Skip the n.  */
                 succeed_n_p = false;
             }
             continue;
@@ -2479,7 +2484,7 @@ struct re_pattern_buffer *bufp;
             EXTRACT_NUMBER_AND_INCR(k, p);
             if (k == 0) {
                 p -= 4;
-                succeed_n_p = true;	/* Spaghetti code alert.  */
+                succeed_n_p = true; /* Spaghetti code alert.  */
                 goto handle_on_failure_jump;
             }
             continue;
@@ -2494,8 +2499,8 @@ struct re_pattern_buffer *bufp;
             continue;
 
         default:
-            abort();		/* We have listed all the cases.  */
-        }			/* switch *p++ */
+            abort();        /* We have listed all the cases.  */
+        }           /* switch *p++ */
 
         /* Getting here means we have found the possible starting
          * characters for one path of the pattern -- and that the empty
@@ -2505,13 +2510,13 @@ struct re_pattern_buffer *bufp;
          * does these things.  */
         path_can_be_null = false;
         p = pend;
-    }				/* while p */
+    }               /* while p */
 
     /* Set `can_be_null' for the last path (also the first path, if the
      * pattern is empty).  */
     bufp->can_be_null |= path_can_be_null;
     return 0;
-}				/* re_compile_fastmap */
+}               /* re_compile_fastmap */
 
 /* Searching routines.  */
 
@@ -2597,7 +2602,7 @@ int stop;
          * null string, however, we don't need to skip characters; we want
          * the first null string.  */
         if (fastmap && startpos < total_size && !bufp->can_be_null) {
-            if (range > 0) {	/* Searching forwards.  */
+            if (range > 0) {    /* Searching forwards.  */
                 register const char *d;
                 register int lim = 0;
                 int irange = range;
@@ -2619,7 +2624,7 @@ int stop;
                         range--;
 
                 startpos += irange - range;
-            } else {		/* Searching backwards.  */
+            } else {        /* Searching backwards.  */
                 register char c = (size1 == 0 || startpos >= size1
                                    ? string2[startpos - size1]
                                    : string1[startpos]);
@@ -2653,7 +2658,7 @@ int stop;
         }
     }
     return -1;
-}				/* re_search_2 */
+}               /* re_search_2 */
 
 /* Declarations and macros for re_match_2.  */
 
@@ -2693,22 +2698,22 @@ static boolean group_match_null_string_p(unsigned char **p, unsigned char *end,
 /* Call this when have matched a real character; it sets `matched' flags
  * for the subexpressions which we are currently inside.  Also records
  * that those subexprs have matched.  */
-#define SET_REGS_MATCHED()						\
-  do									\
-    {									\
-      unsigned r;							\
-      for (r = lowest_active_reg; r <= highest_active_reg; r++)		\
-        {								\
-          MATCHED_SOMETHING (reg_info[r])				\
-            = EVER_MATCHED_SOMETHING (reg_info[r])			\
-            = 1;							\
-        }								\
-    }									\
+#define SET_REGS_MATCHED()                      \
+  do                                    \
+    {                                   \
+      unsigned r;                           \
+      for (r = lowest_active_reg; r <= highest_active_reg; r++)     \
+        {                               \
+          MATCHED_SOMETHING (reg_info[r])               \
+            = EVER_MATCHED_SOMETHING (reg_info[r])          \
+            = 1;                            \
+        }                               \
+    }                                   \
   while (0)
 
 /* This converts PTR, a pointer into one of the search strings `string1'
  * and `string2' into an offset from the beginning of that string.  */
-#define POINTER_TO_OFFSET(ptr)						\
+#define POINTER_TO_OFFSET(ptr)                      \
   (FIRST_STRING_P (ptr) ? (ptr) - string1 : (ptr) - string2 + size1)
 
 /* Registers are set to a sentinel when they haven't yet matched.  */
@@ -2721,15 +2726,15 @@ static boolean group_match_null_string_p(unsigned char **p, unsigned char *end,
 
 /* Call before fetching a character with *d.  This switches over to
  * string2 if necessary.  */
-#define PREFETCH()							\
-  while (d == dend)						    	\
-    {									\
-      /* End of string2 => fail.  */					\
-      if (dend == end_match_2) 						\
-        goto fail;							\
-      /* End of string1 => advance to string2.  */ 			\
-      d = string2;						        \
-      dend = end_match_2;						\
+#define PREFETCH()                          \
+  while (d == dend)                             \
+    {                                   \
+      /* End of string2 => fail.  */                    \
+      if (dend == end_match_2)                      \
+        goto fail;                          \
+      /* End of string1 => advance to string2.  */          \
+      d = string2;                              \
+      dend = end_match_2;                       \
     }
 
 /* Test if at very beginning or at very end of the virtual concatenation
@@ -2744,9 +2749,9 @@ static int at_strings_end(const char *d, const char *end2)
  * two special cases to check for: if past the end of string1, look at
  * the first character in string2; and if before the beginning of
  * string2, look at the last character in string1.  */
-#define WORDCHAR_P(d)							\
-  (re_syntax_table[(d) == end1 ? *string2					\
-           : (d) == string2 - 1 ? *(end1 - 1) : *(d)]			\
+#define WORDCHAR_P(d)                           \
+  (re_syntax_table[(d) == end1 ? *string2                   \
+           : (d) == string2 - 1 ? *(end1 - 1) : *(d)]           \
    == Sword)
 static int
 wordchar_p(const char *d, const char *end1, const char *string2)
@@ -2758,25 +2763,25 @@ wordchar_p(const char *d, const char *end1, const char *string2)
 
 /* Test if the character before D and the one at D differ with respect
  * to being word-constituent.  */
-#define AT_WORD_BOUNDARY(d)						\
-  (AT_STRINGS_BEG (d) || at_strings_end(d,end2)				\
+#define AT_WORD_BOUNDARY(d)                     \
+  (AT_STRINGS_BEG (d) || at_strings_end(d,end2)             \
    || WORDCHAR_P (d - 1) != WORDCHAR_P (d))
 
 /* Free everything we malloc.  */
 #ifdef REGEX_MALLOC
 #define FREE_VAR(var) if (var) free (var); var = NULL
-#define FREE_VARIABLES()						\
-  do {									\
-    FREE_VAR (fail_stack.stack);					\
-    FREE_VAR (regstart);						\
-    FREE_VAR (regend);							\
-    FREE_VAR (old_regstart);						\
-    FREE_VAR (old_regend);						\
-    FREE_VAR (best_regstart);						\
-    FREE_VAR (best_regend);						\
-    FREE_VAR (reg_info);						\
-    FREE_VAR (reg_dummy);						\
-    FREE_VAR (reg_info_dummy);						\
+#define FREE_VARIABLES()                        \
+  do {                                  \
+    FREE_VAR (fail_stack.stack);                    \
+    FREE_VAR (regstart);                        \
+    FREE_VAR (regend);                          \
+    FREE_VAR (old_regstart);                        \
+    FREE_VAR (old_regend);                      \
+    FREE_VAR (best_regstart);                       \
+    FREE_VAR (best_regend);                     \
+    FREE_VAR (reg_info);                        \
+    FREE_VAR (reg_dummy);                       \
+    FREE_VAR (reg_info_dummy);                      \
   } while (0)
 #else /* not REGEX_MALLOC */
 /* Some MIPS systems (at least) want this to free alloca'd storage.  */
@@ -3012,15 +3017,15 @@ int stop;
     for (;;) {
         DEBUG_PRINT2("\n0x%x: ", p);
 
-        if (p == pend) {	/* End of pattern means we might have succeeded.  */
+        if (p == pend) {    /* End of pattern means we might have succeeded.  */
             DEBUG_PRINT1("end of pattern ... ");
 
             /* If we haven't matched the entire string, and we want the
              * longest match, try backtracking.  */
             if (d != end_match_2) {
                 DEBUG_PRINT1("backtracking.\n");
 
-                if (!FAIL_STACK_EMPTY()) {	/* More failure points to try.  */
+                if (!FAIL_STACK_EMPTY()) {  /* More failure points to try.  */
                     boolean same_str_p = (FIRST_STRING_P(match_end)
                                           == MATCHING_IN_FIRST_STRING);
 
@@ -3059,24 +3064,26 @@ int stop;
                         regend[mcnt] = best_regend[mcnt];
                     }
                 }
-            }			/* d != end_match_2 */
+            }           /* d != end_match_2 */
             DEBUG_PRINT1("Accepting match.\n");
 
             /* If caller wants register contents data back, do it.  */
             if (regs && !bufp->no_sub) {
                 /* Have the register data arrays been allocated?  */
-                if (bufp->regs_allocated == REGS_UNALLOCATED) {		/* No.  So allocate them with malloc.  We need one
-									 * extra element beyond `num_regs' for the `-1' marker
-									 * GNU code uses.  */
+                if (bufp->regs_allocated == REGS_UNALLOCATED) {
+                    /* No.  So allocate them with malloc.  We need one
+                                         * extra element beyond `num_regs' for the `-1' marker
+                                         * GNU code uses.  */
                     regs->num_regs = max(RE_NREGS, num_regs + 1);
                     regs->start = TALLOC(regs->num_regs, regoff_t);
                     regs->end = TALLOC(regs->num_regs, regoff_t);
                     if (regs->start == NULL || regs->end == NULL)
                         return -2;
                     bufp->regs_allocated = REGS_REALLOCATE;
-                } else if (bufp->regs_allocated == REGS_REALLOCATE) {	/* Yes.  If we need more elements than were already
-									 * allocated, reallocate them.  If we need fewer, just
-									 * leave it alone.  */
+                } else if (bufp->regs_allocated == REGS_REALLOCATE) {
+                    /* Yes.  If we need more elements than were already
+                                         * allocated, reallocate them.  If we need fewer, just
+                                         * leave it alone.  */
                     if (regs->num_regs < num_regs + 1) {
                         regs->num_regs = num_regs + 1;
                         RETALLOC(regs->start, regs->num_regs, regoff_t);
@@ -3113,7 +3120,7 @@ int stop;
                  * -1 at the end.  */
                 for (mcnt = num_regs; mcnt < regs->num_regs; mcnt++)
                     regs->start[mcnt] = regs->end[mcnt] = -1;
-            }			/* regs && !bufp->no_sub */
+            }           /* regs && !bufp->no_sub */
             FREE_VARIABLES();
             DEBUG_PRINT4("%u failure points pushed, %u popped (%u remain).\n",
                          nfailure_points_pushed, nfailure_points_popped,
@@ -3135,15 +3142,15 @@ int stop;
         switch ((re_opcode_t) * p++)
 #endif
         {
-            /* Ignore these.  Used to ignore the n of succeed_n's which
-             * currently have n == 0.  */
+        /* Ignore these.  Used to ignore the n of succeed_n's which
+         * currently have n == 0.  */
         case no_op:
             DEBUG_PRINT1("EXECUTING no_op.\n");
             break;
 
-            /* Match the next n pattern characters exactly.  The following
-             * byte in the pattern defines n, and the n bytes after that
-             * are the characters to match.  */
+        /* Match the next n pattern characters exactly.  The following
+         * byte in the pattern defines n, and the n bytes after that
+         * are the characters to match.  */
         case exactn:
             mcnt = *p++;
             DEBUG_PRINT2("EXECUTING exactn %d.\n", mcnt);
@@ -3166,7 +3173,7 @@ int stop;
             SET_REGS_MATCHED();
             break;
 
-            /* Match any character except possibly a newline or a null.  */
+        /* Match any character except possibly a newline or a null.  */
         case anychar:
             DEBUG_PRINT1("EXECUTING anychar.\n");
 
@@ -3189,7 +3196,7 @@ int stop;
             DEBUG_PRINT2("EXECUTING charset%s.\n", not ? "_not" : "");
 
             PREFETCH();
-            c = TRANSLATE(*d);	/* The character to match.  */
+            c = TRANSLATE(*d);  /* The character to match.  */
 
             /* Cast to `unsigned' instead of `unsigned char' in case the
              * bit list is a full 32 bytes long.  */
@@ -3216,11 +3223,11 @@ int stop;
             DEBUG_PRINT3("EXECUTING start_memory %d (%d):\n", *p, p[1]);
 
             /* Find out if this group can match the empty string.  */
-            p1 = p;		/* To send to group_match_null_string_p.  */
+            p1 = p;     /* To send to group_match_null_string_p.  */
 
             if (REG_MATCH_NULL_STRING_P(reg_info[*p]) == MATCH_NULL_UNSET_VALUE)
                 REG_MATCH_NULL_STRING_P(reg_info[*p])
-                = group_match_null_string_p(&p1, pend, reg_info);
+                    = group_match_null_string_p(&p1, pend, reg_info);
 
             /* Save the position in the string where we were the last time
              * we were at this open-group operator in case the group is
@@ -3229,7 +3236,7 @@ int stop;
              * the string in case this attempt to match fails.  */
             old_regstart[*p] = REG_MATCH_NULL_STRING_P(reg_info[*p])
                                ? REG_UNSET(regstart[*p]) ? d : regstart[*p]
-                   : regstart[*p];
+                               : regstart[*p];
             DEBUG_PRINT2("  old_regstart: %d\n",
                          POINTER_TO_OFFSET(old_regstart[*p]));
 
@@ -3251,9 +3258,9 @@ int stop;
             p += 2;
             break;
 
-            /* The stop_memory opcode represents the end of a group.  Its
-             * arguments are the same as start_memory's: the register
-             * number, and the number of inner groups.  */
+        /* The stop_memory opcode represents the end of a group.  Its
+         * arguments are the same as start_memory's: the register
+         * number, and the number of inner groups.  */
         case stop_memory:
             DEBUG_PRINT3("EXECUTING stop_memory %d (%d):\n", *p, p[1]);
 
@@ -3264,7 +3271,7 @@ int stop;
              * the string in case this attempt to match fails.  */
             old_regend[*p] = REG_MATCH_NULL_STRING_P(reg_info[*p])
                              ? REG_UNSET(regend[*p]) ? d : regend[*p]
-                 : regend[*p];
+                             : regend[*p];
             DEBUG_PRINT2("      old_regend: %d\n",
                          POINTER_TO_OFFSET(old_regend[*p]));
 
@@ -3279,10 +3286,11 @@ int stop;
             if (lowest_active_reg == highest_active_reg) {
                 lowest_active_reg = NO_LOWEST_ACTIVE_REG;
                 highest_active_reg = NO_HIGHEST_ACTIVE_REG;
-            } else {		/* We must scan for the new highest active register, since
-				 * it isn't necessarily one less than now: consider
-				 * (a(b)c(d(e)f)g).  When group 3 ends, after the f), the
-				 * new highest active register is 1.  */
+            } else {
+                /* We must scan for the new highest active register, since
+                     * it isn't necessarily one less than now: consider
+                     * (a(b)c(d(e)f)g).  When group 3 ends, after the f), the
+                     * new highest active register is 1.  */
                 unsigned char r = *p - 1;
                 while (r > 0 && !IS_ACTIVE(reg_info[r]))
                     r--;
@@ -3373,11 +3381,11 @@ int stop;
             p += 2;
             break;
 
-            /* \<digit> has been turned into a `duplicate' command which is
-             * followed by the numeric value of <digit> as the register number.  */
+        /* \<digit> has been turned into a `duplicate' command which is
+         * followed by the numeric value of <digit> as the register number.  */
         case duplicate: {
             register const char *d2, *dend2;
-            int regno = *p++;	/* Get which register to match against.  */
+            int regno = *p++;   /* Get which register to match against.  */
             DEBUG_PRINT2("EXECUTING duplicate %d.\n", regno);
 
             /* Can't back reference a group which we've never matched.  */
@@ -3449,7 +3457,7 @@ int stop;
             /* In all other cases, we fail.  */
             goto fail;
 
-            /* endline is the dual of begline.  */
+        /* endline is the dual of begline.  */
         case endline:
             DEBUG_PRINT1("EXECUTING endline.\n");
 
@@ -3464,36 +3472,36 @@ int stop;
             }
             goto fail;
 
-            /* Match at the very beginning of the data.  */
+        /* Match at the very beginning of the data.  */
         case begbuf:
             DEBUG_PRINT1("EXECUTING begbuf.\n");
             if (AT_STRINGS_BEG(d))
                 break;
             goto fail;
 
-            /* Match at the very end of the data.  */
+        /* Match at the very end of the data.  */
         case endbuf:
             DEBUG_PRINT1("EXECUTING endbuf.\n");
             if (at_strings_end(d,end2))
                 break;
             goto fail;
 
-            /* on_failure_keep_string_jump is used to optimize `.*\n'.  It
-             * pushes NULL as the value for the string on the stack.  Then
-             * `pop_failure_point' will keep the current value for the
-             * string, instead of restoring it.  To see why, consider
-             * matching `foo\nbar' against `.*\n'.  The .* matches the foo;
-             * then the . fails against the \n.  But the next thing we want
-             * to do is match the \n against the \n; if we restored the
-             * string value, we would be back at the foo.
-             *
-             * Because this is used only in specific cases, we don't need to
-             * check all the things that `on_failure_jump' does, to make
-             * sure the right things get saved on the stack.  Hence we don't
-             * share its code.  The only reason to push anything on the
-             * stack at all is that otherwise we would have to change
-             * `anychar's code to do something besides goto fail in this
-             * case; that seems worse than this.  */
+        /* on_failure_keep_string_jump is used to optimize `.*\n'.  It
+         * pushes NULL as the value for the string on the stack.  Then
+         * `pop_failure_point' will keep the current value for the
+         * string, instead of restoring it.  To see why, consider
+         * matching `foo\nbar' against `.*\n'.  The .* matches the foo;
+         * then the . fails against the \n.  But the next thing we want
+         * to do is match the \n against the \n; if we restored the
+         * string value, we would be back at the foo.
+         *
+         * Because this is used only in specific cases, we don't need to
+         * check all the things that `on_failure_jump' does, to make
+         * sure the right things get saved on the stack.  Hence we don't
+         * share its code.  The only reason to push anything on the
+         * stack at all is that otherwise we would have to change
+         * `anychar's code to do something besides goto fail in this
+         * case; that seems worse than this.  */
         case on_failure_keep_string_jump:
             DEBUG_PRINT1("EXECUTING on_failure_keep_string_jump");
 
@@ -3503,18 +3511,18 @@ int stop;
             PUSH_FAILURE_POINT(p + mcnt, NULL, -2);
             break;
 
-            /* Uses of on_failure_jump:
-             *
-             * Each alternative starts with an on_failure_jump that points
-             * to the beginning of the next alternative.  Each alternative
-             * except the last ends with a jump that in effect jumps past
-             * the rest of the alternatives.  (They really jump to the
-             * ending jump of the following alternative, because tensioning
-             * these jumps is a hassle.)
-             *
-             * Repeats start with an on_failure_jump that points past both
-             * the repetition text and either the following jump or
-             * pop_failure_jump back to this on_failure_jump.  */
+        /* Uses of on_failure_jump:
+         *
+         * Each alternative starts with an on_failure_jump that points
+         * to the beginning of the next alternative.  Each alternative
+         * except the last ends with a jump that in effect jumps past
+         * the rest of the alternatives.  (They really jump to the
+         * ending jump of the following alternative, because tensioning
+         * these jumps is a hassle.)
+         *
+         * Repeats start with an on_failure_jump that points past both
+         * the repetition text and either the following jump or
+         * pop_failure_jump back to this on_failure_jump.  */
         case on_failure_jump:
 on_failure:
             DEBUG_PRINT1("EXECUTING on_failure_jump");
@@ -3553,8 +3561,8 @@ int stop;
             PUSH_FAILURE_POINT(p + mcnt, d, -2);
             break;
 
-            /* A smart repeat ends with `maybe_pop_jump'.
-             * We change it to either `pop_failure_jump' or `jump'.  */
+        /* A smart repeat ends with `maybe_pop_jump'.
+         * We change it to either `pop_failure_jump' or `jump'.  */
         case maybe_pop_jump:
             EXTRACT_NUMBER_AND_INCR(mcnt, p);
             DEBUG_PRINT2("EXECUTING maybe_pop_jump %d.\n", mcnt);
@@ -3578,7 +3586,7 @@ int stop;
                 while (p2 + 2 < pend
                         && ((re_opcode_t) * p2 == stop_memory
                             || (re_opcode_t) * p2 == start_memory))
-                    p2 += 3;	/* Skip over args, too.  */
+                    p2 += 3;    /* Skip over args, too.  */
 
                 /* If we're at the end of the pattern, we can change.  */
                 if (p2 == pend) {
@@ -3591,7 +3599,7 @@ int stop;
                 } else if ((re_opcode_t) * p2 == exactn
                            || (bufp->newline_anchor && (re_opcode_t) * p2 == endline)) {
                     register unsigned char c
-                    = *p2 == (unsigned char) endline ? '\n' : p2[2];
+                        = *p2 == (unsigned char) endline ? '\n' : p2[2];
                     p1 = p + mcnt;
 
                     /* p1[0] ... p1[2] are the `on_failure_jump' corresponding
@@ -3618,20 +3626,20 @@ int stop;
                     }
                 }
             }
-            p -= 2;		/* Point at relative address again.  */
+            p -= 2;     /* Point at relative address again.  */
             if ((re_opcode_t) p[-1] != pop_failure_jump) {
                 p[-1] = (unsigned char) jump;
                 DEBUG_PRINT1("  Match => jump.\n");
                 goto unconditional_jump;
             }
-            /* Note fall through.  */
-
-            /* The end of a simple repeat has a pop_failure_jump back to
-             * its matching on_failure_jump, where the latter will push a
-             * failure point.  The pop_failure_jump takes off failure
-             * points put on by this pop_failure_jump's matching
-             * on_failure_jump; we got through the pattern to here from the
-             * matching on_failure_jump, so didn't fail.  */
+        /* Note fall through.  */
+
+        /* The end of a simple repeat has a pop_failure_jump back to
+         * its matching on_failure_jump, where the latter will push a
+         * failure point.  The pop_failure_jump takes off failure
+         * points put on by this pop_failure_jump's matching
+         * on_failure_jump; we got through the pattern to here from the
+         * matching on_failure_jump, so didn't fail.  */
         case pop_failure_jump: {
             /* We need to pass separate storage for the lowest and
              * highest registers, even though we don't care about the
@@ -3655,44 +3663,44 @@ int stop;
         /* Unconditionally jump (without popping any failure points).  */
         case jump:
 unconditional_jump:
-            EXTRACT_NUMBER_AND_INCR(mcnt, p);	/* Get the amount to jump.  */
+            EXTRACT_NUMBER_AND_INCR(mcnt, p);   /* Get the amount to jump.  */
             DEBUG_PRINT2("EXECUTING jump %d ", mcnt);
-            p += mcnt;		/* Do the jump.  */
+            p += mcnt;      /* Do the jump.  */
             DEBUG_PRINT2("(to 0x%x).\n", p);
             break;
 
-            /* We need this opcode so we can detect where alternatives end
-             * in `group_match_null_string_p' et al.  */
+        /* We need this opcode so we can detect where alternatives end
+         * in `group_match_null_string_p' et al.  */
         case jump_past_alt:
             DEBUG_PRINT1("EXECUTING jump_past_alt.\n");
             goto unconditional_jump;
 
-            /* Normally, the on_failure_jump pushes a failure point, which
-             * then gets popped at pop_failure_jump.  We will end up at
-             * pop_failure_jump, also, and with a pattern of, say, `a+', we
-             * are skipping over the on_failure_jump, so we have to push
-             * something meaningless for pop_failure_jump to pop.  */
+        /* Normally, the on_failure_jump pushes a failure point, which
+         * then gets popped at pop_failure_jump.  We will end up at
+         * pop_failure_jump, also, and with a pattern of, say, `a+', we
+         * are skipping over the on_failure_jump, so we have to push
+         * something meaningless for pop_failure_jump to pop.  */
         case dummy_failure_jump:
             DEBUG_PRINT1("EXECUTING dummy_failure_jump.\n");
             /* It doesn't matter what we push for the string here.  What
              * the code at `fail' tests is the value for the pattern.  */
             PUSH_FAILURE_POINT(0, 0, -2);
             goto unconditional_jump;
 
-            /* At the end of an alternative, we need to push a dummy failure
-             * point in case we are followed by a `pop_failure_jump', because
-             * we don't want the failure point for the alternative to be
-             * popped.  For example, matching `(a|ab)*' against `aab'
-             * requires that we match the `ab' alternative.  */
+        /* At the end of an alternative, we need to push a dummy failure
+         * point in case we are followed by a `pop_failure_jump', because
+         * we don't want the failure point for the alternative to be
+         * popped.  For example, matching `(a|ab)*' against `aab'
+         * requires that we match the `ab' alternative.  */
         case push_dummy_failure:
             DEBUG_PRINT1("EXECUTING push_dummy_failure.\n");
             /* See comments just above at `dummy_failure_jump' about the
              * two zeroes.  */
             PUSH_FAILURE_POINT(0, 0, -2);
             break;
 
-            /* Have to succeed matching what follows at least n times.
-             * After that, handle like `on_failure_jump'.  */
+        /* Have to succeed matching what follows at least n times.
+         * After that, handle like `on_failure_jump'.  */
         case succeed_n:
             EXTRACT_NUMBER(mcnt, p + 2);
             DEBUG_PRINT2("EXECUTING succeed_n %d.\n", mcnt);
@@ -3784,11 +3792,11 @@ int stop;
         default:
             abort();
         }
-        continue;		/* Successfully executed one pattern command; keep going.  */
+        continue;       /* Successfully executed one pattern command; keep going.  */
 
         /* We goto here if a matching operation fails. */
 fail:
-        if (!FAIL_STACK_EMPTY()) {	/* A restart point is known.  Restore to that state.  */
+        if (!FAIL_STACK_EMPTY()) {  /* A restart point is known.  Restore to that state.  */
             DEBUG_PRINT1("\nFAIL:\n");
             POP_FAILURE_POINT(d, p,
                               lowest_active_reg, highest_active_reg,
@@ -3828,16 +3836,16 @@ int stop;
             if (d >= string1 && d <= end1)
                 dend = end_match_1;
         } else
-            break;		/* Matching at this starting point really fails.  */
-    }				/* for (;;) */
+            break;      /* Matching at this starting point really fails.  */
+    }               /* for (;;) */
 
     if (best_regs_set)
         goto restore_best_regs;
 
     FREE_VARIABLES();
 
-    return -1;			/* Failure to match.  */
-}				/* re_match_2 */
+    return -1;          /* Failure to match.  */
+}               /* re_match_2 */
 
 /* Subroutine definitions for re_match_2.  */
 
@@ -3864,7 +3872,7 @@ group_match_null_string_p(unsigned char **p, unsigned char *end, register_info_t
          * matching stop_memory.  */
 
         switch ((re_opcode_t) * p1) {
-            /* Could be either a loop or a series of alternatives.  */
+        /* Could be either a loop or a series of alternatives.  */
         case on_failure_jump:
             p1++;
             EXTRACT_NUMBER_AND_INCR(mcnt, p1);
@@ -3927,8 +3935,8 @@ group_match_null_string_p(unsigned char **p, unsigned char *end, register_info_t
                 if (!alt_match_null_string_p(p1, p1 + mcnt, reg_info))
                     return false;
 
-                p1 += mcnt;	/* Get past the n-th alternative.  */
-            }			/* if mcnt > 0 */
+                p1 += mcnt; /* Get past the n-th alternative.  */
+            }           /* if mcnt > 0 */
             break;
 
         case stop_memory:
@@ -3940,10 +3948,10 @@ group_match_null_string_p(unsigned char **p, unsigned char *end, register_info_t
             if (!common_op_match_null_string_p(&p1, end, reg_info))
                 return false;
         }
-    }				/* while p1 < end */
+    }               /* while p1 < end */
 
     return false;
-}				/* group_match_null_string_p */
+}               /* group_match_null_string_p */
 
 /* Similar to group_match_null_string_p, but doesn't deal with alternatives:
  * It expects P to be the first byte of a single alternative and END one
@@ -3960,7 +3968,7 @@ alt_match_null_string_p(unsigned char *p, unsigned char *end, register_info_type
          * to one that can't.  */
 
         switch ((re_opcode_t) * p1) {
-            /* It's a loop.  */
+        /* It's a loop.  */
         case on_failure_jump:
             p1++;
             EXTRACT_NUMBER_AND_INCR(mcnt, p1);
@@ -3971,10 +3979,10 @@ alt_match_null_string_p(unsigned char *p, unsigned char *end, register_info_type
             if (!common_op_match_null_string_p(&p1, end, reg_info))
                 return false;
         }
-    }				/* while p1 < end */
+    }               /* while p1 < end */
 
     return true;
-}				/* alt_match_null_string_p */
+}               /* alt_match_null_string_p */
 
 /* Deals with the ops common to group_match_null_string_p and
  * alt_match_null_string_p.
@@ -4016,7 +4024,7 @@ common_op_match_null_string_p( unsigned char **p, unsigned char *end, register_i
             return false;
         break;
 
-        /* If this is an optimized succeed_n for zero times, make the jump.  */
+    /* If this is an optimized succeed_n for zero times, make the jump.  */
     case jump:
         EXTRACT_NUMBER_AND_INCR(mcnt, p1);
         if (mcnt >= 0)
@@ -4053,7 +4061,7 @@ common_op_match_null_string_p( unsigned char **p, unsigned char *end, register_i
 
     *p = p1;
     return true;
-}				/* common_op_match_null_string_p */
+}               /* common_op_match_null_string_p */
 
 /* Return zero if TRANSLATE[S1] and TRANSLATE[S2] are identical for LEN
  * bytes; nonzero otherwise.  */
@@ -4116,8 +4124,8 @@ int cflags;
 {
     reg_errcode_t ret;
     unsigned syntax
-    = (cflags & REG_EXTENDED) ?
-      RE_SYNTAX_POSIX_EXTENDED : RE_SYNTAX_POSIX_BASIC;
+        = (cflags & REG_EXTENDED) ?
+          RE_SYNTAX_POSIX_EXTENDED : RE_SYNTAX_POSIX_BASIC;
 
     /* regex_compile will allocate the space for the compiled pattern.  */
     preg->buffer = 0;
@@ -4143,7 +4151,7 @@ int cflags;
         preg->translate = NULL;
 
     /* If REG_NEWLINE is set, newlines are treated differently.  */
-    if (cflags & REG_NEWLINE) {	/* REG_NEWLINE implies neither . nor [^...] match newline.  */
+    if (cflags & REG_NEWLINE) { /* REG_NEWLINE implies neither . nor [^...] match newline.  */
         syntax &= ~RE_DOT_NEWLINE;
         syntax |= RE_HAT_LISTS_NOT_NEWLINE;
         /* It also changes the matching behavior.  */
@@ -4257,7 +4265,7 @@ regerror(int errcode, const regex_t *preg, char *errbuf, size_t errbuf_size)
     if (!msg)
         msg = "Success";
 
-    msg_size = strlen(msg) + 1;	/* Includes the null.  */
+    msg_size = strlen(msg) + 1; /* Includes the null.  */
 
     if (errbuf_size != 0) {
         if (msg_size > errbuf_size) {
@@ -4300,3 +4308,4 @@ regex_t *preg;
  * trim-versions-without-asking: nil
  * End:
  */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -26,375 +26,375 @@
 extern "C" {
 #endif
 
-    /* Definitions for data structures and routines for the regular
-     * expression library, version 0.12.
-     *
-     * Copyright (C) 1985, 1989, 1990, 1991, 1992, 1993 Free Software Foundation, Inc.
-     *
-     * This program is free software; you can redistribute it and/or modify
-     * it under the terms of the GNU General Public License as published by
-     * the Free Software Foundation; either version 2, or (at your option)
-     * any later version.
-     *
-     * This program is distributed in the hope that it will be useful,
-     * but WITHOUT ANY WARRANTY; without even the implied warranty of
-     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-     * GNU General Public License for more details.
-     *
-     * You should have received a copy of the GNU General Public License
-     * along with this program; if not, write to the Free Software
-     * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.  */
-
-    /* POSIX says that <sys/types.h> must be included (by the caller) before
-     * <regex.h>.  */
-
-    /* The following bits are used to determine the regexp syntax we
-     * recognize.  The set/not-set meanings are chosen so that Emacs syntax
-     * remains the value 0.  The bits are given in alphabetical order, and
-     * the definitions shifted by one from the previous bit; thus, when we
-     * add or remove a bit, only one other definition need change.  */
-    typedef unsigned reg_syntax_t;
-
-    /* If this bit is not set, then \ inside a bracket expression is literal.
-     * If set, then such a \ quotes the following character.  */
+/* Definitions for data structures and routines for the regular
+ * expression library, version 0.12.
+ *
+ * Copyright (C) 1985, 1989, 1990, 1991, 1992, 1993 Free Software Foundation, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2, or (at your option)
+ * any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.  */
+
+/* POSIX says that <sys/types.h> must be included (by the caller) before
+ * <regex.h>.  */
+
+/* The following bits are used to determine the regexp syntax we
+ * recognize.  The set/not-set meanings are chosen so that Emacs syntax
+ * remains the value 0.  The bits are given in alphabetical order, and
+ * the definitions shifted by one from the previous bit; thus, when we
+ * add or remove a bit, only one other definition need change.  */
+typedef unsigned reg_syntax_t;
+
+/* If this bit is not set, then \ inside a bracket expression is literal.
+ * If set, then such a \ quotes the following character.  */
 #define RE_BACKSLASH_ESCAPE_IN_LISTS (1)
 
-    /* If this bit is not set, then + and ? are operators, and \+ and \? are
-     * literals.
-     * If set, then \+ and \? are operators and + and ? are literals.  */
+/* If this bit is not set, then + and ? are operators, and \+ and \? are
+ * literals.
+ * If set, then \+ and \? are operators and + and ? are literals.  */
 #define RE_BK_PLUS_QM (RE_BACKSLASH_ESCAPE_IN_LISTS << 1)
 
-    /* If this bit is set, then character classes are supported.  They are:
-     * [:alpha:], [:upper:], [:lower:],  [:digit:], [:alnum:], [:xdigit:],
-     * [:space:], [:print:], [:punct:], [:graph:], and [:cntrl:].
-     * If not set, then character classes are not supported.  */
+/* If this bit is set, then character classes are supported.  They are:
+ * [:alpha:], [:upper:], [:lower:],  [:digit:], [:alnum:], [:xdigit:],
+ * [:space:], [:print:], [:punct:], [:graph:], and [:cntrl:].
+ * If not set, then character classes are not supported.  */
 #define RE_CHAR_CLASSES (RE_BK_PLUS_QM << 1)
 
-    /* If this bit is set, then ^ and $ are always anchors (outside bracket
-     * expressions, of course).
-     * If this bit is not set, then it depends:
-     * ^  is an anchor if it is at the beginning of a regular
-     * expression or after an open-group or an alternation operator;
-     * $  is an anchor if it is at the end of a regular expression, or
-     * before a close-group or an alternation operator.
-     *
-     * This bit could be (re)combined with RE_CONTEXT_INDEP_OPS, because
-     * POSIX draft 11.2 says that * etc. in leading positions is undefined.
-     * We already implemented a previous draft which made those constructs
-     * invalid, though, so we haven't changed the code back.  */
+/* If this bit is set, then ^ and $ are always anchors (outside bracket
+ * expressions, of course).
+ * If this bit is not set, then it depends:
+ * ^  is an anchor if it is at the beginning of a regular
+ * expression or after an open-group or an alternation operator;
+ * $  is an anchor if it is at the end of a regular expression, or
+ * before a close-group or an alternation operator.
+ *
+ * This bit could be (re)combined with RE_CONTEXT_INDEP_OPS, because
+ * POSIX draft 11.2 says that * etc. in leading positions is undefined.
+ * We already implemented a previous draft which made those constructs
+ * invalid, though, so we haven't changed the code back.  */
 #define RE_CONTEXT_INDEP_ANCHORS (RE_CHAR_CLASSES << 1)
 
-    /* If this bit is set, then special characters are always special
-     * regardless of where they are in the pattern.
-     * If this bit is not set, then special characters are special only in
-     * some contexts; otherwise they are ordinary.  Specifically,
-     * * + ? and intervals are only special when not after the beginning,
-     * open-group, or alternation operator.  */
+/* If this bit is set, then special characters are always special
+ * regardless of where they are in the pattern.
+ * If this bit is not set, then special characters are special only in
+ * some contexts; otherwise they are ordinary.  Specifically,
+ * * + ? and intervals are only special when not after the beginning,
+ * open-group, or alternation operator.  */
 #define RE_CONTEXT_INDEP_OPS (RE_CONTEXT_INDEP_ANCHORS << 1)
 
-    /* If this bit is set, then *, +, ?, and { cannot be first in an re or
-     * immediately after an alternation or begin-group operator.  */
+/* If this bit is set, then *, +, ?, and { cannot be first in an re or
+ * immediately after an alternation or begin-group operator.  */
 #define RE_CONTEXT_INVALID_OPS (RE_CONTEXT_INDEP_OPS << 1)
 
-    /* If this bit is set, then . matches newline.
-     * If not set, then it doesn't.  */
+/* If this bit is set, then . matches newline.
+ * If not set, then it doesn't.  */
 #define RE_DOT_NEWLINE (RE_CONTEXT_INVALID_OPS << 1)
 
-    /* If this bit is set, then . doesn't match NUL.
-     * If not set, then it does.  */
+/* If this bit is set, then . doesn't match NUL.
+ * If not set, then it does.  */
 #define RE_DOT_NOT_NULL (RE_DOT_NEWLINE << 1)
 
-    /* If this bit is set, nonmatching lists [^...] do not match newline.
-     * If not set, they do.  */
+/* If this bit is set, nonmatching lists [^...] do not match newline.
+ * If not set, they do.  */
 #define RE_HAT_LISTS_NOT_NEWLINE (RE_DOT_NOT_NULL << 1)
 
-    /* If this bit is set, either \{...\} or {...} defines an
-     * interval, depending on RE_NO_BK_BRACES.
-     * If not set, \{, \}, {, and } are literals.  */
+/* If this bit is set, either \{...\} or {...} defines an
+ * interval, depending on RE_NO_BK_BRACES.
+ * If not set, \{, \}, {, and } are literals.  */
 #define RE_INTERVALS (RE_HAT_LISTS_NOT_NEWLINE << 1)
 
-    /* If this bit is set, +, ? and | aren't recognized as operators.
-     * If not set, they are.  */
+/* If this bit is set, +, ? and | aren't recognized as operators.
+ * If not set, they are.  */
 #define RE_LIMITED_OPS (RE_INTERVALS << 1)
 
-    /* If this bit is set, newline is an alternation operator.
-     * If not set, newline is literal.  */
+/* If this bit is set, newline is an alternation operator.
+ * If not set, newline is literal.  */
 #define RE_NEWLINE_ALT (RE_LIMITED_OPS << 1)
 
-    /* If this bit is set, then `{...}' defines an interval, and \{ and \}
-     * are literals.
-     * If not set, then `\{...\}' defines an interval.  */
+/* If this bit is set, then `{...}' defines an interval, and \{ and \}
+ * are literals.
+ * If not set, then `\{...\}' defines an interval.  */
 #define RE_NO_BK_BRACES (RE_NEWLINE_ALT << 1)
 
-    /* If this bit is set, (...) defines a group, and \( and \) are literals.
-     * If not set, \(...\) defines a group, and ( and ) are literals.  */
+/* If this bit is set, (...) defines a group, and \( and \) are literals.
+ * If not set, \(...\) defines a group, and ( and ) are literals.  */
 #define RE_NO_BK_PARENS (RE_NO_BK_BRACES << 1)
 
-    /* If this bit is set, then \<digit> matches <digit>.
-     * If not set, then \<digit> is a back-reference.  */
+/* If this bit is set, then \<digit> matches <digit>.
+ * If not set, then \<digit> is a back-reference.  */
 #define RE_NO_BK_REFS (RE_NO_BK_PARENS << 1)
 
-    /* If this bit is set, then | is an alternation operator, and \| is literal.
-     * If not set, then \| is an alternation operator, and | is literal.  */
+/* If this bit is set, then | is an alternation operator, and \| is literal.
+ * If not set, then \| is an alternation operator, and | is literal.  */
 #define RE_NO_BK_VBAR (RE_NO_BK_REFS << 1)
 
-    /* If this bit is set, then an ending range point collating higher
-     * than the starting range point, as in [z-a], is invalid.
-     * If not set, then when ending range point collates higher than the
-     * starting range point, the range is ignored.  */
+/* If this bit is set, then an ending range point collating higher
+ * than the starting range point, as in [z-a], is invalid.
+ * If not set, then when ending range point collates higher than the
+ * starting range point, the range is ignored.  */
 #define RE_NO_EMPTY_RANGES (RE_NO_BK_VBAR << 1)
 
-    /* If this bit is set, then an unmatched ) is ordinary.
-     * If not set, then an unmatched ) is invalid.  */
+/* If this bit is set, then an unmatched ) is ordinary.
+ * If not set, then an unmatched ) is invalid.  */
 #define RE_UNMATCHED_RIGHT_PAREN_ORD (RE_NO_EMPTY_RANGES << 1)
 
-    /* Define combinations of the above bits for the standard possibilities.
-     * (The [[[ comments delimit what gets put into the Texinfo file, so
-     * don't delete them!)  */
-    /* [[[begin syntaxes]]] */
+/* Define combinations of the above bits for the standard possibilities.
+ * (The [[[ comments delimit what gets put into the Texinfo file, so
+ * don't delete them!)  */
+/* [[[begin syntaxes]]] */
 #define RE_SYNTAX_EMACS 0
 
-#define RE_SYNTAX_AWK							\
-  (RE_BACKSLASH_ESCAPE_IN_LISTS | RE_DOT_NOT_NULL			\
-   | RE_NO_BK_PARENS            | RE_NO_BK_REFS				\
-   | RE_NO_BK_VBAR               | RE_NO_EMPTY_RANGES			\
+#define RE_SYNTAX_AWK                           \
+  (RE_BACKSLASH_ESCAPE_IN_LISTS | RE_DOT_NOT_NULL           \
+   | RE_NO_BK_PARENS            | RE_NO_BK_REFS             \
+   | RE_NO_BK_VBAR               | RE_NO_EMPTY_RANGES           \
    | RE_UNMATCHED_RIGHT_PAREN_ORD)
 
-#define RE_SYNTAX_POSIX_AWK 						\
+#define RE_SYNTAX_POSIX_AWK                         \
   (RE_SYNTAX_POSIX_EXTENDED | RE_BACKSLASH_ESCAPE_IN_LISTS)
 
-#define RE_SYNTAX_GREP							\
-  (RE_BK_PLUS_QM              | RE_CHAR_CLASSES				\
-   | RE_HAT_LISTS_NOT_NEWLINE | RE_INTERVALS				\
+#define RE_SYNTAX_GREP                          \
+  (RE_BK_PLUS_QM              | RE_CHAR_CLASSES             \
+   | RE_HAT_LISTS_NOT_NEWLINE | RE_INTERVALS                \
    | RE_NEWLINE_ALT)
 
-#define RE_SYNTAX_EGREP							\
-  (RE_CHAR_CLASSES        | RE_CONTEXT_INDEP_ANCHORS			\
-   | RE_CONTEXT_INDEP_OPS | RE_HAT_LISTS_NOT_NEWLINE			\
-   | RE_NEWLINE_ALT       | RE_NO_BK_PARENS				\
+#define RE_SYNTAX_EGREP                         \
+  (RE_CHAR_CLASSES        | RE_CONTEXT_INDEP_ANCHORS            \
+   | RE_CONTEXT_INDEP_OPS | RE_HAT_LISTS_NOT_NEWLINE            \
+   | RE_NEWLINE_ALT       | RE_NO_BK_PARENS             \
    | RE_NO_BK_VBAR)
 
-#define RE_SYNTAX_POSIX_EGREP						\
+#define RE_SYNTAX_POSIX_EGREP                       \
   (RE_SYNTAX_EGREP | RE_INTERVALS | RE_NO_BK_BRACES)
 
-    /* P1003.2/D11.2, section 4.20.7.1, lines 5078ff.  */
+/* P1003.2/D11.2, section 4.20.7.1, lines 5078ff.  */
 #define RE_SYNTAX_ED RE_SYNTAX_POSIX_BASIC
 
 #define RE_SYNTAX_SED RE_SYNTAX_POSIX_BASIC
 
-    /* Syntax bits common to both basic and extended POSIX regex syntax.  */
-#define _RE_SYNTAX_POSIX_COMMON						\
-  (RE_CHAR_CLASSES | RE_DOT_NEWLINE      | RE_DOT_NOT_NULL		\
+/* Syntax bits common to both basic and extended POSIX regex syntax.  */
+#define _RE_SYNTAX_POSIX_COMMON                     \
+  (RE_CHAR_CLASSES | RE_DOT_NEWLINE      | RE_DOT_NOT_NULL      \
    | RE_INTERVALS  | RE_NO_EMPTY_RANGES)
 
-#define RE_SYNTAX_POSIX_BASIC						\
+#define RE_SYNTAX_POSIX_BASIC                       \
   (_RE_SYNTAX_POSIX_COMMON | RE_BK_PLUS_QM)
 
-    /* Differs from ..._POSIX_BASIC only in that RE_BK_PLUS_QM becomes
-     * RE_LIMITED_OPS, i.e., \? \+ \| are not recognized.  Actually, this
-     * isn't minimal, since other operators, such as \`, aren't disabled.  */
-#define RE_SYNTAX_POSIX_MINIMAL_BASIC					\
+/* Differs from ..._POSIX_BASIC only in that RE_BK_PLUS_QM becomes
+ * RE_LIMITED_OPS, i.e., \? \+ \| are not recognized.  Actually, this
+ * isn't minimal, since other operators, such as \`, aren't disabled.  */
+#define RE_SYNTAX_POSIX_MINIMAL_BASIC                   \
   (_RE_SYNTAX_POSIX_COMMON | RE_LIMITED_OPS)
 
-#define RE_SYNTAX_POSIX_EXTENDED					\
-  (_RE_SYNTAX_POSIX_COMMON | RE_CONTEXT_INDEP_ANCHORS			\
-   | RE_CONTEXT_INDEP_OPS  | RE_NO_BK_BRACES				\
-   | RE_NO_BK_PARENS       | RE_NO_BK_VBAR				\
+#define RE_SYNTAX_POSIX_EXTENDED                    \
+  (_RE_SYNTAX_POSIX_COMMON | RE_CONTEXT_INDEP_ANCHORS           \
+   | RE_CONTEXT_INDEP_OPS  | RE_NO_BK_BRACES                \
+   | RE_NO_BK_PARENS       | RE_NO_BK_VBAR              \
    | RE_UNMATCHED_RIGHT_PAREN_ORD)
 
-    /* Differs from ..._POSIX_EXTENDED in that RE_CONTEXT_INVALID_OPS
-     * replaces RE_CONTEXT_INDEP_OPS and RE_NO_BK_REFS is added.  */
-#define RE_SYNTAX_POSIX_MINIMAL_EXTENDED				\
-  (_RE_SYNTAX_POSIX_COMMON  | RE_CONTEXT_INDEP_ANCHORS			\
-   | RE_CONTEXT_INVALID_OPS | RE_NO_BK_BRACES				\
-   | RE_NO_BK_PARENS        | RE_NO_BK_REFS				\
-   | RE_NO_BK_VBAR	    | RE_UNMATCHED_RIGHT_PAREN_ORD)
-    /* [[[end syntaxes]]] */
-    
-    /* Maximum number of duplicates an interval can allow.  Some systems
-     * (erroneously) define this in other header files, but we want our
-     * value, so remove any previous define.  */
+/* Differs from ..._POSIX_EXTENDED in that RE_CONTEXT_INVALID_OPS
+ * replaces RE_CONTEXT_INDEP_OPS and RE_NO_BK_REFS is added.  */
+#define RE_SYNTAX_POSIX_MINIMAL_EXTENDED                \
+  (_RE_SYNTAX_POSIX_COMMON  | RE_CONTEXT_INDEP_ANCHORS          \
+   | RE_CONTEXT_INVALID_OPS | RE_NO_BK_BRACES               \
+   | RE_NO_BK_PARENS        | RE_NO_BK_REFS             \
+   | RE_NO_BK_VBAR      | RE_UNMATCHED_RIGHT_PAREN_ORD)
+/* [[[end syntaxes]]] */
+
+/* Maximum number of duplicates an interval can allow.  Some systems
+ * (erroneously) define this in other header files, but we want our
+ * value, so remove any previous define.  */
 #ifdef RE_DUP_MAX
 #undef RE_DUP_MAX
 #endif
 #define RE_DUP_MAX ((1 << 15) - 1)
 
-    /* POSIX `cflags' bits (i.e., information for `regcomp').  */
+/* POSIX `cflags' bits (i.e., information for `regcomp').  */
 
-    /* If this bit is set, then use extended regular expression syntax.
-     * If not set, then use basic regular expression syntax.  */
+/* If this bit is set, then use extended regular expression syntax.
+ * If not set, then use basic regular expression syntax.  */
 #define REG_EXTENDED 1
 
-    /* If this bit is set, then ignore case when matching.
-     * If not set, then case is significant.  */
+/* If this bit is set, then ignore case when matching.
+ * If not set, then case is significant.  */
 #define REG_ICASE (REG_EXTENDED << 1)
 
-    /* If this bit is set, then anchors do not match at newline
-     * characters in the string.
-     * If not set, then anchors do match at newlines.  */
+/* If this bit is set, then anchors do not match at newline
+ * characters in the string.
+ * If not set, then anchors do match at newlines.  */
 #define REG_NEWLINE (REG_ICASE << 1)
 
-    /* If this bit is set, then report only success or fail in regexec.
-     * If not set, then returns differ between not matching and errors.  */
+/* If this bit is set, then report only success or fail in regexec.
+ * If not set, then returns differ between not matching and errors.  */
 #define REG_NOSUB (REG_NEWLINE << 1)
 
-    /* POSIX `eflags' bits (i.e., information for regexec).  */
+/* POSIX `eflags' bits (i.e., information for regexec).  */
 
-    /* If this bit is set, then the beginning-of-line operator doesn't match
-     * the beginning of the string (presumably because it's not the
-     * beginning of a line).
-     * If not set, then the beginning-of-line operator does match the
-     * beginning of the string.  */
+/* If this bit is set, then the beginning-of-line operator doesn't match
+ * the beginning of the string (presumably because it's not the
+ * beginning of a line).
+ * If not set, then the beginning-of-line operator does match the
+ * beginning of the string.  */
 #define REG_NOTBOL 1
 
-    /* Like REG_NOTBOL, except for the end-of-line.  */
+/* Like REG_NOTBOL, except for the end-of-line.  */
 #define REG_NOTEOL (1 << 1)
 
-    /* If any error codes are removed, changed, or added, update the
-     * `re_error_msg' table in regex.c.  */
-    typedef enum {
-        REG_NOERROR = 0,		/* Success.  */
-        REG_NOMATCH,		/* Didn't find a match (for regexec).  */
-
-        /* POSIX regcomp return error codes.  (In the order listed in the
-         * standard.)  */
-        REG_BADPAT,			/* Invalid pattern.  */
-        REG_ECOLLATE,		/* Not implemented.  */
-        REG_ECTYPE,			/* Invalid character class name.  */
-        REG_EESCAPE,		/* Trailing backslash.  */
-        REG_ESUBREG,		/* Invalid back reference.  */
-        REG_EBRACK,			/* Unmatched left bracket.  */
-        REG_EPAREN,			/* Parenthesis imbalance.  */
-        REG_EBRACE,			/* Unmatched \{.  */
-        REG_BADBR,			/* Invalid contents of \{\}.  */
-        REG_ERANGE,			/* Invalid range end.  */
-        REG_ESPACE,			/* Ran out of memory.  */
-        REG_BADRPT,			/* No preceding re for repetition op.  */
-
-        /* Error codes we've added.  */
-        REG_EEND,			/* Premature end.  */
-        REG_ESIZE,			/* Compiled pattern bigger than 2^16 bytes.  */
-        REG_ERPAREN			/* Unmatched ) or \); not returned from regcomp.  */
-    } reg_errcode_t;
-    
-    /* This data structure represents a compiled pattern.  Before calling
-     * the pattern compiler, the fields `buffer', `allocated', `fastmap',
-     * `translate', and `no_sub' can be set.  After the pattern has been
-     * compiled, the `re_nsub' field is available.  All other fields are
-     * private to the regex routines.  */
-
-    struct re_pattern_buffer {
-        /* [[[begin pattern_buffer]]] */
-        /* Space that holds the compiled pattern.  It is declared as
-         * `unsigned char *' because its elements are
-         * sometimes used as array indexes.  */
-        unsigned char *buffer;
-
-        /* Number of bytes to which `buffer' points.  */
-        unsigned long allocated;
-
-        /* Number of bytes actually used in `buffer'.  */
-        unsigned long used;
-
-        /* Syntax setting with which the pattern was compiled.  */
-        reg_syntax_t syntax;
-
-        /* Pointer to a fastmap, if any, otherwise zero.  re_search uses
-         * the fastmap, if there is one, to skip over impossible
-         * starting points for matches.  */
-        char *fastmap;
-
-        /* Either a translate table to apply to all characters before
-         * comparing them, or zero for no translation.  The translation
-         * is applied to a pattern when it is compiled and to a string
-         * when it is matched.  */
-        char *translate;
-
-        /* Number of subexpressions found by the compiler.  */
-        size_t re_nsub;
-
-        /* Zero if this pattern cannot match the empty string, one else.
-         * Well, in truth it's used only in `re_search_2', to see
-         * whether or not we should use the fastmap, so we don't set
-         * this absolutely perfectly; see `re_compile_fastmap' (the
-         * `duplicate' case).  */
-        unsigned can_be_null:1;
-
-        /* If REGS_UNALLOCATED, allocate space in the `regs' structure
-         * for `max (RE_NREGS, re_nsub + 1)' groups.
-         * If REGS_REALLOCATE, reallocate space if necessary.
-         * If REGS_FIXED, use what's there.  */
+/* If any error codes are removed, changed, or added, update the
+ * `re_error_msg' table in regex.c.  */
+typedef enum {
+    REG_NOERROR = 0,        /* Success.  */
+    REG_NOMATCH,        /* Didn't find a match (for regexec).  */
+
+    /* POSIX regcomp return error codes.  (In the order listed in the
+     * standard.)  */
+    REG_BADPAT,         /* Invalid pattern.  */
+    REG_ECOLLATE,       /* Not implemented.  */
+    REG_ECTYPE,         /* Invalid character class name.  */
+    REG_EESCAPE,        /* Trailing backslash.  */
+    REG_ESUBREG,        /* Invalid back reference.  */
+    REG_EBRACK,         /* Unmatched left bracket.  */
+    REG_EPAREN,         /* Parenthesis imbalance.  */
+    REG_EBRACE,         /* Unmatched \{.  */
+    REG_BADBR,          /* Invalid contents of \{\}.  */
+    REG_ERANGE,         /* Invalid range end.  */
+    REG_ESPACE,         /* Ran out of memory.  */
+    REG_BADRPT,         /* No preceding re for repetition op.  */
+
+    /* Error codes we've added.  */
+    REG_EEND,           /* Premature end.  */
+    REG_ESIZE,          /* Compiled pattern bigger than 2^16 bytes.  */
+    REG_ERPAREN         /* Unmatched ) or \); not returned from regcomp.  */
+} reg_errcode_t;
+
+/* This data structure represents a compiled pattern.  Before calling
+ * the pattern compiler, the fields `buffer', `allocated', `fastmap',
+ * `translate', and `no_sub' can be set.  After the pattern has been
+ * compiled, the `re_nsub' field is available.  All other fields are
+ * private to the regex routines.  */
+
+struct re_pattern_buffer {
+    /* [[[begin pattern_buffer]]] */
+    /* Space that holds the compiled pattern.  It is declared as
+     * `unsigned char *' because its elements are
+     * sometimes used as array indexes.  */
+    unsigned char *buffer;
+
+    /* Number of bytes to which `buffer' points.  */
+    unsigned long allocated;
+
+    /* Number of bytes actually used in `buffer'.  */
+    unsigned long used;
+
+    /* Syntax setting with which the pattern was compiled.  */
+    reg_syntax_t syntax;
+
+    /* Pointer to a fastmap, if any, otherwise zero.  re_search uses
+     * the fastmap, if there is one, to skip over impossible
+     * starting points for matches.  */
+    char *fastmap;
+
+    /* Either a translate table to apply to all characters before
+     * comparing them, or zero for no translation.  The translation
+     * is applied to a pattern when it is compiled and to a string
+     * when it is matched.  */
+    char *translate;
+
+    /* Number of subexpressions found by the compiler.  */
+    size_t re_nsub;
+
+    /* Zero if this pattern cannot match the empty string, one else.
+     * Well, in truth it's used only in `re_search_2', to see
+     * whether or not we should use the fastmap, so we don't set
+     * this absolutely perfectly; see `re_compile_fastmap' (the
+     * `duplicate' case).  */
+    unsigned can_be_null:1;
+
+    /* If REGS_UNALLOCATED, allocate space in the `regs' structure
+     * for `max (RE_NREGS, re_nsub + 1)' groups.
+     * If REGS_REALLOCATE, reallocate space if necessary.
+     * If REGS_FIXED, use what's there.  */
 #define REGS_UNALLOCATED 0
 #define REGS_REALLOCATE 1
 #define REGS_FIXED 2
-        unsigned regs_allocated:2;
+    unsigned regs_allocated:2;
 
-        /* Set to zero when `regex_compile' compiles a pattern; set to one
-         * by `re_compile_fastmap' if it updates the fastmap.  */
-        unsigned fastmap_accurate:1;
+    /* Set to zero when `regex_compile' compiles a pattern; set to one
+     * by `re_compile_fastmap' if it updates the fastmap.  */
+    unsigned fastmap_accurate:1;
 
-        /* If set, `re_match_2' does not return information about
-         * subexpressions.  */
-        unsigned no_sub:1;
+    /* If set, `re_match_2' does not return information about
+     * subexpressions.  */
+    unsigned no_sub:1;
 
-        /* If set, a beginning-of-line anchor doesn't match at the
-         * beginning of the string.  */
-        unsigned not_bol:1;
+    /* If set, a beginning-of-line anchor doesn't match at the
+     * beginning of the string.  */
+    unsigned not_bol:1;
 
-        /* Similarly for an end-of-line anchor.  */
-        unsigned not_eol:1;
+    /* Similarly for an end-of-line anchor.  */
+    unsigned not_eol:1;
 
-        /* If true, an anchor at a newline matches.  */
-        unsigned newline_anchor:1;
+    /* If true, an anchor at a newline matches.  */
+    unsigned newline_anchor:1;
 
-        /* [[[end pattern_buffer]]] */
-    };
+    /* [[[end pattern_buffer]]] */
+};
 
-    typedef struct re_pattern_buffer regex_t;
+typedef struct re_pattern_buffer regex_t;
 
-    /* search.c (search_buffer) in Emacs needs this one opcode value.  It is
-     * defined both in `regex.c' and here.  */
+/* search.c (search_buffer) in Emacs needs this one opcode value.  It is
+ * defined both in `regex.c' and here.  */
 #define RE_EXACTN_VALUE 1
-    
-    /* Type for byte offsets within the string.  POSIX mandates this.  */
-    typedef int regoff_t;
-
-    /* This is the structure we store register match data in.  See
-     * regex.texinfo for a full description of what registers match.  */
-    struct re_registers {
-        unsigned num_regs;
-        regoff_t *start;
-        regoff_t *end;
-    };
-
-    /* If `regs_allocated' is REGS_UNALLOCATED in the pattern buffer,
-     * `re_match_2' returns information about at least this many registers
-     * the first time a `regs' structure is passed.  */
+
+/* Type for byte offsets within the string.  POSIX mandates this.  */
+typedef int regoff_t;
+
+/* This is the structure we store register match data in.  See
+ * regex.texinfo for a full description of what registers match.  */
+struct re_registers {
+    unsigned num_regs;
+    regoff_t *start;
+    regoff_t *end;
+};
+
+/* If `regs_allocated' is REGS_UNALLOCATED in the pattern buffer,
+ * `re_match_2' returns information about at least this many registers
+ * the first time a `regs' structure is passed.  */
 #ifndef RE_NREGS
 #define RE_NREGS 30
 #endif
 
-    /* POSIX specification for registers.  Aside from the different names than
-     * `re_registers', POSIX uses an array of structures, instead of a
-     * structure of arrays.  */
-    typedef struct {
-        regoff_t rm_so;		/* Byte offset from string's start to substring's start.  */
-        regoff_t rm_eo;		/* Byte offset from string's start to substring's end.  */
-    } regmatch_t;
-    
-    /* Declarations for routines.  */
-
-    /* To avoid duplicating every routine declaration -- once with a
-     * prototype (if we are ANSI), and once without (if we aren't) -- we
-     * use the following macro to declare argument types.  This
-     * unfortunately clutters up the declarations a bit, but I think it's
-     * worth it.  */
-
-    /* POSIX compatibility.  */
-    extern int regcomp(regex_t * preg, const char *pattern, int cflags);
-    extern int regexec(const regex_t * preg, const char *string, size_t nmatch, regmatch_t pmatch[], int eflags);
-    extern size_t regerror(int errcode, const regex_t * preg, char *errbuf, size_t errbuf_size);
-    extern void regfree(regex_t * preg);
+/* POSIX specification for registers.  Aside from the different names than
+ * `re_registers', POSIX uses an array of structures, instead of a
+ * structure of arrays.  */
+typedef struct {
+    regoff_t rm_so;     /* Byte offset from string's start to substring's start.  */
+    regoff_t rm_eo;     /* Byte offset from string's start to substring's end.  */
+} regmatch_t;
+
+/* Declarations for routines.  */
+
+/* To avoid duplicating every routine declaration -- once with a
+ * prototype (if we are ANSI), and once without (if we aren't) -- we
+ * use the following macro to declare argument types.  This
+ * unfortunately clutters up the declarations a bit, but I think it's
+ * worth it.  */
+
+/* POSIX compatibility.  */
+extern int regcomp(regex_t * preg, const char *pattern, int cflags);
+extern int regexec(const regex_t * preg, const char *string, size_t nmatch, regmatch_t pmatch[], int eflags);
+extern size_t regerror(int errcode, const regex_t * preg, char *errbuf, size_t errbuf_size);
+extern void regfree(regex_t * preg);
 
 #ifdef __cplusplus
 }
@@ -410,3 +410,4 @@ extern "C" {
  * trim-versions-without-asking: nil
  * End:
  */
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -10,6 +10,7 @@
 
 include $(top_srcdir)/src/Common.am
 
+AUTOMAKE_OPTIONS = subdir-objects
 
 # Ideally this would be 100% inline functions and macro wrappers.
 
@@ -31,11 +32,15 @@ libcompat_squid_la_SOURCES = \
 	eui64_aton.h \
 	eui64_aton.c \
 	fdsetsize.h \
+	getaddrinfo.cc \
 	getaddrinfo.h \
+	getnameinfo.cc \
 	getnameinfo.h \
 	GnuRegex.c \
 	GnuRegex.h \
+	inet_ntop.cc \
 	inet_ntop.h \
+	inet_pton.cc \
 	inet_pton.h \
 	initgroups.h \
 	memrchr.cc \
@@ -91,8 +96,7 @@ TESTS += testPreCompiler
 
 testPreCompiler_SOURCES= \
 	testPreCompiler.h \
-	testPreCompiler.cc \
-	$(top_srcdir)/src/tests/testMain.cc
+	testPreCompiler.cc
 testPreCompiler_LDADD= $(SQUID_CPPUNIT_LA) $(SQUID_CPPUNIT_LIBS)
 testPreCompiler_LDFLAGS=
 
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -13,3 +13,4 @@ void xassert(const char *expr, const char *file, int line)
     fprintf(stderr, "assertion failed: %s:%d: \"%s\"\n", file, line, expr);
     abort();
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -25,3 +25,4 @@ extern void
 xassert(const char *, const char *, int);
 
 #endif /* SQUID_ASSERT_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -140,3 +140,4 @@ struct sockaddr_un {
 #endif
 
 #endif /* SQUID_COMPAT_CMSG_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -10,3 +10,4 @@
 #include "compat.h"
 
 void (*failure_notify) (const char *) = NULL;
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -42,6 +42,17 @@
 #endif
 #endif
 
+/* Solaris 10 has a broken definition for minor_t in IPFilter compat.
+ * We must pre-define before doing anything with OS headers so the OS
+ * do not. Then un-define it before using the IPFilter *_compat.h headers.
+ */
+#if IPF_TRANSPARENT && USE_SOLARIS_IPFILTER_MINOR_T_HACK
+/* But we only need do this nasty thing for src/ip/Intercept.cc */
+#if BUILDING_SQUID_IP_INTERCEPT_CC
+#define minor_t solaris_minor_t_fubar
+#endif
+#endif
+
 /*****************************************************/
 /* FDSETSIZE is messy and needs to be done before    */
 /* sys/types.h are defined.                          */
@@ -87,6 +98,10 @@
 
 #include "compat/assert.h"
 #include "compat/compat_shared.h"
+#include "compat/getaddrinfo.h"
+#include "compat/getnameinfo.h"
+#include "compat/inet_ntop.h"
+#include "compat/inet_pton.h"
 #include "compat/stdvarargs.h"
 
 /* cstdio has a bunch of problems with 64-bit definitions */
@@ -105,9 +120,6 @@
 /* Valgrind API macros changed between two versions squid supports */
 #include "compat/valgrind.h"
 
-/* Endian functions are usualy handled by the OS but not always. */
-#include "squid_endian.h"
-
 /**
  * A Regular Expression library is bundled with Squid.
  * Default is to use a system provided one, but the bundle
@@ -119,3 +131,4 @@
 #include "compat/cppunit.h"
 
 #endif /* _SQUID_COMPAT_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -273,3 +273,4 @@ const char * squid_strnstr(const char *s, const char *find, size_t slen);
 #endif
 
 #endif /* _SQUID_COMPAT_SHARED_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -39,3 +39,4 @@
 #endif /* HAVE_UNIQUE_PTR */
 #endif /* HAVE_CPPUNIT_EXTENSIONS_HELPERMACROS_H */
 #endif /* SQUID_COMPAT_CPPUNIT_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -69,3 +69,4 @@ inline int sched_getaffinity(int, size_t, cpu_set_t *) { return ENOTSUP; }
 #endif /* HAVE_CPU_AFFINITY */
 
 #endif /* SQUID_COMPAT_CPU_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -27,3 +27,4 @@ debug(const char *format,...)
 }
 
 #endif /* __GNUC__ */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -38,3 +38,4 @@ void debug(const char *format,...);
 #endif
 
 #endif /* COMPAT_DEBUG_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -14,21 +14,21 @@
 
 #if !HAVE_DRAND48
 
-#define N	16
-#define MASK	((unsigned)(1 << (N - 1)) + (1 << (N - 1)) - 1)
-#define LOW(x)	((unsigned)(x) & MASK)
-#define HIGH(x)	LOW((x) >> N)
-#define MUL(x, y, z)	{ long l = (long)(x) * (long)(y); \
-		(z)[0] = LOW(l); (z)[1] = HIGH(l); }
-#define CARRY(x, y)	((long)(x) + (long)(y) > MASK)
-#define ADDEQU(x, y, z)	(z = CARRY(x, (y)), x = LOW(x + (y)))
-#define X0	0x330E
-#define X1	0xABCD
-#define X2	0x1234
-#define A0	0xE66D
-#define A1	0xDEEC
-#define A2	0x5
-#define C	0xB
+#define N   16
+#define MASK    ((unsigned)(1 << (N - 1)) + (1 << (N - 1)) - 1)
+#define LOW(x)  ((unsigned)(x) & MASK)
+#define HIGH(x) LOW((x) >> N)
+#define MUL(x, y, z)    { long l = (long)(x) * (long)(y); \
+        (z)[0] = LOW(l); (z)[1] = HIGH(l); }
+#define CARRY(x, y) ((long)(x) + (long)(y) > MASK)
+#define ADDEQU(x, y, z) (z = CARRY(x, (y)), x = LOW(x + (y)))
+#define X0  0x330E
+#define X1  0xABCD
+#define X2  0x1234
+#define A0  0xE66D
+#define A1  0xDEEC
+#define A2  0x5
+#define C   0xB
 
 static void next(void);
 static unsigned x[3] = {X0, X1, X2}, a[3] = {A0, A1, A2}, c = C;
@@ -61,3 +61,4 @@ next(void)
 }
 
 #endif /* HAVE_DRAND48 */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -15,3 +15,4 @@ SQUIDCEXTERN double drand48(void);
 #endif
 
 #endif
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -144,3 +144,4 @@ eui64_aton(const char *a, struct eui64 *e)
 }
 
 #endif /* !SQUID_EUI64_ATON */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -59,28 +59,29 @@ extern "C" {
 
 #define SQUID_EUI64_ATON 1
 
-    /**
-     * Size of the ASCII representation of an EUI-64.
-     */
+/**
+ * Size of the ASCII representation of an EUI-64.
+ */
 #define EUI64_SIZ       24
 
-    /**
-     * The number of bytes in an EUI-64.
-     */
+/**
+ * The number of bytes in an EUI-64.
+ */
 #define EUI64_LEN       8
 
-    /**
-     * Structure of an IEEE EUI-64.
-     */
-    struct eui64 {
-        uint8_t octet[EUI64_LEN];
-    };
+/**
+ * Structure of an IEEE EUI-64.
+ */
+struct eui64 {
+    uint8_t octet[EUI64_LEN];
+};
 
-    int eui64_aton(const char *a, struct eui64 *e);
+int eui64_aton(const char *a, struct eui64 *e);
 #if defined(__cplusplus)
 }
 #endif
 
 #endif /* !_SYS_EUI64_H */
 #endif /* HAVE_SYS_EUI64_H */
 #endif /* SQUID_COMPAT_EUI64_ATON_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -18,8 +18,8 @@
 /* FD_SETSIZE must be redefined before including sys/types.h */
 #if 0
 /* AYJ: would dearly like to use this to enforce include order
-	but at present some helpers don't follow the squid include methodology.
-	that will need fixing later.
+    but at present some helpers don't follow the squid include methodology.
+    that will need fixing later.
 */
 #ifdef _SYS_TYPES_H
 #error squid_fdsetsize.h for FDSETSIZE must be included before sys/types.h
@@ -98,3 +98,4 @@
 #endif
 
 #endif /* SQUID_FDSETSIZE_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -13,13 +13,15 @@
  * Update/Maintenance History:
  *
  *    15-Aug-2007 : Copied from fetchmail 6.3.8
- *			- added protection around libray headers
+ *          - added protection around libray headers
  *
  *    16-Aug-2007 : Altered configure checks
  *                  Un-hacked slightly to use system gethostbyname()
  *
  *    06-Oct-2007 : Various fixes to allow the build on MinGW
  *
+ *    13-Jan-2015 : Various fixed for C++ and MinGW native build
+ *
  *  Original License and code follows.
  */
 #include "squid.h"
@@ -49,15 +51,12 @@
 /* An emulation of the RFC 2553 / Posix getaddrinfo resolver interface.
  */
 
-#if !HAVE_GETADDRINFO
+#if !HAVE_DECL_GETADDRINFO
 
 /* Need to turn off Posix features in glibc to build this */
 #undef _POSIX_C_SOURCE
 #undef _XOPEN_SOURCE
 
-#include "compat/getaddrinfo.h"
-#include "compat/inet_pton.h"
-
 #if HAVE_STRING_H
 #include <string.h>
 #endif
@@ -84,11 +83,11 @@ static struct addrinfo *
 dup_addrinfo (struct addrinfo *info, void *addr, size_t addrlen) {
     struct addrinfo *ret;
 
-    ret = malloc (sizeof (struct addrinfo));
+    ret = (struct addrinfo *)malloc(sizeof (struct addrinfo));
     if (ret == NULL)
         return NULL;
     memcpy (ret, info, sizeof (struct addrinfo));
-    ret->ai_addr = malloc (addrlen);
+    ret->ai_addr = (struct sockaddr*)malloc(addrlen);
     if (ret->ai_addr == NULL) {
         free (ret);
         return NULL;
@@ -179,7 +178,7 @@ xgetaddrinfo (const char *nodename, const char *servname,
 
         sin.sin_family = result.ai_family;
         sin.sin_port = htons (port);
-        if (inet_pton(result.ai_family, nodename, &sin.sin_addr))
+        if (inet_pton(result.ai_family, nodename, &sin.sin_addr) != 1)
             return EAI_NONAME;
         sin.sin_addr.s_addr = inet_addr (nodename);
         /* Duplicate result and addr and return */
@@ -280,7 +279,7 @@ xgetaddrinfo (const char *nodename, const char *servname,
     }
 
     if (hints->ai_flags & AI_CANONNAME) {
-        sai->ai_canonname = malloc (strlen (hp->h_name) + 1);
+        sai->ai_canonname = (char *)malloc(strlen(hp->h_name) + 1);
         if (sai->ai_canonname == NULL) {
             xfreeaddrinfo (sai);
             return EAI_MEMORY;
@@ -313,23 +312,24 @@ xgai_strerror (int ecode)
 {
     static const char *eai_descr[] = {
         "no error",
-        "address family for nodename not supported",	/* EAI_ADDRFAMILY */
-        "temporary failure in name resolution",		/* EAI_AGAIN */
-        "invalid value for ai_flags",	 		/* EAI_BADFLAGS */
-        "non-recoverable failure in name resolution",	/* EAI_FAIL */
-        "ai_family not supported",			/* EAI_FAMILY */
-        "memory allocation failure",			/* EAI_MEMORY */
-        "no address associated with nodename",		/* EAI_NODATA */
-        "nodename nor servname provided, or not known",	/* EAI_NONAME */
-        "servname not supported for ai_socktype",		/* EAI_SERVICE */
-        "ai_socktype not supported",			/* EAI_SOCKTYPE */
-        "system error returned in errno",			/* EAI_SYSTEM */
-        "argument buffer overflow",			/* EAI_OVERFLOW */
+        "address family for nodename not supported",    /* EAI_ADDRFAMILY */
+        "temporary failure in name resolution",     /* EAI_AGAIN */
+        "invalid value for ai_flags",           /* EAI_BADFLAGS */
+        "non-recoverable failure in name resolution",   /* EAI_FAIL */
+        "ai_family not supported",          /* EAI_FAMILY */
+        "memory allocation failure",            /* EAI_MEMORY */
+        "no address associated with nodename",      /* EAI_NODATA */
+        "nodename nor servname provided, or not known", /* EAI_NONAME */
+        "servname not supported for ai_socktype",       /* EAI_SERVICE */
+        "ai_socktype not supported",            /* EAI_SOCKTYPE */
+        "system error returned in errno",           /* EAI_SYSTEM */
+        "argument buffer overflow",         /* EAI_OVERFLOW */
     };
 
     if (ecode < 0 || ecode > (int) (sizeof eai_descr/ sizeof eai_descr[0]))
         return "unknown error";
     return eai_descr[ecode];
 }
 
-#endif /* HAVE_GETADDRINFO */
+#endif /* HAVE_DECL_GETADDRINFO */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -16,7 +16,7 @@
  * Update/Maintenance History:
  *
  *    15-Aug-2007 : Copied from fetchmail 6.3.8
- *			- added protection around libray headers
+ *          - added protection around libray headers
  *
  *    16-Aug-2007 : Altered configure checks
  *                  Un-hacked slightly to use system gethostbyname()
@@ -49,21 +49,21 @@
 /* Structure and prototypes taken from RFC 2553 */
 
 /* These functions are provided by the OS */
-#if !HAVE_GETADDRINFO
+#if !HAVE_DECL_GETADDRINFO
 
 /* SG 23/09/2007:
 On Windows the following definitions are already available, may be that
 this could be needed on some other platform */
 #if 0
 struct addrinfo {
-    int ai_flags;  	  	/* AI_PASSIVE, AI_CANONNAME, AI_NUMERICHOST */
-    int ai_family; 	  	/* PF_xxx */
-    int ai_socktype;	 	/* SOCK_xxx */
-    int ai_protocol;	 	/* 0 or IPPROTO_xxx for IPv4 and IPv6 */
-    socklen_t ai_addrlen;	/* length of ai_addr */
-    char *ai_canonname;		/* canonical name for nodename */
-    struct sockaddr *ai_addr;	/* binary address */
-    struct addrinfo *ai_next;	/* next structure in linked list */
+    int ai_flags;       /* AI_PASSIVE, AI_CANONNAME, AI_NUMERICHOST */
+    int ai_family;      /* PF_xxx */
+    int ai_socktype;        /* SOCK_xxx */
+    int ai_protocol;        /* 0 or IPPROTO_xxx for IPv4 and IPv6 */
+    socklen_t ai_addrlen;   /* length of ai_addr */
+    char *ai_canonname;     /* canonical name for nodename */
+    struct sockaddr *ai_addr;   /* binary address */
+    struct addrinfo *ai_next;   /* next structure in linked list */
 };
 
 /* Supposed to be defined in <netdb.h> */
@@ -100,17 +100,18 @@ struct addrinfo {
 /* RFC 2553 / Posix resolver */
 SQUIDCEXTERN int xgetaddrinfo (const char *nodename, const char *servname,
                                const struct addrinfo *hints, struct addrinfo **res);
-#define getaddrinfo	xgetaddrinfo
+#define getaddrinfo xgetaddrinfo
 
 /* Free addrinfo structure and associated storage */
 SQUIDCEXTERN void xfreeaddrinfo (struct addrinfo *ai);
-#define freeaddrinfo	xfreeaddrinfo
+#define freeaddrinfo    xfreeaddrinfo
 
 /* Convert error return from getaddrinfo() to string */
 SQUIDCEXTERN const char *xgai_strerror (int code);
 #if !defined(gai_strerror)
-#define gai_strerror	xgai_strerror
+#define gai_strerror    xgai_strerror
 #endif
 
-#endif /* HAVE_GETADDRINFO */
+#endif /* HAVE_DECL_GETADDRINFO */
 #endif /* _getaddrinfo_h */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -22,11 +22,13 @@
  *                      - use xinet_ntop instead of inet_ntop
  *                      - use SQUIDHOSTNAMELEN instead of MAXHOSTNAMELEN
  *
+ *    13-Jan-2015 : Various fixed for C++ and MinGW native build
+ *
  *  Original License and code follows.
  */
 #include "squid.h"
 
-/*	KAME: getnameinfo.c,v 1.72 2005/01/13 04:12:03 itojun Exp 	*/
+/*  KAME: getnameinfo.c,v 1.72 2005/01/13 04:12:03 itojun Exp   */
 
 /*
  * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.
@@ -81,10 +83,7 @@
  *     - gethostbyaddr() is usually not thread safe.
  */
 
-#if !HAVE_GETNAMEINFO
-
-#include "compat/getaddrinfo.h"
-#include "compat/inet_ntop.h"
+#if !HAVE_DECL_GETNAMEINFO
 
 #if HAVE_SYS_SOCKET_H
 #include <sys/socket.h>
@@ -133,13 +132,15 @@ static const struct afd {
     int a_portoff;
 } afdl [] = {
 #if INET6
-    {PF_INET6, sizeof(struct in6_addr), sizeof(struct sockaddr_in6),
+    {   PF_INET6, sizeof(struct in6_addr), sizeof(struct sockaddr_in6),
         offsetof(struct sockaddr_in6, sin6_addr),
-        offsetof(struct sockaddr_in6, sin6_port)},
+        offsetof(struct sockaddr_in6, sin6_port)
+    },
 #endif
-    {PF_INET, sizeof(struct in_addr), sizeof(struct sockaddr_in),
-     offsetof(struct sockaddr_in, sin_addr),
-     offsetof(struct sockaddr_in, sin_port)},
+    {   PF_INET, sizeof(struct in_addr), sizeof(struct sockaddr_in),
+        offsetof(struct sockaddr_in, sin_addr),
+        offsetof(struct sockaddr_in, sin_port)
+    },
     {0, 0, 0, 0, 0},
 };
 
@@ -150,14 +151,7 @@ static int ip6_sa2str __P((const struct sockaddr_in6 *, char *, size_t, int));
 #endif
 
 int
-xgetnameinfo(sa, salen, host, hostlen, serv, servlen, flags)
-const struct sockaddr *sa;
-socklen_t salen;
-char *host;
-size_t hostlen;
-char *serv;
-size_t servlen;
-int flags;
+xgetnameinfo(const struct sockaddr *sa, socklen_t salen, char *host, size_t hostlen, char *serv, size_t servlen, int flags)
 {
     const struct afd *afd;
     struct servent *sp;
@@ -171,7 +165,7 @@ int flags;
     if (sa == NULL)
         return EAI_FAIL;
 
-#if HAVE_SA_LEN	/*XXX*/
+#if HAVE_SA_LEN /*XXX*/
     if (sa->sa_len != salen)
         return EAI_FAIL;
 #endif
@@ -422,4 +416,5 @@ int flags;
         return n;
 }
 #endif /* INET6 */
-#endif
+#endif /* HAVE_DECL_GETNAMEINFO */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -9,7 +9,7 @@
 #ifndef _getnameinfo_h
 #define _getnameinfo_h
 
-#if !HAVE_GETNAMEINFO
+#if !HAVE_DECL_GETNAMEINFO
 
 // RFC 2553 / Posix resolver
 // Reconstructed from KAME getnameinfo.c
@@ -20,7 +20,8 @@ SQUIDCEXTERN int xgetnameinfo(const struct sockaddr *sa,
                               char *serv,
                               size_t servlen,
                               int flags );
-#define getnameinfo	xgetnameinfo
+#define getnameinfo xgetnameinfo
 
-#endif /* HAVE_GETNAMEINFO */
+#endif /* HAVE_DECL_GETNAMEINFO */
 #endif /* _getnameinfo_h */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -14,23 +14,24 @@
  * Update/Maintenance History:
  *
  *    24-Sep-2007 : Copied from bind 9.3.3
- * 			- Added protection around libray headers
- * 			- Altered configure checks
- * 			- Un-hacked slightly to use system gethostbyname()
+ *          - Added protection around libray headers
+ *          - Altered configure checks
+ *          - Un-hacked slightly to use system gethostbyname()
  *
  *    06-Oct-2007 : Various fixes to allow the build on MinGW
  *
  *    28-Oct-2007: drop some dead code. now tested working without.
  *
  *    04-Nov-2010: drop SPRINTF casting macro
  *
+ *    13-Jan-2015 : Various fixed for C++ and MinGW native build
+ *
  *  Original License and code follows.
  */
 
 #include "squid.h"
 
-#if !HAVE_INET_NTOP
-#include "inet_ntop.h"
+#if !HAVE_DECL_INET_NTOP
 
 /*
  * Copyright (c) 2004 by Internet Systems Consortium, Inc. ("ISC")
@@ -100,24 +101,20 @@ static const char *inet_ntop6 (const u_char *src, char *dst, size_t size);
 
 /* char *
  * inet_ntop(af, src, dst, size)
- *	convert a network format address to presentation format.
+ *  convert a network format address to presentation format.
  * return:
- *	pointer to presentation format address (`dst'), or NULL (see errno).
+ *  pointer to presentation format address (`dst'), or NULL (see errno).
  * author:
- *	Paul Vixie, 1996.
+ *  Paul Vixie, 1996.
  */
 const char *
-xinet_ntop(af, src, dst, size)
-int af;
-const void *src;
-char *dst;
-size_t size;
+xinet_ntop(int af, const void *src, char *dst, size_t size)
 {
     switch (af) {
     case AF_INET:
-        return (inet_ntop4(src, dst, size));
+        return (inet_ntop4((const u_char*)src, dst, size));
     case AF_INET6:
-        return (inet_ntop6(src, dst, size));
+        return (inet_ntop6((const u_char*)src, dst, size));
     default:
         errno = EAFNOSUPPORT;
         return (NULL);
@@ -127,25 +124,22 @@ size_t size;
 
 /* const char *
  * inet_ntop4(src, dst, size)
- *	format an IPv4 address
+ *  format an IPv4 address
  * return:
- *	`dst' (as a const)
+ *  `dst' (as a const)
  * notes:
- *	(1) uses no statics
- *	(2) takes a u_char* not an in_addr as input
+ *  (1) uses no statics
+ *  (2) takes a u_char* not an in_addr as input
  * author:
- *	Paul Vixie, 1996.
+ *  Paul Vixie, 1996.
  */
 static const char *
-inet_ntop4(src, dst, size)
-const u_char *src;
-char *dst;
-size_t size;
+inet_ntop4(const u_char *src, char *dst, size_t size)
 {
     static const char fmt[] = "%u.%u.%u.%u";
-    char tmp[sizeof "255.255.255.255"];
+    char tmp[sizeof("255.255.255.255")+1];
 
-    if (snprintf(tmp, min(sizeof("255.255.255.255"),size), fmt, src[0], src[1], src[2], src[3]) >= size) {
+    if ((size_t)snprintf(tmp, min(sizeof(tmp),size), fmt, src[0], src[1], src[2], src[3]) >= size) {
         errno = ENOSPC;
         return (NULL);
     }
@@ -155,15 +149,12 @@ size_t size;
 
 /* const char *
  * inet_ntop6(src, dst, size)
- *	convert IPv6 binary address into presentation (printable) format
+ *  convert IPv6 binary address into presentation (printable) format
  * author:
- *	Paul Vixie, 1996.
+ *  Paul Vixie, 1996.
  */
 static const char *
-inet_ntop6(src, dst, size)
-const u_char *src;
-char *dst;
-size_t size;
+inet_ntop6(const u_char *src, char *dst, size_t size)
 {
     /*
      * Note that int32_t and int16_t need only be "at least" large enough
@@ -179,8 +170,8 @@ size_t size;
 
     /*
      * Preprocess:
-     *	Copy the input (bytewise) array into a wordwise array.
-     *	Find the longest run of 0x00's in src[] for :: shorthanding.
+     *  Copy the input (bytewise) array into a wordwise array.
+     *  Find the longest run of 0x00's in src[] for :: shorthanding.
      */
     memset(words, '\0', sizeof words);
     for (i = 0; i < NS_IN6ADDRSZ; i++)
@@ -253,4 +244,5 @@ size_t size;
     return (dst);
 }
 
-#endif /* HAVE_INET_NTOP */
+#endif /* HAVE_DECL_INET_NTOP */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -10,7 +10,7 @@
 #define _INC_INET_NTOP_H
 
 /* Use the system provided version where possible */
-#if !HAVE_INET_NTOP
+#if !HAVE_DECL_INET_NTOP
 
 /* char *
 * inet_ntop(af, src, dst, size)
@@ -21,7 +21,10 @@
 *      Paul Vixie, 1996.
 */
 SQUIDCEXTERN const char * xinet_ntop(int af, const void *src, char *dst, size_t size);
+#ifndef inet_ntop
 #define inet_ntop xinet_ntop
-
 #endif
+
+#endif /* HAVE_DECL_INET_NTOP */
 #endif /* _INC_INET_NTOP_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -21,12 +21,14 @@
  *
  *    28-Oct-2007: drop some dead code. now tested working without.
  *
+ *    13-Jan-2015 : Various fixed for C++ and MinGW native build
+ *
  *  Original License and code follows.
  */
 
 #include "squid.h"
 
-#if !HAVE_INET_PTON
+#if !HAVE_DECL_INET_PTON
 
 /*
  * Copyright (c) 2004 by Internet Systems Consortium, Inc. ("ISC")
@@ -89,31 +91,28 @@ static const char rcsid[] = "inet_pton.c,v 1.2.206.2 2005/07/28 07:43:18 marka E
  * sizeof(int) < 4.  sizeof(int) > 4 is fine; all the world's not a VAX.
  */
 
-static int	inet_pton4 (const char *src, u_char *dst);
-static int	inet_pton6 (const char *src, u_char *dst);
+static int  inet_pton4 (const char *src, u_char *dst);
+static int  inet_pton6 (const char *src, u_char *dst);
 
 /* int
  * inet_pton(af, src, dst)
- *	convert from presentation format (which usually means ASCII printable)
- *	to network format (which is usually some kind of binary format).
+ *  convert from presentation format (which usually means ASCII printable)
+ *  to network format (which is usually some kind of binary format).
  * return:
- *	1 if the address was valid for the specified address family
- *	0 if the address wasn't valid (`dst' is untouched in this case)
- *	-1 if some other error occurred (`dst' is untouched in this case, too)
+ *  1 if the address was valid for the specified address family
+ *  0 if the address wasn't valid (`dst' is untouched in this case)
+ *  -1 if some other error occurred (`dst' is untouched in this case, too)
  * author:
- *	Paul Vixie, 1996.
+ *  Paul Vixie, 1996.
  */
 int
-xinet_pton(af, src, dst)
-int af;
-const char *src;
-void *dst;
+xinet_pton(int af, const char *src, void *dst)
 {
     switch (af) {
     case AF_INET:
-        return (inet_pton4(src, dst));
+        return (inet_pton4(src, (u_char*)dst));
     case AF_INET6:
-        return (inet_pton6(src, dst));
+        return (inet_pton6(src, (u_char*)dst));
     default:
         errno = EAFNOSUPPORT;
         return (-1);
@@ -123,18 +122,16 @@ void *dst;
 
 /* int
  * inet_pton4(src, dst)
- *	like inet_aton() but without all the hexadecimal and shorthand.
+ *  like inet_aton() but without all the hexadecimal and shorthand.
  * return:
- *	1 if `src' is a valid dotted quad, else 0.
+ *  1 if `src' is a valid dotted quad, else 0.
  * notice:
- *	does not touch `dst' unless it's returning 1.
+ *  does not touch `dst' unless it's returning 1.
  * author:
- *	Paul Vixie, 1996.
+ *  Paul Vixie, 1996.
  */
 static int
-inet_pton4(src, dst)
-const char *src;
-u_char *dst;
+inet_pton4(const char *src, u_char *dst)
 {
     static const char digits[] = "0123456789";
     int saw_digit, octets, ch;
@@ -147,13 +144,13 @@ u_char *dst;
         const char *pch;
 
         if ((pch = strchr(digits, ch)) != NULL) {
-            u_int new = *tp * 10 + (pch - digits);
+            u_int nw = *tp * 10 + (pch - digits);
 
             if (saw_digit && *tp == 0)
                 return (0);
-            if (new > 255)
+            if (nw > 255)
                 return (0);
-            *tp = new;
+            *tp = nw;
             if (!saw_digit) {
                 if (++octets > 4)
                     return (0);
@@ -175,21 +172,19 @@ u_char *dst;
 
 /* int
  * inet_pton6(src, dst)
- *	convert presentation level address to network order binary form.
+ *  convert presentation level address to network order binary form.
  * return:
- *	1 if `src' is a valid [RFC1884 2.2] address, else 0.
+ *  1 if `src' is a valid [RFC1884 2.2] address, else 0.
  * notice:
- *	(1) does not touch `dst' unless it's returning 1.
- *	(2) :: in a full address is silently ignored.
+ *  (1) does not touch `dst' unless it's returning 1.
+ *  (2) :: in a full address is silently ignored.
  * credit:
- *	inspired by Mark Andrews.
+ *  inspired by Mark Andrews.
  * author:
- *	Paul Vixie, 1996.
+ *  Paul Vixie, 1996.
  */
 static int
-inet_pton6(src, dst)
-const char *src;
-u_char *dst;
+inet_pton6(const char *src, u_char *dst)
 {
     static const char xdigits_l[] = "0123456789abcdef",
                                     xdigits_u[] = "0123456789ABCDEF";
@@ -242,7 +237,7 @@ u_char *dst;
                 inet_pton4(curtok, tp) > 0) {
             tp += NS_INADDRSZ;
             seen_xdigits = 0;
-            break;	/* '\0' was seen by inet_pton4(). */
+            break;  /* '\0' was seen by inet_pton4(). */
         }
         return (0);
     }
@@ -274,4 +269,5 @@ u_char *dst;
     return (1);
 }
 
-#endif /* HAVE_INET_PTON */
+#endif /* HAVE_DECL_INET_PTON */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -10,7 +10,7 @@
 #define _INC_INET_PTON_H
 
 /* Use the system provided version where possible */
-#if !HAVE_INET_PTON
+#if !HAVE_DECL_INET_PTON
 
 /* int
 * inet_pton(af, src, dst)
@@ -24,7 +24,10 @@
 *      Paul Vixie, 1996.
 */
 SQUIDCEXTERN int xinet_pton(int af, const char *src, void *dst);
+#ifndef inet_pton
 #define inet_pton xinet_pton
-
 #endif
+
+#endif /* HAVE_DECL_INET_PTON */
 #endif /* _INC_INET_NTOP_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -15,3 +15,4 @@ SQUIDCEXTERN int initgroups(const char *user, gid_t group);
 
 #endif
 #endif /* SQUID_INITGROPS_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -38,13 +38,14 @@ memrchr(const void *s, int c, size_t n)
     const unsigned char *cp;
 
     if (n != 0) {
-	cp = (unsigned char *)s + n;
-	do {
-	    if (*(--cp) == (unsigned char)c)
-		return((void *)cp);
-	} while (--n != 0);
+        cp = (unsigned char *)s + n;
+        do {
+            if (*(--cp) == (unsigned char)c)
+                return((void *)cp);
+        } while (--n != 0);
     }
     return((void *)0);
 }
 
 #endif
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -35,3 +35,4 @@ void *memrchr(const void *s, int c, size_t n);
 
 #endif
 #endif /* SQUID_COMPAT_MEMRCHR_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -208,8 +208,8 @@ _free_osfhnd(int filehandle)
         _osfhnd(filehandle) = (long) INVALID_HANDLE_VALUE;
         return (0);
     } else {
-        errno = EBADF;		/* bad handle */
-        _doserrno = 0L;		/* not an OS error */
+        errno = EBADF;      /* bad handle */
+        _doserrno = 0L;     /* not an OS error */
         return -1;
     }
 }
@@ -355,3 +355,4 @@ syslog(int priority, const char *fmt, ...)
 
 /* note: this is all MSWindows-specific code; all of it should be conditional */
 #endif /* _SQUID_WINDOWS_ */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -32,3 +32,4 @@
 
 #endif /* _SQUID_AIX_ */
 #endif /* SQUID_OS_AIX_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -18,3 +18,4 @@
 
 #endif /* _SQUID_ANDROID_ */
 #endif /* SQUID_OS_ANDROID_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -26,3 +26,4 @@
 
 #endif /* _SQUID_DRAGONFLY_ */
 #endif /* SQUID_OS_DRAGONFLY_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -41,3 +41,4 @@
 
 #endif /* _SQUID_FREEBSD_ */
 #endif /* SQUID_OS_FREEBSD_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -40,3 +40,4 @@
 
 #endif /* _SQUID_HPUX_ */
 #endif /* SQUID_OS_HPUX_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -72,3 +72,4 @@ typedef uint32_t __u32;
 
 #endif /* _SQUID_LINUX_ */
 #endif /* SQUID_OS_LINUX_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -35,3 +35,4 @@
 
 #endif /* _SQUID_APPLE_ */
 #endif /* SQUID_OS_MACOSX_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -70,7 +70,7 @@
 #endif
 
 #if defined(_FILE_OFFSET_BITS) && _FILE_OFFSET_BITS == 64
-# define __USE_FILE_OFFSET64	1
+# define __USE_FILE_OFFSET64    1
 #endif
 
 #if defined(_MSC_VER) /* Microsoft C Compiler ONLY */
@@ -179,7 +179,7 @@ SQUIDCEXTERN int WIN32_truncate(const char *pathname, off_t length);
 #define O_RANDOM        _O_RANDOM
 #endif
 #ifndef O_NDELAY
-#define O_NDELAY	0
+#define O_NDELAY    0
 #endif
 
 #ifndef S_IFMT
@@ -226,16 +226,16 @@ SQUIDCEXTERN int WIN32_truncate(const char *pathname, off_t length);
 #endif
 
 #if defined(_MSC_VER)
-#define	S_ISDIR(m) (((m) & _S_IFDIR) == _S_IFDIR)
+#define S_ISDIR(m) (((m) & _S_IFDIR) == _S_IFDIR)
 #endif
 
-#define SIGHUP	1	/* hangup */
-#define SIGKILL	9	/* kill (cannot be caught or ignored) */
-#define SIGBUS	10	/* bus error */
-#define SIGPIPE	13	/* write on a pipe with no one to read it */
-#define SIGCHLD	20	/* to parent on child stop or exit */
-#define SIGUSR1 30	/* user defined signal 1 */
-#define SIGUSR2 31	/* user defined signal 2 */
+#define SIGHUP  1   /* hangup */
+#define SIGKILL 9   /* kill (cannot be caught or ignored) */
+#define SIGBUS  10  /* bus error */
+#define SIGPIPE 13  /* write on a pipe with no one to read it */
+#define SIGCHLD 20  /* to parent on child stop or exit */
+#define SIGUSR1 30  /* user defined signal 1 */
+#define SIGUSR2 31  /* user defined signal 2 */
 
 #if _SQUID_MINGW_
 typedef unsigned char boolean;
@@ -267,8 +267,8 @@ struct group {
 
 #if !HAVE_GETTIMEOFDAY
 struct timezone {
-    int	tz_minuteswest;	/* minutes west of Greenwich */
-    int	tz_dsttime;	/* type of dst correction */
+    int tz_minuteswest; /* minutes west of Greenwich */
+    int tz_dsttime; /* type of dst correction */
 };
 #endif
 
@@ -621,6 +621,28 @@ getsockopt(int s, int l, int o, void * v, socklen_t * n)
 }
 #define getsockopt(s,l,o,v,n) Squid::getsockopt(s,l,o,v,n)
 
+inline char *
+inet_ntop(int af, const void *src, char *dst, size_t size)
+{
+#if HAVE_DECL_INETNTOPA
+    return (char*)InetNtopA(af, const_cast<void*>(src), dst, size);
+#else
+    return ::inet_ntop(af, src, dst, size);
+#endif
+}
+#define inet_ntop(a,s,d,l) Squid::inet_ntop(a,s,d,l)
+
+inline char *
+inet_pton(int af, const void *src, char *dst)
+{
+#if HAVE_DECL_INETPTONA
+    return (char*)InetPtonA(af, const_cast<void*>(src), dst);
+#else
+    return ::inet_pton(af, src, dst);
+#endif
+}
+#define inet_pton(a,s,d) Squid::inet_pton(a,s,d)
+
 /* Simple ioctl() emulation */
 inline int
 ioctl(int s, int c, void * a)
@@ -812,27 +834,27 @@ WSASocket(int a, int t, int p, LPWSAPROTOCOL_INFO i, GROUP g, DWORD f)
 
 #else /* #ifdef __cplusplus */
 #define connect(s,n,l) \
-	(SOCKET_ERROR == connect(_get_osfhandle(s),n,l) ? \
-	(WSAEMFILE == (errno = WSAGetLastError()) ? errno = EMFILE : -1, -1) : 0)
+    (SOCKET_ERROR == connect(_get_osfhandle(s),n,l) ? \
+    (WSAEMFILE == (errno = WSAGetLastError()) ? errno = EMFILE : -1, -1) : 0)
 #define gethostbyname(n) \
-	(NULL == ((HOSTENT FAR*)(ws32_result = (int)gethostbyname(n))) ? \
-	(errno = WSAGetLastError()), (HOSTENT FAR*)NULL : (HOSTENT FAR*)ws32_result)
+    (NULL == ((HOSTENT FAR*)(ws32_result = (int)gethostbyname(n))) ? \
+    (errno = WSAGetLastError()), (HOSTENT FAR*)NULL : (HOSTENT FAR*)ws32_result)
 #define gethostname(n,l) \
-	(SOCKET_ERROR == gethostname(n,l) ? \
-	(errno = WSAGetLastError()), -1 : 0)
+    (SOCKET_ERROR == gethostname(n,l) ? \
+    (errno = WSAGetLastError()), -1 : 0)
 #define recv(s,b,l,f) \
-	(SOCKET_ERROR == (ws32_result = recv(_get_osfhandle(s),b,l,f)) ? \
-	(errno = WSAGetLastError()), -1 : ws32_result)
+    (SOCKET_ERROR == (ws32_result = recv(_get_osfhandle(s),b,l,f)) ? \
+    (errno = WSAGetLastError()), -1 : ws32_result)
 #define sendto(s,b,l,f,t,tl) \
-	(SOCKET_ERROR == (ws32_result = sendto(_get_osfhandle(s),b,l,f,t,tl)) ? \
-	(errno = WSAGetLastError()), -1 : ws32_result)
+    (SOCKET_ERROR == (ws32_result = sendto(_get_osfhandle(s),b,l,f,t,tl)) ? \
+    (errno = WSAGetLastError()), -1 : ws32_result)
 #define select(n,r,w,e,t) \
-	(SOCKET_ERROR == (ws32_result = select(n,r,w,e,t)) ? \
-	(errno = WSAGetLastError()), -1 : ws32_result)
+    (SOCKET_ERROR == (ws32_result = select(n,r,w,e,t)) ? \
+    (errno = WSAGetLastError()), -1 : ws32_result)
 #define socket(f,t,p) \
-	(INVALID_SOCKET == ((SOCKET)(ws32_result = (int)socket(f,t,p))) ? \
-	((WSAEMFILE == (errno = WSAGetLastError()) ? errno = EMFILE : -1), -1) : \
-	(SOCKET)_open_osfhandle(ws32_result,0))
+    (INVALID_SOCKET == ((SOCKET)(ws32_result = (int)socket(f,t,p))) ? \
+    ((WSAEMFILE == (errno = WSAGetLastError()) ? errno = EMFILE : -1), -1) : \
+    (SOCKET)_open_osfhandle(ws32_result,0))
 #define write      _write /* Needed in util.c */
 #define open       _open /* Needed in win32lib.c */
 #endif /* #ifdef __cplusplus */
@@ -845,26 +867,26 @@ WSASocket(int a, int t, int p, LPWSAPROTOCOL_INFO i, GROUP g, DWORD f)
 #if HAVE_SYS_RESOURCE_H
 #include <sys/resource.h>
 #else
-#define	RUSAGE_SELF	0		/* calling process */
-#define	RUSAGE_CHILDREN	-1		/* terminated child processes */
+#define RUSAGE_SELF 0       /* calling process */
+#define RUSAGE_CHILDREN -1      /* terminated child processes */
 
 struct rusage {
-    struct timeval ru_utime;	/* user time used */
-    struct timeval ru_stime;	/* system time used */
-    long ru_maxrss;			/* integral max resident set size */
-    long ru_ixrss;			/* integral shared text memory size */
-    long ru_idrss;			/* integral unshared data size */
-    long ru_isrss;			/* integral unshared stack size */
-    long ru_minflt;			/* page reclaims */
-    long ru_majflt;			/* page faults */
-    long ru_nswap;			/* swaps */
-    long ru_inblock;		/* block input operations */
-    long ru_oublock;		/* block output operations */
-    long ru_msgsnd;			/* messages sent */
-    long ru_msgrcv;			/* messages received */
-    long ru_nsignals;		/* signals received */
-    long ru_nvcsw;			/* voluntary context switches */
-    long ru_nivcsw;			/* involuntary context switches */
+    struct timeval ru_utime;    /* user time used */
+    struct timeval ru_stime;    /* system time used */
+    long ru_maxrss;         /* integral max resident set size */
+    long ru_ixrss;          /* integral shared text memory size */
+    long ru_idrss;          /* integral unshared data size */
+    long ru_isrss;          /* integral unshared stack size */
+    long ru_minflt;         /* page reclaims */
+    long ru_majflt;         /* page faults */
+    long ru_nswap;          /* swaps */
+    long ru_inblock;        /* block input operations */
+    long ru_oublock;        /* block output operations */
+    long ru_msgsnd;         /* messages sent */
+    long ru_msgrcv;         /* messages received */
+    long ru_nsignals;       /* signals received */
+    long ru_nvcsw;          /* voluntary context switches */
+    long ru_nivcsw;         /* involuntary context switches */
 };
 #endif /* HAVE_SYS_RESOURCE_H */
 
@@ -996,3 +1018,4 @@ void WIN32_maperror(unsigned long WIN32_oserrno);
 
 #endif /* _SQUID_WINDOWS_ */
 #endif /* SQUID_OS_MSWINDOWS_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -31,3 +31,4 @@
 
 #endif /* _SQUID_NETBSD_ */
 #endif /* SQUID_OS_NETBSD_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -55,3 +55,4 @@
 
 #endif /* _SQUID_NEXT_ */
 #endif /* SQUID_OS_NEXT_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -48,3 +48,4 @@
 
 #endif /* _SQUID_OPENBSD_ */
 #endif /* SQUID_OS_OPENBSD_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -15,14 +15,14 @@
  * Use is subject to license terms.
  */
 
-/*	Copyright (c) 1983, 1984, 1985, 1986, 1987, 1988, 1989 AT&T	*/
-/*	  All Rights Reserved  	*/
+/*  Copyright (c) 1983, 1984, 1985, 1986, 1987, 1988, 1989 AT&T */
+/*    All Rights Reserved   */
 
 /*
  * BIND 4.9.3:
  *
  * Copyright (c) 1980, 1983, 1988, 1993
- *	The Regents of the University of California.  All rights reserved.
+ *  The Regents of the University of California.  All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
@@ -34,8 +34,8 @@
  *    documentation and/or other materials provided with the distribution.
  * 3. All advertising materials mentioning features or use of this software
  *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
+ *  This product includes software developed by the University of
+ *  California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@ -81,7 +81,7 @@
  */
 
 #ifndef _NETDB_H
-#define	_NETDB_H
+#define _NETDB_H
 
 #include <sys/types.h>
 #include <netinet/in.h>
@@ -90,398 +90,399 @@
 #endif /* !defined(_XPG4_2) || defined(_XPG6) || defined(__EXTENSIONS__) */
 #include <sys/feature_tests.h>
 
-#ifdef	__cplusplus
+#ifdef  __cplusplus
 extern "C" {
 #endif
 
-#define	_PATH_HEQUIV	"/etc/hosts.equiv"
-#define	_PATH_HOSTS	"/etc/hosts"
-#define	_PATH_IPNODES	"/etc/inet/ipnodes"
-#define	_PATH_IPSECALGS	"/etc/inet/ipsecalgs"
-#define	_PATH_NETMASKS	"/etc/netmasks"
-#define	_PATH_NETWORKS	"/etc/networks"
-#define	_PATH_PROTOCOLS	"/etc/protocols"
-#define	_PATH_SERVICES	"/etc/services"
-
-    struct	hostent {
-        char	*h_name;	/* official name of host */
-        char	**h_aliases;	/* alias list */
-        int	h_addrtype;	/* host address type */
-        int	h_length;	/* length of address */
-        char	**h_addr_list;	/* list of addresses from name server */
-#define	h_addr	h_addr_list[0]	/* address, for backward compatiblity */
-    };
-
-    /*
-     * addrinfo introduced with IPv6 for Protocol-Independent Hostname
-     * and Service Name Translation.
-     */
+#define _PATH_HEQUIV    "/etc/hosts.equiv"
+#define _PATH_HOSTS "/etc/hosts"
+#define _PATH_IPNODES   "/etc/inet/ipnodes"
+#define _PATH_IPSECALGS "/etc/inet/ipsecalgs"
+#define _PATH_NETMASKS  "/etc/netmasks"
+#define _PATH_NETWORKS  "/etc/networks"
+#define _PATH_PROTOCOLS "/etc/protocols"
+#define _PATH_SERVICES  "/etc/services"
+
+struct  hostent {
+    char    *h_name;    /* official name of host */
+    char    **h_aliases;    /* alias list */
+    int h_addrtype; /* host address type */
+    int h_length;   /* length of address */
+    char    **h_addr_list;  /* list of addresses from name server */
+#define h_addr  h_addr_list[0]  /* address, for backward compatiblity */
+};
+
+/*
+ * addrinfo introduced with IPv6 for Protocol-Independent Hostname
+ * and Service Name Translation.
+ */
 
 #if !defined(_XPG4_2) || defined(_XPG6) || defined(__EXTENSIONS__)
-    struct addrinfo {
-        int ai_flags;		/* AI_PASSIVE, AI_CANONNAME, ... */
-        int ai_family;		/* PF_xxx */
-        int ai_socktype;	/* SOCK_xxx */
-        int ai_protocol;	/* 0 or IPPROTO_xxx for IPv4 and IPv6 */
+struct addrinfo {
+    int ai_flags;       /* AI_PASSIVE, AI_CANONNAME, ... */
+    int ai_family;      /* PF_xxx */
+    int ai_socktype;    /* SOCK_xxx */
+    int ai_protocol;    /* 0 or IPPROTO_xxx for IPv4 and IPv6 */
 #ifdef __sparcv9
-        int _ai_pad;		/* for backwards compat with old size_t */
+    int _ai_pad;        /* for backwards compat with old size_t */
 #endif /* __sparcv9 */
-        socklen_t ai_addrlen;
-        char *ai_canonname;	/* canonical name for hostname */
-        struct sockaddr *ai_addr;	/* binary address */
-        struct addrinfo *ai_next;	/* next structure in linked list */
-    };
-
-    /* addrinfo flags */
-#define	AI_PASSIVE	0x0008	/* intended for bind() + listen() */
-#define	AI_CANONNAME	0x0010	/* return canonical version of host */
-#define	AI_NUMERICHOST	0x0020	/* use numeric node address string */
-#define	AI_NUMERICSERV	0x0040	/* servname is assumed numeric */
-
-    /* getipnodebyname() flags */
-#define	AI_V4MAPPED	0x0001	/* IPv4 mapped addresses if no IPv6 */
-#define	AI_ALL		0x0002	/* IPv6 and IPv4 mapped addresses */
-#define	AI_ADDRCONFIG	0x0004	/* AAAA or A records only if IPv6/IPv4 cnfg'd */
-
-    /*
-     * These were defined in RFC 2553 but not SUSv3
-     * or RFC 3493 which obsoleted 2553.
-     */
+    socklen_t ai_addrlen;
+    char *ai_canonname; /* canonical name for hostname */
+    struct sockaddr *ai_addr;   /* binary address */
+    struct addrinfo *ai_next;   /* next structure in linked list */
+};
+
+/* addrinfo flags */
+#define AI_PASSIVE  0x0008  /* intended for bind() + listen() */
+#define AI_CANONNAME    0x0010  /* return canonical version of host */
+#define AI_NUMERICHOST  0x0020  /* use numeric node address string */
+#define AI_NUMERICSERV  0x0040  /* servname is assumed numeric */
+
+/* getipnodebyname() flags */
+#define AI_V4MAPPED 0x0001  /* IPv4 mapped addresses if no IPv6 */
+#define AI_ALL      0x0002  /* IPv6 and IPv4 mapped addresses */
+#define AI_ADDRCONFIG   0x0004  /* AAAA or A records only if IPv6/IPv4 cnfg'd */
+
+/*
+ * These were defined in RFC 2553 but not SUSv3
+ * or RFC 3493 which obsoleted 2553.
+ */
 #if !defined(_XPG6) || defined(__EXTENSIONS__)
-#define	AI_DEFAULT	(AI_V4MAPPED | AI_ADDRCONFIG)
+#define AI_DEFAULT  (AI_V4MAPPED | AI_ADDRCONFIG)
 
-    /* addrinfo errors */
-#define	EAI_ADDRFAMILY	1	/* address family not supported */
-#define	EAI_NODATA	7	/* no address */
+/* addrinfo errors */
+#define EAI_ADDRFAMILY  1   /* address family not supported */
+#define EAI_NODATA  7   /* no address */
 #endif /* !defined(_XPG6) || defined(__EXTENSIONS__) */
-#define	EAI_AGAIN	2	/* DNS temporary failure */
-#define	EAI_BADFLAGS	3	/* invalid ai_flags */
-#define	EAI_FAIL	4	/* DNS non-recoverable failure */
-#define	EAI_FAMILY	5	/* ai_family not supported */
-#define	EAI_MEMORY	6	/* memory allocation failure */
-#define	EAI_NONAME	8	/* host/servname not known */
-#define	EAI_SERVICE	9	/* servname not supported for ai_socktype */
-#define	EAI_SOCKTYPE	10	/* ai_socktype not supported */
-#define	EAI_SYSTEM	11	/* system error in errno */
-#define	EAI_OVERFLOW	12	/* argument buffer overflow */
-#define	EAI_PROTOCOL	13
-#define	EAI_MAX		14
-
-    /* getnameinfo flags */
-#define	NI_NOFQDN	0x0001
-#define	NI_NUMERICHOST	0x0002	/* return numeric form of address */
-#define	NI_NAMEREQD	0x0004	/* request DNS name */
-#define	NI_NUMERICSERV	0x0008
-#define	NI_DGRAM	0x0010
+#define EAI_AGAIN   2   /* DNS temporary failure */
+#define EAI_BADFLAGS    3   /* invalid ai_flags */
+#define EAI_FAIL    4   /* DNS non-recoverable failure */
+#define EAI_FAMILY  5   /* ai_family not supported */
+#define EAI_MEMORY  6   /* memory allocation failure */
+#define EAI_NONAME  8   /* host/servname not known */
+#define EAI_SERVICE 9   /* servname not supported for ai_socktype */
+#define EAI_SOCKTYPE    10  /* ai_socktype not supported */
+#define EAI_SYSTEM  11  /* system error in errno */
+#define EAI_OVERFLOW    12  /* argument buffer overflow */
+#define EAI_PROTOCOL    13
+#define EAI_MAX     14
+
+/* getnameinfo flags */
+#define NI_NOFQDN   0x0001
+#define NI_NUMERICHOST  0x0002  /* return numeric form of address */
+#define NI_NAMEREQD 0x0004  /* request DNS name */
+#define NI_NUMERICSERV  0x0008
+#define NI_DGRAM    0x0010
 
 #if !defined(_XPG6) || defined(__EXTENSIONS__)
-    /* Not listed in any standards document */
-#define	NI_WITHSCOPEID  0x0020
-#define	NI_NUMERICSCOPE 0x0040
+/* Not listed in any standards document */
+#define NI_WITHSCOPEID  0x0020
+#define NI_NUMERICSCOPE 0x0040
 
-    /* getnameinfo max sizes as defined in RFC 2553 obsoleted in RFC 3493 */
-#define	NI_MAXHOST	1025
-#define	NI_MAXSERV	32
+/* getnameinfo max sizes as defined in RFC 2553 obsoleted in RFC 3493 */
+#define NI_MAXHOST  1025
+#define NI_MAXSERV  32
 #endif /* !defined(_XPG6) || defined(__EXTENSIONS__) */
 #endif /* !defined(_XPG4_2) || defined(_XPG6) || defined(__EXTENSIONS__) */
 
-    /*
-     * Scope delimit character
-     */
-#define	SCOPE_DELIMITER	'%'
+/*
+ * Scope delimit character
+ */
+#define SCOPE_DELIMITER '%'
 
-    /*
-     * Algorithm entry for /etc/inet/ipsecalgs which defines IPsec protocols
-     * and algorithms.
-     */
+/*
+ * Algorithm entry for /etc/inet/ipsecalgs which defines IPsec protocols
+ * and algorithms.
+ */
 #if !defined(_XPG4_2) || defined(__EXTENSIONS__)
-    typedef struct ipsecalgent {
-        char **a_names;		/* algorithm names */
-        int a_proto_num;	/* protocol number */
-        int a_alg_num;		/* algorithm number */
-        char *a_mech_name;	/* encryption framework mechanism name */
-        int *a_block_sizes;	/* supported block sizes */
-        int *a_key_sizes;	/* supported key sizes */
-        int a_key_increment;	/* key size increment */
-        int *a_mech_params;	/* mechanism specific parameters */
-        int a_alg_flags;	/* algorithm flags */
-    } ipsecalgent_t;
-
-    /* well-known IPsec protocol numbers */
-
-#define	IPSEC_PROTO_AH		2
-#define	IPSEC_PROTO_ESP		3
+typedef struct ipsecalgent {
+    char **a_names;     /* algorithm names */
+    int a_proto_num;    /* protocol number */
+    int a_alg_num;      /* algorithm number */
+    char *a_mech_name;  /* encryption framework mechanism name */
+    int *a_block_sizes; /* supported block sizes */
+    int *a_key_sizes;   /* supported key sizes */
+    int a_key_increment;    /* key size increment */
+    int *a_mech_params; /* mechanism specific parameters */
+    int a_alg_flags;    /* algorithm flags */
+} ipsecalgent_t;
+
+/* well-known IPsec protocol numbers */
+
+#define IPSEC_PROTO_AH      2
+#define IPSEC_PROTO_ESP     3
 #endif /* !defined(_XPG4_2) || defined(__EXTENSIONS__) */
 
-    /*
-     * Assumption here is that a network number
-     * fits in 32 bits -- probably a poor one.
-     */
-    struct	netent {
-        char		*n_name;	/* official name of net */
-        char		**n_aliases;	/* alias list */
-        int		n_addrtype;	/* net address type */
-        in_addr_t	n_net;		/* network # */
-    };
-
-    struct	protoent {
-        char	*p_name;	/* official protocol name */
-        char	**p_aliases;	/* alias list */
-        int	p_proto;	/* protocol # */
-    };
-
-    struct	servent {
-        char	*s_name;	/* official service name */
-        char	**s_aliases;	/* alias list */
-        int	s_port;		/* port # */
-        char	*s_proto;	/* protocol to use */
-    };
-
-#ifdef	__STDC__
+/*
+ * Assumption here is that a network number
+ * fits in 32 bits -- probably a poor one.
+ */
+struct  netent {
+    char        *n_name;    /* official name of net */
+    char        **n_aliases;    /* alias list */
+    int     n_addrtype; /* net address type */
+    in_addr_t   n_net;      /* network # */
+};
+
+struct  protoent {
+    char    *p_name;    /* official protocol name */
+    char    **p_aliases;    /* alias list */
+    int p_proto;    /* protocol # */
+};
+
+struct  servent {
+    char    *s_name;    /* official service name */
+    char    **s_aliases;    /* alias list */
+    int s_port;     /* port # */
+    char    *s_proto;   /* protocol to use */
+};
+
+#ifdef  __STDC__
 #if !defined(_XPG4_2) || defined(__EXTENSIONS__)
-    struct hostent	*gethostbyname_r
-    (const char *, struct hostent *, char *, int, int *h_errnop);
-    struct hostent	*gethostbyaddr_r
-    (const char *, int, int, struct hostent *, char *, int, int *h_errnop);
-    struct hostent	*getipnodebyname(const char *, int, int, int *);
-    struct hostent	*getipnodebyaddr(const void *, size_t, int, int *);
-    void		freehostent(struct hostent *);
-    struct hostent	*gethostent_r(struct hostent *, char *, int, int *h_errnop);
-
-    struct servent	*getservbyname_r
-    (const char *name, const char *, struct servent *, char *, int);
-    struct servent	*getservbyport_r
-    (int port, const char *, struct servent *, char *, int);
-    struct servent	*getservent_r(struct	servent *, char *, int);
-
-    struct netent	*getnetbyname_r
-    (const char *, struct netent *, char *, int);
-    struct netent	*getnetbyaddr_r(long, int, struct netent *, char *, int);
-    struct netent	*getnetent_r(struct netent *, char *, int);
-
-    struct protoent	*getprotobyname_r
-    (const char *, struct protoent *, char *, int);
-    struct protoent	*getprotobynumber_r
-    (int, struct protoent *, char *, int);
-    struct protoent	*getprotoent_r(struct protoent *, char *, int);
-
-    int getnetgrent_r(char **, char **, char **, char *, int);
-    int innetgr(const char *, const char *, const char *, const char *);
+struct hostent  *gethostbyname_r
+(const char *, struct hostent *, char *, int, int *h_errnop);
+struct hostent  *gethostbyaddr_r
+(const char *, int, int, struct hostent *, char *, int, int *h_errnop);
+struct hostent  *getipnodebyname(const char *, int, int, int *);
+struct hostent  *getipnodebyaddr(const void *, size_t, int, int *);
+void        freehostent(struct hostent *);
+struct hostent  *gethostent_r(struct hostent *, char *, int, int *h_errnop);
+
+struct servent  *getservbyname_r
+(const char *name, const char *, struct servent *, char *, int);
+struct servent  *getservbyport_r
+(int port, const char *, struct servent *, char *, int);
+struct servent  *getservent_r(struct    servent *, char *, int);
+
+struct netent   *getnetbyname_r
+(const char *, struct netent *, char *, int);
+struct netent   *getnetbyaddr_r(long, int, struct netent *, char *, int);
+struct netent   *getnetent_r(struct netent *, char *, int);
+
+struct protoent *getprotobyname_r
+(const char *, struct protoent *, char *, int);
+struct protoent *getprotobynumber_r
+(int, struct protoent *, char *, int);
+struct protoent *getprotoent_r(struct protoent *, char *, int);
+
+int getnetgrent_r(char **, char **, char **, char *, int);
+int innetgr(const char *, const char *, const char *, const char *);
 #endif /* !defined(_XPG4_2) || defined(__EXTENSIONS__) */
 
-    /* Old interfaces that return a pointer to a static area;  MT-unsafe */
-    struct hostent	*gethostbyname(const char *);
-    struct hostent	*gethostent(void);
-    struct netent	*getnetbyaddr(in_addr_t, int);
-    struct netent	*getnetbyname(const char *);
-    struct netent	*getnetent(void);
-    struct protoent	*getprotobyname(const char *);
-    struct protoent	*getprotobynumber(int);
-    struct protoent	*getprotoent(void);
-    struct servent	*getservbyname(const char *, const char *);
-    struct servent	*getservbyport(int, const char *);
-    struct servent	*getservent(void);
-
-    /* gethostbyaddr() second argument is a size_t only in unix95/unix98 */
+/* Old interfaces that return a pointer to a static area;  MT-unsafe */
+struct hostent  *gethostbyname(const char *);
+struct hostent  *gethostent(void);
+struct netent   *getnetbyaddr(in_addr_t, int);
+struct netent   *getnetbyname(const char *);
+struct netent   *getnetent(void);
+struct protoent *getprotobyname(const char *);
+struct protoent *getprotobynumber(int);
+struct protoent *getprotoent(void);
+struct servent  *getservbyname(const char *, const char *);
+struct servent  *getservbyport(int, const char *);
+struct servent  *getservent(void);
+
+/* gethostbyaddr() second argument is a size_t only in unix95/unix98 */
 #if !defined(_XPG4_2) || defined(_XPG6) || defined(__EXTENSIONS__)
-    struct hostent	*gethostbyaddr(const void *, socklen_t, int);
+struct hostent  *gethostbyaddr(const void *, socklen_t, int);
 #else
-    struct hostent	*gethostbyaddr(const void *, size_t, int);
+struct hostent  *gethostbyaddr(const void *, size_t, int);
 #endif /* !defined(_XPG4_2) || defined(_XPG6) || defined(__EXTENSIONS__) */
 
 #if !defined(_XPG4_2) || defined(__EXTENSIONS__)
-    int endhostent(void);
-    int endnetent(void);
-    int endprotoent(void);
-    int endservent(void);
-    int sethostent(int);
-    int setnetent(int);
-    int setprotoent(int);
-    int setservent(int);
+int endhostent(void);
+int endnetent(void);
+int endprotoent(void);
+int endservent(void);
+int sethostent(int);
+int setnetent(int);
+int setprotoent(int);
+int setservent(int);
 #else
-    void endhostent(void);
-    void endnetent(void);
-    void endprotoent(void);
-    void endservent(void);
-    void sethostent(int);
-    void setnetent(int);
-    void setprotoent(int);
-    void setservent(int);
+void endhostent(void);
+void endnetent(void);
+void endprotoent(void);
+void endservent(void);
+void sethostent(int);
+void setnetent(int);
+void setprotoent(int);
+void setservent(int);
 #endif /* !defined(_XPG4_2) || defined(__EXTENSIONS__) */
 
 #if !defined(_XPG4_2) || defined(_XPG6) || defined(__EXTENSIONS__)
 
-#ifdef	_XPG6
-#ifdef	__PRAGMA_REDEFINE_EXTNAME
+#ifdef  _XPG6
+#ifdef  __PRAGMA_REDEFINE_EXTNAME
 #pragma redefine_extname getaddrinfo __xnet_getaddrinfo
-#else	/* __PRAGMA_REDEFINE_EXTNAME */
-#define	getaddrinfo __xnet_getaddrinfo
-#endif	/* __PRAGMA_REDEFINE_EXTNAME */
-#endif	/* _XPG6 */
-
-    int		getaddrinfo(const char *_RESTRICT_KYWD1,
-                     const char *_RESTRICT_KYWD2,
-                     const struct addrinfo *_RESTRICT_KYWD3,
-                     struct addrinfo **_RESTRICT_KYWD4);
-    void		freeaddrinfo(struct addrinfo *);
-    const char	*gai_strerror(int);
-    int		getnameinfo(const struct sockaddr *_RESTRICT_KYWD1,
-                     socklen_t, char *_RESTRICT_KYWD2, socklen_t,
-                     char *_RESTRICT_KYWD3, socklen_t, int);
+#else   /* __PRAGMA_REDEFINE_EXTNAME */
+#define getaddrinfo __xnet_getaddrinfo
+#endif  /* __PRAGMA_REDEFINE_EXTNAME */
+#endif  /* _XPG6 */
+
+int     getaddrinfo(const char *_RESTRICT_KYWD1,
+                    const char *_RESTRICT_KYWD2,
+                    const struct addrinfo *_RESTRICT_KYWD3,
+                    struct addrinfo **_RESTRICT_KYWD4);
+void        freeaddrinfo(struct addrinfo *);
+const char  *gai_strerror(int);
+int     getnameinfo(const struct sockaddr *_RESTRICT_KYWD1,
+                    socklen_t, char *_RESTRICT_KYWD2, socklen_t,
+                    char *_RESTRICT_KYWD3, socklen_t, int);
 #endif /* !defined(_XPG4_2) || defined(_XPG6) || defined(__EXTENSIONS__) */
 
 #if !defined(_XPG4_2) || defined(__EXTENSIONS__)
-    int getnetgrent(char **, char **, char **);
-    int setnetgrent(const char *);
-    int endnetgrent(void);
-    int rcmd(char **, unsigned short,
-             const char *, const char *, const char *, int *);
-    int rcmd_af(char **, unsigned short,
-                const char *, const char *, const char *, int *, int);
-    int rresvport_af(int *, int);
-    int rresvport_addr(int *, struct sockaddr_storage *);
-    int rexec(char **, unsigned short,
-              const char *, const char *, const char *, int *);
-    int rexec_af(char **, unsigned short,
-                 const char *, const char *, const char *, int *, int);
-    int rresvport(int *);
-    int ruserok(const char *, int, const char *, const char *);
-    /* BIND */
-    struct hostent	*gethostbyname2(const char *, int);
-    void		herror(const char *);
-    const char	*hstrerror(int);
-    /* End BIND */
-
-    /* IPsec algorithm prototype definitions */
-    struct ipsecalgent *getipsecalgbyname(const char *, int, int *);
-    struct ipsecalgent *getipsecalgbynum(int, int, int *);
-    int getipsecprotobyname(const char *doi_name);
-    char *getipsecprotobynum(int doi_domain);
-    void freeipsecalgent(struct ipsecalgent *ptr);
-    /* END IPsec algorithm prototype definitions */
+int getnetgrent(char **, char **, char **);
+int setnetgrent(const char *);
+int endnetgrent(void);
+int rcmd(char **, unsigned short,
+         const char *, const char *, const char *, int *);
+int rcmd_af(char **, unsigned short,
+            const char *, const char *, const char *, int *, int);
+int rresvport_af(int *, int);
+int rresvport_addr(int *, struct sockaddr_storage *);
+int rexec(char **, unsigned short,
+          const char *, const char *, const char *, int *);
+int rexec_af(char **, unsigned short,
+             const char *, const char *, const char *, int *, int);
+int rresvport(int *);
+int ruserok(const char *, int, const char *, const char *);
+/* BIND */
+struct hostent  *gethostbyname2(const char *, int);
+void        herror(const char *);
+const char  *hstrerror(int);
+/* End BIND */
+
+/* IPsec algorithm prototype definitions */
+struct ipsecalgent *getipsecalgbyname(const char *, int, int *);
+struct ipsecalgent *getipsecalgbynum(int, int, int *);
+int getipsecprotobyname(const char *doi_name);
+char *getipsecprotobynum(int doi_domain);
+void freeipsecalgent(struct ipsecalgent *ptr);
+/* END IPsec algorithm prototype definitions */
 
 #endif /* !defined(_XPG4_2) || defined(__EXTENSIONS__) */
-#else	/* __STDC__ */
-    struct hostent	*gethostbyname_r();
-    struct hostent	*gethostbyaddr_r();
-    struct hostent	*getipnodebyname();
-    struct hostent	*getipnodebyaddr();
-    void		 freehostent();
-    struct hostent	*gethostent_r();
-    struct servent	*getservbyname_r();
-    struct servent	*getservbyport_r();
-    struct servent	*getservent_r();
-    struct netent	*getnetbyname_r();
-    struct netent	*getnetbyaddr_r();
-    struct netent	*getnetent_r();
-    struct protoent	*getprotobyname_r();
-    struct protoent	*getprotobynumber_r();
-    struct protoent	*getprotoent_r();
-    int		 getnetgrent_r();
-    int		 innetgr();
-
-    /* Old interfaces that return a pointer to a static area;  MT-unsafe */
-    struct hostent	*gethostbyname();
-    struct hostent	*gethostbyaddr();
-    struct hostent	*gethostent();
-    struct netent	*getnetbyname();
-    struct netent	*getnetbyaddr();
-    struct netent	*getnetent();
-    struct servent	*getservbyname();
-    struct servent	*getservbyport();
-    struct servent	*getservent();
-    struct protoent	*getprotobyname();
-    struct protoent	*getprotobynumber();
-    struct protoent	*getprotoent();
-    int		 getnetgrent();
-
-    int sethostent();
-    int endhostent();
-    int setnetent();
-    int endnetent();
-    int setservent();
-    int endservent();
-    int setprotoent();
-    int endprotoent();
-    int setnetgrent();
-    int endnetgrent();
-    int rcmd();
-    int rcmd_af();
-    int rexec();
-    int rexec_af();
-    int rresvport();
-    int rresvport_af();
-    int rresvport_addr();
-    int ruserok();
-    /* BIND */
-    struct hostent	*gethostbyname2();
-    void		herror();
-    char		*hstrerror();
-    /* IPv6 prototype definitons */
-    int		getaddrinfo();
-    void		freeaddrinfo();
-    const char	*gai_strerror();
-    int		getnameinfo();
-    /* END IPv6 prototype definitions */
-    /* End BIND */
+#else   /* __STDC__ */
+struct hostent  *gethostbyname_r();
+struct hostent  *gethostbyaddr_r();
+struct hostent  *getipnodebyname();
+struct hostent  *getipnodebyaddr();
+void         freehostent();
+struct hostent  *gethostent_r();
+struct servent  *getservbyname_r();
+struct servent  *getservbyport_r();
+struct servent  *getservent_r();
+struct netent   *getnetbyname_r();
+struct netent   *getnetbyaddr_r();
+struct netent   *getnetent_r();
+struct protoent *getprotobyname_r();
+struct protoent *getprotobynumber_r();
+struct protoent *getprotoent_r();
+int      getnetgrent_r();
+int      innetgr();
+
+/* Old interfaces that return a pointer to a static area;  MT-unsafe */
+struct hostent  *gethostbyname();
+struct hostent  *gethostbyaddr();
+struct hostent  *gethostent();
+struct netent   *getnetbyname();
+struct netent   *getnetbyaddr();
+struct netent   *getnetent();
+struct servent  *getservbyname();
+struct servent  *getservbyport();
+struct servent  *getservent();
+struct protoent *getprotobyname();
+struct protoent *getprotobynumber();
+struct protoent *getprotoent();
+int      getnetgrent();
+
+int sethostent();
+int endhostent();
+int setnetent();
+int endnetent();
+int setservent();
+int endservent();
+int setprotoent();
+int endprotoent();
+int setnetgrent();
+int endnetgrent();
+int rcmd();
+int rcmd_af();
+int rexec();
+int rexec_af();
+int rresvport();
+int rresvport_af();
+int rresvport_addr();
+int ruserok();
+/* BIND */
+struct hostent  *gethostbyname2();
+void        herror();
+char        *hstrerror();
+/* IPv6 prototype definitons */
+int     getaddrinfo();
+void        freeaddrinfo();
+const char  *gai_strerror();
+int     getnameinfo();
+/* END IPv6 prototype definitions */
+/* End BIND */
 
 #if !defined(_XPG4_2) || defined(__EXTENSIONS__)
-    /* IPsec algorithm prototype definitions */
-    struct ipsecalgent *getalgbyname();
-    struct ipsecalgent *getalgbydoi();
-    int getdoidomainbyname();
-    const char *getdoidomainbynum();
-    void freealgent();
-    /* END IPsec algorithm prototype definitions */
+/* IPsec algorithm prototype definitions */
+struct ipsecalgent *getalgbyname();
+struct ipsecalgent *getalgbydoi();
+int getdoidomainbyname();
+const char *getdoidomainbynum();
+void freealgent();
+/* END IPsec algorithm prototype definitions */
 #endif /* !defined(_XPG4_2) || defined(__EXTENSIONS__) */
 
-#endif	/* __STDC__ */
+#endif  /* __STDC__ */
 
-    /*
-     * Error return codes from gethostbyname() and gethostbyaddr()
-     * (when using the resolver)
-     */
+/*
+ * Error return codes from gethostbyname() and gethostbyaddr()
+ * (when using the resolver)
+ */
 
-    extern  int h_errno;
+extern  int h_errno;
 
-#ifdef	_REENTRANT
-#ifdef	__STDC__
-    extern int	*__h_errno(void);
+#ifdef  _REENTRANT
+#ifdef  __STDC__
+extern int  *__h_errno(void);
 #else
-    extern int	*__h_errno();
-#endif	/* __STDC__ */
-
-    /* Only #define h_errno if there is no conflict with other use */
-#ifdef	H_ERRNO_IS_FUNCTION
-#define	h_errno	(*__h_errno())
-#endif	/* NO_H_ERRNO_DEFINE */
-#endif	/* _REENTRANT */
-
-    /*
-     * Error return codes from gethostbyname() and gethostbyaddr()
-     * (left in extern int h_errno).
-     */
-#define	HOST_NOT_FOUND	1 /* Authoritive Answer Host not found */
-#define	TRY_AGAIN	2 /* Non-Authoritive Host not found, or SERVERFAIL */
-#define	NO_RECOVERY	3 /* Non recoverable errors, FORMERR, REFUSED, NOTIMP */
-#define	NO_DATA		4 /* Valid name, no data record of requested type */
+extern int  *__h_errno();
+#endif  /* __STDC__ */
+
+/* Only #define h_errno if there is no conflict with other use */
+#ifdef  H_ERRNO_IS_FUNCTION
+#define h_errno (*__h_errno())
+#endif  /* NO_H_ERRNO_DEFINE */
+#endif  /* _REENTRANT */
+
+/*
+ * Error return codes from gethostbyname() and gethostbyaddr()
+ * (left in extern int h_errno).
+ */
+#define HOST_NOT_FOUND  1 /* Authoritive Answer Host not found */
+#define TRY_AGAIN   2 /* Non-Authoritive Host not found, or SERVERFAIL */
+#define NO_RECOVERY 3 /* Non recoverable errors, FORMERR, REFUSED, NOTIMP */
+#define NO_DATA     4 /* Valid name, no data record of requested type */
 
 #if !defined(_XPG4_2) || defined(__EXTENSIONS__)
-#define	NO_ADDRESS	NO_DATA		/* no address, look for MX record */
+#define NO_ADDRESS  NO_DATA     /* no address, look for MX record */
 
-    /* BIND */
-#define	NETDB_INTERNAL	-1	/* see errno */
-#define	NETDB_SUCCESS	0	/* no problem */
-    /* End BIND */
+/* BIND */
+#define NETDB_INTERNAL  -1  /* see errno */
+#define NETDB_SUCCESS   0   /* no problem */
+/* End BIND */
 
-#define	MAXHOSTNAMELEN	256
+#define MAXHOSTNAMELEN  256
 
-#define	MAXALIASES	35
-#define	MAXADDRS	35
+#define MAXALIASES  35
+#define MAXADDRS    35
 #endif /* !defined(_XPG4_2) || defined(__EXTENSIONS__) */
 
-#ifdef	__cplusplus
+#ifdef  __cplusplus
 }
 #endif
 
-#endif	/* _NETDB_H */
+#endif  /* _NETDB_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -25,3 +25,4 @@
 
 #endif /* _SQUID_OS2_ */
 #endif /* SQUID_OS_OS2_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -24,3 +24,4 @@
 
 #endif /* _SQUID_QNX_ */
 #endif /* SQUID_OS_QNX_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -18,7 +18,7 @@
  ****************************************************************************/
 
 #if !defined(_SVR4_SOURCE)
-#define _SVR4_SOURCE		/* for tempnam(3) */
+#define _SVR4_SOURCE        /* for tempnam(3) */
 #endif
 
 #if USE_ASYNC_IO
@@ -36,3 +36,4 @@
 
 #endif /* _SQUID_SGI_ */
 #endif /* SQUID_OS_SGI_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -28,14 +28,14 @@
 #if defined(i386) || defined(__i386)
 #if !HAVE_PAD128_T
 typedef union {
-    long double	_q;
-    int32_t		_l[4];
+    long double _q;
+    int32_t     _l[4];
 } pad128_t;
 #endif
 #if !HAVE_UPAD128_T
 typedef union {
-    long double	_q;
-    uint32_t	_l[4];
+    long double _q;
+    uint32_t    _l[4];
 } upad128_t;
 #endif
 #endif
@@ -105,3 +105,4 @@ SQUIDCEXTERN int gethostname(char *, int);
 
 #endif /* _SQUID_SOLARIS_ */
 #endif /* SQUID_OS_SOALRIS_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -29,3 +29,4 @@
 
 #endif /* _SQUID_SUNOS_ */
 #endif /* SQUID_OS_SUNOS_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -24,45 +24,37 @@
 
 /* SUN SOLARIS / OPENSOLARIS */
 #if defined(__sun__) || defined(__sun) || defined(__SUNPRO_CC) || defined(__SunOS_OSversion)
-#define _SQUID_SUN_ 1 /* SunOS */
 
 #if defined(__SVR4) /* Solaris */
 #define _SQUID_SOLARIS_ 1
 #else /* SunOS */
 #define _SQUID_SUNOS_ 1
 #endif /* __SVR4 */
 
-#elif defined(__hpux)		/* HP-UX - SysV-like? */
+#elif defined(__hpux)       /* HP-UX - SysV-like? */
 #define _SQUID_HPUX_ 1
-#define _SQUID_SYSV_ 1
 
-#elif defined(__osf__)		/* OSF/1 */
+#elif defined(__osf__)      /* OSF/1 */
 #define _SQUID_OSF_ 1
 
-#elif defined(__ultrix)		/* Ultrix */
-#define _SQUID_ULTRIX_ 1
-
-#elif defined(_AIX)		/* AIX */
+#elif defined(_AIX)     /* AIX */
 #define _SQUID_AIX_ 1
 
-#elif defined(__linux__)	/* Linux. WARNING: solaris-x86 also sets this */
+#elif defined(__linux__)    /* Linux. WARNING: solaris-x86 also sets this */
 #define _SQUID_LINUX_ 1
 
-#elif defined(__FreeBSD__)	/* FreeBSD */
+#elif defined(__FreeBSD__)  /* FreeBSD */
 #define _SQUID_FREEBSD_ 1
 
 #elif defined(__FreeBSD_kernel__)      /* GNU/kFreeBSD */
 #define _SQUID_KFREEBSD_ 1
 
-#elif defined(__sgi__)	|| defined(sgi) || defined(__sgi)	/* SGI */
+#elif defined(__sgi__)  || defined(sgi) || defined(__sgi)   /* SGI */
 #define _SQUID_SGI_ 1
 
 #elif defined(__NeXT__)
 #define _SQUID_NEXT_ 1
 
-#elif defined(__bsdi__)		/* BSD/OS */
-#define _SQUID_BSDI_ 1
-
 #elif defined(__NetBSD__)
 #define _SQUID_NETBSD_ 1
 
@@ -98,3 +90,4 @@
 #endif /* OS automatic detection */
 
 #endif /* SQUID_COMPAT_OSDETECT_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -27,3 +27,4 @@ psignal( int sig, const char* msg )
     else
         fputs( "(unknown)\n", stderr );
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -16,3 +16,4 @@
 extern void psignal(int sig, const char* msg);
 
 #endif /* __SQUID_PSIGNAL_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -33,3 +33,4 @@ shm_portable_segment_name_is_path()
     return false;
 #endif
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -51,3 +51,4 @@ extern "C" {
 bool shm_portable_segment_name_is_path();
 
 #endif /* SQUID_COMPAT_CPU_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -82,3 +82,4 @@ xstatvfs(const char *path, struct statvfs *sfs)
 }
 
 #endif /* HAVE_STATVFS */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -32,7 +32,6 @@
 #endif
 #endif /* !HAVE_STATVFS */
 
-
 #if HAVE_STATVFS
 #define xstatvfs statvfs
 
@@ -63,3 +62,4 @@ int xstatvfs(const char *path, struct statvfs *buf);
 #endif
 
 #endif /* _SQUID_COMPAT_XSTATVFS_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -63,3 +63,4 @@ inline FILE * tmpfile(void) { return tmpfile64(); }
 #endif
 
 #endif /* _SQUID_COMPAT_STDIO_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -47,3 +47,4 @@
 #endif
 
 #endif /* _SQUID_STDVARARGS_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -23,3 +23,4 @@ strerror(int ern)
 {
     return sys_errlist[ern];
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -22,3 +22,4 @@ strnrchr(const char *s, size_t count, int c)
     }
     return rv;
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -22,3 +22,4 @@
 SQUIDCEXTERN const char *strnrchr(const char *s, size_t count, int c);
 
 #endif /* COMPAT_STRNRCHR_H_ */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -16,9 +16,9 @@
  * Update/Maintenance History:
  *
  *    26-Apr-2008 : Copied from FreeBSD via OpenGrok
- * 			- added protection around libray headers
- * 			- added squid_ prefix for uniqueness
- * 			  so we can use it where OS copy is broken.
+ *          - added protection around libray headers
+ *          - added squid_ prefix for uniqueness
+ *            so we can use it where OS copy is broken.
  *
  *  Original License and code follows.
  */
@@ -30,7 +30,7 @@
 /*-
  * Copyright (c) 2001 Mike Barcroft <mike@FreeBSD.org>
  * Copyright (c) 1990, 1993
- *	The Regents of the University of California.  All rights reserved.
+ *  The Regents of the University of California.  All rights reserved.
  *
  * This code is derived from software contributed to Berkeley by
  * Chris Torek.
@@ -59,7 +59,7 @@
  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
  *
- * @(#)strstr.c	8.1 (Berkeley) 6/4/93
+ * @(#)strstr.c 8.1 (Berkeley) 6/4/93
  * $FreeBSD: src/lib/libc/string/strnstr.c,v 1.2.2.1 2001/12/09 06:50:03 mike Exp $
  * $DragonFly: src/lib/libc/string/strnstr.c,v 1.4 2006/03/20 17:24:20 dillon Exp $
  */
@@ -98,3 +98,4 @@ squid_strnstr(const char *s, const char *find, size_t slen)
 
 #endif /* !HAVE_STRNSTR */
 #endif /* SQUID_COMPAT_STRNSTR_CC_ */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -20,8 +20,8 @@
  *    documentation and/or other materials provided with the distribution.
  * 3. All advertising materials mentioning features or use of this software
  *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
+ *  This product includes software developed by the University of
+ *  California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -23,3 +23,4 @@ SQUIDCEXTERN int64_t strtoll(const char *nptr, char **endptr, int base);
 
 #endif /* !HAVE_STRTOLL */
 #endif /* _SQUID_COMPAT_STRTOLL_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -31,20 +31,20 @@
 
 #undef TMP_MAX
 
-#define _tmp		"/tmp/"
-#define lengthof_tmp	5
+#define _tmp        "/tmp/"
+#define lengthof_tmp    5
 
 #ifndef LONG_BIT
-#define LONG_BIT	(CHAR_BIT * 4)	/* assume sizeof(long) == 4 */
+#define LONG_BIT    (CHAR_BIT * 4)  /* assume sizeof(long) == 4 */
 #endif
 
-#define L_tmpmin	(lengthof_tmp + 5)	/* 5 chars for pid. */
+#define L_tmpmin    (lengthof_tmp + 5)  /* 5 chars for pid. */
 
 #if (L_tmpnam > L_tmpmin)
-#if (L_tmpnam > L_tmpmin + LONG_BIT / 6)	/* base 64 */
-#define TMP_MAX	ULONG_MAX
+#if (L_tmpnam > L_tmpmin + LONG_BIT / 6)    /* base 64 */
+#define TMP_MAX ULONG_MAX
 #else
-#define TMP_MAX	((1L << (6 * (L_tmpnam - L_tmpmin))) - 1)
+#define TMP_MAX ((1L << (6 * (L_tmpnam - L_tmpmin))) - 1)
 #endif
 #else
 #ifndef L_tmpnam
@@ -60,10 +60,10 @@ _tmpnam(void)
     static const char digits[] =
 #if (L_tmpnam >= L_tmpmin + LONG_BIT / 4)
         "0123456789abcdef";
-#define TMP_BASE	16
+#define TMP_BASE    16
 #else
         "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";
-#define TMP_BASE	64
+#define TMP_BASE    64
 #endif
     static unsigned long lastcount = 0;
     static char buffer[L_tmpnam + 1];
@@ -72,7 +72,7 @@ _tmpnam(void)
     pid_t pid = getpid();
 
     if (sizeof(_tmp) - 1 != lengthof_tmp)
-        abort();		/* Consistency error. */
+        abort();        /* Consistency error. */
 
     for (;;) {
         register int i = L_tmpnam;
@@ -135,3 +135,4 @@ main()
     return 1;
 }
 #endif
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -31,3 +31,4 @@
 extern char *tempnam(const char *, const char *);
 
 #endif /* SQUID_TEMPNAM_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -8,6 +8,7 @@
 
 #include "squid.h"
 #include "testPreCompiler.h"
+#include "unitTestMain.h"
 
 #include <cassert>
 
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -30,3 +30,4 @@ class testPreCompiler : public CPPUNIT_NS::TestFixture
 };
 
 #endif /* SQUID_COMPAT_TESTS_TESTPRECOMPILER_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -124,3 +124,4 @@ typedef long mtyp_t;
 #endif
 
 #endif /* SQUID_TYPES_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -43,3 +43,4 @@
 #endif /* WITH_VALGRIND */
 
 #endif /* SQUID_CONFIG_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -176,3 +176,4 @@ free_const(const void *s_const)
     PROF_stop(free);
     PROF_stop(free_const);
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -13,63 +13,63 @@
 extern "C" {
 #endif
 
-    /**
-     * xcalloc() - same as calloc(3).  Used for portability.
-     * Never returns NULL; fatal on error.
-     *
-     * Define failure_notify to receive error message.
-     * otherwise perror() is used to display it.
-     */
-    void *xcalloc(size_t n, size_t sz);
+/**
+ * xcalloc() - same as calloc(3).  Used for portability.
+ * Never returns NULL; fatal on error.
+ *
+ * Define failure_notify to receive error message.
+ * otherwise perror() is used to display it.
+ */
+void *xcalloc(size_t n, size_t sz);
 
-    /**
-     * xmalloc() - same as malloc(3).  Used for portability.
-     * Never returns NULL; fatal on error.
-     *
-     * Define failure_notify to receive error message.
-     * otherwise perror() is used to display it.
-     */
-    void *xmalloc(size_t sz);
+/**
+ * xmalloc() - same as malloc(3).  Used for portability.
+ * Never returns NULL; fatal on error.
+ *
+ * Define failure_notify to receive error message.
+ * otherwise perror() is used to display it.
+ */
+void *xmalloc(size_t sz);
 
-    /**
-     * xrealloc() - same as realloc(3). Used for portability.
-     * Never returns NULL; fatal on error.
-     */
-    void *xrealloc(void *s, size_t sz);
+/**
+ * xrealloc() - same as realloc(3). Used for portability.
+ * Never returns NULL; fatal on error.
+ */
+void *xrealloc(void *s, size_t sz);
 
-    /**
-     * free_const() - Same as free(3).  Used for portability.
-     * Accepts pointers to dynamically allocated const data.
-     *
-     * Define failure_notify to receive error message.
-     * otherwise perror() is used to display it.
-     */
-    void free_const(const void *s);
+/**
+ * free_const() - Same as free(3).  Used for portability.
+ * Accepts pointers to dynamically allocated const data.
+ *
+ * Define failure_notify to receive error message.
+ * otherwise perror() is used to display it.
+ */
+void free_const(const void *s);
 
-    /**
-     *  xfree() - same as free(3).  Used for portability.
-     * Accepts pointers to dynamically allocated const data.
-     * Will not call free(3) if the pointer is NULL.
-     *
-     * Pointer is left with a value on completion.
-     * Use safe_free() if the pointer needs to be set to NULL afterward.
-     *
-     * Define failure_notify to receive error message.
-     * otherwise perror() is used to display it.
-     */
-    static inline void xfree(const void *p) { if (p) free_const(p); }
+/**
+ *  xfree() - same as free(3).  Used for portability.
+ * Accepts pointers to dynamically allocated const data.
+ * Will not call free(3) if the pointer is NULL.
+ *
+ * Pointer is left with a value on completion.
+ * Use safe_free() if the pointer needs to be set to NULL afterward.
+ *
+ * Define failure_notify to receive error message.
+ * otherwise perror() is used to display it.
+ */
+static inline void xfree(const void *p) { if (p) free_const(p); }
 
-    /**
-     *  safe_free() - same as free(3).  Used for portability.
-     * Accepts pointers to dynamically allocated const data.
-     * Will not call free(3) if the pointer is NULL.
-     * Sets the pointer to NULL on completion.
-     *
-     * Use xfree() if the pointer does not need to be set afterward.
-     *
-     * Define failure_notify to receive error message.
-     * otherwise perror() is used to display it.
-     */
+/**
+ *  safe_free() - same as free(3).  Used for portability.
+ * Accepts pointers to dynamically allocated const data.
+ * Will not call free(3) if the pointer is NULL.
+ * Sets the pointer to NULL on completion.
+ *
+ * Use xfree() if the pointer does not need to be set afterward.
+ *
+ * Define failure_notify to receive error message.
+ * otherwise perror() is used to display it.
+ */
 #define safe_free(x)    while ((x)) { free_const((x)); (x) = NULL; }
 
 #ifdef __cplusplus
@@ -81,3 +81,4 @@ extern void malloc_statistics(void (*func) (int, int, int, void *), void *data);
 #endif
 
 #endif /* _SQUID_COMPAT_XALLOC_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -28,3 +28,4 @@
 #define xisgraph(x) isgraph((unsigned char)x)
 
 #endif /* _SQUID_COMPAT_XIS_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -107,3 +107,4 @@ xstrerr(int error)
 
     return xstrerror_buf;
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -27,3 +27,4 @@
 extern const char * xstrerr(int error);
 
 #endif /* _SQUID_COMPAT_XSTRERROR_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -79,3 +79,4 @@ xstrndup(const char *s, size_t n)
     p = xstrncpy((char *)xmalloc(sz), s, sz);
     return p;
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -17,40 +17,40 @@
 extern "C" {
 #endif
 
-    /**
-     * xstrdup() - same as strdup(3).  Used for portability.
-     * Never returns NULL; fatal on error.
-     *
-     * Sets errno to EINVAL if a NULL pointer is passed.
-     *
-     * Define failure_notify to receive error message.
-     * otherwise perror() is used to display it.
-     */
-    char *xstrdup(const char *s);
+/**
+ * xstrdup() - same as strdup(3).  Used for portability.
+ * Never returns NULL; fatal on error.
+ *
+ * Sets errno to EINVAL if a NULL pointer is passed.
+ *
+ * Define failure_notify to receive error message.
+ * otherwise perror() is used to display it.
+ */
+char *xstrdup(const char *s);
 
 #ifdef strdup
 #undef strdup
 #endif
 #define strdup(X) xstrdup((X))
 
-    /*
-     *  xstrncpy() - similar to strncpy(3) but terminates string
-     *  always with '\0' if (n != 0 and dst != NULL),
-     *  and doesn't do padding
-     */
-    char *xstrncpy(char *dst, const char *src, size_t n);
+/*
+ *  xstrncpy() - similar to strncpy(3) but terminates string
+ *  always with '\0' if (n != 0 and dst != NULL),
+ *  and doesn't do padding
+ */
+char *xstrncpy(char *dst, const char *src, size_t n);
 
-    /**
-     * xstrndup() - same as strndup(3).  Used for portability.
-     * Never returns NULL; fatal on error.
-     *
-     * Sets errno to EINVAL if a NULL pointer or negative
-     * length is passed.
-     *
-     * Define failure_notify to receive error message.
-     * otherwise perror() is used to display it.
-     */
-    char *xstrndup(const char *s, size_t n);
+/**
+ * xstrndup() - same as strndup(3).  Used for portability.
+ * Never returns NULL; fatal on error.
+ *
+ * Sets errno to EINVAL if a NULL pointer or negative
+ * length is passed.
+ *
+ * Define failure_notify to receive error message.
+ * otherwise perror() is used to display it.
+ */
+char *xstrndup(const char *s, size_t n);
 
 #ifdef strndup
 #undef strndup
@@ -62,3 +62,4 @@ extern "C" {
 #endif
 
 #endif /* SQUID_COMPAT_XSTRING_H */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -28,8 +28,8 @@
  * Update/Maintenance History:
  *
  *    12-Sep-2010 : Copied from iptables xtables.c
- * 			- xtables_strtoui renamed to xstrtoui
- * 			- xtables_strtoul renamed to xstrtoul
+ *          - xtables_strtoui renamed to xstrtoui
+ *          - xtables_strtoul renamed to xstrtoul
  *
  *  Original License and code follows.
  */
@@ -100,3 +100,4 @@ xstrtoui(const char *s, char **end, unsigned int *value,
 }
 
 #endif /* SQUID_XSTRTO_C_ */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -40,3 +40,4 @@ bool xstrtoui(const char *s, char **end, unsigned int *value,
 
 #endif /* __cplusplus */
 #endif /* _SQUID_XSTRTO_H */
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -93,16 +93,7 @@ if test "x$squid_host_os" = "solaris" -a "x$GCC" != "x" ; then
 fi
 
 # Check for C++11 compiler support
-if test "x$squid_host_os" != "xmingw" ; then
-    #BUG 3613: when clang -std=c++0x is used, it activates a "strict mode"
-    # in the system libraries, which makes some c99 methods unavailable
-    # (e.g. strtoll), yet configure detects them as avilable.
-    case "$CXX" in
-      *clang++*) ;; #do nothing
-      *)
-      AX_CXX_COMPILE_STDCXX_11([noext],[optional])
-    esac
-fi
+AX_CXX_COMPILE_STDCXX_11([noext],[optional])
 
 # test for programs
 AC_PROG_RANLIB
@@ -373,11 +364,18 @@ else
   SQUID_CXXFLAGS=
 fi
 
+dnl CentOS (and RHEL) still define ntohs() using deprecated C++ features
+SQUID_CC_REQUIRE_ARGUMENT([ac_cv_require_wno_deprecated_register],[-Werror -Wno-deprecated-register],[[#include <arpa/inet.h>]],[[int fox=ntohs(1);]])
+
 if test "x$enable_strict_error_checking" != "xno"; then
   SQUID_CFLAGS="$SQUID_CFLAGS $squid_cv_cc_option_werror"
   SQUID_CXXFLAGS="$SQUID_CXXFLAGS $squid_cv_cxx_option_werror"
 fi
 
+if test "x$ac_cv_require_wno_deprecated_register" = "xyes"; then
+  SQUID_CXXFLAGS="$SQUID_CXXFLAGS -Wno-deprecated-register"
+fi
+
 # squid_cv_cc_arg_pipe is set by SQUID_CC_GUESS_OPTIONS
 SQUID_CXXFLAGS="$SQUID_CXXFLAGS $squid_cv_cc_arg_pipe"
 SQUID_CFLAGS="$SQUID_CFLAGS $squid_cv_cc_arg_pipe"
@@ -1210,6 +1208,30 @@ if test "x$with_nettle" != "xno" ; then
     NETTLELIB="$NETTLELIBDIR -lnettle"
     AC_CHECK_HEADERS(nettle/md5.h)
   ],[with_nettle=no])
+  if test "x$with_nettle" != "xno" ; then
+    # Base64 uses the nettle 3.0 API
+    # which matters on 64-bit systems
+    AC_CHECK_HEADERS(nettle/base64.h)
+    AC_MSG_CHECKING([for Nettle 3.0 API compatibility])
+    AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
+#     include <cstddef>
+#     include <cstdint>
+#     include <nettle/base64.h>
+    ]],[[
+      uint8_t inData[10]; inData[0] = '\0';
+      size_t srcLen = 0;
+      struct base64_decode_ctx ctx;
+      base64_decode_init(&ctx);
+      uint8_t outData[10];
+      size_t dstLen = 0;
+      if (!base64_decode_update(&ctx, &dstLen, outData, srcLen, inData) ||
+              !base64_decode_final(&ctx)) {
+          return 1;
+      }
+    ]])],[AC_MSG_RESULT(yes)
+      AC_DEFINE(HAVE_NETTLE30_BASE64,1,[set to 1 if Nettle 3.0 API will link])
+    ],[AC_MSG_RESULT(no)])
+  fi
 fi
 AC_MSG_NOTICE([Using Nettle cryptographic library: ${with_nettle:=yes}])
 AC_SUBST(NETTLELIB)
@@ -2754,26 +2776,20 @@ AC_CHECK_HEADERS( \
   glob.h \
   gnumalloc.h \
   grp.h \
-  ip_compat.h \
-  ip_fil_compat.h \
-  ip_fil.h \
-  ip_nat.h \
   ipl.h \
   lber.h \
   ldap.h \
   libc.h \
   limits.h \
   linux/posix_types.h \
   linux/types.h \
-  machine/byte_swap.h \
   malloc.h \
   math.h \
   memory.h \
   mount.h \
   netdb.h \
   netinet/in.h \
   netinet/in_systm.h \
-  netinet/ip_fil_compat.h \
   netinet/tcp.h \
   paths.h \
   poll.h \
@@ -2790,8 +2806,6 @@ AC_CHECK_HEADERS( \
   string.h \
   strings.h \
   sys/bitypes.h \
-  sys/bswap.h \
-  sys/endian.h \
   sys/file.h \
   sys/ioctl.h \
   sys/ipc.cc \
@@ -2850,12 +2864,8 @@ AC_CHECK_HEADERS( \
   netinet/in.h \
   netinet/ip.h \
   netinet/ip6.h \
-  netinet/ip_compat.h\
-  netinet/ip_fil_compat.h\
-  netinet/ip_fil.h\
   netinet/ip_icmp.h \
   netinet/ipl.h \
-  netinet/ip_nat.h\
   net/pf/pfvar.h \
   net/pfvar.h \
   sys/mount.h\
@@ -3304,10 +3314,6 @@ dnl Check for library functions
 AC_CHECK_FUNCS(\
 	backtrace_symbols_fd \
 	bcopy \
-	bswap_16 \
-	bswap_32 \
-	bswap16 \
-	bswap32 \
 	eui64_aton \
 	fchmod \
 	getdtablesize \
@@ -3318,8 +3324,6 @@ AC_CHECK_FUNCS(\
 	getspnam \
 	gettimeofday \
 	glob \
-	htobe16 \
-	htole16 \
 	lrand48 \
 	mallocblksize \
 	mallopt \
@@ -3364,17 +3368,42 @@ AC_CHECK_FUNCS(\
 dnl ... and some we provide local replacements for
 AC_REPLACE_FUNCS(\
 	drand48 \
-	inet_ntop \
-	inet_pton \
 	initgroups \
-	getaddrinfo \
-	getnameinfo \
 	psignal \
 	strerror \
 	strtoll \
 	tempnam \
 )
 
+AC_CHECK_DECLS([getaddrinfo,getnameinfo,inet_ntop,inet_pton,InetNtopA,InetPtonA],,,[
+/*
+ * BSD requires sys/types.h, sys/socket.h, netinet/in.h, netdb.h, arpa/inet.h
+ * Linux requires sys/types.h, sys/socket.h, arpa/inet.h
+ * Windows requires sys/socket.h, winsock2.h, ws2tcpip.h
+ */
+#if HAVE_SYS_TYPES_H
+#include <sys/types.h>
+#endif
+#if HAVE_NETINET_IN_H
+#include <netinet/in.h>
+#endif
+#if HAVE_SYS_SOCKET_H
+#include <sys/socket.h>
+#endif
+#if HAVE_NETDB_H
+#include <netdb.h>
+#endif
+#if HAVE_ARPA_INET_H
+#include <arpa/inet.h>
+#endif
+#if HAVE_WINSOCK2_H
+#include <winsock2.h>
+#endif
+#if HAVE_WS2TCPIP_H
+#include <ws2tcpip.h>
+#endif
+])
+
 # Magic which checks whether we are forcing a type of comm loop we
 # are actually going to (ab)use.
 # Mostly ripped from squid-commloops, thanks to adrian and benno
@@ -3496,19 +3525,19 @@ SQUID_CHECK_FUNC_STRNSTR
 SQUID_CHECK_FUNC_VACOPY
 SQUID_CHECK_FUNC___VACOPY
 
-  
 dnl IP-Filter support requires ipf header files. These aren't
 dnl installed by default, so we need to check for them
 if test "x$enable_ipf_transparent" != "xno" ; then
+    SQUID_CHECK_BROKEN_SOLARIS_IPFILTER
     AC_MSG_CHECKING(for availability of IP-Filter header files)
     # hold on to your hats...
     if test "x$ac_cv_header_ip_compat_h" = "xyes" -o \
         "x$ac_cv_header_ip_fil_compat_h" = "xyes" -o \
         "x$ac_cv_header_netinet_ip_compat_h" = "xyes" -o \
         "x$ac_cv_header_netinet_ip_fil_compat_h" = "xyes" ; then
         have_ipfilter_compat_header="yes"
-     fi
-     if test "x$have_ipfilter_compat_header" = "xyes" -a \
+    fi
+    if test "x$have_ipfilter_compat_header" = "xyes" -a \
        "x$ac_cv_header_ip_fil_h" = "xyes" -a \
        "x$ac_cv_header_ip_nat_h" = "xyes" ; then
         enable_ipf_transparent="yes"
@@ -3520,19 +3549,20 @@ if test "x$enable_ipf_transparent" != "xno" ; then
         enable_ipf_transparent="no"
     fi
     AC_MSG_RESULT($IPF_TRANSPARENT)
+
+## On Solaris Ipfilter includes expect that SOLARIS2 is defined with the
+## Solaris minor version (8, 9, 10, ...)
+  if test "x$enable_ipf_transparent" = "xyes" -a "x$squid_host_os" = "xsolaris" ; then
+    solrev=`uname -r | sh -c 'IFS=. read j n x; echo $n'`
+    CFLAGS="-DSOLARIS2=$solrev $CFLAGS"
+    CXXFLAGS="-DSOLARIS2=$solrev $CXXFLAGS"
+  fi
+
 fi
 AC_MSG_NOTICE([IPF-based transparent proxying enabled: $enable_ipf_transparent])
 SQUID_DEFINE_BOOL(IPF_TRANSPARENT,$enable_ipf_transparent,
     [Enable support for IPF-style transparent proxying])
 
-if test "x$enable_ipf_transparent" = "xyes" -a "x$squid_host_os" = "xsolaris" ; then
-dnl On Solaris Ipfilter includes expect that SOLARIS2 is defined with the
-dnl Solaris minor version (8, 9, 10, ...)
-  solrev=`uname -r | sh -c 'IFS=. read j n x; echo $n'`
-  CFLAGS="-DSOLARIS2=$solrev $CFLAGS" 
-  CXXFLAGS="-DSOLARIS2=$solrev $CXXFLAGS" 
-fi
-
 dnl PF /dev/pf support requires a header file.
 if test "x$with_nat_devpf" != "xno" ; then
   if test "x$ac_cv_header_net_pfvar_h" = "xyes" -o \
@@ -3752,82 +3782,29 @@ rm -f core
 AC_CONFIG_FILES([
 	Makefile
 	compat/Makefile
-	lib/Makefile
-	lib/ntlmauth/Makefile
-	lib/libTrie/Makefile
-	lib/libTrie/test/Makefile
-	lib/profiler/Makefile
-	lib/rfcnb/Makefile
-	lib/smblib/Makefile
-	lib/snmplib/Makefile
-	scripts/Makefile
-	src/Makefile
-	src/anyp/Makefile
-	src/ftp/Makefile
-	src/base/Makefile
-	src/acl/Makefile
-	src/clients/Makefile
-	src/servers/Makefile
-	src/fs/Makefile
-	src/repl/Makefile
-	src/auth/Makefile
-	src/auth/basic/Makefile
-	src/auth/digest/Makefile
-	src/auth/negotiate/Makefile
-	src/auth/ntlm/Makefile
-	src/adaptation/Makefile
-	src/adaptation/icap/Makefile
-	src/adaptation/ecap/Makefile
-	src/comm/Makefile
-	src/esi/Makefile
-	src/eui/Makefile
-	src/format/Makefile
-	src/helper/Makefile
-	src/http/Makefile
-	src/http/one/Makefile
-	src/icmp/Makefile
-	src/ident/Makefile
-	src/ip/Makefile
-	src/log/Makefile
-	src/ipc/Makefile
-	src/ssl/Makefile
-	src/mgr/Makefile
-	src/parser/Makefile
-	src/snmp/Makefile
 	contrib/Makefile
-	icons/Makefile
-	errors/Makefile
-	test-suite/Makefile
 	doc/Makefile
 	doc/manuals/Makefile
+	errors/Makefile
 	helpers/Makefile
 	helpers/basic_auth/Makefile
 	helpers/basic_auth/DB/Makefile
 	helpers/basic_auth/fake/Makefile
 	helpers/basic_auth/getpwnam/Makefile
 	helpers/basic_auth/LDAP/Makefile
-	helpers/basic_auth/MSNT/Makefile
-	helpers/basic_auth/MSNT-multi-domain/Makefile
 	helpers/basic_auth/NCSA/Makefile
 	helpers/basic_auth/NIS/Makefile
 	helpers/basic_auth/PAM/Makefile
 	helpers/basic_auth/POP3/Makefile
 	helpers/basic_auth/RADIUS/Makefile
 	helpers/basic_auth/SASL/Makefile
 	helpers/basic_auth/SMB/Makefile
+	helpers/basic_auth/SMB_LM/Makefile
 	helpers/basic_auth/SSPI/Makefile
 	helpers/digest_auth/Makefile
 	helpers/digest_auth/eDirectory/Makefile
 	helpers/digest_auth/file/Makefile
 	helpers/digest_auth/LDAP/Makefile
-	helpers/ntlm_auth/Makefile
-	helpers/ntlm_auth/fake/Makefile
-	helpers/ntlm_auth/smb_lm/Makefile
-	helpers/ntlm_auth/SSPI/Makefile
-	helpers/negotiate_auth/Makefile
-	helpers/negotiate_auth/kerberos/Makefile
-	helpers/negotiate_auth/SSPI/Makefile
-	helpers/negotiate_auth/wrapper/Makefile
 	helpers/external_acl/Makefile
 	helpers/external_acl/AD_group/Makefile
 	helpers/external_acl/delayer/Makefile
@@ -3844,15 +3821,71 @@ AC_CONFIG_FILES([
 	helpers/log_daemon/Makefile
 	helpers/log_daemon/DB/Makefile
 	helpers/log_daemon/file/Makefile
-	helpers/url_rewrite/Makefile
-	helpers/url_rewrite/fake/Makefile
+	helpers/negotiate_auth/Makefile
+	helpers/negotiate_auth/kerberos/Makefile
+	helpers/negotiate_auth/SSPI/Makefile
+	helpers/negotiate_auth/wrapper/Makefile
+	helpers/ntlm_auth/Makefile
+	helpers/ntlm_auth/fake/Makefile
+	helpers/ntlm_auth/smb_lm/Makefile
+	helpers/ntlm_auth/SSPI/Makefile
 	helpers/ssl/Makefile
 	helpers/storeid_rewrite/Makefile
 	helpers/storeid_rewrite/file/Makefile
+	helpers/url_rewrite/Makefile
+	helpers/url_rewrite/fake/Makefile
+	helpers/url_rewrite/LFS/Makefile
+	icons/Makefile
+	lib/Makefile
+	lib/libTrie/Makefile
+	lib/libTrie/test/Makefile
+	lib/ntlmauth/Makefile
+	lib/profiler/Makefile
+	lib/rfcnb/Makefile
+	lib/smblib/Makefile
+	lib/snmplib/Makefile
+	scripts/Makefile
+	src/Makefile
+	src/acl/Makefile
+	src/adaptation/Makefile
+	src/adaptation/icap/Makefile
+	src/adaptation/ecap/Makefile
+	src/anyp/Makefile
+	src/auth/Makefile
+	src/auth/basic/Makefile
+	src/auth/digest/Makefile
+	src/auth/negotiate/Makefile
+	src/auth/ntlm/Makefile
+	src/base/Makefile
+	src/clients/Makefile
+	src/comm/Makefile
+	src/esi/Makefile
+	src/eui/Makefile
+	src/format/Makefile
+	src/fs/Makefile
+	src/ftp/Makefile
+	src/helper/Makefile
+	src/http/Makefile
+	src/http/one/Makefile
+	src/icmp/Makefile
+	src/ident/Makefile
+	src/ip/Makefile
+	src/ipc/Makefile
+	src/log/Makefile
+	src/mem/Makefile
+	src/mgr/Makefile
+	src/parser/Makefile
+	src/repl/Makefile
+	src/servers/Makefile
+	src/snmp/Makefile
+	src/ssl/Makefile
+	test-suite/Makefile
 	tools/Makefile
 	tools/helper-mux/Makefile
-	tools/squidclient/Makefile
 	tools/purge/Makefile
+	tools/squidclient/Makefile
+	tools/systemd/Makefile
+	tools/sysvinit/Makefile
 ])
 
 # must configure libltdl subdir unconditionally for "make distcheck" to work
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -10,15 +10,12 @@
 # using a SVR4-based startup mechanism/file system layout
 #
 
-SQUID_RC        = squid.rc
+SQUID_RC        = $(top_srcdir)/tools/sysvinit/squid.rc
 SQUID_OPTIONS   = squid.options
 
 EXTRA_DIST = \
 	squid.options \
 	config.site \
-	squid.rc \
-	rredir.c \
-	rredir.pl \
 	user-agents.pl \
 	url-normalizer.pl \
 	nextstep/Makefile \
@@ -1,60 +0,0 @@
-#!/usr/bin/perl -T -w
-#
-# rredir.pl
-#
-# Author: Peter Eisenhauer <pe@pipetronix.de>
-# First Version: 26. May 1997
-#
-# Description: Direct all request to files who are in a local dir to
-# this directory
-# 
-use File::Basename;
-use URI::URL;
-
-# customization part
-
-# Local Domainame from which no redirects should be done
-$localdomain = 'pipetronix.de';
-# Local domainame qouted for regexps
-$regexlocaldomain = quotemeta($localdomain);
-# Path under which the scripts accesses the local dir (must end with /)
-$access_local_dir='/opt/utils/etc/httpd/htdocs/local-rredir/';
-# Information for the redirected URL (redirect_path must end with /)
-$redirect_scheme = 'http';
-$redirect_host = 'ws-server.pipetronix.de';
-$redirect_path = 'local-rredir/';
-
-# end of customization part
-
-# flush after every print
-$| = 1;
-
-# Process lines of the form 'URL ip-address/fqdn ident method'
-# See release notes of Squid 1.1 for details
-while ( <> ) {
-    ($url, $addr, $fqdn, $ident, $method) = m:(\S*) (\S*)/(\S*) (\S*) (\S*):;
-
-    $url = url $url;
-    $host = lc($url->host);
-
-    # do not process hosts in local domain or unqualified hostnames
-    if ( $host =~ /$regexlocaldomain/ || $host !~ /\./ ) {
-	next;
-    }
-
-    # just the file, without any host or path parts
-    # and just in case: lowercase the file name, so you should make sure
-    # all the files in the local dir are only lowercase !!
-    $file = lc(basename($url->path));
-
-    # look if in local dir, if yes redirect
-    if ( $file && -r $access_local_dir . $file
-	&& $file ne '.' && $file ne '..' ) {
-	$url->scheme($redirect_scheme);
-	$url->host($redirect_host);
-	$url->path($redirect_path . $file);
-    }
-
-} continue {
-    print "$url $addr/$fqdn $ident $method\n"
-}
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1 +1,8 @@
 </div>
+<!--
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+-->
@@ -1,4 +1,11 @@
 <hr size="1"><address style="text-align: right;"><small>
 Generated on $datetime for $projectname by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> $doxygenversion</small></address>
+<small>
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+<br>
+Squid software is distributed under GPLv2+ license and includes
+contributions from numerous individuals and organizations.
+Please see the COPYING and CONTRIBUTORS files for details.
+</small>
 </body>
 </html>
@@ -1 +1,8 @@
+<!--
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+-->
 <div id="doxypage">
@@ -1,5 +1,7 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
-<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
+<html><head>
+<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
+<meta name="dcterms.rights" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <title>Squid3 Programmers Guide - $title</title>
 <link href="$relpath$doxygen.css" rel="stylesheet" type="text/css">
 <link href="$relpath$tabs.css" rel="stylesheet" type="text/css">
@@ -1,62 +0,0 @@
-This version of squid has been patched with the wccpv2 support patch.  To
-enable this option, use the --enable-wccpv2 option on the configure script.
-
-Wccpv2 allows a single cache to associate itself with multiple routers, and
-also allows multiple wccp services to be defined.  The other advantage of
-wccpv2 is that the cisco IOS uses CEF to switch the packets.
-
-Example simple web cache
-------------------------
-
-Internet <-> fa0/0 2621 fa0/1 <-> cache, internal network
-
-squid.conf:
-
-wccp2_router 192.168.2.1:2048
-wccp2_version 4
-wccp2_forwarding_method 1
-wccp2_return_method 1
-wccp2_service standard 0
-
-Router config:
-
-ip wccp web-cache
-!
-interface FastEthernet0/0
- description uplink
- ip address 192.168.1.200 255.255.255.0
- ip wccp web-cache redirect out
- duplex auto
- speed auto
-!
-interface FastEthernet0/1
- description local network
- ip address 192.168.2.1 255.255.255.0
- duplex auto
- speed auto
-!
-
-Note the cache is on the internal network (Fa0/1), the interception occurs
-on the uplink interface(0/0).
-
-Linux (Kernel 2.6.10, i386) side of things:
-
-#!/bin/sh
-echo "1" > /proc/sys/net/ipv4/ip_forward
-echo "0" > /proc/sys/net/ipv4/conf/all/rp_filter
-iptunnel add gre1 mode gre remote 192.168.2.1 local 192.168.2.2 dev eth0
-ifconfig gre1 up 127.0.0.2
-iptables -t nat -F
-# iptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3128
-iptables -t nat -A PREROUTING -i gre1 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.2.2:3128 
-
-
-TODO
-----
-
-* The wccp2 router configuration need to have a better configuration interface
-  (it currently uses ip:port when only the ip address is needed).
-* A shutting-down cache should generate a removal query, informing the router
-  (and therefore the caches in the group) that this cache is going
-  away and no new traffic should be forwarded to it.
-* Some more documentation, examples, etc.
@@ -1,11 +1,12 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
  * Please see the COPYING and CONTRIBUTORS files for details.
  */
 
+
 section 00    Announcement Server
 section 00    Client Database
 section 00    Debug Routines
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,10 +1,11 @@
 ##
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
+
 TRANSLATE_LANGUAGES= \
     ar.lang \
     cs.lang \
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1082,7 +1082,7 @@ See the accf_http(9) man page.
 
 <sect>Copyright
 <p>
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 <p>
 Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
@@ -1779,7 +1779,7 @@ This section gives an account of those changes in three categories:
 
 <sect>Copyright
 <p>
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 <p>
 Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
@@ -1117,7 +1117,7 @@ This section gives an account of those changes in three categories:
 
 <sect>Copyright
 <p>
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 <p>
 Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
@@ -363,7 +363,7 @@ This section gives an account of those changes in three categories:
 
 <sect>Copyright
 <p>
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 <p>
 Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
@@ -1,6 +1,6 @@
 <!doctype linuxdoc system>
 <article>
-<title>Squid 3.4.9 release notes</title>
+<title>Squid 3.4.11 release notes</title>
 <author>Squid Developers</author>
 
 <abstract>
@@ -13,7 +13,7 @@ for Applied Network Research and members of the Web Caching community.
 
 <sect>Notice
 <p>
-The Squid Team are pleased to announce the release of Squid-3.4.9 for testing.
+The Squid Team are pleased to announce the release of Squid-3.4.11 for testing.
 
 This new release is available for download from <url url="http://www.squid-cache.org/Versions/v3/3.4/"> or the
  <url url="http://www.squid-cache.org/Mirrors/http-mirrors.html" name="mirrors">.
@@ -495,7 +495,7 @@ This section gives an account of those changes in three categories:
 
 <sect>Copyright
 <p>
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 <p>
 Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
@@ -1,6 +1,6 @@
 <!doctype linuxdoc system>
 <article>
-<title>Squid 3.5.0.2 release notes</title>
+<title>Squid 3.5.1 release notes</title>
 <author>Squid Developers</author>
 
 <abstract>
@@ -13,12 +13,13 @@ for Applied Network Research and members of the Web Caching community.
 
 <sect>Notice
 <p>
-The Squid Team are pleased to announce the release of Squid-3.5.0.2 for testing.
+The Squid Team are pleased to announce the release of Squid-3.5.1 for testing.
 
 This new release is available for download from <url url="http://www.squid-cache.org/Versions/v3/3.5/"> or the
  <url url="http://www.squid-cache.org/Mirrors/http-mirrors.html" name="mirrors">.
 
-<p>While this release is not deemed ready for production use, we believe it is ready for wider testing by the community.
+<p>Some interesting new features adding system flexibility have been added along with general improvements all around.
+   While this release is not fully bug-free we believe it is ready for use in production on many systems.
 
 <p>We welcome feedback and bug reports. If you find a bug, please see <url url="http://wiki.squid-cache.org/SquidFaq/BugReporting">
    for how to submit a report with a stack trace.
@@ -63,6 +64,7 @@ The 3.5 change history can be <url url="http://www.squid-cache.org/Versions/v3/3
 	<item>Helper support for concurrency channels
 	<item>Native FTP Relay
 	<item>Receive PROXY protocol, Versions 1 & 2
+	<item>Basic authentication MSNT helper changes
 </itemize>
 
 Most user-facing changes are reflected in squid.conf (see below).
@@ -117,7 +119,7 @@ Most user-facing changes are reflected in squid.conf (see below).
 
 
 <sect1>Upgraded squidclient tool
-<p>Details at <url="http://www.squid-cache.org/Versions/v3/3.5/manuals/squidclient.html">.
+<p>Details at <url url="http://www.squid-cache.org/Versions/v3/3.5/manuals/squidclient.html">.
 
 <p>The <em>squidclient</em> has begun the process of upgrading to support
    protocols other than HTTP.
@@ -237,7 +239,7 @@ Most user-facing changes are reflected in squid.conf (see below).
    receive traffic from client software sending in this protocol.
    HTTP traffic without the PROXY header is not accepted on such a port.
 
-<p>The <em>accel</em> and <em>intercept</em> options are still used to identify the
+<p>The <em>accel</em> and <em>intercept</em> options are still used to identify the HTTP
    traffic syntax being delivered by the client proxy.
 
 <p>Squid can be configured by adding an <em>http_port</em>
@@ -270,6 +272,23 @@ Most user-facing changes are reflected in squid.conf (see below).
    Use of <em>require-proxy-header</em> on <em>https_port</em> and <em>ftp_port</em> is not supported.
 
 
+<sect1>Basic authentication MSNT helper changes
+
+<p>The authentication helper previously known as <em>basic_msnt_auth</em> has
+   been deprecated and renamed to <em>basic_smb_lm_auth</em> to reflect that
+   it only performs SMB LanMan protocol(s) instead of modern MS authentication
+   protocols.
+
+<p>The <em>basic_smb_lm_auth</em> helper has been remodelled and no longer uses
+   configuration files. The Doman Controller servers are now configured via
+   command line parameters and user credentials are looked up in each DC in the
+   order configured until one matches or all have confirmed a non-match.
+
+<p>The <em>MSNT-multi-domain</em> helper provides the same functionality and
+   is also deprecated. It will be removed in the Squid-3.6 series.
+
+
+
 <sect>Changes to squid.conf since Squid-3.4
 <p>
 There have been changes to Squid's configuration file since Squid-3.4.
@@ -301,18 +320,14 @@ This section gives a thorough account of those changes in three categories:
 	<p>Ported from Squid-2 with no configuration or visible behaviour changes.
            Collapsing of requests is performed across SMP workers.
 
-	<tag>ftp_client_idle_timeout</tag>
-	<p>This new configuration directive controls how long Squid should
-	   wait for an FTP request on a connection to an ftp_port.  Many FTP
-	   clients do not deal with idle connection closures well,
-	   necessitating a longer default timeout (30 minutes) than
-	   client_idle_pconn_timeout used for incoming HTTP requests (2
-	   minutes). The current default may be changed as we get more
-	   experience with FTP relaying.
-
 	<tag>ftp_client_idle_timeout</tag>
 	<p>New directive controlling how long to wait for an FTP request on a
 	   client connection to Squid <em>ftp_port</em>.
+	<p>Many FTP clients do not deal with idle connection closures well,
+	   necessitating a longer default timeout (30 minutes) than
+	   <em>client_idle_pconn_timeout</em> used for incoming HTTP requests (2
+	   minutes).
+	<p>The current default may be changed as we get more experience with FTP relaying.
 
 	<tag>ftp_port</tag>
 	<p>New configuration directive to accept and relay native FTP
@@ -403,6 +418,12 @@ This section gives a thorough account of those changes in three categories:
 	   more circumstances than squid-2 idle connections were. They are
 	   also spread over all IPs of the peer.
 
+	<tag>configuration_includes_quoted_values</tag>
+	<p>Regex pattern values cannot be parsed in parts of squid.conf when this
+	   directive is configured to <em>ON</em>. Instead of quoted strings Squid
+	   now accepts regex \-escaped characters (including escaped spaces) in all
+	   regex patterns.
+
 	<tag>external_acl_type</tag>
 	<p>New format code <em>%ssl::&gt;sni</em> to send SSL client SNI.
 	<p>New format code <em>%ssl::&lt;cert_subject</em> to send SSL server certificate DN.
@@ -614,7 +635,7 @@ This section gives an account of those changes in three categories:
 
 <sect>Copyright
 <p>
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 <p>
 Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
@@ -263,7 +263,7 @@ <H2><A NAME="ss5.1">5.1</A> <A HREF="#toc5.1">Missing squid.conf options availab
 
 <H2><A NAME="s6">6.</A> <A HREF="#toc6">Copyright</A></H2>
 
-<P>Copyright (C) 1996-2014 The Squid Software Foundation and contributors</P>
+<P>Copyright (C) 1996-2015 The Squid Software Foundation and contributors</P>
 <P>Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
 Please see the COPYING and CONTRIBUTORS files for details.</P>
@@ -38,7 +38,10 @@ The 3.6 change history can be <url url="http://www.squid-cache.org/Versions/v3/3
 
 <p>The most important of these new features are:
 <itemize>
-	<item>BLAH
+	<item>Helper concurrency channels changes
+	<item>Configurable helper queue size
+	<item>SSLv2 support removal
+	<item>MSNT-multi-domain helper removal
 </itemize>
 
 Most user-facing changes are reflected in squid.conf (see below).
@@ -48,6 +51,37 @@ Most user-facing changes are reflected in squid.conf (see below).
 <p>The new queue-size=N option to helpers configuration, allows users 
 to configure the maximum number of queued requests to busy helpers.
 
+<sect1>Helper concurrency channels changes
+<p> helper-mux.pl we have been distributing for the past few years to
+    encourage use of concurrency is no longer compatible with Squid. If
+    used it will spawn up to 2^64 helpers and DoS the Squid server.
+
+<p> Helpers utilizing arrays to handle fixed amounts of concurrency
+    channels MUST be re-written to use queues and capable of handling a
+    64-bit int as index or they will be vulnerable to buffer overrun and
+    arbitrary memory accesses.
+
+<p> 32-bit helpers need re-writing to handle the concurrency channel ID
+    as a 64-bit integer value. If not updated they will cause proxies to
+    return unexpected results or timeout once crossing the 32-bit wrap
+    boundary. Leading to undefined behaviour in the client HTTP traffic.
+
+<sect1>SSLv2 support removal
+<p>Details in <url url="https://tools.ietf.org/html/rfc6176" name="RFC 6176">
+
+<p>SSLv2 is not fit for purpose. Squid no longer supports being configured with
+any settings regarding this protocol. That includes settings manually disabling
+its use since it is now forced to disable by default. Also settings enabling
+various client/server workarounds specific to SSLv2 are removed.
+
+
+<sect1>MSNT-multi-domain helper removal
+
+<p>The <em>basic_msnt_multi_domain_auth</em> helper has been removed. The
+   <em>basic_smb_lm_auth</em> helper performs the same actions without extra
+   Perl and Samba dependencies.
+
+
 <sect>Changes to squid.conf since Squid-3.5
 <p>
 There have been changes to Squid's configuration file since Squid-3.5.
@@ -64,31 +98,57 @@ This section gives a thorough account of those changes in three categories:
 <sect1>New tags<label id="newtags">
 <p>
 <descrip>
-
+         <tag> url_rewrite_timeout </tag>
+         <p> Squid times active requests to redirector. This option sets
+             the timeout value and the Squid reaction to a timed out
+             request. </p>
 </descrip>
 
 <sect1>Changes to existing tags<label id="modifiedtags">
 <p>
 <descrip>
-         <tag> auth_param </tag>
-         <p> New parameter <em>queue-size=</em> to set the maximum number
-             of queued requests.
+	<tag>auth_param</tag>
+	<p>New parameter <em>queue-size=</em> to set the maximum number
+	   of queued requests.
+
+	<tag>cache_peer</tag>
+	<p>All <em>ssloption=</em> and <em>sslversion=</em> values for
+	   SSLv2 configuration or disabling have been removed.
+	<p>Manual squid.conf update may be required on upgrade.
+
+	<tag>external_acl_type<tag>
+	<p>New parameter <em>queue-size=</em> to set the maximum number
+	   of queued requests.
+
+	<tag>http_port</tag>
+	<p>All <em>version=</em> <em>option=</em> values for SSLv2
+	   configuration or disabling have been removed.
+	<p>Manual squid.conf update may be required on upgrade.
+
+	<tag>https_port</tag>
+	<p>All <em>version=</em> <em>option=</em> values for SSLv2
+	   configuration or disabling have been removed.
+	<p>Manual squid.conf update may be required on upgrade.
+
+	<tag>sslcrtd_children</tag>
+	<p>New parameter <em>queue-size=</em> to set the maximum number
+	   of queued requests.
+
+	<tag>sslcrtvalidator_children</tag>
+	<p>New parameter <em>queue-size=</em> to set the maximum number
+	   of queued requests.
 
-         <tag>external_acl_type<tag>
-         <p> New parameter <em>queue-size=</em> to set the maximum number
-             of queued requests.
+	<tag>sslproxy_options</tag>
+	<p>All values for SSLv2 configuration or disabling have been removed.
+	<p>Manual squid.conf update may be required on upgrade.
 
-         <tag>url_rewrite_children<tag>
-         <p> New parameter <em>queue-size=</em> to set the maximum number
-             of queued requests.
+	<tag>sslproxy_version</tag>
+	<p>Value '2' for SSLv2-only operation is no longer supported.
 
-         <tag>sslcrtd_children</tag>
-         <p> New parameter <em>queue-size=</em> to set the maximum number
-             of queued requests.
+	<tag>url_rewrite_children<tag>
+	<p>New parameter <em>queue-size=</em> to set the maximum number
+	   of queued requests.
 
-         <tag>sslcrtvalidator_children</tag>
-         <p> New parameter <em>queue-size=</em> to set the maximum number
-             of queued requests.
 </descrip>
 
 <sect1>Removed tags<label id="removedtags">
@@ -120,6 +180,8 @@ This section gives an account of those changes in three categories:
 <sect1>Changes to existing options<label id="modifiedoptions">
 <p>
 <descrip>
+	<tag>--enable-auth-basic</tag>
+	<p>The <em>MSNT-multi-domain</em> helper has been removed.
 
 </descrip>
 </p>
@@ -185,7 +247,7 @@ This section gives an account of those changes in three categories:
 
 <sect>Copyright
 <p>
-Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 <p>
 Squid software is distributed under GPLv2+ license and includes
 contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,6 +1,6 @@
 #!/bin/sh
 #
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,10 +1,11 @@
 ##
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
+
 TRANSLATE_LANGUAGES= \
     af.lang \
     ar.lang \
@@ -1,10 +1,11 @@
 ##
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
+
 ERROR_TEMPLATES= \
     templates/ERR_ACCESS_DENIED \
     templates/ERR_ACL_TIME_QUOTA_EXCEEDED \
@@ -36,6 +37,7 @@ ERROR_TEMPLATES= \
     templates/ERR_NO_RELAY \
     templates/ERR_ONLY_IF_CACHED_MISS \
     templates/ERR_PRECONDITION_FAILED \
+    templates/ERR_PROTOCOL_UNKNOWN \
     templates/ERR_READ_ERROR \
     templates/ERR_READ_TIMEOUT \
     templates/ERR_SECURE_CONNECT_FAIL \
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!--
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>Web Browser Configuration</title>
 <style type="text/css"><!--
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>Web Browser Configuration</title>
 <style type="text/css"><!--
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: Cache Access Denied</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: Cache Manager Access Denied</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" CONTENT="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>Directory: %U</title>
 <style type="text/css"><!--
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>FTP PUT Successful.</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: FTP upload failed</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>FTP PUT Successful.</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -0,0 +1,38 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
+<html><head>
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
+<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
+<title>ERROR: The requested URL could not be retrieved</title>
+<style type="text/css"><!-- 
+ %l
+
+body
+:lang(fa) { direction: rtl; font-size: 100%; font-family: Tahoma, Roya, sans-serif; float: right; }
+:lang(he) { direction: rtl; }
+ --></style>
+</head><body id=%c>
+<div id="titles">
+<h1>ERROR</h1>
+<h2>The requested URL could not be retrieved</h2>
+</div>
+<hr>
+
+<div id="content">
+<p>The following error was encountered while trying to retrieve the URL: <a href="%U">%U</a></p>
+
+<blockquote id="error">
+<p><b>Unsupported Protocol</b></p>
+</blockquote>
+
+<p>Squid does not support some access protocols. For example, the SSH protocol is currently not supported.</p>
+
+<p>Your cache administrator is <a href="mailto:%w%W">%w</a>.</p>
+<br>
+</div>
+
+<hr>
+<div id="footer">
+<p>Generated %T by %h (%s)</p>
+<!-- %c -->
+</div>
+</body></html>
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URN could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html><head>
-<meta type="copyright" content="Copyright (C) 1996-2014 The Squid Software Foundation and contributors">
+<meta type="copyright" content="Copyright (C) 1996-2015 The Squid Software Foundation and contributors">
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <title>ERROR: The requested URL could not be retrieved</title>
 <style type="text/css"><!-- 
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -7,7 +7,6 @@
 include $(top_srcdir)/src/Common.am
 
 libexec_SCRIPTS	= basic_db_auth
-CLEANFILES += basic_db_auth basic_db_auth.8
 man_MANS = basic_db_auth.8
 EXTRA_DIST= \
 	basic_db_auth.8 \
@@ -20,3 +19,5 @@ basic_db_auth.8: basic_db_auth
 
 basic_db_auth: basic_db_auth.pl.in
 	$(subst_perlshell)
+
+CLEANFILES += basic_db_auth basic_db_auth.8
@@ -1,99 +1,147 @@
 #!@PERL@
+
 use strict;
-use DBI;
-use Getopt::Long;
 use Pod::Usage;
-use Digest::MD5 qw(md5 md5_hex md5_base64);
-$|=1;
+use Getopt::Long;
 
 =pod
 
 =head1 NAME
 
-basic_db_auth - Database auth helper for Squid
-
-=cut
-
-my $dsn = "DBI:mysql:database=squid";
-my $db_user = undef;
-my $db_passwd = undef;
-my $db_table = "passwd";
-my $db_usercol = "user";
-my $db_passwdcol = "password";
-my $db_cond = "enabled = 1";
-my $plaintext = 0;
-my $md5 = 0;
-my $persist = 0;
-my $isjoomla = 0;
-my $debug = 0;
-my $hashsalt = undef;
-
-=pod
+ basic_db_auth - Database auth helper for Squid
 
 =head1 SYNOPSIS
 
-basic_db_auth [options]
+ basic_db_auth [options]
 
 =head1 DESCRIPTOIN
 
 This program verifies username & password to a database
 
-=over 8
+=head1 OPTIONS
+
+=over 12
+
+=item B<--debug>
 
-=item	B<--dsn>
+Write debug info to stderr.
+
+=item B<--dsn>
 
 Database DSN. Default "DBI:mysql:database=squid"
 
-=item	B<--user>
+=item B<--user>
 
 Database User
 
-=item	B<--password>
+=item B<--password>
 
 Database password
 
-=item	B<--table>
+=item B<--table>
 
 Database table. Default "passwd".
 
-=item	B<--usercol>
+=item B<--usercol>
 
 Username column. Default "user".
 
-=item	B<--passwdcol>
+=item B<--passwdcol>
 
 Password column. Default "password".
 
-=item	B<--cond>
+=item B<--cond>
 
 Condition, defaults to enabled=1. Specify 1 or "" for no condition
 If you use --joomla flag, this condition will be changed to block=0
 
-=item	B<--plaintext>
+=item B<--plaintext>
 
 Database contains plain-text passwords
 
-=item   B<--md5>
+=item B<--md5>
 
 Database contains unsalted md5 passwords
 
-=item	B<--salt>
+=item B<--salt>
 
 Selects the correct salt to evaluate passwords
 
-=item	B<--persist>
+=item B<--persist>
 
 Keep a persistent database connection open between queries. 
 
-=item  B<--joomla>
+=item B<--joomla>
 
 Tells helper that user database is Joomla DB.  So their unusual salt 
 hashing is understood.
 
 =back
 
+=head1 AUTHOR
+
+This program was written by
+I<Henrik Nordstrom <henrik@henriknordstrom.net>> and
+I<Luis Daniel Lucio Quiroz <dlucio@okay.com.mx>>
+
+This manual was written by I<Henrik Nordstrom <henrik@henriknordstrom.net>>
+
+=head1 COPYRIGHT
+
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+
+Copyright (C) 2007 Henrik Nordstrom <henrik@henriknordstrom.net>
+Copyright (C) 2010 Luis Daniel Lucio Quiroz <dlucio@okay.com.mx> (Joomla support)
+This program is free software. You may redistribute copies of it under the
+terms of the GNU General Public License version 2, or (at youropinion) any
+later version.
+
+=head1 QUESTIONS
+
+Questions on the usage of this program can be sent to the I<Squid Users mailing list <squid-users@squid-cache.org>>
+
+=head1 REPORTING BUGS
+
+Bug reports need to be made in English.
+See http://wiki.squid-cache.org/SquidFaq/BugReporting for details of what you need to include with your bug report.
+
+Report bugs or bug fixes using http://bugs.squid-cache.org/
+
+Report serious security bugs to I<Squid Bugs <squid-bugs@squid-cache.org>>
+
+Report ideas for new improvements to the I<Squid Developers mailing list <squid-dev@squid-cache.org>>
+
+=head1 SEE ALSO
+
+squid (8), GPL (7),
+
+The Squid FAQ wiki http://wiki.squid-cache.org/SquidFaq
+
+The Squid Configuration Manual http://www.squid-cache.org/Doc/config/
+
 =cut
 
+use DBI;
+use Digest::MD5 qw(md5 md5_hex md5_base64);
+
+my $dsn = "DBI:mysql:database=squid";
+my $db_user = undef;
+my $db_passwd = undef;
+my $db_table = "passwd";
+my $db_usercol = "user";
+my $db_passwdcol = "password";
+my $db_cond = "enabled = 1";
+my $plaintext = 0;
+my $md5 = 0;
+my $persist = 0;
+my $isjoomla = 0;
+my $debug = 0;
+my $hashsalt = undef;
+
 GetOptions(
 	'dsn=s' => \$dsn,
 	'user=s' => \$db_user,
@@ -173,6 +221,7 @@ sub query_db($) {
 }
 my $status;
 
+$|=1;
 while (<>) {
     my ($user, $password) = split;
     $status = "ERR";
@@ -190,21 +239,3 @@ while (<>) {
     close_db() if (!$persist);
     print $status . "\n";
 }
-
-=pod
-
-=head1 COPYRIGHT
-
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
-
-Copyright (C) 2007 Henrik Nordstrom <henrik@henriknordstrom.net>
-Copyright (C) 2010 Luis Daniel Lucio Quiroz <dlucio@okay.com.mx> (Joomla support)
-This program is free software. You may redistribute copies of it under the
-terms of the GNU General Public License version 2, or (at youropinion) any
-later version.
-
-=cut
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,18 +0,0 @@
-	LDAP authentication helper for Squid.
-
-This Squid helper allows authentication against LDAP directories
-using the "simple authentication" (plain-text).
-
-This code is maintained by Henrik Nordstrom <hno@squid-cache.org>
-who added many command line options, and the ability to search for
-the user DN to log in as.
-
-The original LDAP Authentication code is written by Glen Newton
-<gnewton@wapiti.cisti.nrc.ca>.
-
-For detailed usage information please see the supplied man page
-
-  nroff -man squid_ldap_auth.8 | less
-
-In order to use squid_ldap_auth, you will also need to install
-the OpenLDAP libraries (ldap lber) from http://www.openldap.org.
@@ -305,7 +305,7 @@ This manual is written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -388,7 +388,7 @@ main(int argc, char **argv)
             fprintf(stderr, "ERROR: Your LDAP library does not have URI support\n");
             exit(1);
 #endif
-            /* Fall thru to -h */
+        /* Fall thru to -h */
         case 'h':
             if (ldapServer) {
                 int len = strlen(ldapServer) + 1 + strlen(value) + 1;
@@ -796,3 +796,4 @@ readSecret(const char *filename)
 
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,15 +0,0 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
-##
-## Squid software is distributed under GPLv2+ license and includes
-## contributions from numerous individuals and organizations.
-## Please see the COPYING and CONTRIBUTORS files for details.
-##
-
-include $(top_srcdir)/src/Common.am
-
-libexec_SCRIPTS	= basic_msnt_multi_domain_auth
-EXTRA_DIST = basic_msnt_multi_domain_auth.pl.in README.txt required.m4
-CLEANFILES += basic_msnt_multi_domain_auth
-
-basic_msnt_multi_domain_auth: basic_msnt_multi_domain_auth.pl.in
-	$(subst_perlshell)
@@ -1,17 +0,0 @@
-
-From: "Francesco Chemolli" <kinkie@kame.usr.dsi.unimi.it>
-Subject: Multiple NT domains authenticator
-Date: Fri, 7 Jul 2000 15:37:32 +0200 
-
-This is the multi-domain NTLM authenticator, blissfully undocumented
-(but there's a few strategic comments, so that at least the user
-is not left alone).
-
-The user is expected to enter his/her credentials as domain\username
-or domain/username (in analogy to what M$-Proxy does).
-
-Requires Authen::SMB from CPAN and Samba if you need to perform netbios
-queries.
-
-        Francesco 'Kinkie' Chemolli
-
@@ -1,142 +0,0 @@
-#!@PERL@
-##
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
-##
-## Squid software is distributed under GPLv2+ license and includes
-## contributions from numerous individuals and organizations.
-## Please see the COPYING and CONTRIBUTORS files for details.
-##
-
-#if you define this, debugging output will be printed to STDERR.
-#$debug=1;
-
-#to force using some DC for some domains, fill in this hash.
-#the key is a regexp matched against the domain name
-# the value is an array ref with PDC and BDC.
-# the order the names are matched in is UNDEFINED.
-#i.e.:
-# %controllers = ( "domain" => ["pdc","bdc"]);
-
-#%controllers = ( ".*" => ["pdcname","bdcname"]);
-
-#define this if you wish to use a WINS server. If undefined, broadcast
-# will be attempted.
-#$wins_server="winsservername";
-
-# Some servers (at least mine) really really want to be called by address.
-# If this variable is defined, we'll ask nmblookup to do a reverse DNS on the
-#  DC addresses. It might fail though, for instance because you have a crappy
-#  DNS with no reverse zones or records. If it doesn't work, you'll have to
-#  fall back to the %controllers hack.
-$try_reverse_dns=1;
-
-# Some servers (at least mine) don't like to be called by their fully
-#  qualified name. define this if you wish to call them ONLY by their
-#  hostname.
-$dont_use_fqdn=1;
-
-#no more user-serviceable parts
-use Authen::Smb;
-
-#variables: 
-# %pdc used to cache the domain -> pdc_ip values. IT NEVER EXPIRES!
-
-
-$|=1;
-while (<>) {
-	chomp;
-	if (! m;^(\S+)(/|%5c)(\S+)\s(\S+)$; ) { #parse the line
-		print "ERR\n";
-		next;
-	}
-	$domain=$1;
-	$user=$3;
-	$pass=$4;
-	$domain =~ s/%([0-9a-f][0-9a-f])/pack("H2",$1)/gie;
-        $user =~ s/%([0-9a-f][0-9a-f])/pack("H2",$1)/gie;
-        $pass =~ s/%([0-9a-f][0-9a-f])/pack("H2",$1)/gie;
-	print STDERR "domain: $domain, user: $user, pass=$pass\n" 
-		if (defined ($debug));
-	# check out that we know the PDC address
-	if (!$pdc{$domain}) {
-    ($pdc,$bdc)=&discover_dc($domain);
-    if ($pdc) {
-      $pdc{$domain}=$pdc;
-      $bdc{$domain}=$bdc;
-    }
-	}
-	$pdc=$pdc{$domain};
-	$bdc=$bdc{$domain};
-	if (!$pdc) {
-		#a pdc was not found
-		print "ERR\n";
-		print STDERR "No PDC found\n" if (defined($debug));
-		next;
-	}
-
-  print STDERR "querying '$pdc' and '$bdc' for user '$domain\\$user', ".
-    "pass $pass\n" if (defined($debug));
-  $result=Authen::Smb::authen($user,$pass,$pdc,$bdc,$domain);
-  print STDERR "result is: $nt_results{$result} ($result)\n"
-    if (defined($debug));
-  if ($result == NTV_NO_ERROR) {
-    print STDERR ("OK for user '$domain\\$user'\n") if (defined($debug));
-    print ("OK\n");
-  } else {
-    print STDERR "Could not authenticate user '$domain\\$user'\n";
-    print ("ERR\n");
-  }
-}
-
-#why do Microsoft servers have to be so damn picky and convoluted?
-sub discover_dc {
-  my $domain = shift @_;
-  my ($pdc, $bdc, $lookupstring, $datum);
-
-  foreach (keys %controllers) {
-    if ($domain =~ /$_/) {
-      print STDERR "DCs forced by user: $_ => ".
-        join(',',@{$controllers{$_}}).
-        "\n" if (defined($debug));
-      return @{$controllers{$_}};
-    }
-  }
-  $lookupstring="nmblookup";
-  $lookupstring.=" -R -U $wins_server" if (defined($wins_server));
-  $lookupstring.=" -T" if (defined($try_reverse_dns));
-  $lookupstring.=" '$domain#1c'";
-  print STDERR "Discovering PDC: $lookupstring\n"
-    if (defined($debug));
-  #discover the PDC address
-  open(PDC,"$lookupstring|");
-  while (<PDC>) {
-    print STDERR "response line: $_" if (defined($debug));
-    if (m|(.*), (\d+\.\d+\.\d+\.\d+)|) {
-      $datum=$1;
-      print STDERR "matched $datum\n" if (defined($debug));
-      if (defined($dont_use_fqdn) && $datum =~ /^([^.]+)\..*/) {
-        $datum=$1;
-        print STDERR "stripped domain name: $datum\n" if (defined($debug));
-      }
-    } elsif (m|^(\d+\.\d+\.\d+\.\d+)|) {
-      $datum=$1;
-    } else {
-      #no data here, go to next line
-      next;
-    }
-    if ($datum) {
-      if ($pdc) {
-        $bdc=$datum;
-        print STDERR "BDC is $datum\n" if (defined($debug));
-        last;
-      }	else {
-        $pdc=$datum;
-        print STDERR "PDC is $datum\n" if (defined($debug));
-      }
-      last;
-    }
-  }
-  close(PDC);
-  return ($pdc,$bdc) if ($pdc);
-  return 0;
-}
@@ -1,58 +0,0 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
-##
-## Squid software is distributed under GPLv2+ license and includes
-## contributions from numerous individuals and organizations.
-## Please see the COPYING and CONTRIBUTORS files for details.
-##
-
-include $(top_srcdir)/src/Common.am
-
-MSNTAUTH_CONF = $(sysconfdir)/msntauth.conf
-
-libexec_PROGRAMS = basic_msnt_auth
-
-basic_msnt_auth_SOURCES = \
-	allowusers.cc \
-	confload.cc \
-	denyusers.cc \
-	msntauth.cc \
-	msntauth.h \
-	usersfile.cc \
-	usersfile.h \
-	valid.cc \
-	valid.h
-
-EXTRA_DIST = \
-	msntauth.conf.default \
-	msntauth-v2.0.lsm \
-	README.html \
-	required.m4
-
-sysconf_DATA = \
-	msntauth.conf.default
-
-CFLAGS += -DSYSCONFDIR=\"$(sysconfdir)\"
-CXXFLAGS += -DSYSCONFDIR=\"$(sysconfdir)\"
-LDADD = \
-	$(top_builddir)/lib/smblib/libsmblib.la \
-	$(top_builddir)/lib/rfcnb/librfcnb.la \
-	$(top_builddir)/lib/libmiscencoding.la \
-	$(COMPAT_LIB) \
-	$(XTRA_LIBS)
-
-## we need our local files too (but avoid -I. at all costs)
-AM_CPPFLAGS += -I$(srcdir) -I$(top_srcdir)/lib
-
-
-install-data-local: msntauth.conf.default
-	@if test -f $(DESTDIR)$(MSNTAUTH_CONF) ; then \
-		echo "$@ will not overwrite existing $(DESTDIR)$(MSNTAUTH_CONF)" ; \
-	else \
-		echo "$(INSTALL_DATA) $(srcdir)/msntauth.conf.default $(DESTDIR)$(MSNTAUTH_CONF)" ; \
-		$(INSTALL_DATA) $(srcdir)/msntauth.conf.default $(DESTDIR)$(MSNTAUTH_CONF) ; \
-	fi
-
-uninstall-local:
-	@$(SHELL) $(top_srcdir)/scripts/remove-cfg.sh "$(RM)" $(DESTDIR)$(MSNTAUTH_CONF)
-	$(RM) -f $(DESTDIR)$(MSNTAUTH_CONF).default
-
@@ -1,350 +0,0 @@
-<HTML>
-<HEAD>
-<TITLE>MSNTAUTH readme</TITLE>
-</HEAD>
-<BODY BGCOLOR="#FFFFFF">
-
-<!--
-If you require this document in text form, download the 
-HTML-text package from http://members.tripod.com/stellarx.
--->
-
-<H1>
-MSNT Auth v2.0.3-squid.1<BR>
-Squid web proxy NT authentication module<BR>
-Modified by the Squid HTTP Proxy team<BR>
-Wed Jun 26 21:16:32 CEST 2002<BR>
-Original release by Antonino Iannella, Stellar-X Pty Ltd<BR>
-</H1>
-
-<H2>Contents</H2>
-
-<UL>
-<LI> <A HREF="#introduction">Introduction</A>
-<LI> <A HREF="#installation">Installation</A>
-<LI> <A HREF="#compiling">Issues when compiling</A>
-<LI> <A HREF="#configuration">Configuration file</A>
-<LI> <A HREF="#denying">Denying users</A>
-<LI> <A HREF="#allowing">Allowing users</A>
-<LI> <A HREF="#squid">Squid.conf changes</A>
-<LI> <A HREF="#testing">Testing</A>
-<LI> <A HREF="#contact">Contact details</A>
-<LI> <A HREF="#unknown">Unknown username issue</A>
-<LI> <A HREF="#changes">Revision history</A>
-</UL>
-
-<A NAME="introduction"><H2>Introduction</H2>
-
-<P>
-This is an authentication module for the Squid proxy server
-to use an NT domain server.
-
-<P>
-It originates from the Samba and SMB packages by Andrew Tridgell
-and Richard Sharpe. It is sourced from the Pike
-authentication module by William Welliver (hwellive@intersil.com),
-and the SMB 1.0.1 libraries.
-Releases up to version 2.0.3 were created by Antonino Iannella
-(antonino@rager.com.au, http://stellarx.tripod.com).
-The module is now distributed with Squid, and is maintained by the
-Squid proxy team as an Open Source effort.
-Msntauth is released under the GNU General Public License.
-
-<P>
-Usage is simple. It accepts a username and password on standard input.
-It will return OK if the username/password is valid for the domain,
-or ERR if there was some problem.
-Check syslog messages for reported problems.
-
-<P>
-Msntauth works in environments with NT domain controllers on
-Windows (TM) NT 4, 2000, and Samba.
-
-<A NAME="installation"><H2>Installation</H2>
-
-<P>
-Msntauth will be compiled when you compile Squid, using
-their autoconf system.
-Refer to Squid documentation for details.
-If the build is suitable, you can skip this section.
-
-<P>
-Alternatively, a supplementary makefile is also provided for manual compiling.
-Review Makefile.MSNT, and modify it based on the target platform or
-site requirements.
-
-<P>
-Make any necessary changes to the source code.
-
-<P>
-Copy Makefile.MSNT to Makefile.
-Type 'make', then 'make install', then 'make clean'.
-
-<P>
-To avoid using the makefile, it may compile with
-
-  gcc -O2 -s -o msntauth *.c
-
-<P>
-'Make install' will put 'msntauth' into
-/usr/local/squid/bin.
-
-<A NAME="compiling"><H2>Issues when compiling</H2>
-
-<P>
-The Makefile uses your C compiler (usually GCC), assuming it's in your PATH.
-Msntauth is known to compile properly on Linux, FreeBSD, and Solaris.
-
-<P>
-When compiling under Solaris, link to the NSL and socket libraries.
-In the Makefile, enable the alternative CFLAGS line for Solaris.
-Ensure /usr/ccs/bin is in your PATH.
-In Smbencrypt.c, '#include <sys/vfs.h>' only gets included when
-compiled with Solaris.
-
-<P>
-For Digital Unix/Tru64, review the INSTALL line in the makefile.
-The install-bsd command is used to place files in their target location.
-
-<A NAME="configuration"><H2>Configuration file</H2>
-
-<P>
-Msntauth uses a configuration file, usually
-/usr/local/squid/etc/msntauth.conf.
-To change this, edit the following line in confload.c -
-
-<PRE>
-  #define CONFIGFILE   "/usr/local/squid/etc/msntauth.conf"
-</PRE>
-
-<P>
-An example configuration file is provided -
-
-<PRE>
-# Sample MSNT authenticator configuration file
-# Antonino Iannella, Stellar-X Pty Ltd
-# Tue Aug 26 17:26:59 GMT+9 2003
-
-# NT domain hosts. Best to put the hostnames in /etc/hosts.
-server myPDC           myBDC          myNTdomain
-server otherPDC        otherBDC       otherdomain
-
-# Denied and allowed users. Comment these if not needed.
-denyusers       /usr/local/squid/etc/denyusers
-allowusers      /usr/local/squid/etc/allowusers
-</PRE>
-
-<P>
-All comments start with '#'.
-
-<P>
-NT servers are used to query user accounts. The 'server' lines
-are used for this, with the PDC, BDC, and NT domain as parameters.
-Up to 5 servers/domains can be queried. If this is not enough,
-modify the MAXSERVERS define in confload.c.
-At least one server must be specified, or msntauth will not start.
-Server names must be resolvable by the system. If not, msntauth
-reports an error. If you can't ping it, you might have a host
-resolution problem.
-
-<P>
-The name you specify is used in the NetBIOS protocol when
-communicating with the target server.
-The name must be resolvable by the local system, and it must be a 
-name that the target server uses.
-You cannot simply invent a hostname.
-You cannot use it IP address.
-
-<P>
-When a user provides a username/password, each of these
-servers will be queried to authenticate the username.
-It stops after a user has been successfully authenticated,
-so it makes sense to specify the most commonly queried
-server first. Make sure the servers can be reached and
-are active, or else msntauth will report failures.
-
-<P>
-The 'denyusers' and 'allowusers' lines give the absolute path
-to files of user accounts. They can be used to deny or allow
-access to the proxy. Remove these directives if you
-do not need these features.
-
-<A NAME="denying"><H2>Denying users</H2>
-
-<P>
-Users who are not allowed to access the web proxy can be added to
-the denied user list. This list is read around every minute, or when
-the msntauth process receives a SIGHUP signal.
-
-<P>
-The denied user file is set using the 'denyusers' directive
-in msntauth.conf.  The denied user file
-contains a list of usernames, one per line.
-If the file does not exist, no users are denied.
-The file must be readable by the web proxy user.
-
-<P>
-Msntauth will send syslog messages if a user was denied,
-at LOG_USER facility. Check your syslog messages for clues.
-
-<A NAME="allowing"><H2>Allowing users</H2>
-
-<P>
-Similar to denying users, you can allow users to access the proxy
-by username. This is useful if only a number of people are
-allowed to use a proxy.
-
-<P>
-The allowed user file is set using the 'allowusers' directive
-in msntauth.conf.
-If the file does not exist or if empty, all users are allowed.
-
-<P>
-You could make use of the SHOWMBRS tool in Microsoft Technet.
-This gives you a list of users which are in a particular
-NT Domain Group. This list can be made into the allowed users
-file using sed or awk.
-
-<P>
-Some other rules -
-
-<OL>
-<LI> The operation of the denied user file is independent of the
-allowed user file. The former file is checked first.
-<LI> You can use none, one, or both files.
-<LI> If a username appears in the denied user file, they will
-be denied, even if they are in the allowed user file.
-<LI> If a username is not in either file, they will be denied,
-because they have not been allowed.
-<LI> If the allowed user file is in use and is empty, all
-users will be allowed.
-</OL>
-
-<A NAME="squid"><H2>Squid.conf changes</H2>
-
-<P>
-Refer to Squid documentation for the required changes to squid.conf.
-You will need to set the following lines to enable authentication for
-your access list -
-
-<PRE>
-  acl <I>yourACL</I> proxy_auth REQUIRED
-  http_access allow password
-  http_access allow <I>yourACL</I>
-  http_access deny all
-</PRE>
-
-<P>
-You will also need to review the following directives. The number of
-msntauth children spawned is set with authenticate_children.
-The number of children needed is site-dependent, so some
-experimentation may be required to find the best number.
-There should be no visible delay in performance with Squid once
-msntauth is in use. As an example, a firm with 1500 users and a T1
-internet connection required a value of 30.
-
-<PRE>
-  proxy_auth_realm enterprise web gateway
-  authenticate_program /usr/local/squid/bin/msntauth
-  authenticate_ttl 5
-  authenticate_children 20
-</PRE>
-
-<A NAME="testing"><H2>Testing</H2>
-
-<P>
-I strongly urge that Msntauth is tested prior to being used in a 
-production environment. It may behave differently on different platforms.
-To test it, run it from the command line. Enter username and password
-pairs separated by a space.
-
-<P>
-It should behave in the following way -
-<PRE>
- - Press ENTER to get an OK or ERR message.
- - Make sure pressing CTRL-D behaves the same as a carriage return.
- - Make sure pressing CTRL-C aborts the program.
- - Test that entering no details does not result in an OK or ERR message.
- - Test that entering an invalid username and password results in
-   an ERR message. Note that if NT guest user access is allowed on
-   the PDC, an OK message may be returned instead of ERR.
- - Test that entering an valid username and password results in an OK message.
-   Try usernames which are and aren't in the denied/allowed user files,
-   if they're in use.
- - Test that entering a guest username and password returns the correct response.
-</PRE>
-
-<P>
-If the above didn't work as expected, you may need to modify the main()
-function in msntauth.c. Inform the Squid maintainers of any problems.
-
-<P>
-Usernames cannot have whitespace in them, but passwords can.
-
-<P>
-As of version 2.0.3, the msntauth version can be found in the executable.
-Type this to retrieve it -
-
-<PRE>
-  strings msntauth | grep -i msntauth
-</PRE>
-
-<A NAME="contact"><H2>Support details</H2>
-
-<P>
-Refer to the Squid website at http://www.squid-cache.org.
-Submit problems or fixes using their Bugzilla facility.
-
-<A NAME="unknown"><H2>Unknown username issue</H2>
-
-<P>
-For an unknown username, Msntauth returns OK.
-This is because the PDC returns guest access for unknown users,
-even if guest access is disabled.
-This problem was reported by Mr Vadim Popov (vap@iilsr.minsk.by).
-
-<P>
-The tested environment consisted of PDC on Windows NT 4, SP 6.
-Squid 2.3 and Msntauth was tested on SuSe, RedHat, and Debian Linux.
-A fix was provided in case you have this problem.
-Apply the provided patch before compiling, using
-
-<PRE>
-  patch smblib.c < smblib.c.patch
-</PRE>
-
-<A NAME="changes"><H2>Revision history</H2>
-
-<P>
-The following sequence of changes have been made to improve msntauth.
-
-<UL>
-<LI>Added many patches from Duane Wessels to stop compilation errors
-<LI>Improved the main() function yet again
-<LI>Created a more informative Makefile
-<LI>Added an 'allowed users' feature to complement the 'denied users' feature
-<LI>Stopped the use of alarm() which was causing problems under Solaris
-<LI>Added more syslog messages for authentication problems
-<LI>Added the use of a configuration file, instead of hard-coding NT server details
-<LI>Allowed for querying multiple NT servers and domains (this was a hot issue)
-<LI>Changed README into an HTML document to improve readability
-<LI>Removed denied/allowed username substring search limitation
-<LI>Fixed a bug which occurred when reading denied/allowed usernames
-<LI>Allows whitespace in passwords
-<LI>To check user list changes, doesn't use an alarm every minute.
-<LI>Fixed a sigaction compilation error, causing problems on FreeBSD and HPUX
-<LI>Removed a problem of finding a valid username as a substring in the denied user list.
-<LI>Support email address change from antonino@usa.net to antonino@rager.com.au.
-<LI>Msntauth was successfully tested on Tru64.
-<LI>PDC and BDC hostnames are now checked if they are resolvable.
-<LI>Smbencrypt.c does not have to be checked for Solaris systems any more.
-<LI>Imbedded version information in the executable.
-<LI>Version 2.0.3 and later now supported by the Squid team.
-</UL>
-
-<P>
-A future improvement may be to cache accepted usernames and passwords,
-to reduce network authentication traffic, and improve the Squid response time.
-
-</BODY>
-</HTML>
@@ -1,58 +0,0 @@
-/*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-/*
- * allowusers.c
- * (C) 2000 Antonino Iannella, Stellar-X Pty Ltd
- * Released under GPL, see COPYING-2.0 for details.
- *
- * These routines are to allow users attempting to use the proxy which
- * have been explicitly allowed by the system administrator.
- * The code originated from denyusers.c.
- */
-
-#include "squid.h"
-#include "msntauth.h"
-#include "usersfile.h"
-
-#include <cstdlib>
-#include <cstring>
-#include <unistd.h>
-#include <sys/types.h>
-#include <sys/param.h>
-
-static usersfile AllowUsers;
-static int init = 0;
-
-/* shared */
-char Allowuserpath[MAXPATHLEN];	/* MAXPATHLEN defined in param.h */
-
-int
-Read_allowusers(void)
-{
-    if (!init) {
-        memset(&AllowUsers, '\0', sizeof(AllowUsers));
-        init = 1;
-    }
-    if (*Allowuserpath)
-        return Read_usersfile(Allowuserpath, &AllowUsers);
-    else
-        return 0;
-}
-
-int
-Check_ifuserallowed(char *ConnectingUser)
-{
-    return Check_userlist(&AllowUsers, ConnectingUser);
-}
-
-void
-Check_forallowchange(void)
-{
-    Check_forfilechange(&AllowUsers);
-}
@@ -1,273 +0,0 @@
-/*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-/*
- * confload.c
- * (C) 2000 Antonino Iannella, Stellar-X Pty Ltd
- * Released under GPL, see COPYING-2.0 for details.
- *
- * These routines load the msntauth configuration file.
- * It stores the servers to query, sets the denied and
- * allowed user files, and provides the
- * authenticating function.
- */
-
-/* Squid provides a number of portability overrides */
-#include "squid.h"
-
-#include <cassert>
-#include <cerrno>
-#include <cstdlib>
-#include <cstring>
-#include <syslog.h>
-#include <sys/param.h>
-#include <netdb.h>
-
-#include "msntauth.h"
-#include "valid.h"
-
-/* Path to configuration file */
-#ifndef SYSCONFDIR
-#define SYSCONFDIR "/usr/local/squid/etc"
-#endif
-#define CONFIGFILE   SYSCONFDIR "/msntauth.conf"
-
-/* Maximum number of servers to query. This number can be increased. */
-#define MAXSERVERS 5
-#define NTHOSTLEN 65
-
-extern char Denyuserpath[MAXPATHLEN];	/* MAXPATHLEN defined in param.h */
-extern char Allowuserpath[MAXPATHLEN];
-
-typedef struct _ServerTuple {
-    char pdc[NTHOSTLEN];
-    char bdc[NTHOSTLEN];
-    char domain[NTHOSTLEN];
-} ServerTuple;
-
-ServerTuple ServerArray[MAXSERVERS];	/* Array of servers to query */
-int Serversqueried = 0;		/* Number of servers queried */
-
-/* Declarations */
-
-static void ProcessLine(char *);
-static void AddServer(char *, char *, char *);
-static int QueryServerForUser(int, char *, char *);
-
-/*
- * Opens and reads the configuration file.
- * Returns 0 on success, or 1 for error.
- */
-
-int
-OpenConfigFile(void)
-{
-    FILE *ConfigFile;
-    char Confbuf[2049];		/* Line reading buffer */
-
-    /* Initialise defaults */
-
-    Serversqueried = 0;
-    memset(ServerArray, '\0', sizeof(ServerArray));
-    memset(Denyuserpath, '\0', MAXPATHLEN);
-    memset(Allowuserpath, '\0', MAXPATHLEN);
-
-    /* Open file */
-    if ((ConfigFile = fopen(CONFIGFILE, "r")) == NULL) {
-        syslog(LOG_ERR, "OpenConfigFile: Failed to open %s.", CONFIGFILE);
-        syslog(LOG_ERR, "%s", strerror(errno));
-        return 1;
-    }
-    /* Read in, one line at a time */
-    while (!feof(ConfigFile)) {
-        Confbuf[0] = '\0';
-        if (NULL == fgets(Confbuf, 2048, ConfigFile))
-            break;
-        Confbuf[2048] = '\0';
-        ProcessLine(Confbuf);
-    }
-    fclose(ConfigFile);
-
-    /*
-     * Check that at least one server is being queried. Report error if not.
-     * Denied and allowed user files are hardcoded, so it's fine if they're
-     * not set in the confugration file.
-     */
-    if (Serversqueried == 0) {
-        syslog(LOG_ERR, "OpenConfigFile: No servers set in %s. At least one is needed.", CONFIGFILE);
-        return 1;
-    }
-    return 0;
-}
-
-/* Parses a configuration file line. */
-
-static void
-ProcessLine(char *Linebuf)
-{
-    char *Directive;
-    char *Param1;
-    char *Param2;
-    char *Param3;
-
-    /* Ignore empty lines */
-    if (strlen(Linebuf) == 0)
-        return;
-
-    /* Break up on whitespaces */
-    if ((Directive = strtok(Linebuf, " \t\n")) == NULL)
-        return;
-
-    /* Check for a comment line. If found, stop . */
-    if (Directive[0] == '#')
-        return;
-
-    /* Check for server line. Check for 3 parameters. */
-    if (strcmp(Directive, "server") == 0) {
-        Param1 = strtok(NULL, " \t\n");
-        if (NULL == Param1) {
-            syslog(LOG_ERR, "ProcessLine: 'server' missing PDC parameter.");
-            return;
-        }
-        Param2 = strtok(NULL, " \t\n");
-        if (NULL == Param2) {
-            syslog(LOG_ERR, "ProcessLine: 'server' missing BDC parameter.");
-            return;
-        }
-        Param3 = strtok(NULL, " \t\n");
-        if (NULL == Param3) {
-            syslog(LOG_ERR, "ProcessLine: 'server' missing domain parameter.");
-            return;
-        }
-        AddServer(Param1, Param2, Param3);
-        return;
-    }
-    /* Check for denyusers line */
-    if (strcmp(Directive, "denyusers") == 0) {
-        Param1 = strtok(NULL, " \t\n");
-
-        if (NULL == Param1) {
-            syslog(LOG_ERR, "ProcessLine: A 'denyusers' line needs a filename parameter.");
-            return;
-        }
-        memset(Denyuserpath, '\0', MAXPATHLEN);
-        strncpy(Denyuserpath, Param1, MAXPATHLEN - 1);
-        return;
-    }
-    /* Check for allowusers line */
-    if (strcmp(Directive, "allowusers") == 0) {
-        Param1 = strtok(NULL, " \t\n");
-
-        if (NULL == Param1) {
-            syslog(LOG_ERR, "ProcessLine: An 'allowusers' line needs a filename parameter.");
-            return;
-        }
-        memset(Allowuserpath, '\0', MAXPATHLEN);
-        strncpy(Allowuserpath, Param1, MAXPATHLEN - 1);
-        return;
-    }
-    /* Reports error for unknown line */
-    syslog(LOG_ERR, "ProcessLine: Ignoring '%s' line.", Directive);
-}
-
-/*
- * Adds a server to query to the server array.
- * Checks if the server IP is resolvable.
- * Checks if the number of servers to query is not exceeded.
- * Does not allow parameters longer than NTHOSTLEN.
- */
-
-void
-AddServer(char *ParamPDC, char *ParamBDC, char *ParamDomain)
-{
-    if (Serversqueried == MAXSERVERS) {
-        syslog(LOG_ERR, "AddServer: Ignoring '%s' server line; "
-               "too many servers.", ParamPDC);
-        return;
-    }
-    if (gethostbyname(ParamPDC) == NULL) {
-        syslog(LOG_ERR, "AddServer: Ignoring host '%s'. "
-               "Cannot resolve its address.", ParamPDC);
-        return;
-    }
-    if (gethostbyname(ParamBDC) == NULL) {
-        syslog(LOG_USER | LOG_ERR, "AddServer: Ignoring host '%s'. "
-               "Cannot resolve its address.", ParamBDC);
-        return;
-    }
-    /* NOTE: ServerArray is zeroed in OpenConfigFile() */
-    assert(Serversqueried < MAXSERVERS);
-    strncpy(ServerArray[Serversqueried].pdc, ParamPDC, NTHOSTLEN - 1);
-    strncpy(ServerArray[Serversqueried].bdc, ParamBDC, NTHOSTLEN - 1);
-    strncpy(ServerArray[Serversqueried].domain, ParamDomain, NTHOSTLEN - 1);
-    ++Serversqueried;
-}
-
-/*
- * Cycles through all servers to query.
- * Returns 0 if one server could authenticate the user.
- * Returns 1 if no server authenticated the user.
- */
-
-int
-QueryServers(char *username, char *password)
-{
-    int i;
-    for (i = 0; i < Serversqueried; ++i) {
-        if (0 == QueryServerForUser(i, username, password))
-            return 0;
-    }
-    return 1;
-}
-
-/*
- * Attempts to authenticate the user with one server.
- * Logs syslog messages for different errors.
- * Returns 0 on success, non-zero on failure.
- */
-
-/* Define for systems which don't support it, like Solaris */
-#ifndef LOG_AUTHPRIV
-#define LOG_AUTHPRIV LOG_AUTH
-#endif
-
-static int
-QueryServerForUser(int x, char *username, char *password)
-{
-    int result = 1;
-
-    result = Valid_User(username, password, ServerArray[x].pdc,
-                        ServerArray[x].bdc, ServerArray[x].domain);
-
-    switch (result) {		/* Write any helpful syslog messages */
-    case 0:
-        break;
-    case 1:
-        syslog(LOG_AUTHPRIV | LOG_INFO, "Server error when checking %s.",
-               username);
-        break;
-    case 2:
-        syslog(LOG_AUTHPRIV | LOG_INFO, "Protocol error when checking %s.",
-               username);
-        break;
-    case 3:
-        syslog(LOG_AUTHPRIV | LOG_INFO, "Authentication failed for %s.",
-               username);
-        break;
-    }
-
-    return result;
-}
-
-/* Valid_User return codes -
- *
- * 0 - User authenticated successfully.
- * 1 - Server error.
- * 2 - Protocol error.
- * 3 - Logon error; Incorrect password or username given.
- */
@@ -1,126 +0,0 @@
-/*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-/*
- * denyusers.c
- * (C) 2000 Antonino Iannella, Stellar-X Pty Ltd
- * Released under GPL, see COPYING-2.0 for details.
- *
- * These routines are to block users attempting to use the proxy which
- * have been explicitly denied by the system administrator.
- * Routines at the bottom also use the allowed user functions.
- */
-
-#include "squid.h"
-#include "msntauth.h"
-#include "usersfile.h"
-
-#include <cstdlib>
-#include <cstring>
-#include <ctime>
-#include <unistd.h>
-#include <sys/types.h>
-#include <sys/param.h>
-
-static usersfile DenyUsers;
-static int init = 0;
-
-/* shared */
-char Denyuserpath[MAXPATHLEN];	/* MAXPATHLEN defined in param.h */
-
-int
-Read_denyusers(void)
-{
-    if (!init) {
-        memset(&DenyUsers, '\0', sizeof(DenyUsers));
-        init = 1;
-    }
-    if (*Denyuserpath)
-        return Read_usersfile(Denyuserpath, &DenyUsers);
-    else
-        return 0;
-}
-
-static void
-Check_fordenychange(void)
-{
-    Check_forfilechange(&DenyUsers);
-}
-
-/*
- * Check to see if the username provided by Squid appears in the denied
- * user list. Returns 0 if the user was not found, and 1 if they were.
- */
-
-static int
-Check_ifuserdenied(char *ConnectingUser)
-{
-    /* If user string is empty, deny */
-    if (ConnectingUser[0] == '\0')
-        return 1;
-
-    /* If denied user list is empty, allow */
-    if (DenyUsers.Inuse == 0)
-        return 0;
-
-    return Check_userlist(&DenyUsers, ConnectingUser);
-}
-
-/*
- * Decides if a user is denied or allowed.
- * If they have been denied, or not allowed, return 1.
- * Else return 0.
- */
-
-int
-Check_user(char *ConnectingUser)
-{
-    if (Check_ifuserdenied(ConnectingUser) == 1)
-        return 1;
-
-    if (Check_ifuserallowed(ConnectingUser) == 0)
-        return 1;
-
-    return 0;
-}
-
-/*
- * Checks the denied and allowed user files for change.
- * This function is invoked when a SIGHUP signal is received.
- * It is also run after every 60 seconds, at the next request.
- */
-
-void
-Check_forchange(int signal)
-{
-    Check_fordenychange();
-    Check_forallowchange();
-}
-
-/*
- * Checks the timer. If longer than 1 minute has passed since the last
- * time someone has accessed the proxy, then check for changes in the
- * denied user file. If longer than one minute hasn't passed, return.
- */
-
-void
-Checktimer()
-{
-    static time_t Lasttime;	/* The last time the timer was checked */
-    static time_t Currenttime;	/* The current time */
-
-    Currenttime = time(NULL);
-
-    /* If timeout has expired, check the denied user file, else return */
-    if (difftime(Currenttime, Lasttime) < 60)
-        return;
-    else {
-        Check_forchange(-1);
-        Lasttime = Currenttime;
-    }
-}
@@ -1,19 +0,0 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
-##
-## Squid software is distributed under GPLv2+ license and includes
-## contributions from numerous individuals and organizations.
-## Please see the COPYING and CONTRIBUTORS files for details.
-##
-
-# Sample MSNT authenticator configuration file
-# Antonino Iannella, Stellar-X Pty Ltd
-# Sun Sep  2 15:52:31 CST 2001
-
-# NT hosts to use. Best to put their IP addresses in /etc/hosts.
-server my_PDC		my_BDC		my_NTdomain
-server other_PDC	other_BDC	otherdomain
-
-# Denied and allowed users. Comment these if not needed.
-#denyusers	/usr/local/squid/etc/msntauth.denyusers
-#allowusers	/usr/local/squid/etc/msntauth.allowusers
-
@@ -1,205 +0,0 @@
-/*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-/*
- * usersfile.c
- * (C) 2000 Antonino Iannella, Stellar-X Pty Ltd
- * Released under GPL, see COPYING-2.0 for details.
- *
- * These routines are to allow users attempting to use the proxy which
- * have been explicitly allowed by the system administrator.
- * The code originated from denyusers.c.
- */
-
-#include "squid.h"
-#include "util.h"
-
-#include <cctype>
-#include <cerrno>
-#include <cstring>
-#include <ctime>
-#include <syslog.h>
-#include <unistd.h>
-#include <sys/stat.h>
-#include <sys/param.h>
-#include <fcntl.h>
-
-#include "usersfile.h"
-
-#define NAMELEN     50		/* Maximum username length */
-
-static int
-name_cmp(const void *a, const void *b)
-{
-    const char * const *A = static_cast<const char * const *>(a);
-    const char * const *B = static_cast<const char * const *>(b);
-    return strcasecmp(*A, *B);
-}
-
-static void
-free_names(usersfile * uf)
-{
-    int i;
-    for (i = 0; i < uf->Inuse; ++i) {
-        if (uf->names[i])
-            free(uf->names[i]);
-        uf->names[i] = NULL;
-    }
-    uf->Inuse = 0;
-}
-
-/*
- * Reads a file of usernames and stuffs them into an array
- * of strings.
- * Returns 0 if the user list was successfully loaded,
- * and 1 in case of error.
- */
-
-int
-Read_usersfile(const char *path, usersfile * uf)
-{
-    FILE *fp;
-    struct stat FileBuf;
-    char buf[1024];
-
-    free_names(uf);
-
-    if (NULL == path) {
-        path = uf->path;
-    } else {
-        if (uf->path)
-            free(uf->path);
-        uf->path = xstrdup(path);
-    }
-
-    /* Open the users file. Report any errors. */
-    fp = fopen(path, "r");
-    if (NULL == fp) {
-        uf->LMT = 0;
-        if (errno == ENOENT)
-            return 0;
-        syslog(LOG_ERR, "%s: %s", path, strerror(errno));
-        return 1;
-    }
-    /* Stat the file. If it does not exist, save the size as zero.
-     * Clear the allowed user string. Return. */
-    if (fstat(fileno(fp), &FileBuf) < 0) {
-        syslog(LOG_ERR, "%s: %s", path, strerror(errno));
-        fclose(fp);
-        return 1;
-    }
-    /* If it exists, save the modification time and size */
-    uf->LMT = FileBuf.st_mtime;
-
-    /* Handle the special case of a zero length file */
-    if (FileBuf.st_size == 0) {
-        fclose(fp);
-        return 0;
-    }
-
-    /*
-     * Read the file into memory
-     * XXX assumes one username per input line
-     */
-    while (fgets(buf, 1024, fp) != NULL) {
-        /* ensure no names longer than our limit */
-        buf[NAMELEN] = '\0';
-        /* skip bad input lines */
-        if (NULL == strtok(buf, "\r\n"))
-            continue;
-        /* grow the list if necessary */
-        if (0 == uf->Alloc) {
-            uf->Alloc = 256;
-            uf->names = static_cast<char**>(calloc(uf->Alloc, sizeof(*uf->names)));
-        } else if (uf->Inuse == uf->Alloc) {
-            uf->Alloc = uf->Alloc << 1;
-            uf->names = static_cast<char**>(realloc(uf->names, uf->Alloc * sizeof(*uf->names)));
-            /* zero out the newly allocated memory */
-            memset(&uf->names[uf->Alloc >> 1],
-                   '\0',
-                   (uf->Alloc >> 1) * sizeof(*uf->names));
-        }
-        uf->names[uf->Inuse] = xstrdup(buf);
-        ++uf->Inuse;
-    }
-    fclose(fp);
-    fp = NULL;
-
-    /* sort the names for searching */
-    qsort(uf->names, uf->Inuse, sizeof(*uf->names), name_cmp);
-
-    return 0;
-}
-
-/*
- * Check to see if the username provided by Squid appears in the
- * user list. Returns 0 if the user was not found, and 1 if they were.
- */
-
-int
-Check_userlist(usersfile * uf, char *User)
-{
-    void *p;
-
-    /* Empty users are always in the list */
-    if (User[0] == '\0')
-        return 1;
-
-    /* If allowed user list is empty, allow all users.
-     * If no users are supposed to be using the proxy, stop squid instead. */
-    if (0 == uf->Inuse)
-        return 1;
-
-    /* Check if username string is found in the allowed user list.
-     * If so, allow. If not, deny. Reconstruct the username
-     * to have whitespace, to avoid finding wrong string subsets. */
-
-    p = bsearch(&User,
-                uf->names,
-                uf->Inuse,
-                sizeof(*uf->names),
-                name_cmp);
-    if (NULL == p) {
-        return 0;
-    }
-    return 1;
-}
-
-/*
- * Checks if there has been a change in a users file.
- * If the modification time has changed, then reload the user list.
- */
-void
-Check_forfilechange(usersfile * uf)
-{
-    struct stat ChkBuf;		/* Stat data buffer */
-
-    /* Stat the allowed users file. If it cannot be accessed, return. */
-
-    if (uf->path == NULL)
-        return;
-
-    if (stat(uf->path, &ChkBuf) < 0) {
-        if (errno == ENOENT) {
-            uf->LMT = 0;
-            free_names(uf);
-        } else {		/* Report error when accessing file */
-            syslog(LOG_ERR, "%s: %s", uf->path, strerror(errno));
-        }
-        return;
-    }
-    /* return if no change */
-    if (ChkBuf.st_mtime == uf->LMT)
-        return;
-
-    /*
-     * The file changed, so re-read it.
-     */
-    syslog(LOG_INFO, "Check_forfilechange: Reloading user list '%s'.", uf->path);
-    Read_usersfile(NULL, uf);
-}
@@ -1,19 +0,0 @@
-/*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-typedef struct {
-    char *path;
-    char **names;
-    int Alloc;
-    int Inuse;
-    time_t LMT;
-} usersfile;
-
-int Read_usersfile(const char *path, usersfile * uf);
-int Check_userlist(usersfile * uf, char *User);
-void Check_forfilechange(usersfile * uf);
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -11,15 +11,14 @@ DIST_SUBDIRS = \
 	fake \
 	getpwnam \
 	LDAP \
-	MSNT \
-	MSNT-multi-domain \
 	NCSA \
 	NIS \
 	PAM \
 	POP3 \
 	RADIUS \
 	SASL \
 	SMB \
+	SMB_LM \
 	SSPI
 
 SUBDIRS	= $(BASIC_AUTH_HELPERS)
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -57,7 +57,7 @@ Based on original documentation by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -127,7 +127,7 @@ main(int argc, char **argv)
     }
     while (fgets(buf, HELPER_INPUT_BUFFER, stdin) != NULL) {
         if ((p = strchr(buf, '\n')) != NULL)
-            *p = '\0';		/* strip \n */
+            *p = '\0';      /* strip \n */
         if (stat(argv[1], &sb) == 0) {
             if (sb.st_mtime != change_time) {
                 read_passwd_file(argv[1]);
@@ -187,3 +187,4 @@ main(int argc, char **argv)
     }
     exit(0);
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -29,7 +29,7 @@
 
 #include <cstring>
 
-static unsigned char itoa64[] =	/* 0 ... 63 => ascii - 64 */
+static unsigned char itoa64[] = /* 0 ... 63 => ascii - 64 */
     "./0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
 
 static void md5to64(char *s, unsigned long v, int n)
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -29,3 +29,4 @@ char *crypt_md5(const char *pw, const char *salt);
 char *md5sum(const char *s);
 
 #endif /* _CRYPT_MD5_H */
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -54,7 +54,7 @@ main(int argc, char **argv)
 
     while (fgets(buf, 256, stdin) != NULL) {
         if ((p = strchr(buf, '\n')) != NULL)
-            *p = '\0';		/* strip \n */
+            *p = '\0';      /* strip \n */
 
         if ((user = strtok(buf, " ")) == NULL) {
             printf("ERR\n");
@@ -90,3 +90,4 @@ main(int argc, char **argv)
     }
     exit(0);
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -37,7 +37,7 @@
 
 #include "nis_support.h"
 
-#define NO_YPERR 0		/* There is no error */
+#define NO_YPERR 0      /* There is no error */
 
 char *
 get_nis_password(char *user, char *nisdomain, char *nismap)
@@ -69,9 +69,10 @@ get_nis_password(char *user, char *nisdomain, char *nismap)
     case YPERR_YPBIND:
         syslog(LOG_ERR, "Squid Authentication through ypbind failure: can't communicate with ypbind");
         return NULL;
-    case YPERR_KEY:		/* No such key in map */
+    case YPERR_KEY:     /* No such key in map */
         return NULL;
     default:
         return NULL;
     }
 }
+
@@ -1,9 +1,10 @@
-/*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-extern char * get_nis_password(char *user, char *nisdomain, char *nismap);
+/*
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+ */
+
+extern char * get_nis_password(char *user, char *nisdomain, char *nismap);
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -81,7 +81,7 @@ This program and documentation was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -58,17 +58,17 @@
  *
  *   Version 2.0, 2002-01-07
  *      One shot mode, command line options
- *	man page
+ *  man page
  *
  *   Version 1.3, 1999-12-10
- *   	Bugfix release 1.3 to work around Solaris 2.6
+ *      Bugfix release 1.3 to work around Solaris 2.6
  *      brokenness (not sending arguments to conversation
  *      functions)
  *
  *   Version 1.2, internal release
  *
  *   Version 1.1, 1999-05-11
- *	Initial version
+ *  Initial version
  */
 #include "squid.h"
 #include "helpers/defines.h"
@@ -97,7 +97,7 @@
 #endif
 
 #if _SQUID_SOLARIS_
-static char *password = NULL;	/* Workaround for Solaris 2.6 brokenness */
+static char *password = NULL;   /* Workaround for Solaris 2.6 brokenness */
 #endif
 
 extern "C" int password_conversation(int num_msg, PAM_CONV_FUNC_CONST_PARM struct pam_message **msg,
@@ -224,7 +224,7 @@ main(int argc, char *argv[])
         ++password_buf;
         rfc1738_unescape(user);
         rfc1738_unescape(password_buf);
-        conv.appdata_ptr = (char *) password_buf;	/* from buf above. not allocated */
+        conv.appdata_ptr = (char *) password_buf;   /* from buf above. not allocated */
 
         if (no_realm) {
             /* Remove DOMAIN\.. and ...@domain from the user name in case the user
@@ -310,3 +310,4 @@ main(int argc, char *argv[])
     }
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -8,8 +8,16 @@
 include $(top_srcdir)/src/Common.am
 
 libexec_SCRIPTS	= basic_pop3_auth
-EXTRA_DIST = basic_pop3_auth.pl.in required.m4
-CLEANFILES += basic_pop3_auth
+man_MANS= basic_pop3_auth.8
+EXTRA_DIST= \
+	basic_pop3_auth.8 \
+	basic_pop3_auth.pl.in \
+	required.m4
 
 basic_pop3_auth: basic_pop3_auth.pl.in
 	$(subst_perlshell)
+
+basic_pop3_auth.8: basic_pop3_auth
+	pod2man basic_pop3_auth basic_pop3_auth.8
+
+CLEANFILES += basic_pop3_auth basic_pop3_auth.8
@@ -1,32 +1,85 @@
 #!@PERL@
-##
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
-##
-## Squid software is distributed under GPLv2+ license and includes
-## contributions from numerous individuals and organizations.
-## Please see the COPYING and CONTRIBUTORS files for details.
-##
-
-# POP3 authenticator for Squid
-# Copyright (C) 2006 Henrik Nordstrom <henrik@henriknordstrom.net>
-#
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-# 
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-# 
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
-# 
-# Change log:
-#   2006-12-10	henrik	Initial revision
-#
+
+use strict;
+use Pod::Usage;
+use Getopt::Long;
+
+=pod
+
+=head1 NAME
+
+ basic_pop3_auth - POP3 authenticator for Squid
+
+=head1 SYNOPSIS
+
+ basic_pop3_auth server
+
+=head1 DESCRIPTION
+
+B<basic_pop3_auth> authenticates user credentials against a POP3 server.
+
+=head1 OPTIONS
+
+The only option this helper takes is the name of the POP3 server to validate against.
+
+=head1 AUTHOR
+
+This program was written by I<Henrik Nordstrom <henrik@henriknordstrom.net>>
+
+This manual was written by I<Amos Jeffries <squid3@treenet.co.nz>>
+
+=head1 COPYRIGHT
+
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+
+ # Copyright (C) 2006 Henrik Nordstrom <henrik@henriknordstrom.net>
+ #
+ # This program is free software; you can redistribute it and/or modify
+ # it under the terms of the GNU General Public License as published by
+ # the Free Software Foundation; either version 2 of the License, or
+ # (at your option) any later version.
+ # 
+ # This program is distributed in the hope that it will be useful,
+ # but WITHOUT ANY WARRANTY; without even the implied warranty of
+ # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ # GNU General Public License for more details.
+ # 
+ # You should have received a copy of the GNU General Public License
+ # along with this program; if not, write to the Free Software
+ # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ # 
+ # Change log:
+ #   2006-12-10	henrik	Initial revision
+ #
+
+=head1 QUESTIONS
+
+Questions on the usage of this program can be sent to the I<Squid Users mailing list <squid-users@squid-cache.org>>
+
+=head1 REPORTING BUGS
+
+Bug reports need to be made in English.
+See http://wiki.squid-cache.org/SquidFaq/BugReporting for details of what you need to include with your bug report.
+
+Report bugs or bug fixes using http://bugs.squid-cache.org/
+
+Report serious security bugs to I<Squid Bugs <squid-bugs@squid-cache.org>>
+
+Report ideas for new improvements to the I<Squid Developers mailing list <squid-dev@squid-cache.org>>
+
+=head1 SEE ALSO
+
+squid (8), GPL (7),
+
+The Squid FAQ wiki http://wiki.squid-cache.org/SquidFaq
+
+The Squid Configuration Manual http://www.squid-cache.org/Doc/config/
+
+=cut
 
 use Net::POP3;
 $|=1;
@@ -1,8 +1,10 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
-BUILD_HELPER="POP3"
+if test "x$PERL" != "x" -a "x$POD2MAN" != "x"; then
+  BUILD_HELPER="POP3"
+fi
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -96,7 +96,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -92,9 +92,9 @@
 #endif
 
 /* AYJ: helper input buffer may be a lot larger than this used to expect... */
-#define MAXPWNAM	254
-#define MAXPASS		254
-#define MAXLINE		254
+#define MAXPWNAM    254
+#define MAXPASS     254
+#define MAXLINE     254
 
 static void md5_calc(uint8_t out[16], void *in, size_t len);
 
@@ -162,7 +162,7 @@ md5_calc(uint8_t out[16], void *in, size_t len)
  *    Receive and verify the result.
  */
 static int
-result_recv(uint32_t host, unsigned short udp_port, char *buffer, int length)
+result_recv(char *buffer, int length)
 {
     AUTH_HDR *auth;
     int totallen;
@@ -440,7 +440,7 @@ authenticate(int socket_fd, const char *username, const char *passwd)
             }
             FD_ZERO(&readfds);
             FD_SET(socket_fd, &readfds);
-            if (select(socket_fd + 1, &readfds, NULL, NULL, &tv) == 0)	/* Select timeout */
+            if (select(socket_fd + 1, &readfds, NULL, NULL, &tv) == 0)  /* Select timeout */
                 break;
             salen = sizeof(saremote);
             len = recvfrom(socket_fd, recv_buffer, sizeof(i_recv_buffer),
@@ -449,7 +449,7 @@ authenticate(int socket_fd, const char *username, const char *passwd)
             if (len < 0)
                 continue;
 
-            rc = result_recv(saremote.sin_addr.s_addr, saremote.sin_port, recv_buffer, len);
+            rc = result_recv(recv_buffer, len);
             if (rc == 0) {
                 SEND_OK("");
                 return;
@@ -617,3 +617,4 @@ main(int argc, char **argv)
     close(sockfd);
     exit(1);
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -9,34 +9,34 @@
 // 2008-05-14: rename to radius-util.* to avoid name clashes with squid util.*
 /*
  *
- *	RADIUS
- *	Remote Authentication Dial In User Service
+ *  RADIUS
+ *  Remote Authentication Dial In User Service
  *
  *
- *	Livingston Enterprises, Inc.
- *	6920 Koll Center Parkway
- *	Pleasanton, CA   94566
+ *  Livingston Enterprises, Inc.
+ *  6920 Koll Center Parkway
+ *  Pleasanton, CA   94566
  *
- *	Copyright 1992 Livingston Enterprises, Inc.
- *	Copyright 1997 Cistron Internet Services B.V.
+ *  Copyright 1992 Livingston Enterprises, Inc.
+ *  Copyright 1997 Cistron Internet Services B.V.
  *
- *	Permission to use, copy, modify, and distribute this software for any
- *	purpose and without fee is hereby granted, provided that this
- *	copyright and permission notice appear on all copies and supporting
- *	documentation, the name of Livingston Enterprises, Inc. not be used
- *	in advertising or publicity pertaining to distribution of the
- *	program without specific prior permission, and notice be given
- *	in supporting documentation that copying and distribution is by
- *	permission of Livingston Enterprises, Inc.
+ *  Permission to use, copy, modify, and distribute this software for any
+ *  purpose and without fee is hereby granted, provided that this
+ *  copyright and permission notice appear on all copies and supporting
+ *  documentation, the name of Livingston Enterprises, Inc. not be used
+ *  in advertising or publicity pertaining to distribution of the
+ *  program without specific prior permission, and notice be given
+ *  in supporting documentation that copying and distribution is by
+ *  permission of Livingston Enterprises, Inc.
  *
- *	Livingston Enterprises, Inc. makes no representations about
- *	the suitability of this software for any purpose.  It is
- *	provided "as is" without express or implied warranty.
+ *  Livingston Enterprises, Inc. makes no representations about
+ *  the suitability of this software for any purpose.  It is
+ *  provided "as is" without express or implied warranty.
  *
  */
 
 /*
- * util.c	Miscellanous generic functions.
+ * util.c   Miscellanous generic functions.
  *
  */
 
@@ -65,12 +65,12 @@ char util_sccsid[] =
 #endif
 
 /*
- *	Check for valid IP address in standard dot notation.
+ *  Check for valid IP address in standard dot notation.
  */
 static int good_ipaddr(char *addr)
 {
-    int	dot_count;
-    int	digit_count;
+    int dot_count;
+    int digit_count;
 
     dot_count = 0;
     digit_count = 0;
@@ -96,17 +96,17 @@ static int good_ipaddr(char *addr)
 }
 
 /*
- *	Return an IP address in host long notation from
- *	one supplied in standard dot notation.
+ *  Return an IP address in host long notation from
+ *  one supplied in standard dot notation.
  */
 static uint32_t ipstr2long(char *ip_str)
 {
-    char	buf[6];
-    char	*ptr;
-    int	i;
-    int	count;
-    uint32_t	ipaddr;
-    int	cur_byte;
+    char    buf[6];
+    char    *ptr;
+    int i;
+    int count;
+    uint32_t    ipaddr;
+    int cur_byte;
 
     ipaddr = (uint32_t)0;
     for (i = 0; i < 4; ++i) {
@@ -137,12 +137,12 @@ static uint32_t ipstr2long(char *ip_str)
 }
 
 /*
- *	Return an IP address in host long notation from a host
- *	name or address in dot notation.
+ *  Return an IP address in host long notation from a host
+ *  name or address in dot notation.
  */
 uint32_t get_ipaddr(char *host)
 {
-    struct hostent	*hp;
+    struct hostent  *hp;
 
     if (good_ipaddr(host) == 0) {
         return(ipstr2long(host));
@@ -151,3 +151,4 @@ uint32_t get_ipaddr(char *host)
     }
     return(ntohl(*(uint32_t *)hp->h_addr));
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -12,4 +12,5 @@
 #include "util.h"
 
 /* util.c */
-uint32_t		get_ipaddr (char *);
+uint32_t        get_ipaddr (char *);
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -8,195 +8,195 @@
 
 /*
  *
- *	RADIUS
- *	Remote Authentication Dial In User Service
+ *  RADIUS
+ *  Remote Authentication Dial In User Service
  *
  *
- *	Livingston Enterprises, Inc.
- *	6920 Koll Center Parkway
- *	Pleasanton, CA   94566
+ *  Livingston Enterprises, Inc.
+ *  6920 Koll Center Parkway
+ *  Pleasanton, CA   94566
  *
- *	Copyright 1992 Livingston Enterprises, Inc.
+ *  Copyright 1992 Livingston Enterprises, Inc.
  *
- *	Permission to use, copy, modify, and distribute this software for any
- *	purpose and without fee is hereby granted, provided that this
- *	copyright and permission notice appear on all copies and supporting
- *	documentation, the name of Livingston Enterprises, Inc. not be used
- *	in advertising or publicity pertaining to distribution of the
- *	program without specific prior permission, and notice be given
- *	in supporting documentation that copying and distribution is by
- *	permission of Livingston Enterprises, Inc.
+ *  Permission to use, copy, modify, and distribute this software for any
+ *  purpose and without fee is hereby granted, provided that this
+ *  copyright and permission notice appear on all copies and supporting
+ *  documentation, the name of Livingston Enterprises, Inc. not be used
+ *  in advertising or publicity pertaining to distribution of the
+ *  program without specific prior permission, and notice be given
+ *  in supporting documentation that copying and distribution is by
+ *  permission of Livingston Enterprises, Inc.
  *
- *	Livingston Enterprises, Inc. makes no representations about
- *	the suitability of this software for any purpose.  It is
- *	provided "as is" without express or implied warranty.
+ *  Livingston Enterprises, Inc. makes no representations about
+ *  the suitability of this software for any purpose.  It is
+ *  provided "as is" without express or implied warranty.
  *
  */
 
 /*
- *	@(#)radius.h	2.0  03-Aug-1996
+ *  @(#)radius.h    2.0  03-Aug-1996
  */
 
-#define AUTH_VECTOR_LEN		16
-#define AUTH_PASS_LEN		16
-#define AUTH_STRING_LEN		128	/* maximum of 254 */
+#define AUTH_VECTOR_LEN     16
+#define AUTH_PASS_LEN       16
+#define AUTH_STRING_LEN     128 /* maximum of 254 */
 
 typedef struct pw_auth_hdr {
-    u_char		code;
-    u_char		id;
-    uint16_t		length;
-    u_char		vector[AUTH_VECTOR_LEN];
-    u_char		data[2];
+    u_char      code;
+    u_char      id;
+    uint16_t        length;
+    u_char      vector[AUTH_VECTOR_LEN];
+    u_char      data[2];
 } AUTH_HDR;
 
-#define AUTH_HDR_LEN			20
-#define CHAP_VALUE_LENGTH		16
-
-#define PW_AUTH_UDP_PORT		1812
-#define PW_ACCT_UDP_PORT		1813
-
-#define VENDORPEC_USR			429
-
-#define PW_TYPE_STRING			0
-#define PW_TYPE_INTEGER			1
-#define PW_TYPE_IPADDR			2
-#define PW_TYPE_DATE			3
-
-#define	PW_AUTHENTICATION_REQUEST	1
-#define	PW_AUTHENTICATION_ACK		2
-#define	PW_AUTHENTICATION_REJECT	3
-#define	PW_ACCOUNTING_REQUEST		4
-#define	PW_ACCOUNTING_RESPONSE		5
-#define	PW_ACCOUNTING_STATUS		6
-#define PW_PASSWORD_REQUEST		7
-#define PW_PASSWORD_ACK			8
-#define PW_PASSWORD_REJECT		9
-#define	PW_ACCOUNTING_MESSAGE		10
-#define PW_ACCESS_CHALLENGE		11
-
-#define	PW_USER_NAME			1
-#define	PW_PASSWORD			2
-#define	PW_CHAP_PASSWORD		3
-#define	PW_NAS_IP_ADDRESS		4
-#define	PW_NAS_PORT_ID			5
-#define	PW_SERVICE_TYPE			6
-#define	PW_FRAMED_PROTOCOL		7
-#define	PW_FRAMED_IP_ADDRESS		8
-#define	PW_FRAMED_IP_NETMASK		9
-#define	PW_FRAMED_ROUTING		10
-#define	PW_FILTER_ID			11
-#define	PW_FRAMED_MTU			12
-#define	PW_FRAMED_COMPRESSION		13
-#define	PW_LOGIN_IP_HOST		14
-#define	PW_LOGIN_SERVICE		15
-#define	PW_LOGIN_TCP_PORT		16
-#define PW_OLD_PASSWORD			17
-#define PW_REPLY_MESSAGE		18
-#define PW_CALLBACK_NUMBER		19
-#define PW_CALLBACK_ID			20
-#define PW_EXPIRATION			21
-#define PW_FRAMED_ROUTE			22
-#define PW_FRAMED_IPXNET		23
-#define PW_STATE			24
-#define PW_CLASS			25
-#define PW_VENDOR_SPECIFIC		26
-#define PW_SESSION_TIMEOUT		27
-#define PW_IDLE_TIMEOUT			28
-#define PW_CALLED_STATION_ID		30
-#define PW_CALLING_STATION_ID		31
-#define PW_NAS_ID			32
-#define PW_PROXY_STATE			33
-
-#define PW_ACCT_STATUS_TYPE		40
-#define PW_ACCT_DELAY_TIME		41
-#define PW_ACCT_INPUT_OCTETS		42
-#define PW_ACCT_OUTPUT_OCTETS		43
-#define PW_ACCT_SESSION_ID		44
-#define PW_ACCT_AUTHENTIC		45
-#define PW_ACCT_SESSION_TIME		46
-#define PW_ACCT_INPUT_PACKETS		47
-#define PW_ACCT_OUTPUT_PACKETS		48
-
-#define PW_CHAP_CHALLENGE		60
-#define PW_NAS_PORT_TYPE		61
-#define PW_PORT_LIMIT			62
-#define PW_CONNECT_INFO			77
-
-#define PW_HUNTGROUP_NAME		221
-#define PW_AUTHTYPE			1000
-#define PW_PREFIX			1003
-#define PW_SUFFIX			1004
-#define PW_GROUP			1005
-#define PW_CRYPT_PASSWORD		1006
-#define PW_CONNECT_RATE			1007
-#define PW_USER_CATEGORY		1029
-#define PW_GROUP_NAME			1030
-#define PW_SIMULTANEOUS_USE		1034
-#define PW_STRIP_USERNAME		1035
-#define PW_FALL_THROUGH			1036
-#define PW_ADD_PORT_TO_IP_ADDRESS	1037
-#define PW_EXEC_PROGRAM			1038
-#define PW_EXEC_PROGRAM_WAIT		1039
-#define PW_HINT				1040
-#define PAM_AUTH_ATTR			1041
-#define PW_LOGIN_TIME			1042
+#define AUTH_HDR_LEN            20
+#define CHAP_VALUE_LENGTH       16
+
+#define PW_AUTH_UDP_PORT        1812
+#define PW_ACCT_UDP_PORT        1813
+
+#define VENDORPEC_USR           429
+
+#define PW_TYPE_STRING          0
+#define PW_TYPE_INTEGER         1
+#define PW_TYPE_IPADDR          2
+#define PW_TYPE_DATE            3
+
+#define PW_AUTHENTICATION_REQUEST   1
+#define PW_AUTHENTICATION_ACK       2
+#define PW_AUTHENTICATION_REJECT    3
+#define PW_ACCOUNTING_REQUEST       4
+#define PW_ACCOUNTING_RESPONSE      5
+#define PW_ACCOUNTING_STATUS        6
+#define PW_PASSWORD_REQUEST     7
+#define PW_PASSWORD_ACK         8
+#define PW_PASSWORD_REJECT      9
+#define PW_ACCOUNTING_MESSAGE       10
+#define PW_ACCESS_CHALLENGE     11
+
+#define PW_USER_NAME            1
+#define PW_PASSWORD         2
+#define PW_CHAP_PASSWORD        3
+#define PW_NAS_IP_ADDRESS       4
+#define PW_NAS_PORT_ID          5
+#define PW_SERVICE_TYPE         6
+#define PW_FRAMED_PROTOCOL      7
+#define PW_FRAMED_IP_ADDRESS        8
+#define PW_FRAMED_IP_NETMASK        9
+#define PW_FRAMED_ROUTING       10
+#define PW_FILTER_ID            11
+#define PW_FRAMED_MTU           12
+#define PW_FRAMED_COMPRESSION       13
+#define PW_LOGIN_IP_HOST        14
+#define PW_LOGIN_SERVICE        15
+#define PW_LOGIN_TCP_PORT       16
+#define PW_OLD_PASSWORD         17
+#define PW_REPLY_MESSAGE        18
+#define PW_CALLBACK_NUMBER      19
+#define PW_CALLBACK_ID          20
+#define PW_EXPIRATION           21
+#define PW_FRAMED_ROUTE         22
+#define PW_FRAMED_IPXNET        23
+#define PW_STATE            24
+#define PW_CLASS            25
+#define PW_VENDOR_SPECIFIC      26
+#define PW_SESSION_TIMEOUT      27
+#define PW_IDLE_TIMEOUT         28
+#define PW_CALLED_STATION_ID        30
+#define PW_CALLING_STATION_ID       31
+#define PW_NAS_ID           32
+#define PW_PROXY_STATE          33
+
+#define PW_ACCT_STATUS_TYPE     40
+#define PW_ACCT_DELAY_TIME      41
+#define PW_ACCT_INPUT_OCTETS        42
+#define PW_ACCT_OUTPUT_OCTETS       43
+#define PW_ACCT_SESSION_ID      44
+#define PW_ACCT_AUTHENTIC       45
+#define PW_ACCT_SESSION_TIME        46
+#define PW_ACCT_INPUT_PACKETS       47
+#define PW_ACCT_OUTPUT_PACKETS      48
+
+#define PW_CHAP_CHALLENGE       60
+#define PW_NAS_PORT_TYPE        61
+#define PW_PORT_LIMIT           62
+#define PW_CONNECT_INFO         77
+
+#define PW_HUNTGROUP_NAME       221
+#define PW_AUTHTYPE         1000
+#define PW_PREFIX           1003
+#define PW_SUFFIX           1004
+#define PW_GROUP            1005
+#define PW_CRYPT_PASSWORD       1006
+#define PW_CONNECT_RATE         1007
+#define PW_USER_CATEGORY        1029
+#define PW_GROUP_NAME           1030
+#define PW_SIMULTANEOUS_USE     1034
+#define PW_STRIP_USERNAME       1035
+#define PW_FALL_THROUGH         1036
+#define PW_ADD_PORT_TO_IP_ADDRESS   1037
+#define PW_EXEC_PROGRAM         1038
+#define PW_EXEC_PROGRAM_WAIT        1039
+#define PW_HINT             1040
+#define PAM_AUTH_ATTR           1041
+#define PW_LOGIN_TIME           1042
 
 /*
- *	INTEGER TRANSLATIONS
+ *  INTEGER TRANSLATIONS
  */
 
-/*	USER TYPES	*/
+/*  USER TYPES  */
 
-#define	PW_LOGIN_USER			1
-#define	PW_FRAMED_USER			2
-#define	PW_DIALBACK_LOGIN_USER		3
-#define	PW_DIALBACK_FRAMED_USER		4
+#define PW_LOGIN_USER           1
+#define PW_FRAMED_USER          2
+#define PW_DIALBACK_LOGIN_USER      3
+#define PW_DIALBACK_FRAMED_USER     4
 
-/*	FRAMED PROTOCOLS	*/
+/*  FRAMED PROTOCOLS    */
 
-#define	PW_PPP				1
-#define	PW_SLIP				2
+#define PW_PPP              1
+#define PW_SLIP             2
 
-/*	FRAMED ROUTING VALUES	*/
+/*  FRAMED ROUTING VALUES   */
 
-#define	PW_NONE				0
-#define	PW_BROADCAST			1
-#define	PW_LISTEN			2
-#define	PW_BROADCAST_LISTEN		3
+#define PW_NONE             0
+#define PW_BROADCAST            1
+#define PW_LISTEN           2
+#define PW_BROADCAST_LISTEN     3
 
-/*	FRAMED COMPRESSION TYPES	*/
+/*  FRAMED COMPRESSION TYPES    */
 
-#define	PW_VAN_JACOBSEN_TCP_IP		1
+#define PW_VAN_JACOBSEN_TCP_IP      1
 
-/*	LOGIN SERVICES	*/
+/*  LOGIN SERVICES  */
 
-#define	PW_TELNET			0
-#define	PW_RLOGIN			1
-#define	PW_TCP_CLEAR			2
-#define	PW_PORTMASTER			3
+#define PW_TELNET           0
+#define PW_RLOGIN           1
+#define PW_TCP_CLEAR            2
+#define PW_PORTMASTER           3
 
-/*	AUTHENTICATION LEVEL	*/
+/*  AUTHENTICATION LEVEL    */
 
-#define PW_AUTHTYPE_LOCAL		0
-#define PW_AUTHTYPE_SYSTEM		1
-#define PW_AUTHTYPE_SECURID		2
-#define PW_AUTHTYPE_CRYPT		3
-#define PW_AUTHTYPE_REJECT		4
-#define PW_AUTHTYPE_PAM			253
-#define PW_AUTHTYPE_ACCEPT		254
+#define PW_AUTHTYPE_LOCAL       0
+#define PW_AUTHTYPE_SYSTEM      1
+#define PW_AUTHTYPE_SECURID     2
+#define PW_AUTHTYPE_CRYPT       3
+#define PW_AUTHTYPE_REJECT      4
+#define PW_AUTHTYPE_PAM         253
+#define PW_AUTHTYPE_ACCEPT      254
 
-/*	PORT TYPES		*/
-#define PW_NAS_PORT_ASYNC		0
-#define PW_NAS_PORT_SYNC		1
-#define PW_NAS_PORT_ISDN		2
-#define PW_NAS_PORT_ISDN_V120		3
-#define PW_NAS_PORT_ISDN_V110		4
+/*  PORT TYPES      */
+#define PW_NAS_PORT_ASYNC       0
+#define PW_NAS_PORT_SYNC        1
+#define PW_NAS_PORT_ISDN        2
+#define PW_NAS_PORT_ISDN_V120       3
+#define PW_NAS_PORT_ISDN_V110       4
 
-/*	STATUS TYPES	*/
+/*  STATUS TYPES    */
 
-#define PW_STATUS_START			1
-#define PW_STATUS_STOP			2
-#define PW_STATUS_ALIVE			3
-#define PW_STATUS_ACCOUNTING_ON		7
-#define PW_STATUS_ACCOUNTING_OFF	8
+#define PW_STATUS_START         1
+#define PW_STATUS_STOP          2
+#define PW_STATUS_ALIVE         3
+#define PW_STATUS_ACCOUNTING_ON     7
+#define PW_STATUS_ACCOUNTING_OFF    8
 
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -80,7 +80,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -46,10 +46,10 @@
 #include <sasl.h>
 #endif
 
-#define APP_NAME_SASL	"basic_sasl_auth"
+#define APP_NAME_SASL   "basic_sasl_auth"
 
 int
-main(int argc, char *argv[])
+main(int, char *argv[])
 {
     char line[HELPER_INPUT_BUFFER];
     char *username, *password;
@@ -128,3 +128,4 @@ main(int argc, char *argv[])
     sasl_done();
     return 0;
 }
+
@@ -1,6 +1,6 @@
 #%PAM-1.0
 ##
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -31,18 +31,18 @@
 
 #include <cstring>
 
-#define NMB_UNICAST		1
-#define NMB_BROADCAST	2
+#define NMB_UNICAST     1
+#define NMB_BROADCAST   2
 
 struct SMBDOMAIN {
-    const char *name;		/* domain name */
-    const char *sname;		/* match this with user input */
-    const char *passthrough;	/* pass-through authentication */
-    const char *nmbaddr;	/* name service address */
-    int nmbcast;		/* broadcast or unicast */
-    char *authshare;		/* share name of auth file */
-    const char *authfile;	/* pathname of auth file */
-    struct SMBDOMAIN *next;	/* linked list */
+    const char *name;       /* domain name */
+    const char *sname;      /* match this with user input */
+    const char *passthrough;    /* pass-through authentication */
+    const char *nmbaddr;    /* name service address */
+    int nmbcast;        /* broadcast or unicast */
+    char *authshare;        /* share name of auth file */
+    const char *authfile;   /* pathname of auth file */
+    struct SMBDOMAIN *next; /* linked list */
 };
 
 struct SMBDOMAIN *firstdom = NULL;
@@ -236,6 +236,7 @@ main(int argc, char *argv[])
             SEND_OK("");
         else
             SEND_ERR("");
-    }				/* while (1) */
+    }               /* while (1) */
     return 0;
 }
+
@@ -1,6 +1,6 @@
 #!/bin/sh
 #
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -0,0 +1,31 @@
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+##
+## Squid software is distributed under GPLv2+ license and includes
+## contributions from numerous individuals and organizations.
+## Please see the COPYING and CONTRIBUTORS files for details.
+##
+
+include $(top_srcdir)/src/Common.am
+
+libexec_PROGRAMS = basic_smb_lm_auth
+
+basic_smb_lm_auth_SOURCES = \
+	msntauth.cc \
+	msntauth.h \
+	valid.cc \
+	valid.h
+
+EXTRA_DIST = \
+	msntauth-v2.0.lsm \
+	README.html \
+	required.m4
+
+LDADD = \
+	$(top_builddir)/lib/smblib/libsmblib.la \
+	$(top_builddir)/lib/rfcnb/librfcnb.la \
+	$(top_builddir)/lib/libmiscencoding.la \
+	$(COMPAT_LIB) \
+	$(XTRA_LIBS)
+
+## we need our local files too (but avoid -I. at all costs)
+AM_CPPFLAGS += -I$(srcdir) -I$(top_srcdir)/lib
@@ -0,0 +1,151 @@
+<HTML>
+<HEAD>
+<TITLE>MSNTAUTH readme</TITLE>
+</HEAD>
+<BODY BGCOLOR="#FFFFFF">
+
+<!--
+If you require this document in text form, download the 
+HTML-text package from http://members.tripod.com/stellarx.
+-->
+
+<H1>
+MSNT Auth v3.0.0<BR>
+Squid web proxy NT authentication module<BR>
+Modified by the Squid HTTP Proxy team<BR>
+Original release by Antonino Iannella, Stellar-X Pty Ltd<BR>
+</H1>
+
+<H2>Contents</H2>
+
+<UL>
+<LI> <A HREF="#introduction">Introduction</A>
+<LI> <A HREF="#installation">Installation</A>
+<LI> <A HREF="#configuration">Configuration</A>
+<LI> <A HREF="#squid">Squid.conf changes</A>
+<LI> <A HREF="#testing">Testing</A>
+<LI> <A HREF="#contact">Support details</A>
+</UL>
+
+<A NAME="introduction"><H2>Introduction</H2>
+
+<P>
+This is an authentication module for the Squid proxy server
+to use an NT domain server.
+
+<P>
+It originates from the Samba and SMB packages by Andrew Tridgell
+and Richard Sharpe. It is sourced from the Pike
+authentication module by William Welliver (hwellive@intersil.com),
+and the SMB 1.0.1 libraries.
+Releases up to version 2.0.3 were created by Antonino Iannella
+(antonino@rager.com.au, http://stellarx.tripod.com).
+The module is now distributed with Squid, and is maintained by the
+Squid proxy team as an Open Source effort.
+Msntauth is released under the GNU General Public License.
+
+<P>
+<i>basic_msnt_auth</i> follows the standard Squid basic authentication helper protocol.
+See <a href="http://wiki.squid-cache.org/Features/AddonHelpers#Basic_Scheme"
+>http://wiki.squid-cache.org/Features/AddonHelpers#Basic_Scheme</a> for details.
+Problems are logged to syslog.
+
+<P>
+Msntauth works in environments with NT domain controllers on
+Windows (TM) NT 4, 2000, and Samba. It only uses the ancient <i>Lanman</i> protocol,
+the authenticating systems must be configured to accept it.
+
+<A NAME="installation"><H2>Installation</H2>
+
+<P>
+Msntauth will be compiled when you compile Squid, using
+their autoconf system.
+Refer to Squid documentation for details.
+If the build is suitable, you can skip this section.
+
+<A NAME="configuration"><H2>Configuration</H2>
+
+<P>
+As of version 3.0.0, a configuration file is no longer needed.
+The specification of the domains and domain controllers to use is
+passed as a list of arguments on the command line.
+
+The syntax is:
+<PRE>
+basic_msnt_auth domain1/domaincontroller1 [domain2/domaincontroller2 ...]
+</PRE>
+An arbitrary number of domain controllers can be specified, for any number of daomains.
+Domain controllers will be attempted in the same order they are configured, until
+any of them successfully authenticates the user passed by squid. If all domain
+controllers fail to authenticate the user, then access is denied.
+Domain controllers can be specified by their NetBios name.
+
+<P>
+<B>WARNING!</B> this means that a wrong password will be attempted a number of times.
+Watch out for domain lock-out policies!
+
+<A NAME="squid"><H2>Squid.conf changes</H2>
+
+<P>
+Refer to Squid documentation for the required changes to squid.conf.
+You will need to set the following lines to enable authentication for
+your access list -
+
+<PRE>
+  acl <I>yourACL</I> proxy_auth REQUIRED
+  http_access allow password
+  http_access allow <I>yourACL</I>
+  http_access deny all
+</PRE>
+
+<P>
+You will also need to review the following directives. The number of
+msntauth children spawned is set with authenticate_children.
+The number of children needed is site-dependent, so some
+experimentation may be required to find the best number.
+There should be no visible delay in performance with Squid once
+msntauth is in use.
+
+Please see <A href="http://www.squid-cache.org/Doc/config/auth_param/"
+>http://www.squid-cache.org/Doc/config/auth_param/</A> or your <TT>squid.conf.default</TT>
+file to check how to configure squid to make use of this helper.
+
+<A NAME="testing"><H2>Testing</H2>
+
+<P>
+I strongly urge that Msntauth is tested prior to being used in a 
+production environment. It may behave differently on different platforms.
+To test it, run it from the command line, and enter username and password
+pairs separated by a space.
+
+<P>
+It should behave in the following way -
+<PRE>
+ - Press ENTER to get an OK or ERR message.
+ - Make sure pressing CTRL-D behaves the same as a carriage return.
+ - Make sure pressing CTRL-C aborts the program.
+ - Test that entering no details does not result in an OK or ERR message.
+ - Test that entering an invalid username and password results in
+   an ERR message. Note that if NT guest user access is allowed on
+   the PDC, an OK message may be returned instead of ERR.
+ - Test that entering an valid username and password results in an OK message.
+   Try usernames which are and aren't in the denied/allowed user files,
+   if they're in use.
+ - Test that entering a guest username and password returns the correct response.
+</PRE>
+
+<P>
+If the above didn't work as expected, you may need to modify the main()
+function in msntauth.c. Inform the Squid maintainers of any problems.
+
+<P>
+Usernames and passwords are expected to be URL-encoded (see RFC 1738 for details)
+
+<A NAME="contact"><H2>Support details</H2>
+
+<P>
+Refer to the Squid website at http://www.squid-cache.org.
+You can submit problems or fixes using the Squid project's Bugzilla database.
+
+</BODY>
+</HTML>
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -43,18 +43,45 @@
 
 #include <csignal>
 #include <cstring>
+#include <iostream>
+#include <string>
+#include <vector> //todo: turn into multimap
 #include <syslog.h>
 
 #include "msntauth.h"
+#include "valid.h"
 
-extern char version[];
-char msntauth_version[] = "Msntauth v2.0.3 (C) 2 Sep 2001 Stellar-X Antonino Iannella.\nModified by the Squid HTTP Proxy team 26 Jun 2002";
+static char msntauth_version[] = "Msntauth v3.0.0 (C) 2 Sep 2001 Stellar-X Antonino Iannella.\nModified by the Squid HTTP Proxy team 2002-2014";
 
-/* Main program for simple authentication.
- * Reads the denied user file. Sets alarm timer.
- * Scans and checks for Squid input, and attempts to validate the user.
- */
+struct domaincontroller {
+    std::string domain;
+    std::string server;
+};
+typedef std::vector<domaincontroller> domaincontrollers_t;
+domaincontrollers_t domaincontrollers;
+
+bool
+validate_user(char *username, char *password)
+{
+    for (domaincontrollers_t::iterator dc = domaincontrollers.begin(); dc != domaincontrollers.end(); ++dc) {
+        //std::cerr << "testing against " << dc->server << std::endl;
+        const int rv = Valid_User(username, password, dc->server.c_str(), NULL, dc->domain.c_str());
+        //std::cerr << "check result: " << rv << std::endl;
+        if (rv == NTV_NO_ERROR)
+            return true;
+    }
+    return false;
+}
+
+static char instructions[] = "Usage instructions: basic_nsnt_auth <domainname>/<domaincontroller> [<domainname>/<domaincontroller> ...]";
+void
+display_usage_instructions()
+{
+    using std::endl;
+    std::cerr << msntauth_version << endl << instructions << endl << endl;
+}
 
+// arguments: domain/server_name [domain/server_name ...]
 int
 main(int argc, char **argv)
 {
@@ -63,36 +90,31 @@ main(int argc, char **argv)
     char wstr[256];
     int err = 0;
 
-    openlog("msnt_auth", LOG_PID, LOG_USER);
+    openlog("basic_smb_lm_auth", LOG_PID, LOG_USER);
     setbuf(stdout, NULL);
 
-    /* Read configuration file. Abort wildly if error. */
-    if (OpenConfigFile() == 1)
-        return 1;
-
-    /*
-     * Read denied and allowed user files.
-     * If they fails, there is a serious problem.
-     * Check syslog messages. Deny all users while in this state.
-     * The msntauth process should then be killed.
-     */
-    if ((Read_denyusers() == 1) || (Read_allowusers() == 1)) {
-        while (1) {
-            memset(wstr, '\0', sizeof(wstr));
-            if (fgets(wstr, 255, stdin) == NULL)
-                break;
-            puts("ERR");
+    for (int j = 1; j < argc; ++j) {
+        std::string arg = argv[j];
+        size_t pos=arg.find('/');
+        if (arg.find('/',pos+1) != std::string::npos) {
+            std::cerr << "Error: can't understand domain controller specification '"
+                      << arg << "'. Ignoring" << std::endl;
+        }
+        domaincontroller dc;
+        dc.domain = arg.substr(0,pos);
+        dc.server = arg.substr(pos+1);
+        if (dc.domain.length() == 0 || dc.server.length() == 0) {
+            std::cerr << "Error: invalid domain specification in '" << arg <<
+                      "'. Ignoring." << std::endl;
+            exit(1);
         }
-        return 1;
+        domaincontrollers.push_back(dc);
+    }
+    if (domaincontrollers.empty()) {
+        display_usage_instructions();
+        std::cerr << "Error: no domain controllers specified" << std::endl;
+        exit(1);
     }
-
-    /*
-     * Make Check_forchange() the handle for HUP signals.
-     * Don't use alarms any more. I don't think it was very
-     * portable between systems.
-     * XXX this should be sigaction()
-     */
-    signal(SIGHUP, Check_forchange);
 
     while (1) {
         int n;
@@ -114,7 +136,6 @@ main(int argc, char **argv)
 
         /*
          * extract username and password.
-         * XXX is sscanf() safe?
          */
         username[0] = '\0';
         password[0] = '\0';
@@ -128,21 +149,13 @@ main(int argc, char **argv)
             puts("ERR");
             continue;
         }
-        Checktimer();		/* Check if the user lists have changed */
 
         rfc1738_unescape(username);
         rfc1738_unescape(password);
 
-        /*
-         * Check if user is explicitly denied or allowed.
-         * If user passes both checks, they can be authenticated.
-         */
-        if (Check_user(username) == 1) {
-            syslog(LOG_INFO, "'%s' denied", username);
-            puts("ERR");
-        } else if (QueryServers(username, password) == 0)
+        if (validate_user(username, password)) {
             puts("OK");
-        else {
+        } else {
             syslog(LOG_INFO, "'%s' login failed", username);
             puts("ERR");
         }
@@ -151,3 +164,4 @@ main(int argc, char **argv)
 
     return 0;
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -9,15 +9,8 @@
 #ifndef _SQUID_HELPERS_BASIC_AUTH_MSNT_MSNTAUTH_H
 #define _SQUID_HELPERS_BASIC_AUTH_MSNT_MSNTAUTH_H
 
-extern int OpenConfigFile(void);
 extern int QueryServers(char *, char *);
-extern void Checktimer(void);
-extern "C" void Check_forchange(int);
-extern int Read_denyusers(void);
-extern int Read_allowusers(void);
-extern int Check_user(char *);
-extern int QueryServers(char *, char *);
-extern int Check_ifuserallowed(char *ConnectingUser);
 extern void Check_forallowchange(void);
 
 #endif /* _SQUID_HELPERS_BASIC_AUTH_MSNT_MSNTAUTH_H */
+
@@ -1,11 +1,11 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
-BUILD_HELPER="MSNT"
+BUILD_HELPER="SMB_LM"
 
 # DONT build this helper on Windows
 AC_CHECK_HEADERS([w32api/windows.h windows.h],[BUILD_HELPER=""])
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -19,8 +19,9 @@
 #include "smblib/smblib.h"
 #include "valid.h"
 
+// BACKUP is unused
 int
-Valid_User(char *USERNAME, char *PASSWORD, char *SERVER, char *BACKUP, char *DOMAIN)
+Valid_User(char *USERNAME, char *PASSWORD, const char *SERVER, char *, const char *DOMAIN)
 {
     const char *supportedDialects[] = {"PC NETWORK PROGRAM 1.0",
                                        "MICROSOFT NETWORKS 1.03",
@@ -36,13 +37,10 @@ Valid_User(char *USERNAME, char *PASSWORD, char *SERVER, char *BACKUP, char *DOM
 
     SMB_Init();
     con = SMB_Connect_Server(NULL, SERVER, DOMAIN);
-    if (con == NULL) {		/* Error ... */
-        con = SMB_Connect_Server(NULL, BACKUP, DOMAIN);
-        if (con == NULL) {
-            return (NTV_SERVER_ERROR);
-        }
+    if (con == NULL) {
+        return (NTV_SERVER_ERROR);
     }
-    if (SMB_Negotiate(con, supportedDialects) < 0) {	/* An error */
+    if (SMB_Negotiate(con, supportedDialects) < 0) {    /* An error */
         SMB_Discon(con, 0);
         return (NTV_PROTOCOL_ERROR);
     }
@@ -53,3 +51,4 @@ Valid_User(char *USERNAME, char *PASSWORD, char *SERVER, char *BACKUP, char *DOM
     SMB_Discon(con, 0);
     return (NTV_NO_ERROR);
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -15,6 +15,7 @@
 #define NTV_PROTOCOL_ERROR 2
 #define NTV_LOGON_ERROR 3
 
-int Valid_User(char *USERNAME, char *PASSWORD, char *SERVER, char *BACKUP, char *DOMAIN);
+int Valid_User(char *USERNAME, char *PASSWORD, const char *SERVER, char *BACKUP, const char *DOMAIN);
 
 #endif
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -19,10 +19,9 @@ basic_sspi_auth_SOURCES = \
 	valid.cc valid.h
 basic_sspi_auth_CXXFLAGS = -Wl,--enable-auto-import
 basic_sspi_auth_LDADD = \
+	$(top_builddir)/lib/libsspwin32.la \
+	$(top_builddir)/lib/libmiscencoding.la \
 	$(COMPAT_LIB) \
-	-L$(top_builddir)/lib \
-	-lsspwin32 \
-	-lmiscencoding \
 	-lnetapi32 -ladvapi32 \
 	$(XTRA_LIBS)
 
@@ -134,7 +134,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -100,7 +100,7 @@ process_options(int argc, char *argv[])
             exit(0);
         case '?':
             opt = optopt;
-            /* fall thru to default */
+        /* fall thru to default */
         default:
             fprintf(stderr, "FATAL: Unknown option: -%c\n", opt);
             usage(argv[0]);
@@ -149,13 +149,13 @@ main(int argc, char **argv)
         }
 
         if ((p = strchr(wstr, '\n')) != NULL)
-            *p = '\0';		/* strip \n */
+            *p = '\0';      /* strip \n */
         if ((p = strchr(wstr, '\r')) != NULL)
-            *p = '\0';		/* strip \r */
+            *p = '\0';      /* strip \r */
         /* Clear any current settings */
         username[0] = '\0';
         password[0] = '\0';
-        sscanf(wstr, "%s %s", username, password);	/* Extract parameters */
+        sscanf(wstr, "%s %s", username, password);  /* Extract parameters */
 
         debug("Got %s from Squid\n", wstr);
 
@@ -179,3 +179,4 @@ main(int argc, char **argv)
     }
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -61,8 +61,8 @@ int
 Valid_Group(char *UserName, char *Group)
 {
     int result = FALSE;
-    WCHAR wszUserName[256];	// Unicode user name
-    WCHAR wszGroup[256];	// Unicode Group
+    WCHAR wszUserName[256]; // Unicode user name
+    WCHAR wszGroup[256];    // Unicode Group
 
     LPLOCALGROUP_USERS_INFO_0 pBuf = NULL;
     LPLOCALGROUP_USERS_INFO_0 pTmpBuf;
@@ -124,13 +124,6 @@ Valid_Group(char *UserName, char *Group)
     return result;
 }
 
-/* Valid_User return codes -
-   0 - User authenticated successfully.
-   1 - Server error.
-   2 - Group membership error.
-   3 - Logon error; Incorrect password or username given.
-*/
-
 int
 Valid_User(char *UserName, char *Password, char *Group)
 {
@@ -186,3 +179,4 @@ Valid_User(char *UserName, char *Password, char *Group)
     }
     return result;
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -67,8 +67,18 @@ extern int debug_enabled;
 extern char Default_NTDomain[DNLEN+1];
 extern const char * errormsg;
 
+/**
+ * Valid_User return codes.
+ *
+ * \retval 0   User authenticated successfully.
+ * \retval 1   Server error.
+ * \retval 2   Group membership error.
+ * \retval 3   Logon error; Incorrect password or username given.
+ */
+int Valid_User(char *UserName, char *Password, char *Group);
+
 /* Debugging stuff */
-#if defined(__GNUC__)			/* this is really a gcc-ism */
+#if defined(__GNUC__)           /* this is really a gcc-ism */
 #include <unistd.h>
 static char *__foo;
 #define debug(X...) if (debug_enabled) { \
@@ -91,6 +101,5 @@ debug(char *format,...)
 }
 #endif /* __GNUC__ */
 
-int Valid_User(char *,char *, char *);
-
 #endif
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -105,7 +105,7 @@ main(int argc, char *argv[])
         char *p;
 
         if ((p = strchr(buf, '\n')) != NULL) {
-            *p = '\0';		/* strip \n */
+            *p = '\0';      /* strip \n */
             buflen = p - buf;   /* length is known already */
         } else
             buflen = strlen(buf);   /* keep this so we only scan the buffer for \0 once per loop */
@@ -118,3 +118,4 @@ main(int argc, char *argv[])
     debug("%s build " __DATE__ ", " __TIME__ " shutting down...\n", program_name);
     exit(0);
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -74,7 +74,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -57,12 +57,12 @@ passwd_auth(char *user, char *passwd)
     struct passwd *pwd;
     pwd = getpwnam(user);
     if (pwd == NULL) {
-        return 0;		/* User does not exist */
+        return 0;       /* User does not exist */
     } else {
         if (strcmp(pwd->pw_passwd, (char *) crypt(passwd, pwd->pw_passwd))) {
-            return 2;		/* Wrong password */
+            return 2;       /* Wrong password */
         } else {
-            return 1;		/* Authentication Sucessful */
+            return 1;       /* Authentication Sucessful */
         }
     }
 }
@@ -74,19 +74,19 @@ shadow_auth(char *user, char *passwd)
     struct spwd *pwd;
     pwd = getspnam(user);
     if (pwd == NULL) {
-        return passwd_auth(user, passwd);	/* Fall back to passwd_auth */
+        return passwd_auth(user, passwd);   /* Fall back to passwd_auth */
     } else {
         if (strcmp(pwd->sp_pwdp, crypt(passwd, pwd->sp_pwdp))) {
-            return 2;		/* Wrong password */
+            return 2;       /* Wrong password */
         } else {
-            return 1;		/* Authentication Sucessful */
+            return 1;       /* Authentication Sucessful */
         }
     }
 }
 #endif
 
 int
-main(int argc, char **argv)
+main(int, char **)
 {
     int auth = 0;
     char buf[HELPER_INPUT_BUFFER];
@@ -96,7 +96,7 @@ main(int argc, char **argv)
     while (fgets(buf, HELPER_INPUT_BUFFER, stdin) != NULL) {
 
         if ((p = strchr(buf, '\n')) != NULL)
-            *p = '\0';		/* strip \n */
+            *p = '\0';      /* strip \n */
 
         if ((user = strtok(buf, " ")) == NULL) {
             SEND_ERR("No Username");
@@ -125,3 +125,4 @@ main(int argc, char **argv)
     }
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -44,12 +44,6 @@ if test "x$enable_auth_basic" != "xno" ; then
       elif test "x$helper" = "xLDAP" ; then
         m4_include([helpers/basic_auth/LDAP/required.m4])
 
-      elif test "x$helper" = "xMSNT-multi-domain" ; then
-        m4_include([helpers/basic_auth/MSNT-multi-domain/required.m4])
-
-      elif test "x$helper" = "xMSNT" ; then
-        m4_include([helpers/basic_auth/MSNT/required.m4])
-
       elif test "x$helper" = "xNCSA" ; then
         m4_include([helpers/basic_auth/NCSA/required.m4])
 
@@ -71,6 +65,9 @@ if test "x$enable_auth_basic" != "xno" ; then
       elif test "x$helper" = "xSMB" ; then
         m4_include([helpers/basic_auth/SMB/required.m4])
 
+      elif test "x$helper" = "xSMB_LM" ; then
+        m4_include([helpers/basic_auth/SMB_LM/required.m4])
+
       elif test "x$helper" = "xSSPI" ; then
         m4_include([helpers/basic_auth/SSPI/required.m4])
 
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -43,18 +43,19 @@
  * useful and shared between helpers.
  */
 
-#define HELPER_INPUT_BUFFER	8196
+#define HELPER_INPUT_BUFFER 8196
 
 /* send OK result to Squid with a string parameter. */
-#define SEND_OK(x)	fprintf(stdout, "OK %s\n",x)
+#define SEND_OK(x)  fprintf(stdout, "OK %s\n",x)
 
 /* send ERR result to Squid with a string parameter. */
-#define SEND_ERR(x)	fprintf(stdout, "ERR %s\n",x)
+#define SEND_ERR(x) fprintf(stdout, "ERR %s\n",x)
 
 /* send ERR result to Squid with a string parameter. */
-#define SEND_BH(x)	fprintf(stdout, "BH %s\n",x)
+#define SEND_BH(x)  fprintf(stdout, "BH %s\n",x)
 
 /* send TT result to Squid with a string parameter. */
-#define SEND_TT(x)	fprintf(stdout, "TT %s\n",x)
+#define SEND_TT(x)  fprintf(stdout, "TT %s\n",x)
 
 #endif /* __SQUID_HELPERS_DEFINES_H */
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -52,3 +52,4 @@ typedef void HandleArguments(int, char **);
 typedef void HHA1Creator(RequestData *);
 
 #endif /* SQUID_DIGEST_COMMON_H_ */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -55,7 +55,7 @@ ParseBuffer(char *buf, RequestData * requestData)
     char *p;
     requestData->parsed = 0;
     if ((p = strchr(buf, '\n')) != NULL)
-        *p = '\0';		/* strip \n */
+        *p = '\0';      /* strip \n */
 
     p = NULL;
     requestData->channelId = strtoll(buf, &p, 10);
@@ -120,3 +120,4 @@ main(int argc, char **argv)
         DoOneRequest(buf);
     exit(0);
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -430,7 +430,7 @@ LDAPArguments(int argc, char **argv)
             fprintf(stderr, "ERROR: Your LDAP library does not have URI support\n");
             return 1;
 #endif
-            /* Fall thru to -h */
+        /* Fall thru to -h */
         case 'h':
             if (ldapServer) {
                 int len = strlen(ldapServer) + 1 + strlen(value) + 1;
@@ -660,3 +660,4 @@ LDAPHHA1(RequestData * requestData)
     }
 
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -14,3 +14,4 @@
 
 extern int LDAPArguments(int argc, char **argv);
 extern void LDAPHHA1(RequestData * requestData);
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -55,3 +55,4 @@ typedef void HandleArguments(int, char **);
 typedef void HHA1Creator(RequestData *);
 
 #endif /* SQUID_DIGEST_COMMON_H_ */
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -54,7 +54,7 @@ ParseBuffer(char *buf, RequestData * requestData)
     char *p;
     requestData->parsed = 0;
     if ((p = strchr(buf, '\n')) != NULL)
-        *p = '\0';		/* strip \n */
+        *p = '\0';      /* strip \n */
 
     p = NULL;
     requestData->channelId = strtoll(buf, &p, 10);
@@ -119,3 +119,4 @@ main(int argc, char **argv)
         DoOneRequest(buf);
     exit(0);
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -13,7 +13,7 @@
  *
  * Original copyright & license follows:
  *
- * Copyright (C) Vince Brimhall			2004-2005
+ * Copyright (C) Vince Brimhall         2004-2005
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -59,16 +59,16 @@
 
 #include "edir_ldapext.h"
 
-#define NMASLDAP_GET_LOGIN_CONFIG_REQUEST	"2.16.840.1.113719.1.39.42.100.3"
-#define NMASLDAP_GET_LOGIN_CONFIG_RESPONSE	"2.16.840.1.113719.1.39.42.100.4"
-#define NMASLDAP_SET_PASSWORD_REQUEST		"2.16.840.1.113719.1.39.42.100.11"
-#define NMASLDAP_SET_PASSWORD_RESPONSE		"2.16.840.1.113719.1.39.42.100.12"
-#define NMASLDAP_GET_PASSWORD_REQUEST		"2.16.840.1.113719.1.39.42.100.13"
-#define NMASLDAP_GET_PASSWORD_RESPONSE		"2.16.840.1.113719.1.39.42.100.14"
+#define NMASLDAP_GET_LOGIN_CONFIG_REQUEST   "2.16.840.1.113719.1.39.42.100.3"
+#define NMASLDAP_GET_LOGIN_CONFIG_RESPONSE  "2.16.840.1.113719.1.39.42.100.4"
+#define NMASLDAP_SET_PASSWORD_REQUEST       "2.16.840.1.113719.1.39.42.100.11"
+#define NMASLDAP_SET_PASSWORD_RESPONSE      "2.16.840.1.113719.1.39.42.100.12"
+#define NMASLDAP_GET_PASSWORD_REQUEST       "2.16.840.1.113719.1.39.42.100.13"
+#define NMASLDAP_GET_PASSWORD_RESPONSE      "2.16.840.1.113719.1.39.42.100.14"
 
-#define NMAS_LDAP_EXT_VERSION				1
+#define NMAS_LDAP_EXT_VERSION               1
 
-#define SMB_MALLOC_ARRAY(type, nelem)		calloc(sizeof(type), nelem)
+#define SMB_MALLOC_ARRAY(type, nelem)       calloc(sizeof(type), nelem)
 #define DEBUG(level, args)
 
 /**********************************************************************
@@ -161,7 +161,7 @@ static int berEncodeLoginData(
     unsigned int i;
     unsigned int elemCnt = methodIDLen / sizeof(unsigned int);
 
-    char	*utf8ObjPtr=NULL;
+    char    *utf8ObjPtr=NULL;
     int     utf8ObjSize = 0;
 
     char    *utf8TagPtr = NULL;
@@ -276,7 +276,7 @@ static int berDecodeLoginData(
 **********************************************************************/
 
 static int getLoginConfig(
-    LDAP	 *ld,
+    LDAP     *ld,
     char     *objectDN,
     unsigned int  methodIDLen,
     unsigned int *methodID,
@@ -346,9 +346,9 @@ static int getLoginConfig(
 **********************************************************************/
 
 static int nmasldap_get_simple_pwd(
-    LDAP	 *ld,
+    LDAP     *ld,
     char     *objectDN,
-    size_t	 pwdLen,
+    size_t   pwdLen,
     char     *pwd )
 {
     int err = 0;
@@ -404,9 +404,9 @@ static int nmasldap_get_simple_pwd(
 **********************************************************************/
 
 static int nmasldap_get_password(
-    LDAP	 *ld,
+    LDAP     *ld,
     char     *objectDN,
-    size_t   *pwdSize,	/* in bytes */
+    size_t   *pwdSize,  /* in bytes */
     unsigned char     *pwd )
 {
     int err = 0;
@@ -1,9 +1,10 @@
-/*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-int nds_get_password(LDAP *ld, char *object_dn, size_t * pwd_len, char *pwd);
+/*
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+ */
+
+int nds_get_password(LDAP *ld, char *object_dn, size_t * pwd_len, char *pwd);
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -457,7 +457,7 @@ LDAPArguments(int argc, char **argv)
             fprintf(stderr, "ERROR: Your LDAP library does not have URI support\n");
             return 1;
 #endif
-            /* Fall thru to -h */
+        /* Fall thru to -h */
         case 'h':
             if (ldapServer) {
                 int len = strlen(ldapServer) + 1 + strlen(value) + 1;
@@ -691,3 +691,4 @@ LDAPHHA1(RequestData * requestData)
     }
 
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -14,3 +14,4 @@
 #include "digest_common.h"
 extern int LDAPArguments(int argc, char **argv);
 extern void LDAPHHA1(RequestData * requestData);
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -47,3 +47,4 @@ typedef void HandleArguments(int, char **);
 typedef void HHA1Creator(RequestData *);
 
 #endif /* SQUID_DIGEST_COMMON_H_ */
+
@@ -71,7 +71,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -56,7 +56,7 @@ ParseBuffer(char *buf, RequestData * requestData)
     char *p;
     requestData->parsed = 0;
     if ((p = strchr(buf, '\n')) != NULL)
-        *p = '\0';		/* strip \n */
+        *p = '\0';      /* strip \n */
 
     p = NULL;
     requestData->channelId = strtoll(buf, &p, 10);
@@ -118,3 +118,4 @@ main(int argc, char **argv)
         DoOneRequest(buf);
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -195,3 +195,4 @@ TextHHA1(RequestData * requestData)
         DigestCalcHA1("md5", requestData->user, requestData->realm, u->passwd, NULL, NULL, HA1, requestData->HHA1);
     }
 }
+
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -10,3 +10,4 @@
 
 extern void TextArguments(int argc, char **argv);
 extern void TextHHA1(RequestData * requestData);
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -237,7 +237,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -385,7 +385,7 @@ wccmparray(const wchar_t * str, const wchar_t ** array)
 static int
 wcstrcmparray(const wchar_t * str, const char **array)
 {
-    WCHAR wszGroup[GNLEN + 1];	// Unicode Group
+    WCHAR wszGroup[GNLEN + 1];  // Unicode Group
 
     while (*array) {
         MultiByteToWideChar(CP_ACP, 0, *array,
@@ -525,7 +525,7 @@ Valid_Local_Groups(char *UserName, const char **Groups)
 {
     int result = 0;
     char *Domain_Separator;
-    WCHAR wszUserName[UNLEN + 1];	/* Unicode user name */
+    WCHAR wszUserName[UNLEN + 1];   /* Unicode user name */
 
     LPLOCALGROUP_USERS_INFO_0 pBuf;
     LPLOCALGROUP_USERS_INFO_0 pTmpBuf;
@@ -602,7 +602,7 @@ int
 Valid_Global_Groups(char *UserName, const char **Groups)
 {
     int result = 0;
-    WCHAR wszUser[DNLEN + UNLEN + 2];	/* Unicode user name */
+    WCHAR wszUser[DNLEN + UNLEN + 2];   /* Unicode user name */
     char NTDomain[DNLEN + UNLEN + 2];
 
     char *domain_qualify = NULL;
@@ -756,12 +756,12 @@ process_options(int argc, char *argv[])
             exit(0);
         case '?':
             opt = optopt;
-            /* fall thru to default */
+        /* fall thru to default */
         default:
             fprintf(stderr, "%s: FATAL: Unknown option: -%c. Exiting\n", program_name, opt);
             usage(argv[0]);
             exit(1);
-            break;		/* not reached */
+            break;      /* not reached */
         }
     }
     return;
@@ -777,7 +777,7 @@ main(int argc, char *argv[])
     const char *groups[512];
     int n;
 
-    if (argc > 0) {		/* should always be true */
+    if (argc > 0) {     /* should always be true */
         program_name = strrchr(argv[0], '/');
         if (program_name == NULL)
             program_name = argv[0];
@@ -824,9 +824,9 @@ main(int argc, char *argv[])
             continue;
         }
         if ((p = strchr(buf, '\n')) != NULL)
-            *p = '\0';		/* strip \n */
+            *p = '\0';      /* strip \n */
         if ((p = strchr(buf, '\r')) != NULL)
-            *p = '\0';		/* strip \r */
+            *p = '\0';      /* strip \r */
 
         debug("Got '%s' from Squid (length: %d).\n", buf, strlen(buf));
 
@@ -857,3 +857,4 @@ main(int argc, char *argv[])
     }
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,12 @@
-Version 2.17
+/*
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+ */
+
+Version 2.18
 
 2010-07-12 Amos Jeffries <amosjeffries@squid-cache.org>
 
@@ -7,6 +15,40 @@ Version 2.17
 	Remove several goto statements.
 	Update to use helper macro API
 
+/*
+ * ext_ldap_group_acl: lookup group membership in LDAP
+ *
+ * Version 2.17
+ *
+ * (C)2002,2003 MARA Systems AB
+ *
+ * License: squid_ldap_group is free software; you can redistribute it
+ * and/or modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2,
+ * or (at your option) any later version.
+ *
+ * Authors:
+ *  Flavio Pescuma <flavio@marasystems.com>
+ *  Henrik Nordstrom <hno@marasystems.com>
+ *  MARA Systems AB, Sweden <http://www.marasystems.com>
+ *
+ * With contributions from others mentioned in the ChangeLog file
+ *
+ * In part based on squid_ldap_auth by Glen Newton and Henrik Nordstrom.
+ *
+ * Latest version of this program can always be found from MARA Systems
+ * at http://marasystems.com/download/LDAP_Group/
+ *
+ * Dependencies: You need to get the OpenLDAP libraries
+ * from http://www.openldap.org or use another compatible
+ * LDAP C-API library.
+ *
+ * If you want to make a TLS enabled connection you will also need the
+ * OpenSSL libraries linked into openldap. See http://www.openssl.org/
+ */
+
+Version 2.17
+
 2005-03-19 Henrik Nordstrom <hno@squid-cache.org>
 
 	Bug #1258: LDAP helpers fails to compile with SUN LDAP SDK
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -3,7 +3,7 @@
 .SH NAME
 ext_ldap_group_acl \- Squid LDAP external acl group helper
 .PP
-Version 2.17
+Version 2.18
 .
 .SH SYNOPSIS
 .if !'po4a'hide' .B ext_ldap_group_acl
@@ -242,7 +242,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -86,7 +86,7 @@ PFldap_start_tls_s Win32_ldap_start_tls_s;
 #endif
 
 #define PROGRAM_NAME "ext_ldap_group_acl"
-#define PROGRAM_VERSION "2.17"
+#define PROGRAM_VERSION "2.18"
 
 /* Globals */
 
@@ -257,7 +257,7 @@ main(int argc, char **argv)
             fprintf(stderr, "FATAL: Your LDAP library does not have URI support\n");
             exit(1);
 #endif
-            /* Fall thru to -h */
+        /* Fall thru to -h */
         case 'h':
             if (ldapServer) {
                 int len = strlen(ldapServer) + 1 + strlen(value) + 1;
@@ -835,3 +835,4 @@ readSecret(const char *filename)
 
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -169,7 +169,7 @@ This manual was written by
 .
 .SH COPYRIGHT
 .PP
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
@@ -219,7 +219,7 @@ GetDomainName(void)
 static int
 wcstrcmparray(const wchar_t * str, const char **array)
 {
-    WCHAR wszGroup[GNLEN + 1];	// Unicode Group
+    WCHAR wszGroup[GNLEN + 1];  // Unicode Group
 
     while (*array) {
         MultiByteToWideChar(CP_ACP, 0, *array,
@@ -238,7 +238,7 @@ Valid_Local_Groups(char *UserName, const char **Groups)
 {
     int result = 0;
     char *Domain_Separator;
-    WCHAR wszUserName[UNLEN + 1];	// Unicode user name
+    WCHAR wszUserName[UNLEN + 1];   // Unicode user name
 
     LPLOCALGROUP_USERS_INFO_0 pBuf = NULL;
     LPLOCALGROUP_USERS_INFO_0 pTmpBuf;
@@ -312,11 +312,11 @@ int
 Valid_Global_Groups(char *UserName, const char **Groups)
 {
     int result = 0;
-    WCHAR wszUserName[UNLEN + 1];	// Unicode user name
+    WCHAR wszUserName[UNLEN + 1];   // Unicode user name
 
-    WCHAR wszLocalDomain[DNLEN + 1];	// Unicode Local Domain
+    WCHAR wszLocalDomain[DNLEN + 1];    // Unicode Local Domain
 
-    WCHAR wszUserDomain[DNLEN + 1];	// Unicode User Domain
+    WCHAR wszUserDomain[DNLEN + 1]; // Unicode User Domain
 
     char NTDomain[DNLEN + UNLEN + 2];
     char *domain_qualify;
@@ -495,12 +495,12 @@ process_options(int argc, char *argv[])
             exit(0);
         case '?':
             opt = optopt;
-            /* fall thru to default */
+        /* fall thru to default */
         default:
             fprintf(stderr, "%s: FATAL: Unknown option: -%c. Exiting\n", program_name, opt);
             usage(argv[0]);
             exit(1);
-            break;		/* not reached */
+            break;      /* not reached */
         }
     }
     return;
@@ -516,7 +516,7 @@ main(int argc, char *argv[])
     const char *groups[512];
     int n;
 
-    if (argc > 0) {		/* should always be true */
+    if (argc > 0) {     /* should always be true */
         program_name = strrchr(argv[0], '/');
         if (program_name == NULL)
             program_name = argv[0];
@@ -566,9 +566,9 @@ main(int argc, char *argv[])
             continue;
         }
         if ((p = strchr(buf, '\n')) != NULL)
-            *p = '\0';		/* strip \n */
+            *p = '\0';      /* strip \n */
         if ((p = strchr(buf, '\r')) != NULL)
-            *p = '\0';		/* strip \r */
+            *p = '\0';      /* strip \r */
 
         debug("Got '%s' from Squid (length: %d).\n", buf, strlen(buf));
 
@@ -597,3 +597,4 @@ main(int argc, char *argv[])
     }
     return 0;
 }
+
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,34 +1,18 @@
 #!@PERL@
+
 use strict;
-use DBI;
 use Getopt::Long;
 use Pod::Usage;
-$|=1;
 
 =pod
 
 =head1 NAME
 
-ext_sql_session_acl.pl - SQL Database session lookup helper for Squid
-
-=cut
-
-my $dsn = "DBI:mysql:database=squid";
-my $db_user = undef;
-my $db_passwd = undef;
-my $db_table = "passwd";
-my $db_uidcol = "id";
-my $db_usercol = "''";
-my $db_tagcol = "''";
-my $db_cond = "enabled = 1";
-my $persist = 0;
-my $debug = 0;
-
-=pod
+ ext_sql_session_acl - SQL Database session lookup helper for Squid
 
 =head1 SYNOPSIS
 
-ext_sql_session_acl [options]
+ ext_sql_session_acl [options]
 
 =head1 DESCRIPTION
 
@@ -41,52 +25,111 @@ Common forms of identifiers are IP address, EUI (MAC) address, passwords, or UUI
 
 This program uses Squid concurrency support.
 
-=over 8
+=head1 OPTIONS
 
-=item	B<--dsn>
+=over 12
+
+=item B<--dsn>
 
 Database DSN. Default "DBI:mysql:database=squid"
 
-=item	B<--user>
+=item B<--user>
 
 Database User
 
-=item	B<--password>
+=item B<--password>
 
 Database password
 
-=item	B<--table>
+=item B<--table>
 
 Database table. Default "passwd".
 
-=item	B<--uidcol>
+=item B<--uidcol>
 
 Unique Session Identifier column. Default "id".
 
-=item	B<--usercol>
+=item B<--usercol>
 
 External ACL user= result column.
 
-=item	B<--tagcol>
+=item B<--tagcol>
 
 External ACL tag= result column.
 
-=item	B<--cond>
+=item B<--cond>
 
 Condition, defaults to enabled=1. Specify 1 or "" for no condition
 
-=item	B<--persist>
+=item B<--persist>
 
 Keep a persistent database connection open between queries. 
 
-=item	B<--debug>
+=item B<--debug>
 
-Print Debug output traces to stderr.
+Write debug info to stderr.
 
 =back
 
+=head1 AUTHOR
+
+This program and documentation was written by I<Amos Jeffries <amosjeffries@squid-cache.org>>
+
+Based on original work in DB_auth by Henrik Nordstrom <henrik@henriknordstrom.net>
+With assistance of Nishant Sharma <codemarauder@gmail.com>
+
+=head1 COPYRIGHT
+
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+
+ Copyright (C) 2012 Amos Jeffries <amosjeffries@squid-cache.org>
+
+ This program is free software. You may redistribute copies of it under the
+ terms of the GNU General Public License version 2, or (at your opinion) any
+ later version.
+
+=head1 QUESTIONS
+
+Questions on the usage of this program can be sent to the I<Squid Users mailing list <squid-users@squid-cache.org>>
+
+=head1 REPORTING BUGS
+
+Bug reports need to be made in English.
+See http://wiki.squid-cache.org/SquidFaq/BugReporting for details of what you need to include with your bug report.
+
+Report bugs or bug fixes using http://bugs.squid-cache.org/
+
+Report serious security bugs to I<Squid Bugs <squid-bugs@squid-cache.org>>
+
+Report ideas for new improvements to the I<Squid Developers mailing list <squid-dev@squid-cache.org>>
+
+=head1 SEE ALSO
+
+squid (8), GPL (7),
+
+The Squid FAQ wiki http://wiki.squid-cache.org/SquidFaq
+
+The Squid Configuration Manual http://www.squid-cache.org/Doc/config/
+
 =cut
 
+use DBI;
+
+my $dsn = "DBI:mysql:database=squid";
+my $db_user = undef;
+my $db_passwd = undef;
+my $db_table = "passwd";
+my $db_uidcol = "id";
+my $db_usercol = "''";
+my $db_tagcol = "''";
+my $db_cond = "enabled = 1";
+my $persist = 0;
+my $debug = 0;
+
 GetOptions(
 	'dsn=s' => \$dsn,
 	'user=s' => \$db_user,
@@ -140,6 +183,7 @@ sub query_db($) {
 }
 my $status;
 
+$|=1;
 while (<>) {
     my $string = $_;
     $string =~ m/^(\d+)\s(.*)$/;
@@ -162,22 +206,3 @@ while (<>) {
     close_db() if (!$persist);
     print $status . "\n";
 }
-
-=pod
-
-=head1 COPYRIGHT
-
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
-
-Copyright (C) 2012 Amos Jeffries <amosjeffries@squid-cache.org>
-Based on original work in DB_auth by Henrik Nordstrom <henrik@henriknordstrom.net>
-With assistance of Nishant Sharma <codemarauder@gmail.com>
-This program is free software. You may redistribute copies of it under the
-terms of the GNU General Public License version 2, or (at your opinion) any
-later version.
-
-=cut
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
@@ -1,17 +1,31 @@
 #!@PERL@
+
+use strict;
+use warnings;
+use Getopt::Long qw(:config auto_version auto_help);
+use Pod::Usage;
+
 =pod
 
 =head1 NAME
 
-delayer - Squid external acl helper adding artificial delay to requests
+ delayer - Squid external ACL helper adding artificial delay to requests
 
 =head1 SYNOPSIS
 
-delayer [--help] [--debug] [--log file] [--wait msec]
+ delayer [--help] [--debug] [--log file] [--wait msec]
+
+=head1 DESCRIPTION
+
+Squid external acl helper; causes squid to delay responding to HTTP requests.
+
+By carefully crafting the ACLs of a Squid setup it is possible to
+selectively delay requests received by a proxy. After the configured amount
+of time, it will always return "true".
 
 =head1 OPTIONS
 
-=over 8
+=over 12
 
 =item B<--help> or B<-h>
 
@@ -33,14 +47,6 @@ will be delayed by half a second (500 msec).
 
 =back
 
-=head1 DESCRIPTION
-
-Squid external acl helper; causes squid to delay responding to HTTP requests.
-
-By carefully crafting the ACLs of a Squid setup it is possible to
-selectively delay requests received by a proxy. After the configured amount
-of time, it will always return "true".
-
 =head1 CONFIGURATION
 
 To engage it, this snippet of configuration template can be used in squid.conf:
@@ -68,40 +74,43 @@ This software is written by Francesco Chemolli <kinkie@squid-cache.org>
 
 =head1 COPYRIGHT
 
- * Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
  * Please see the COPYING and CONTRIBUTORS files for details.
 
-(C) 2014 Francesco Chemolli <kinkie@squid-cache.org>
+ (C) 2014 Francesco Chemolli <kinkie@squid-cache.org>
 
-This program is free software. You may redistribute copies of it under the
-terms of the GNU General Public License version 2, or (at your opinion) any
-later version.
+ This program is free software. You may redistribute copies of it under the
+ terms of the GNU General Public License version 2, or (at your opinion) any
+ later version.
 
 =head1 QUESTIONS
 
-Questions on this code are best addressed on the Squid-users mailing list
-<squid-users@squid-cache.org>
+Questions on the usage of this program can be sent to the I<Squid Users mailing list <squid-users@squid-cache.org>>
 
 =head1 REPORTING BUGS
 
 Bug reports need to be made in English.
-See http://wiki.squid-cache.org/SquidFaq/BugReporting for details of what you
-need to include with your bug report.
+See http://wiki.squid-cache.org/SquidFaq/BugReporting for details of what you need to include with your bug report.
+
 Report bugs or bug fixes using http://bugs.squid-cache.org/
 
+Report serious security bugs to I<Squid Bugs <squid-bugs@squid-cache.org>>
+
+Report ideas for new improvements to the I<Squid Developers mailing list <squid-dev@squid-cache.org>>
+
 =head1 SEE ALSO
 
-B<squid>(8), B<GPL>(7), B<Squid Wiki> http://wiki.squid-cache.org/ ,
-B<Squid Configuration Manual> http://www.squid-cache.org/Doc/config/
+squid (8), GPL (7),
+
+The Squid FAQ wiki http://wiki.squid-cache.org/SquidFaq
+
+The Squid Configuration Manual http://www.squid-cache.org/Doc/config/
 
 =cut
 
-use strict;
-use warnings;
-use Getopt::Long qw(:config auto_version auto_help);
 use Data::Dumper;
 use Time::HiRes qw(gettimeofday tv_interval);
 
@@ -1,4 +1,4 @@
-## Copyright (C) 1996-2014 The Squid Software Foundation and contributors
+## Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
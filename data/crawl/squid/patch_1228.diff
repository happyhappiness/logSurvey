@@ -69,3 +69,6 @@ bootstrap automake$amver --foreign --add-missing
 bootstrap autoconf$acver
 
 echo "Autotool bootstrapping complete."
+echo "bootstrapping sub projects."
+cd lib/libTrie && $SHELL ./bootstrap.sh
+
@@ -3,7 +3,7 @@ dnl  Configuration input file for Squid
 dnl
 dnl  Duane Wessels, wessels@nlanr.net, February 1996 (autoconf v2.9)
 dnl
-dnl  $Id: configure.in,v 1.327 2003/03/04 01:39:45 robertc Exp $
+dnl  $Id: configure.in,v 1.328 2003/03/10 04:55:33 robertc Exp $
 dnl
 dnl
 dnl
@@ -13,7 +13,7 @@ AC_CONFIG_SRCDIR([src/main.cc])
 AC_CONFIG_AUX_DIR(cfgaux)
 AM_INIT_AUTOMAKE(squid, 3.0-DEVEL)
 AM_CONFIG_HEADER(include/autoconf.h)
-AC_REVISION($Revision: 1.327 $)dnl
+AC_REVISION($Revision: 1.328 $)dnl
 AC_PREFIX_DEFAULT(/usr/local/squid)
 AM_MAINTAINER_MODE
 
@@ -515,6 +515,17 @@ AC_ARG_ENABLE(delay-pools,
   fi
 ])
 
+AM_CONDITIONAL(USE_ESI, false)
+AC_ARG_ENABLE(esi,
+              AC_HELP_STRING([--enable-esi],[Enable ESI for accelerators. Requires libexpat. Enabling ESI will cause squid to follow the Edge Acceleration Specification (www.esi.org). This causes squid to IGNORE client Cache-Control headers. DO NOT use this in a squid configured as a web proxy, ONLY use it in a squid configured for webserver acceleration.]),
+	      ac_cv_use_esi=$enableval, ac_cv_use_esi=no)
+AC_CACHE_CHECK(whether to enable ESI,ac_cv_use_esi, ac_cv_use_esi=no)
+if test "$ac_cv_use_esi" = "yes" ; then
+  AC_DEFINE(ESI,1,[Compile the ESI processor and Surrogate header support])
+  AM_CONDITIONAL(USE_ESI, true)
+  XTRA_LIBS="$XTRA_LIBS -lexpat"
+fi
+
 dnl This is a developer only option. Developers know how to set defines
 dnl
 dnl AC_ARG_ENABLE(mem-gen-trace,
@@ -2477,4 +2488,7 @@ AC_CONFIG_FILES([\
 	helpers/external_acl/wbinfo_group/Makefile \
 	helpers/external_acl/winbind_group/Makefile
 ])
+
+AC_CONFIG_SUBDIRS(lib/libTrie)
+
 AC_OUTPUT
@@ -2,7 +2,7 @@
 <article>
 <title>Squid Programmers Guide</title>
 <author>Squid Developers</author>
-<date>$Id: prog-guide.sgml,v 1.55 2003/02/05 10:35:30 robertc Exp $</date>
+<date>$Id: prog-guide.sgml,v 1.56 2003/03/10 04:55:35 robertc Exp $</date>
 
 <abstract>
 Squid is a WWW Cache application developed by the National Laboratory
@@ -384,6 +384,14 @@ Squid consists of the following major components
 	(the ``standard'' mode), or only specific request headers
 	will be allowed (the ``paranoid'' mode).
 
+<sect1>Delay Pools
+
+	<P>
+	Delay pools provide bandwidth regulation by restricting the rate
+	at which squid reads from a server before sending to a client. They
+	do not prevent cache hits from being sent at maximal capacity. Delay
+	pools can aggregate the bandwidth from multiple machines and users
+	to provide more or less general restrictions.
 
 <sect1>Internet Cache Protocol
 
@@ -459,14 +467,12 @@ Squid consists of the following major components
 	see <url        url="http://squid.nlanr.net/Squid/urn-support.html"
 	name="URN support in Squid">.
 
-<sect1>Delay Pools
-
+<sect1>ESI
 	<P>
-	Delay pools provide bandwidth regulation by restricting the rate
-	at which squid reads from a server before sending to a client. They
-	do not prevent cache hits from being sent at maximal capacity. Delay
-	pools can aggregate the bandwidth from multiple machines and users
-	to provide more or less general restrictions.
+	ESI is an implementation of Edge Side Includes (<url url="http://www.esi.org">.)
+	ESI is implemented as a client side stream and a small 
+	modification to client_side_reply.c to check whether
+	ESI should be inserted into the reply stream or not.
 
 <sect>External Programs
 
@@ -89,7 +89,9 @@ section 82    External ACL
 section 83    SSL accelerator support
 section 84    Helper process maintenance
 section 85    Client side request management - after parsing, before caching
+section 86    ESI processing
 section 87    client side stream management
 section 88    Client side reply management - from store to stream
 section 89    NAT / IP Interception
 section 90    Store Client
+section 91    Http Surrogate-Control Header
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,28 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff;font-family:verdana,sans-serif}PRE{font-family:sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>. 
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -0,0 +1,29 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
+<HTML><HEAD>
+<TITLE>ERROR: The requested URL could not be retrieved</TITLE>
+<STYLE type="text/css"><!--BODY{background-color:#ffffff; font-family:verdana,sans-serif}--></STYLE>
+</HEAD><BODY>
+<H2>The requested URL could not be retrieved</H2>
+<HR noshade size="1px">
+<P>
+While trying to retrieve the URL:
+<A HREF="%U">%U</A>
+<P>
+The following error was encountered:
+<BLOCKQUOTE>
+ESI Processing failed.
+</BLOCKQUOTE>
+
+<P>
+The ESI processor returned:
+<BLOCKQUOTE>
+%Z
+</BLOCKQUOTE>
+
+<P>
+This means that:
+<PRE>
+ The surrogate was not able to process the ESI template. Please report this error to the webmaster. 
+</PRE>
+<P>Your webmaster is <A HREF="mailto:%w">%w</A>.</P>
+<P>This page is in english because a translation has not been made. If you are able to, please create a translation and contact the squid project to get it included.</P>
@@ -1,6 +1,6 @@
 
 /*
- * $Id: RefCount.h,v 1.3 2003/01/23 00:36:47 robertc Exp $
+ * $Id: RefCount.h,v 1.4 2003/03/10 04:56:20 robertc Exp $
  *
  * DEBUG: section xx    Refcount allocator
  * AUTHOR:  Robert Collins
@@ -37,58 +37,98 @@
 #define _SQUID_REFCOUNT_H_
 
 template <class C>
-class RefCount {
+
+class RefCount
+{
+
 public:
-  RefCount () : p_ (NULL) {}
-  RefCount (C const *p) : p_(p) { if (p_) p_->RefCountReference(); }
-  ~RefCount()
+    RefCount () : p_ (NULL) {}
+
+    RefCount (C const *p) : p_(p) { reference (*this); }
+
+    ~RefCount()
     {
-      dereference();
+        dereference();
     }
-  RefCount (const RefCount &p) : p_(p.p_) 
+
+    RefCount (const RefCount &p) : p_(p.p_)
     {
-      reference (p);
+        reference (p);
     }
-  RefCount& operator = (const RefCount& p)
+
+    RefCount& operator = (const RefCount& p)
     {
-      // DO NOT CHANGE THE ORDER HERE!!!
-      // This preserves semantics on self assignment
-      reference(p);
-      dereference();
-      p_ = p.p_;
-      return *this;
+        // DO NOT CHANGE THE ORDER HERE!!!
+        // This preserves semantics on self assignment
+        C const *newP_ = p.p_;
+        reference(p);
+        dereference();
+        p_ = newP_;
+        return *this;
     }
-  C const * operator-> () const {return p_; }
-  C * operator-> () {return const_cast<C *>(p_); }
-  C const & operator * () const {return *p_; }
-  C & operator * () {return *const_cast<C *>(p_); }
-  C const * getRaw() const{return p_; }
-  C * getRaw() {return const_cast<C *>(p_); }
-  bool operator == (const RefCount& p) const
+
+    C const * operator-> () const {return p_; }
+
+    C * operator-> () {return const_cast<C *>(p_); }
+
+    C const & operator * () const {return *p_; }
+
+    C & operator * () {return *const_cast<C *>(p_); }
+
+    C const * getRaw() const{return p_; }
+
+    C * getRaw() {return const_cast<C *>(p_); }
+
+    bool operator == (const RefCount& p) const
     {
-      return p.p_ == p_;
+        return p.p_ == p_;
     }
+
 private:
-  void dereference()
+    void dereference()
     {
-      if (p_ && p_->RefCountDereference() == 0) p_->deleteSelf();
+        if (p_ && p_->RefCountDereference() == 0)
+            p_->deleteSelf();
+
+        p_ = NULL;
     }
-  void reference (const RefCount& p)
+
+    void reference (const RefCount& p)
     {
-      if (p.p_) p.p_->RefCountReference();
+        if (p.p_)
+            p.p_->RefCountReference();
     }
-  C const *p_;
+
+    C const *p_;
 
 };
 
 struct RefCountable_
 {
     RefCountable_():count_(0){}
+
     virtual ~RefCountable_(){}
+
     virtual void deleteSelf() const = 0;
     /* Not private, to allow class hierarchies */
-    void RefCountReference() const { ++count_; }
-    unsigned RefCountDereference() const { return --count_; }
+    void RefCountReference() const
+    {
+#if REFCOUNT_DEBUG
+        debug (0,1)("Incrementing this %p from count %u\n",this,count_);
+#endif
+
+        ++count_;
+    }
+
+    unsigned RefCountDereference() const
+    {
+#if REFCOUNT_DEBUG
+        debug (0,1)("Decrementing this %p from count %u\n",this,count_);
+#endif
+
+        return --count_;
+    }
+
 private:
     mutable unsigned count_;
 };
@@ -45,6 +45,9 @@
 /* Define if you have problems with memPools and want to disable Pools */
 #undef DISABLE_POOLS
 
+/* Compile the ESI processor and Surrogate header support */
+#undef ESI
+
 /* Enable Forw/Via database */
 #undef FORW_VIA_DB
 
@@ -17,7 +17,8 @@ static inline hrtime_t
 get_tick(void)
 {
     hrtime_t regs;
-    asm volatile ("rdtsc":"=A" (regs));
+
+asm volatile ("rdtsc":"=A" (regs));
     return regs;
     /* We need return value, we rely on CC to optimise out needless subf calls */
     /* Note that "rdtsc" is relatively slow OP and stalls the CPU pipes, so use it wisely */
@@ -28,22 +29,25 @@ static inline hrtime_t
 get_tick(void)
 {
     hrtime_t regs;
-    asm volatile ("rpcc $0":"=A" (regs));	/* I'm not sure of syntax */
+
+asm volatile ("rpcc $0":"=A" (regs));	/* I'm not sure of syntax */
     return regs;
 }
+
 #elif defined(_M_IX86) && defined(_MSC_VER) /* x86 platform on Microsoft C Compiler ONLY */
-static __inline hrtime_t 
+static __inline hrtime_t
 get_tick(void)
 {
     hrtime_t regs;
     __asm {
-	cpuid
-	rdtsc
-	mov eax,DWORD PTR regs[0]
-	mov edx,DWORD PTR regs[4]
+        cpuid
+        rdtsc
+        mov eax,DWORD PTR regs[0]
+        mov edx,DWORD PTR regs[4]
     }
     return regs;
 }
+
 #else
 #warning Unsupported CPU. Define function get_tick(). Disabling USE_XPROF_STATS...
 #undef USE_XPROF_STATS
@@ -96,15 +100,22 @@ typedef enum {
     XPROF_file_read,
     XPROF_file_write,
     XPROF_file_close,
+#ifdef ESI
+    XPROF_esiExpressionEval,
+    XPROF_esiProcessing,
+    XPROF_esiParsing,
+#endif
     XPROF_LAST
 } xprof_type;
 
 #define XP_NOBEST (hrtime_t)-1
 
 typedef struct _xprof_stats_node xprof_stats_node;
+
 typedef struct _xprof_stats_data xprof_stats_data;
 
-struct _xprof_stats_data {
+struct _xprof_stats_data
+{
     hrtime_t start;
     hrtime_t stop;
     hrtime_t delta;
@@ -114,7 +125,8 @@ struct _xprof_stats_data {
     int64_t summ;
 };
 
-struct _xprof_stats_node {
+struct _xprof_stats_node
+{
     const char *name;
     xprof_stats_data accu;
     xprof_stats_data hist;
@@ -1,8 +1,10 @@
 ## Process this file with automake to produce Makefile.in
 #
-#  $Id: Makefile.am,v 1.9 2003/02/05 10:36:39 robertc Exp $
+#  $Id: Makefile.am,v 1.10 2003/03/10 04:56:21 robertc Exp $
 #
 
+SUBDIRS = libTrie
+
 if ENABLE_XPROF_STATS
 XPROF_STATS_SOURCE = Profiler.c
 else
@@ -55,6 +57,8 @@ libmiscutil_a_SOURCES = \
 	uudecode.c \
 	$(XPROF_STATS_SOURCE)
 libmiscutil_a_LIBADD = \
+	libTrie/src/Trie.o \
+	libTrie/src/TrieNode.o \
 	@LIBOBJS@
 # $(top_srcdir)/include/version.h should be a dependency
 libregex_a_SOURCES = \
@@ -0,0 +1 @@
+Robert Collins <rbtcollins@hotmail.com>
@@ -0,0 +1,340 @@
+		    GNU GENERAL PUBLIC LICENSE
+		       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.
+     59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+			    Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Library General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+		    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+			    NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+		     END OF TERMS AND CONDITIONS
+
+	    How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+convey the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+
+Also add information on how to contact you by electronic and paper mail.
+
+If the program is interactive, make it output a short notice like this
+when it starts in an interactive mode:
+
+    Gnomovision version 69, Copyright (C) year  name of author
+    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, the commands you use may
+be called something other than `show w' and `show c'; they could even be
+mouse-clicks or menu items--whatever suits your program.
+
+You should also get your employer (if you work as a programmer) or your
+school, if any, to sign a "copyright disclaimer" for the program, if
+necessary.  Here is a sample; alter the names:
+
+  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
+  `Gnomovision' (which makes passes at compilers) written by James Hacker.
+
+  <signature of Ty Coon>, 1 April 1989
+  Ty Coon, President of Vice
+
+This General Public License does not permit incorporating your program into
+proprietary programs.  If your program is a subroutine library, you may
+consider it more useful to permit linking proprietary applications with the
+library.  If this is what you want to do, use the GNU Library General
+Public License instead of this License.
@@ -0,0 +1 @@
+TODO: Fill this out
@@ -0,0 +1,229 @@
+Copyright 1994, 1995, 1996, 1999, 2000, 2001, 2002 Free Software
+Foundation, Inc.
+
+   This file is free documentation; the Free Software Foundation gives
+unlimited permission to copy, distribute and modify it.
+
+Basic Installation
+==================
+
+   These are generic installation instructions.
+
+   The `configure' shell script attempts to guess correct values for
+various system-dependent variables used during compilation.  It uses
+those values to create a `Makefile' in each directory of the package.
+It may also create one or more `.h' files containing system-dependent
+definitions.  Finally, it creates a shell script `config.status' that
+you can run in the future to recreate the current configuration, and a
+file `config.log' containing compiler output (useful mainly for
+debugging `configure').
+
+   It can also use an optional file (typically called `config.cache'
+and enabled with `--cache-file=config.cache' or simply `-C') that saves
+the results of its tests to speed up reconfiguring.  (Caching is
+disabled by default to prevent problems with accidental use of stale
+cache files.)
+
+   If you need to do unusual things to compile the package, please try
+to figure out how `configure' could check whether to do them, and mail
+diffs or instructions to the address given in the `README' so they can
+be considered for the next release.  If you are using the cache, and at
+some point `config.cache' contains results you don't want to keep, you
+may remove or edit it.
+
+   The file `configure.ac' (or `configure.in') is used to create
+`configure' by a program called `autoconf'.  You only need
+`configure.ac' if you want to change it or regenerate `configure' using
+a newer version of `autoconf'.
+
+The simplest way to compile this package is:
+
+  1. `cd' to the directory containing the package's source code and type
+     `./configure' to configure the package for your system.  If you're
+     using `csh' on an old version of System V, you might need to type
+     `sh ./configure' instead to prevent `csh' from trying to execute
+     `configure' itself.
+
+     Running `configure' takes awhile.  While running, it prints some
+     messages telling which features it is checking for.
+
+  2. Type `make' to compile the package.
+
+  3. Optionally, type `make check' to run any self-tests that come with
+     the package.
+
+  4. Type `make install' to install the programs and any data files and
+     documentation.
+
+  5. You can remove the program binaries and object files from the
+     source code directory by typing `make clean'.  To also remove the
+     files that `configure' created (so you can compile the package for
+     a different kind of computer), type `make distclean'.  There is
+     also a `make maintainer-clean' target, but that is intended mainly
+     for the package's developers.  If you use it, you may have to get
+     all sorts of other programs in order to regenerate files that came
+     with the distribution.
+
+Compilers and Options
+=====================
+
+   Some systems require unusual options for compilation or linking that
+the `configure' script does not know about.  Run `./configure --help'
+for details on some of the pertinent environment variables.
+
+   You can give `configure' initial values for configuration parameters
+by setting variables in the command line or in the environment.  Here
+is an example:
+
+     ./configure CC=c89 CFLAGS=-O2 LIBS=-lposix
+
+   *Note Defining Variables::, for more details.
+
+Compiling For Multiple Architectures
+====================================
+
+   You can compile the package for more than one kind of computer at the
+same time, by placing the object files for each architecture in their
+own directory.  To do this, you must use a version of `make' that
+supports the `VPATH' variable, such as GNU `make'.  `cd' to the
+directory where you want the object files and executables to go and run
+the `configure' script.  `configure' automatically checks for the
+source code in the directory that `configure' is in and in `..'.
+
+   If you have to use a `make' that does not support the `VPATH'
+variable, you have to compile the package for one architecture at a
+time in the source code directory.  After you have installed the
+package for one architecture, use `make distclean' before reconfiguring
+for another architecture.
+
+Installation Names
+==================
+
+   By default, `make install' will install the package's files in
+`/usr/local/bin', `/usr/local/man', etc.  You can specify an
+installation prefix other than `/usr/local' by giving `configure' the
+option `--prefix=PATH'.
+
+   You can specify separate installation prefixes for
+architecture-specific files and architecture-independent files.  If you
+give `configure' the option `--exec-prefix=PATH', the package will use
+PATH as the prefix for installing programs and libraries.
+Documentation and other data files will still use the regular prefix.
+
+   In addition, if you use an unusual directory layout you can give
+options like `--bindir=PATH' to specify different values for particular
+kinds of files.  Run `configure --help' for a list of the directories
+you can set and what kinds of files go in them.
+
+   If the package supports it, you can cause programs to be installed
+with an extra prefix or suffix on their names by giving `configure' the
+option `--program-prefix=PREFIX' or `--program-suffix=SUFFIX'.
+
+Optional Features
+=================
+
+   Some packages pay attention to `--enable-FEATURE' options to
+`configure', where FEATURE indicates an optional part of the package.
+They may also pay attention to `--with-PACKAGE' options, where PACKAGE
+is something like `gnu-as' or `x' (for the X Window System).  The
+`README' should mention any `--enable-' and `--with-' options that the
+package recognizes.
+
+   For packages that use the X Window System, `configure' can usually
+find the X include and library files automatically, but if it doesn't,
+you can use the `configure' options `--x-includes=DIR' and
+`--x-libraries=DIR' to specify their locations.
+
+Specifying the System Type
+==========================
+
+   There may be some features `configure' cannot figure out
+automatically, but needs to determine by the type of machine the package
+will run on.  Usually, assuming the package is built to be run on the
+_same_ architectures, `configure' can figure that out, but if it prints
+a message saying it cannot guess the machine type, give it the
+`--build=TYPE' option.  TYPE can either be a short name for the system
+type, such as `sun4', or a canonical name which has the form:
+
+     CPU-COMPANY-SYSTEM
+
+where SYSTEM can have one of these forms:
+
+     OS KERNEL-OS
+
+   See the file `config.sub' for the possible values of each field.  If
+`config.sub' isn't included in this package, then this package doesn't
+need to know the machine type.
+
+   If you are _building_ compiler tools for cross-compiling, you should
+use the `--target=TYPE' option to select the type of system they will
+produce code for.
+
+   If you want to _use_ a cross compiler, that generates code for a
+platform different from the build platform, you should specify the
+"host" platform (i.e., that on which the generated programs will
+eventually be run) with `--host=TYPE'.
+
+Sharing Defaults
+================
+
+   If you want to set default values for `configure' scripts to share,
+you can create a site shell script called `config.site' that gives
+default values for variables like `CC', `cache_file', and `prefix'.
+`configure' looks for `PREFIX/share/config.site' if it exists, then
+`PREFIX/etc/config.site' if it exists.  Or, you can set the
+`CONFIG_SITE' environment variable to the location of the site script.
+A warning: not all `configure' scripts look for a site script.
+
+Defining Variables
+==================
+
+   Variables not defined in a site shell script can be set in the
+environment passed to `configure'.  However, some packages may run
+configure again during the build, and the customized values of these
+variables may be lost.  In order to avoid this problem, you should set
+them in the `configure' command line, using `VAR=value'.  For example:
+
+     ./configure CC=/usr/local2/bin/gcc
+
+will cause the specified gcc to be used as the C compiler (unless it is
+overridden in the site shell script).
+
+`configure' Invocation
+======================
+
+   `configure' recognizes the following options to control how it
+operates.
+
+`--help'
+`-h'
+     Print a summary of the options to `configure', and exit.
+
+`--version'
+`-V'
+     Print the version of Autoconf used to generate the `configure'
+     script, and exit.
+
+`--cache-file=FILE'
+     Enable the cache: use and save the results of the tests in FILE,
+     traditionally `config.cache'.  FILE defaults to `/dev/null' to
+     disable caching.
+
+`--config-cache'
+`-C'
+     Alias for `--cache-file=config.cache'.
+
+`--quiet'
+`--silent'
+`-q'
+     Do not print messages saying which checks are being made.  To
+     suppress all normal output, redirect it to `/dev/null' (any error
+     messages will still be shown).
+
+`--srcdir=DIR'
+     Look for the package's source code in directory DIR.  Usually
+     `configure' can determine that directory automatically.
+
+`configure' also accepts some other, not widely useful, options.  Run
+`configure --help' for more details.
+
@@ -0,0 +1,8 @@
+## Process this file with automake to produce Makefile.in
+#
+# $Id: Makefile.am,v 1.1 2003/03/10 04:56:24 robertc Exp $
+#
+
+AUTOMAKE_OPTIONS = dist-bzip2 subdir-objects 1.5
+DIST_SUBDIRS = include src test
+SUBDIRS = src test
@@ -0,0 +1,430 @@
+# Makefile.in generated by automake 1.6.3 from Makefile.am.
+# @configure_input@
+
+# Copyright 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002
+# Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+@SET_MAKE@
+
+#
+# $Id: Makefile.in,v 1.1 2003/03/10 04:56:24 robertc Exp $
+#
+SHELL = @SHELL@
+
+srcdir = @srcdir@
+top_srcdir = @top_srcdir@
+VPATH = @srcdir@
+prefix = @prefix@
+exec_prefix = @exec_prefix@
+
+bindir = @bindir@
+sbindir = @sbindir@
+libexecdir = @libexecdir@
+datadir = @datadir@
+sysconfdir = @sysconfdir@
+sharedstatedir = @sharedstatedir@
+localstatedir = @localstatedir@
+libdir = @libdir@
+infodir = @infodir@
+mandir = @mandir@
+includedir = @includedir@
+oldincludedir = /usr/include
+pkgdatadir = $(datadir)/@PACKAGE@
+pkglibdir = $(libdir)/@PACKAGE@
+pkgincludedir = $(includedir)/@PACKAGE@
+top_builddir = .
+
+ACLOCAL = @ACLOCAL@
+AUTOCONF = @AUTOCONF@
+AUTOMAKE = @AUTOMAKE@
+AUTOHEADER = @AUTOHEADER@
+
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+INSTALL = @INSTALL@
+INSTALL_PROGRAM = @INSTALL_PROGRAM@
+INSTALL_DATA = @INSTALL_DATA@
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_SCRIPT = @INSTALL_SCRIPT@
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = @program_transform_name@
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+
+EXEEXT = @EXEEXT@
+OBJEXT = @OBJEXT@
+PATH_SEPARATOR = @PATH_SEPARATOR@
+AMTAR = @AMTAR@
+AWK = @AWK@
+CC = @CC@
+CXX = @CXX@
+DEPDIR = @DEPDIR@
+INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+MAINT = @MAINT@
+PACKAGE = @PACKAGE@
+RANLIB = @RANLIB@
+STRIP = @STRIP@
+VERSION = @VERSION@
+am__include = @am__include@
+am__quote = @am__quote@
+install_sh = @install_sh@
+
+AUTOMAKE_OPTIONS = dist-bzip2 subdir-objects 1.5
+DIST_SUBDIRS = include src test
+SUBDIRS = src test
+subdir = .
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+CONFIG_HEADER = config.h
+CONFIG_CLEAN_FILES =
+DIST_SOURCES =
+
+RECURSIVE_TARGETS = info-recursive dvi-recursive install-info-recursive \
+	uninstall-info-recursive all-recursive install-data-recursive \
+	install-exec-recursive installdirs-recursive install-recursive \
+	uninstall-recursive check-recursive installcheck-recursive
+DIST_COMMON = README AUTHORS COPYING ChangeLog INSTALL Makefile.am \
+	Makefile.in NEWS aclocal.m4 config.guess config.h.in config.sub \
+	configure configure.in depcomp install-sh ltmain.sh missing \
+	mkinstalldirs
+all: config.h
+	$(MAKE) $(AM_MAKEFLAGS) all-recursive
+
+.SUFFIXES:
+
+am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
+ configure.lineno
+$(srcdir)/Makefile.in: @MAINTAINER_MODE_TRUE@ Makefile.am  $(top_srcdir)/configure.in $(ACLOCAL_M4)
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --gnu  Makefile
+Makefile: @MAINTAINER_MODE_TRUE@ $(srcdir)/Makefile.in  $(top_builddir)/config.status
+	cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe)
+
+$(top_builddir)/config.status: $(srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	$(SHELL) ./config.status --recheck
+$(srcdir)/configure: @MAINTAINER_MODE_TRUE@ $(srcdir)/configure.in $(ACLOCAL_M4) $(CONFIGURE_DEPENDENCIES)
+	cd $(srcdir) && $(AUTOCONF)
+
+$(ACLOCAL_M4): @MAINTAINER_MODE_TRUE@ configure.in 
+	cd $(srcdir) && $(ACLOCAL) $(ACLOCAL_AMFLAGS)
+
+config.h: stamp-h1
+	@if test ! -f $@; then \
+	  rm -f stamp-h1; \
+	  $(MAKE) stamp-h1; \
+	else :; fi
+
+stamp-h1: $(srcdir)/config.h.in $(top_builddir)/config.status
+	@rm -f stamp-h1
+	cd $(top_builddir) && $(SHELL) ./config.status config.h
+
+$(srcdir)/config.h.in: @MAINTAINER_MODE_TRUE@ $(top_srcdir)/configure.in $(ACLOCAL_M4) 
+	cd $(top_srcdir) && $(AUTOHEADER)
+	touch $(srcdir)/config.h.in
+
+distclean-hdr:
+	-rm -f config.h stamp-h1
+uninstall-info-am:
+
+# This directory's subdirectories are mostly independent; you can cd
+# into them and run `make' without going through this Makefile.
+# To change the values of `make' variables: instead of editing Makefiles,
+# (1) if the variable is set in `config.status', edit `config.status'
+#     (which will cause the Makefiles to be regenerated when you run `make');
+# (2) otherwise, pass the desired values on the `make' command line.
+$(RECURSIVE_TARGETS):
+	@set fnord $$MAKEFLAGS; amf=$$2; \
+	dot_seen=no; \
+	target=`echo $@ | sed s/-recursive//`; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    dot_seen=yes; \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	   || case "$$amf" in *=*) exit 1;; *k*) fail=yes;; *) exit 1;; esac; \
+	done; \
+	if test "$$dot_seen" = "no"; then \
+	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+	fi; test -z "$$fail"
+
+mostlyclean-recursive clean-recursive distclean-recursive \
+maintainer-clean-recursive:
+	@set fnord $$MAKEFLAGS; amf=$$2; \
+	dot_seen=no; \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	rev=''; for subdir in $$list; do \
+	  if test "$$subdir" = "."; then :; else \
+	    rev="$$subdir $$rev"; \
+	  fi; \
+	done; \
+	rev="$$rev ."; \
+	target=`echo $@ | sed s/-recursive//`; \
+	for subdir in $$rev; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	   || case "$$amf" in *=*) exit 1;; *k*) fail=yes;; *) exit 1;; esac; \
+	done && test -z "$$fail"
+tags-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+	done
+
+ETAGS = etags
+ETAGSFLAGS =
+
+tags: TAGS
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	mkid -fID $$unique
+
+TAGS: tags-recursive $(HEADERS) $(SOURCES) config.h.in $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test -f $$subdir/TAGS && tags="$$tags -i $$here/$$subdir/TAGS"; \
+	  fi; \
+	done; \
+	list='$(SOURCES) $(HEADERS) config.h.in $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	test -z "$(ETAGS_ARGS)$$tags$$unique" \
+	  || $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+
+top_distdir = .
+distdir = $(PACKAGE)-$(VERSION)
+
+am__remove_distdir = \
+  { test ! -d $(distdir) \
+    || { find $(distdir) -type d ! -perm -200 -exec chmod u+w {} ';' \
+         && rm -fr $(distdir); }; }
+
+GZIP_ENV = --best
+distcleancheck_listfiles = find . -type f -print
+
+distdir: $(DISTFILES)
+	$(am__remove_distdir)
+	mkdir $(distdir)
+	@list='$(DISTFILES)'; for file in $$list; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  dir=`echo "$$file" | sed -e 's,/[^/]*$$,,'`; \
+	  if test "$$dir" != "$$file" && test "$$dir" != "."; then \
+	    dir="/$$dir"; \
+	    $(mkinstalldirs) "$(distdir)$$dir"; \
+	  else \
+	    dir=''; \
+	  fi; \
+	  if test -d $$d/$$file; then \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+	list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test -d $(distdir)/$$subdir \
+	    || mkdir $(distdir)/$$subdir \
+	    || exit 1; \
+	    (cd $$subdir && \
+	      $(MAKE) $(AM_MAKEFLAGS) \
+	        top_distdir="$(top_distdir)" \
+	        distdir=../$(distdir)/$$subdir \
+	        distdir) \
+	      || exit 1; \
+	  fi; \
+	done
+	-find $(distdir) -type d ! -perm -777 -exec chmod a+rwx {} \; -o \
+	  ! -type d ! -perm -444 -links 1 -exec chmod a+r {} \; -o \
+	  ! -type d ! -perm -400 -exec chmod a+r {} \; -o \
+	  ! -type d ! -perm -444 -exec $(SHELL) $(install_sh) -c -m a+r {} {} \; \
+	|| chmod -R a+r $(distdir)
+dist-gzip: distdir
+	$(AMTAR) chof - $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+	$(am__remove_distdir)
+
+dist-bzip2: distdir
+	$(AMTAR) chof - $(distdir) | bzip2 -9 -c >$(distdir).tar.bz2
+	$(am__remove_distdir)
+
+dist dist-all: distdir
+	$(AMTAR) chof - $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+	$(AMTAR) chof - $(distdir) | bzip2 -9 -c >$(distdir).tar.bz2
+	$(am__remove_distdir)
+
+# This target untars the dist file and tries a VPATH configuration.  Then
+# it guarantees that the distribution is self-contained by making another
+# tarfile.
+distcheck: dist
+	$(am__remove_distdir)
+	GZIP=$(GZIP_ENV) gunzip -c $(distdir).tar.gz | $(AMTAR) xf -
+	chmod -R a-w $(distdir); chmod a+w $(distdir)
+	mkdir $(distdir)/=build
+	mkdir $(distdir)/=inst
+	chmod a-w $(distdir)
+	dc_install_base=`$(am__cd) $(distdir)/=inst && pwd` \
+	  && cd $(distdir)/=build \
+	  && ../configure --srcdir=.. --prefix=$$dc_install_base \
+	    $(DISTCHECK_CONFIGURE_FLAGS) \
+	  && $(MAKE) $(AM_MAKEFLAGS) \
+	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
+	  && $(MAKE) $(AM_MAKEFLAGS) check \
+	  && $(MAKE) $(AM_MAKEFLAGS) install \
+	  && $(MAKE) $(AM_MAKEFLAGS) installcheck \
+	  && $(MAKE) $(AM_MAKEFLAGS) uninstall \
+	  && (test `find $$dc_install_base -type f -print | wc -l` -le 1 \
+	      || { echo "ERROR: files left after uninstall:" ; \
+	           find $$dc_install_base -type f -print ; \
+	           exit 1; } >&2 ) \
+	  && $(MAKE) $(AM_MAKEFLAGS) dist-gzip \
+	  && rm -f $(distdir).tar.gz \
+	  && $(MAKE) $(AM_MAKEFLAGS) distcleancheck
+	$(am__remove_distdir)
+	@echo "$(distdir).tar.gz is ready for distribution" | \
+	  sed 'h;s/./=/g;p;x;p;x'
+distcleancheck: distclean
+	if test '$(srcdir)' = . ; then \
+	  echo "ERROR: distcleancheck can only run from a VPATH build" ; \
+	  exit 1 ; \
+	fi
+	test `$(distcleancheck_listfiles) | wc -l` -eq 0 \
+	  || { echo "ERROR: files left after distclean:" ; \
+	       $(distcleancheck_listfiles) ; \
+	       exit 1; } >&2
+check-am: all-am
+check: check-recursive
+all-am: Makefile config.h
+installdirs: installdirs-recursive
+installdirs-am:
+
+install: install-recursive
+install-exec: install-exec-recursive
+install-data: install-data-recursive
+uninstall: uninstall-recursive
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-recursive
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-rm -f Makefile $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-recursive
+
+clean-am: clean-generic mostlyclean-am
+
+distclean: distclean-recursive
+	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
+distclean-am: clean-am distclean-generic distclean-hdr distclean-tags
+
+dvi: dvi-recursive
+
+dvi-am:
+
+info: info-recursive
+
+info-am:
+
+install-data-am:
+
+install-exec-am:
+
+install-info: install-info-recursive
+
+install-man:
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-recursive
+	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
+	-rm -rf autom4te.cache
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-recursive
+
+mostlyclean-am: mostlyclean-generic
+
+uninstall-am: uninstall-info-am
+
+uninstall-info: uninstall-info-recursive
+
+.PHONY: $(RECURSIVE_TARGETS) GTAGS all all-am check check-am clean \
+	clean-generic clean-recursive dist dist-all dist-bzip2 \
+	dist-gzip distcheck distclean distclean-generic distclean-hdr \
+	distclean-recursive distclean-tags distcleancheck distdir dvi \
+	dvi-am dvi-recursive info info-am info-recursive install \
+	install-am install-data install-data-am install-data-recursive \
+	install-exec install-exec-am install-exec-recursive \
+	install-info install-info-am install-info-recursive install-man \
+	install-recursive install-strip installcheck installcheck-am \
+	installdirs installdirs-am installdirs-recursive \
+	maintainer-clean maintainer-clean-generic \
+	maintainer-clean-recursive mostlyclean mostlyclean-generic \
+	mostlyclean-recursive tags tags-recursive uninstall \
+	uninstall-am uninstall-info-am uninstall-info-recursive \
+	uninstall-recursive
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
@@ -0,0 +1,873 @@
+# aclocal.m4 generated automatically by aclocal 1.6.3 -*- Autoconf -*-
+
+# Copyright 1996, 1997, 1998, 1999, 2000, 2001, 2002
+# Free Software Foundation, Inc.
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+# Like AC_CONFIG_HEADER, but automatically create stamp file. -*- Autoconf -*-
+
+# Copyright 1996, 1997, 2000, 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+AC_PREREQ([2.52])
+
+# serial 6
+
+# When config.status generates a header, we must update the stamp-h file.
+# This file resides in the same directory as the config header
+# that is generated.  We must strip everything past the first ":",
+# and everything past the last "/".
+
+# _AM_DIRNAME(PATH)
+# -----------------
+# Like AS_DIRNAME, only do it during macro expansion
+AC_DEFUN([_AM_DIRNAME],
+       [m4_if(regexp([$1], [^.*[^/]//*[^/][^/]*/*$]), -1,
+	      m4_if(regexp([$1], [^//\([^/]\|$\)]), -1,
+		    m4_if(regexp([$1], [^/.*]), -1,
+			  [.],
+			  patsubst([$1], [^\(/\).*], [\1])),
+		    patsubst([$1], [^\(//\)\([^/].*\|$\)], [\1])),
+	      patsubst([$1], [^\(.*[^/]\)//*[^/][^/]*/*$], [\1]))[]dnl
+])# _AM_DIRNAME
+
+
+# The stamp files are numbered to have different names.
+# We could number them on a directory basis, but that's additional
+# complications, let's have a unique counter.
+m4_define([_AM_STAMP_Count], [0])
+
+
+# _AM_STAMP(HEADER)
+# -----------------
+# The name of the stamp file for HEADER.
+AC_DEFUN([_AM_STAMP],
+[m4_define([_AM_STAMP_Count], m4_incr(_AM_STAMP_Count))dnl
+AS_ESCAPE(_AM_DIRNAME(patsubst([$1],
+                               [:.*])))/stamp-h[]_AM_STAMP_Count])
+
+
+# _AM_CONFIG_HEADER(HEADER[:SOURCES], COMMANDS, INIT-COMMANDS)
+# ------------------------------------------------------------
+# We used to try to get a real timestamp in stamp-h.  But the fear is that
+# that will cause unnecessary cvs conflicts.
+AC_DEFUN([_AM_CONFIG_HEADER],
+[# Add the stamp file to the list of files AC keeps track of,
+# along with our hook.
+AC_CONFIG_HEADERS([$1],
+                  [# update the timestamp
+echo 'timestamp for $1' >"_AM_STAMP([$1])"
+$2],
+                  [$3])
+])# _AM_CONFIG_HEADER
+
+
+# AM_CONFIG_HEADER(HEADER[:SOURCES]..., COMMANDS, INIT-COMMANDS)
+# --------------------------------------------------------------
+AC_DEFUN([AM_CONFIG_HEADER],
+[AC_FOREACH([_AM_File], [$1], [_AM_CONFIG_HEADER(_AM_File, [$2], [$3])])
+])# AM_CONFIG_HEADER
+
+# Do all the work for Automake.                            -*- Autoconf -*-
+
+# This macro actually does too much some checks are only needed if
+# your package does certain things.  But this isn't really a big deal.
+
+# Copyright 1996, 1997, 1998, 1999, 2000, 2001, 2002
+# Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# serial 8
+
+# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
+# written in clear, in which case automake, when reading aclocal.m4,
+# will think it sees a *use*, and therefore will trigger all it's
+# C support machinery.  Also note that it means that autoscan, seeing
+# CC etc. in the Makefile, will ask for an AC_PROG_CC use...
+
+
+AC_PREREQ([2.52])
+
+# Autoconf 2.50 wants to disallow AM_ names.  We explicitly allow
+# the ones we care about.
+m4_pattern_allow([^AM_[A-Z]+FLAGS$])dnl
+
+# AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
+# AM_INIT_AUTOMAKE([OPTIONS])
+# -----------------------------------------------
+# The call with PACKAGE and VERSION arguments is the old style
+# call (pre autoconf-2.50), which is being phased out.  PACKAGE
+# and VERSION should now be passed to AC_INIT and removed from
+# the call to AM_INIT_AUTOMAKE.
+# We support both call styles for the transition.  After
+# the next Automake release, Autoconf can make the AC_INIT
+# arguments mandatory, and then we can depend on a new Autoconf
+# release and drop the old call support.
+AC_DEFUN([AM_INIT_AUTOMAKE],
+[AC_REQUIRE([AM_SET_CURRENT_AUTOMAKE_VERSION])dnl
+ AC_REQUIRE([AC_PROG_INSTALL])dnl
+# test to see if srcdir already configured
+if test "`cd $srcdir && pwd`" != "`pwd`" &&
+   test -f $srcdir/config.status; then
+  AC_MSG_ERROR([source directory already configured; run "make distclean" there first])
+fi
+
+# Define the identity of the package.
+dnl Distinguish between old-style and new-style calls.
+m4_ifval([$2],
+[m4_ifval([$3], [_AM_SET_OPTION([no-define])])dnl
+ AC_SUBST([PACKAGE], [$1])dnl
+ AC_SUBST([VERSION], [$2])],
+[_AM_SET_OPTIONS([$1])dnl
+ AC_SUBST([PACKAGE], [AC_PACKAGE_TARNAME])dnl
+ AC_SUBST([VERSION], [AC_PACKAGE_VERSION])])dnl
+
+_AM_IF_OPTION([no-define],,
+[AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
+ AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package])])dnl
+
+# Some tools Automake needs.
+AC_REQUIRE([AM_SANITY_CHECK])dnl
+AC_REQUIRE([AC_ARG_PROGRAM])dnl
+AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version})
+AM_MISSING_PROG(AUTOCONF, autoconf)
+AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version})
+AM_MISSING_PROG(AUTOHEADER, autoheader)
+AM_MISSING_PROG(MAKEINFO, makeinfo)
+AM_MISSING_PROG(AMTAR, tar)
+AM_PROG_INSTALL_SH
+AM_PROG_INSTALL_STRIP
+# We need awk for the "check" target.  The system "awk" is bad on
+# some platforms.
+AC_REQUIRE([AC_PROG_AWK])dnl
+AC_REQUIRE([AC_PROG_MAKE_SET])dnl
+
+_AM_IF_OPTION([no-dependencies],,
+[AC_PROVIDE_IFELSE([AC_PROG_][CC],
+                  [_AM_DEPENDENCIES(CC)],
+                  [define([AC_PROG_][CC],
+                          defn([AC_PROG_][CC])[_AM_DEPENDENCIES(CC)])])dnl
+AC_PROVIDE_IFELSE([AC_PROG_][CXX],
+                  [_AM_DEPENDENCIES(CXX)],
+                  [define([AC_PROG_][CXX],
+                          defn([AC_PROG_][CXX])[_AM_DEPENDENCIES(CXX)])])dnl
+])
+])
+
+# Copyright 2002  Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+
+# AM_AUTOMAKE_VERSION(VERSION)
+# ----------------------------
+# Automake X.Y traces this macro to ensure aclocal.m4 has been
+# generated from the m4 files accompanying Automake X.Y.
+AC_DEFUN([AM_AUTOMAKE_VERSION],[am__api_version="1.6"])
+
+# AM_SET_CURRENT_AUTOMAKE_VERSION
+# -------------------------------
+# Call AM_AUTOMAKE_VERSION so it can be traced.
+# This function is AC_REQUIREd by AC_INIT_AUTOMAKE.
+AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
+	 [AM_AUTOMAKE_VERSION([1.6.3])])
+
+# Helper functions for option handling.                    -*- Autoconf -*-
+
+# Copyright 2001, 2002  Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# serial 2
+
+# _AM_MANGLE_OPTION(NAME)
+# -----------------------
+AC_DEFUN([_AM_MANGLE_OPTION],
+[[_AM_OPTION_]m4_bpatsubst($1, [[^a-zA-Z0-9_]], [_])])
+
+# _AM_SET_OPTION(NAME)
+# ------------------------------
+# Set option NAME.  Presently that only means defining a flag for this option.
+AC_DEFUN([_AM_SET_OPTION],
+[m4_define(_AM_MANGLE_OPTION([$1]), 1)])
+
+# _AM_SET_OPTIONS(OPTIONS)
+# ----------------------------------
+# OPTIONS is a space-separated list of Automake options.
+AC_DEFUN([_AM_SET_OPTIONS],
+[AC_FOREACH([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
+
+# _AM_IF_OPTION(OPTION, IF-SET, [IF-NOT-SET])
+# -------------------------------------------
+# Execute IF-SET if OPTION is set, IF-NOT-SET otherwise.
+AC_DEFUN([_AM_IF_OPTION],
+[m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
+
+#
+# Check to make sure that the build environment is sane.
+#
+
+# Copyright 1996, 1997, 2000, 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# serial 3
+
+# AM_SANITY_CHECK
+# ---------------
+AC_DEFUN([AM_SANITY_CHECK],
+[AC_MSG_CHECKING([whether build environment is sane])
+# Just in case
+sleep 1
+echo timestamp > conftest.file
+# Do `set' in a subshell so we don't clobber the current shell's
+# arguments.  Must try -L first in case configure is actually a
+# symlink; some systems play weird games with the mod time of symlinks
+# (eg FreeBSD returns the mod time of the symlink's containing
+# directory).
+if (
+   set X `ls -Lt $srcdir/configure conftest.file 2> /dev/null`
+   if test "$[*]" = "X"; then
+      # -L didn't work.
+      set X `ls -t $srcdir/configure conftest.file`
+   fi
+   rm -f conftest.file
+   if test "$[*]" != "X $srcdir/configure conftest.file" \
+      && test "$[*]" != "X conftest.file $srcdir/configure"; then
+
+      # If neither matched, then we have a broken ls.  This can happen
+      # if, for instance, CONFIG_SHELL is bash and it inherits a
+      # broken ls alias from the environment.  This has actually
+      # happened.  Such a system could not be considered "sane".
+      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
+alias in your environment])
+   fi
+
+   test "$[2]" = conftest.file
+   )
+then
+   # Ok.
+   :
+else
+   AC_MSG_ERROR([newly created file is older than distributed files!
+Check your system clock])
+fi
+AC_MSG_RESULT(yes)])
+
+#  -*- Autoconf -*-
+
+
+# Copyright 1997, 1999, 2000, 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# serial 3
+
+# AM_MISSING_PROG(NAME, PROGRAM)
+# ------------------------------
+AC_DEFUN([AM_MISSING_PROG],
+[AC_REQUIRE([AM_MISSING_HAS_RUN])
+$1=${$1-"${am_missing_run}$2"}
+AC_SUBST($1)])
+
+
+# AM_MISSING_HAS_RUN
+# ------------------
+# Define MISSING if not defined so far and test if it supports --run.
+# If it does, set am_missing_run to use it, otherwise, to nothing.
+AC_DEFUN([AM_MISSING_HAS_RUN],
+[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
+test x"${MISSING+set}" = xset || MISSING="\${SHELL} $am_aux_dir/missing"
+# Use eval to expand $SHELL
+if eval "$MISSING --run true"; then
+  am_missing_run="$MISSING --run "
+else
+  am_missing_run=
+  AC_MSG_WARN([`missing' script is too old or missing])
+fi
+])
+
+# AM_AUX_DIR_EXPAND
+
+# Copyright 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
+# $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
+# `$srcdir', `$srcdir/..', or `$srcdir/../..'.
+#
+# Of course, Automake must honor this variable whenever it calls a
+# tool from the auxiliary directory.  The problem is that $srcdir (and
+# therefore $ac_aux_dir as well) can be either absolute or relative,
+# depending on how configure is run.  This is pretty annoying, since
+# it makes $ac_aux_dir quite unusable in subdirectories: in the top
+# source directory, any form will work fine, but in subdirectories a
+# relative path needs to be adjusted first.
+#
+# $ac_aux_dir/missing
+#    fails when called from a subdirectory if $ac_aux_dir is relative
+# $top_srcdir/$ac_aux_dir/missing
+#    fails if $ac_aux_dir is absolute,
+#    fails when called from a subdirectory in a VPATH build with
+#          a relative $ac_aux_dir
+#
+# The reason of the latter failure is that $top_srcdir and $ac_aux_dir
+# are both prefixed by $srcdir.  In an in-source build this is usually
+# harmless because $srcdir is `.', but things will broke when you
+# start a VPATH build or use an absolute $srcdir.
+#
+# So we could use something similar to $top_srcdir/$ac_aux_dir/missing,
+# iff we strip the leading $srcdir from $ac_aux_dir.  That would be:
+#   am_aux_dir='\$(top_srcdir)/'`expr "$ac_aux_dir" : "$srcdir//*\(.*\)"`
+# and then we would define $MISSING as
+#   MISSING="\${SHELL} $am_aux_dir/missing"
+# This will work as long as MISSING is not called from configure, because
+# unfortunately $(top_srcdir) has no meaning in configure.
+# However there are other variables, like CC, which are often used in
+# configure, and could therefore not use this "fixed" $ac_aux_dir.
+#
+# Another solution, used here, is to always expand $ac_aux_dir to an
+# absolute PATH.  The drawback is that using absolute paths prevent a
+# configured tree to be moved without reconfiguration.
+
+# Rely on autoconf to set up CDPATH properly.
+AC_PREREQ([2.50])
+
+AC_DEFUN([AM_AUX_DIR_EXPAND], [
+# expand $ac_aux_dir to an absolute path
+am_aux_dir=`cd $ac_aux_dir && pwd`
+])
+
+# AM_PROG_INSTALL_SH
+# ------------------
+# Define $install_sh.
+
+# Copyright 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+AC_DEFUN([AM_PROG_INSTALL_SH],
+[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
+install_sh=${install_sh-"$am_aux_dir/install-sh"}
+AC_SUBST(install_sh)])
+
+# AM_PROG_INSTALL_STRIP
+
+# Copyright 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# One issue with vendor `install' (even GNU) is that you can't
+# specify the program used to strip binaries.  This is especially
+# annoying in cross-compiling environments, where the build's strip
+# is unlikely to handle the host's binaries.
+# Fortunately install-sh will honor a STRIPPROG variable, so we
+# always use install-sh in `make install-strip', and initialize
+# STRIPPROG with the value of the STRIP variable (set by the user).
+AC_DEFUN([AM_PROG_INSTALL_STRIP],
+[AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
+# Installed binaries are usually stripped using `strip' when the user
+# run `make install-strip'.  However `strip' might not be the right
+# tool to use in cross-compilation environments, therefore Automake
+# will honor the `STRIP' environment variable to overrule this program.
+dnl Don't test for $cross_compiling = yes, because it might be `maybe'.
+if test "$cross_compiling" != no; then
+  AC_CHECK_TOOL([STRIP], [strip], :)
+fi
+INSTALL_STRIP_PROGRAM="\${SHELL} \$(install_sh) -c -s"
+AC_SUBST([INSTALL_STRIP_PROGRAM])])
+
+# serial 4						-*- Autoconf -*-
+
+# Copyright 1999, 2000, 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+
+# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
+# written in clear, in which case automake, when reading aclocal.m4,
+# will think it sees a *use*, and therefore will trigger all it's
+# C support machinery.  Also note that it means that autoscan, seeing
+# CC etc. in the Makefile, will ask for an AC_PROG_CC use...
+
+
+
+# _AM_DEPENDENCIES(NAME)
+# ----------------------
+# See how the compiler implements dependency checking.
+# NAME is "CC", "CXX", "GCJ", or "OBJC".
+# We try a few techniques and use that to set a single cache variable.
+#
+# We don't AC_REQUIRE the corresponding AC_PROG_CC since the latter was
+# modified to invoke _AM_DEPENDENCIES(CC); we would have a circular
+# dependency, and given that the user is not expected to run this macro,
+# just rely on AC_PROG_CC.
+AC_DEFUN([_AM_DEPENDENCIES],
+[AC_REQUIRE([AM_SET_DEPDIR])dnl
+AC_REQUIRE([AM_OUTPUT_DEPENDENCY_COMMANDS])dnl
+AC_REQUIRE([AM_MAKE_INCLUDE])dnl
+AC_REQUIRE([AM_DEP_TRACK])dnl
+
+ifelse([$1], CC,   [depcc="$CC"   am_compiler_list=],
+       [$1], CXX,  [depcc="$CXX"  am_compiler_list=],
+       [$1], OBJC, [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
+       [$1], GCJ,  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
+                   [depcc="$$1"   am_compiler_list=])
+
+AC_CACHE_CHECK([dependency style of $depcc],
+               [am_cv_$1_dependencies_compiler_type],
+[if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
+  # We make a subdir and do the tests there.  Otherwise we can end up
+  # making bogus files that we don't know about and never remove.  For
+  # instance it was reported that on HP-UX the gcc test will end up
+  # making a dummy file named `D' -- because `-MD' means `put the output
+  # in D'.
+  mkdir conftest.dir
+  # Copy depcomp to subdir because otherwise we won't find it if we're
+  # using a relative directory.
+  cp "$am_depcomp" conftest.dir
+  cd conftest.dir
+
+  am_cv_$1_dependencies_compiler_type=none
+  if test "$am_compiler_list" = ""; then
+     am_compiler_list=`sed -n ['s/^#*\([a-zA-Z0-9]*\))$/\1/p'] < ./depcomp`
+  fi
+  for depmode in $am_compiler_list; do
+    # We need to recreate these files for each test, as the compiler may
+    # overwrite some of them when testing with obscure command lines.
+    # This happens at least with the AIX C compiler.
+    echo '#include "conftest.h"' > conftest.c
+    echo 'int i;' > conftest.h
+    echo "${am__include} ${am__quote}conftest.Po${am__quote}" > confmf
+
+    case $depmode in
+    nosideeffect)
+      # after this tag, mechanisms are not by side-effect, so they'll
+      # only be used when explicitly requested
+      if test "x$enable_dependency_tracking" = xyes; then
+	continue
+      else
+	break
+      fi
+      ;;
+    none) break ;;
+    esac
+    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+    # mode.  It turns out that the SunPro C++ compiler does not properly
+    # handle `-M -o', and we need to detect this.
+    if depmode=$depmode \
+       source=conftest.c object=conftest.o \
+       depfile=conftest.Po tmpdepfile=conftest.TPo \
+       $SHELL ./depcomp $depcc -c conftest.c -o conftest.o >/dev/null 2>&1 &&
+       grep conftest.h conftest.Po > /dev/null 2>&1 &&
+       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
+      am_cv_$1_dependencies_compiler_type=$depmode
+      break
+    fi
+  done
+
+  cd ..
+  rm -rf conftest.dir
+else
+  am_cv_$1_dependencies_compiler_type=none
+fi
+])
+AC_SUBST([$1DEPMODE], [depmode=$am_cv_$1_dependencies_compiler_type])
+])
+
+
+# AM_SET_DEPDIR
+# -------------
+# Choose a directory name for dependency files.
+# This macro is AC_REQUIREd in _AM_DEPENDENCIES
+AC_DEFUN([AM_SET_DEPDIR],
+[rm -f .deps 2>/dev/null
+mkdir .deps 2>/dev/null
+if test -d .deps; then
+  DEPDIR=.deps
+else
+  # MS-DOS does not allow filenames that begin with a dot.
+  DEPDIR=_deps
+fi
+rmdir .deps 2>/dev/null
+AC_SUBST([DEPDIR])
+])
+
+
+# AM_DEP_TRACK
+# ------------
+AC_DEFUN([AM_DEP_TRACK],
+[AC_ARG_ENABLE(dependency-tracking,
+[  --disable-dependency-tracking Speeds up one-time builds
+  --enable-dependency-tracking  Do not reject slow dependency extractors])
+if test "x$enable_dependency_tracking" != xno; then
+  am_depcomp="$ac_aux_dir/depcomp"
+  AMDEPBACKSLASH='\'
+fi
+AM_CONDITIONAL([AMDEP], [test "x$enable_dependency_tracking" != xno])
+AC_SUBST([AMDEPBACKSLASH])
+])
+
+# Generate code to set up dependency tracking.   -*- Autoconf -*-
+
+# Copyright 1999, 2000, 2001, 2002 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+#serial 2
+
+# _AM_OUTPUT_DEPENDENCY_COMMANDS
+# ------------------------------
+AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
+[for mf in $CONFIG_FILES; do
+  # Strip MF so we end up with the name of the file.
+  mf=`echo "$mf" | sed -e 's/:.*$//'`
+  # Check whether this is an Automake generated Makefile or not.
+  # We used to match only the files named `Makefile.in', but
+  # some people rename them; so instead we look at the file content.
+  # Grep'ing the first line is not enough: some people post-process
+  # each Makefile.in and add a new line on top of each file to say so.
+  # So let's grep whole file.
+  if grep '^#.*generated by automake' $mf > /dev/null 2>&1; then
+    dirpart=`AS_DIRNAME("$mf")`
+  else
+    continue
+  fi
+  grep '^DEP_FILES *= *[[^ @%:@]]' < "$mf" > /dev/null || continue
+  # Extract the definition of DEP_FILES from the Makefile without
+  # running `make'.
+  DEPDIR=`sed -n -e '/^DEPDIR = / s///p' < "$mf"`
+  test -z "$DEPDIR" && continue
+  # When using ansi2knr, U may be empty or an underscore; expand it
+  U=`sed -n -e '/^U = / s///p' < "$mf"`
+  test -d "$dirpart/$DEPDIR" || mkdir "$dirpart/$DEPDIR"
+  # We invoke sed twice because it is the simplest approach to
+  # changing $(DEPDIR) to its actual value in the expansion.
+  for file in `sed -n -e '
+    /^DEP_FILES = .*\\\\$/ {
+      s/^DEP_FILES = //
+      :loop
+	s/\\\\$//
+	p
+	n
+	/\\\\$/ b loop
+      p
+    }
+    /^DEP_FILES = / s/^DEP_FILES = //p' < "$mf" | \
+       sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
+    # Make sure the directory exists.
+    test -f "$dirpart/$file" && continue
+    fdir=`AS_DIRNAME(["$file"])`
+    AS_MKDIR_P([$dirpart/$fdir])
+    # echo "creating $dirpart/$file"
+    echo '# dummy' > "$dirpart/$file"
+  done
+done
+])# _AM_OUTPUT_DEPENDENCY_COMMANDS
+
+
+# AM_OUTPUT_DEPENDENCY_COMMANDS
+# -----------------------------
+# This macro should only be invoked once -- use via AC_REQUIRE.
+#
+# This code is only required when automatic dependency tracking
+# is enabled.  FIXME.  This creates each `.P' file that we will
+# need in order to bootstrap the dependency handling code.
+AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
+[AC_CONFIG_COMMANDS([depfiles],
+     [test x"$AMDEP_TRUE" != x"" || _AM_OUTPUT_DEPENDENCY_COMMANDS],
+     [AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"])
+])
+
+# Copyright 2001 Free Software Foundation, Inc.             -*- Autoconf -*-
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# serial 2
+
+# AM_MAKE_INCLUDE()
+# -----------------
+# Check to see how make treats includes.
+AC_DEFUN([AM_MAKE_INCLUDE],
+[am_make=${MAKE-make}
+cat > confinc << 'END'
+doit:
+	@echo done
+END
+# If we don't find an include directive, just comment out the code.
+AC_MSG_CHECKING([for style of include used by $am_make])
+am__include="#"
+am__quote=
+_am_result=none
+# First try GNU make style include.
+echo "include confinc" > confmf
+# We grep out `Entering directory' and `Leaving directory'
+# messages which can occur if `w' ends up in MAKEFLAGS.
+# In particular we don't look at `^make:' because GNU make might
+# be invoked under some other name (usually "gmake"), in which
+# case it prints its new name instead of `make'.
+if test "`$am_make -s -f confmf 2> /dev/null | fgrep -v 'ing directory'`" = "done"; then
+   am__include=include
+   am__quote=
+   _am_result=GNU
+fi
+# Now try BSD make style include.
+if test "$am__include" = "#"; then
+   echo '.include "confinc"' > confmf
+   if test "`$am_make -s -f confmf 2> /dev/null`" = "done"; then
+      am__include=.include
+      am__quote="\""
+      _am_result=BSD
+   fi
+fi
+AC_SUBST(am__include)
+AC_SUBST(am__quote)
+AC_MSG_RESULT($_am_result)
+rm -f confinc confmf
+])
+
+# AM_CONDITIONAL                                              -*- Autoconf -*-
+
+# Copyright 1997, 2000, 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# serial 5
+
+AC_PREREQ(2.52)
+
+# AM_CONDITIONAL(NAME, SHELL-CONDITION)
+# -------------------------------------
+# Define a conditional.
+AC_DEFUN([AM_CONDITIONAL],
+[ifelse([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
+        [$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
+AC_SUBST([$1_TRUE])
+AC_SUBST([$1_FALSE])
+if $2; then
+  $1_TRUE=
+  $1_FALSE='#'
+else
+  $1_TRUE='#'
+  $1_FALSE=
+fi
+AC_CONFIG_COMMANDS_PRE(
+[if test -z "${$1_TRUE}" && test -z "${$1_FALSE}"; then
+  AC_MSG_ERROR([conditional \"$1\" was never defined.
+Usually this means the macro was only invoked conditionally.])
+fi])])
+
+# Add --enable-maintainer-mode option to configure.
+# From Jim Meyering
+
+# Copyright 1996, 1998, 2000, 2001 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# serial 1
+
+AC_DEFUN([AM_MAINTAINER_MODE],
+[AC_MSG_CHECKING([whether to enable maintainer-specific portions of Makefiles])
+  dnl maintainer-mode is disabled by default
+  AC_ARG_ENABLE(maintainer-mode,
+[  --enable-maintainer-mode enable make rules and dependencies not useful
+                          (and sometimes confusing) to the casual installer],
+      USE_MAINTAINER_MODE=$enableval,
+      USE_MAINTAINER_MODE=no)
+  AC_MSG_RESULT([$USE_MAINTAINER_MODE])
+  AM_CONDITIONAL(MAINTAINER_MODE, [test $USE_MAINTAINER_MODE = yes])
+  MAINT=$MAINTAINER_MODE_TRUE
+  AC_SUBST(MAINT)dnl
+]
+)
+
@@ -0,0 +1,30 @@
+#! /bin/sh
+# Used to setup the configure.in, autoheader and Makefile.in's if configure
+# has not been generated. This script is only needed for developers when
+# configure has not been run, or if a Makefile.am in a non-configured directory
+# has been updated
+
+
+bootstrap() {
+  if "$@"; then
+    true # Everything OK
+  else
+    echo "$1 failed"
+    echo "Autotool bootstrapping failed. You will need to investigate and correct" ;
+    echo "before you can develop on this source tree" 
+    exit 1
+  fi
+}
+
+# Make sure cfgaux exists
+mkdir -p cfgaux
+
+echo "Bootstrapping libTrie."
+# Bootstrap the autotool subsystems
+bootstrap aclocal
+bootstrap autoheader
+#bootstrap libtoolize --automake 
+bootstrap automake --add-missing
+bootstrap autoconf
+
+echo "Autotool bootstrapping complete."
@@ -0,0 +1,1325 @@
+#! /bin/sh
+# Attempt to guess a canonical system name.
+#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
+#   2000, 2001, 2002 Free Software Foundation, Inc.
+
+timestamp='2002-05-29'
+
+# This file is free software; you can redistribute it and/or modify it
+# under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+# General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+#
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
+
+# Originally written by Per Bothner <per@bothner.com>.
+# Please send patches to <config-patches@gnu.org>.  Submit a context
+# diff and a properly formatted ChangeLog entry.
+#
+# This script attempts to guess a canonical system name similar to
+# config.sub.  If it succeeds, it prints the system name on stdout, and
+# exits with 0.  Otherwise, it exits with 1.
+#
+# The plan is that this can be called by configure scripts if you
+# don't specify an explicit build system type.
+
+me=`echo "$0" | sed -e 's,.*/,,'`
+
+usage="\
+Usage: $0 [OPTION]
+
+Output the configuration name of the system \`$me' is run on.
+
+Operation modes:
+  -h, --help         print this help, then exit
+  -t, --time-stamp   print date of last modification, then exit
+  -v, --version      print version number, then exit
+
+Report bugs and patches to <config-patches@gnu.org>."
+
+version="\
+GNU config.guess ($timestamp)
+
+Originally written by Per Bothner.
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001
+Free Software Foundation, Inc.
+
+This is free software; see the source for copying conditions.  There is NO
+warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
+
+help="
+Try \`$me --help' for more information."
+
+# Parse command line
+while test $# -gt 0 ; do
+  case $1 in
+    --time-stamp | --time* | -t )
+       echo "$timestamp" ; exit 0 ;;
+    --version | -v )
+       echo "$version" ; exit 0 ;;
+    --help | --h* | -h )
+       echo "$usage"; exit 0 ;;
+    -- )     # Stop option processing
+       shift; break ;;
+    - )	# Use stdin as input.
+       break ;;
+    -* )
+       echo "$me: invalid option $1$help" >&2
+       exit 1 ;;
+    * )
+       break ;;
+  esac
+done
+
+if test $# != 0; then
+  echo "$me: too many arguments$help" >&2
+  exit 1
+fi
+
+
+dummy=dummy-$$
+trap 'rm -f $dummy.c $dummy.o $dummy.rel $dummy; exit 1' 1 2 15
+
+# CC_FOR_BUILD -- compiler used by this script.
+# Historically, `CC_FOR_BUILD' used to be named `HOST_CC'. We still
+# use `HOST_CC' if defined, but it is deprecated.
+
+set_cc_for_build='case $CC_FOR_BUILD,$HOST_CC,$CC in
+ ,,)    echo "int dummy(){}" > $dummy.c ;
+	for c in cc gcc c89 c99 ; do
+	  ($c $dummy.c -c -o $dummy.o) >/dev/null 2>&1 ;
+	  if test $? = 0 ; then
+	     CC_FOR_BUILD="$c"; break ;
+	  fi ;
+	done ;
+	rm -f $dummy.c $dummy.o $dummy.rel ;
+	if test x"$CC_FOR_BUILD" = x ; then
+	  CC_FOR_BUILD=no_compiler_found ;
+	fi
+	;;
+ ,,*)   CC_FOR_BUILD=$CC ;;
+ ,*,*)  CC_FOR_BUILD=$HOST_CC ;;
+esac'
+
+# This is needed to find uname on a Pyramid OSx when run in the BSD universe.
+# (ghazi@noc.rutgers.edu 1994-08-24)
+if (test -f /.attbin/uname) >/dev/null 2>&1 ; then
+	PATH=$PATH:/.attbin ; export PATH
+fi
+
+UNAME_MACHINE=`(uname -m) 2>/dev/null` || UNAME_MACHINE=unknown
+UNAME_RELEASE=`(uname -r) 2>/dev/null` || UNAME_RELEASE=unknown
+UNAME_SYSTEM=`(uname -s) 2>/dev/null`  || UNAME_SYSTEM=unknown
+UNAME_VERSION=`(uname -v) 2>/dev/null` || UNAME_VERSION=unknown
+
+# Note: order is significant - the case branches are not exclusive.
+
+case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
+    *:NetBSD:*:*)
+	# NetBSD (nbsd) targets should (where applicable) match one or
+	# more of the tupples: *-*-netbsdelf*, *-*-netbsdaout*,
+	# *-*-netbsdecoff* and *-*-netbsd*.  For targets that recently
+	# switched to ELF, *-*-netbsd* would select the old
+	# object file format.  This provides both forward
+	# compatibility and a consistent mechanism for selecting the
+	# object file format.
+	#
+	# Note: NetBSD doesn't particularly care about the vendor
+	# portion of the name.  We always set it to "unknown".
+	sysctl="sysctl -n hw.machine_arch"
+	UNAME_MACHINE_ARCH=`(/sbin/$sysctl 2>/dev/null || \
+	    /usr/sbin/$sysctl 2>/dev/null || echo unknown)`
+	case "${UNAME_MACHINE_ARCH}" in
+	    armeb) machine=armeb-unknown ;;
+	    arm*) machine=arm-unknown ;;
+	    sh3el) machine=shl-unknown ;;
+	    sh3eb) machine=sh-unknown ;;
+	    *) machine=${UNAME_MACHINE_ARCH}-unknown ;;
+	esac
+	# The Operating System including object format, if it has switched
+	# to ELF recently, or will in the future.
+	case "${UNAME_MACHINE_ARCH}" in
+	    arm*|i386|m68k|ns32k|sh3*|sparc|vax)
+		eval $set_cc_for_build
+		if echo __ELF__ | $CC_FOR_BUILD -E - 2>/dev/null \
+			| grep __ELF__ >/dev/null
+		then
+		    # Once all utilities can be ECOFF (netbsdecoff) or a.out (netbsdaout).
+		    # Return netbsd for either.  FIX?
+		    os=netbsd
+		else
+		    os=netbsdelf
+		fi
+		;;
+	    *)
+	        os=netbsd
+		;;
+	esac
+	# The OS release
+	release=`echo ${UNAME_RELEASE}|sed -e 's/[-_].*/\./'`
+	# Since CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM:
+	# contains redundant information, the shorter form:
+	# CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM is used.
+	echo "${machine}-${os}${release}"
+	exit 0 ;;
+    amiga:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    arc:OpenBSD:*:*)
+	echo mipsel-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    hp300:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mac68k:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    macppc:OpenBSD:*:*)
+	echo powerpc-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mvme68k:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mvme88k:OpenBSD:*:*)
+	echo m88k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mvmeppc:OpenBSD:*:*)
+	echo powerpc-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    pmax:OpenBSD:*:*)
+	echo mipsel-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    sgi:OpenBSD:*:*)
+	echo mipseb-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    sun3:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    wgrisc:OpenBSD:*:*)
+	echo mipsel-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    *:OpenBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    alpha:OSF1:*:*)
+	if test $UNAME_RELEASE = "V4.0"; then
+		UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $3}'`
+	fi
+	# A Vn.n version is a released version.
+	# A Tn.n version is a released field test version.
+	# A Xn.n version is an unreleased experimental baselevel.
+	# 1.2 uses "1.2" for uname -r.
+	cat <<EOF >$dummy.s
+	.data
+\$Lformat:
+	.byte 37,100,45,37,120,10,0	# "%d-%x\n"
+
+	.text
+	.globl main
+	.align 4
+	.ent main
+main:
+	.frame \$30,16,\$26,0
+	ldgp \$29,0(\$27)
+	.prologue 1
+	.long 0x47e03d80 # implver \$0
+	lda \$2,-1
+	.long 0x47e20c21 # amask \$2,\$1
+	lda \$16,\$Lformat
+	mov \$0,\$17
+	not \$1,\$18
+	jsr \$26,printf
+	ldgp \$29,0(\$26)
+	mov 0,\$16
+	jsr \$26,exit
+	.end main
+EOF
+	eval $set_cc_for_build
+	$CC_FOR_BUILD $dummy.s -o $dummy 2>/dev/null
+	if test "$?" = 0 ; then
+		case `./$dummy` in
+			0-0)
+				UNAME_MACHINE="alpha"
+				;;
+			1-0)
+				UNAME_MACHINE="alphaev5"
+				;;
+			1-1)
+				UNAME_MACHINE="alphaev56"
+				;;
+			1-101)
+				UNAME_MACHINE="alphapca56"
+				;;
+			2-303)
+				UNAME_MACHINE="alphaev6"
+				;;
+			2-307)
+				UNAME_MACHINE="alphaev67"
+				;;
+			2-1307)
+				UNAME_MACHINE="alphaev68"
+				;;
+		esac
+	fi
+	rm -f $dummy.s $dummy
+	echo ${UNAME_MACHINE}-dec-osf`echo ${UNAME_RELEASE} | sed -e 's/^[VTX]//' | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
+	exit 0 ;;
+    Alpha\ *:Windows_NT*:*)
+	# How do we know it's Interix rather than the generic POSIX subsystem?
+	# Should we change UNAME_MACHINE based on the output of uname instead
+	# of the specific Alpha model?
+	echo alpha-pc-interix
+	exit 0 ;;
+    21064:Windows_NT:50:3)
+	echo alpha-dec-winnt3.5
+	exit 0 ;;
+    Amiga*:UNIX_System_V:4.0:*)
+	echo m68k-unknown-sysv4
+	exit 0;;
+    *:[Aa]miga[Oo][Ss]:*:*)
+	echo ${UNAME_MACHINE}-unknown-amigaos
+	exit 0 ;;
+    *:[Mm]orph[Oo][Ss]:*:*)
+	echo ${UNAME_MACHINE}-unknown-morphos
+	exit 0 ;;
+    *:OS/390:*:*)
+	echo i370-ibm-openedition
+	exit 0 ;;
+    arm:RISC*:1.[012]*:*|arm:riscix:1.[012]*:*)
+	echo arm-acorn-riscix${UNAME_RELEASE}
+	exit 0;;
+    SR2?01:HI-UX/MPP:*:* | SR8000:HI-UX/MPP:*:*)
+	echo hppa1.1-hitachi-hiuxmpp
+	exit 0;;
+    Pyramid*:OSx*:*:* | MIS*:OSx*:*:* | MIS*:SMP_DC-OSx*:*:*)
+	# akee@wpdis03.wpafb.af.mil (Earle F. Ake) contributed MIS and NILE.
+	if test "`(/bin/universe) 2>/dev/null`" = att ; then
+		echo pyramid-pyramid-sysv3
+	else
+		echo pyramid-pyramid-bsd
+	fi
+	exit 0 ;;
+    NILE*:*:*:dcosx)
+	echo pyramid-pyramid-svr4
+	exit 0 ;;
+    sun4H:SunOS:5.*:*)
+	echo sparc-hal-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    sun4*:SunOS:5.*:* | tadpole*:SunOS:5.*:*)
+	echo sparc-sun-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    i86pc:SunOS:5.*:*)
+	echo i386-pc-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    sun4*:SunOS:6*:*)
+	# According to config.sub, this is the proper way to canonicalize
+	# SunOS6.  Hard to guess exactly what SunOS6 will be like, but
+	# it's likely to be more like Solaris than SunOS4.
+	echo sparc-sun-solaris3`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    sun4*:SunOS:*:*)
+	case "`/usr/bin/arch -k`" in
+	    Series*|S4*)
+		UNAME_RELEASE=`uname -v`
+		;;
+	esac
+	# Japanese Language versions have a version number like `4.1.3-JL'.
+	echo sparc-sun-sunos`echo ${UNAME_RELEASE}|sed -e 's/-/_/'`
+	exit 0 ;;
+    sun3*:SunOS:*:*)
+	echo m68k-sun-sunos${UNAME_RELEASE}
+	exit 0 ;;
+    sun*:*:4.2BSD:*)
+	UNAME_RELEASE=`(sed 1q /etc/motd | awk '{print substr($5,1,3)}') 2>/dev/null`
+	test "x${UNAME_RELEASE}" = "x" && UNAME_RELEASE=3
+	case "`/bin/arch`" in
+	    sun3)
+		echo m68k-sun-sunos${UNAME_RELEASE}
+		;;
+	    sun4)
+		echo sparc-sun-sunos${UNAME_RELEASE}
+		;;
+	esac
+	exit 0 ;;
+    aushp:SunOS:*:*)
+	echo sparc-auspex-sunos${UNAME_RELEASE}
+	exit 0 ;;
+    # The situation for MiNT is a little confusing.  The machine name
+    # can be virtually everything (everything which is not
+    # "atarist" or "atariste" at least should have a processor
+    # > m68000).  The system name ranges from "MiNT" over "FreeMiNT"
+    # to the lowercase version "mint" (or "freemint").  Finally
+    # the system name "TOS" denotes a system which is actually not
+    # MiNT.  But MiNT is downward compatible to TOS, so this should
+    # be no problem.
+    atarist[e]:*MiNT:*:* | atarist[e]:*mint:*:* | atarist[e]:*TOS:*:*)
+        echo m68k-atari-mint${UNAME_RELEASE}
+	exit 0 ;;
+    atari*:*MiNT:*:* | atari*:*mint:*:* | atarist[e]:*TOS:*:*)
+	echo m68k-atari-mint${UNAME_RELEASE}
+        exit 0 ;;
+    *falcon*:*MiNT:*:* | *falcon*:*mint:*:* | *falcon*:*TOS:*:*)
+        echo m68k-atari-mint${UNAME_RELEASE}
+	exit 0 ;;
+    milan*:*MiNT:*:* | milan*:*mint:*:* | *milan*:*TOS:*:*)
+        echo m68k-milan-mint${UNAME_RELEASE}
+        exit 0 ;;
+    hades*:*MiNT:*:* | hades*:*mint:*:* | *hades*:*TOS:*:*)
+        echo m68k-hades-mint${UNAME_RELEASE}
+        exit 0 ;;
+    *:*MiNT:*:* | *:*mint:*:* | *:*TOS:*:*)
+        echo m68k-unknown-mint${UNAME_RELEASE}
+        exit 0 ;;
+    powerpc:machten:*:*)
+	echo powerpc-apple-machten${UNAME_RELEASE}
+	exit 0 ;;
+    RISC*:Mach:*:*)
+	echo mips-dec-mach_bsd4.3
+	exit 0 ;;
+    RISC*:ULTRIX:*:*)
+	echo mips-dec-ultrix${UNAME_RELEASE}
+	exit 0 ;;
+    VAX*:ULTRIX*:*:*)
+	echo vax-dec-ultrix${UNAME_RELEASE}
+	exit 0 ;;
+    2020:CLIX:*:* | 2430:CLIX:*:*)
+	echo clipper-intergraph-clix${UNAME_RELEASE}
+	exit 0 ;;
+    mips:*:*:UMIPS | mips:*:*:RISCos)
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+#ifdef __cplusplus
+#include <stdio.h>  /* for printf() prototype */
+	int main (int argc, char *argv[]) {
+#else
+	int main (argc, argv) int argc; char *argv[]; {
+#endif
+	#if defined (host_mips) && defined (MIPSEB)
+	#if defined (SYSTYPE_SYSV)
+	  printf ("mips-mips-riscos%ssysv\n", argv[1]); exit (0);
+	#endif
+	#if defined (SYSTYPE_SVR4)
+	  printf ("mips-mips-riscos%ssvr4\n", argv[1]); exit (0);
+	#endif
+	#if defined (SYSTYPE_BSD43) || defined(SYSTYPE_BSD)
+	  printf ("mips-mips-riscos%sbsd\n", argv[1]); exit (0);
+	#endif
+	#endif
+	  exit (-1);
+	}
+EOF
+	$CC_FOR_BUILD $dummy.c -o $dummy \
+	  && ./$dummy `echo "${UNAME_RELEASE}" | sed -n 's/\([0-9]*\).*/\1/p'` \
+	  && rm -f $dummy.c $dummy && exit 0
+	rm -f $dummy.c $dummy
+	echo mips-mips-riscos${UNAME_RELEASE}
+	exit 0 ;;
+    Motorola:PowerMAX_OS:*:*)
+	echo powerpc-motorola-powermax
+	exit 0 ;;
+    Night_Hawk:*:*:PowerMAX_OS)
+	echo powerpc-harris-powermax
+	exit 0 ;;
+    Night_Hawk:Power_UNIX:*:*)
+	echo powerpc-harris-powerunix
+	exit 0 ;;
+    m88k:CX/UX:7*:*)
+	echo m88k-harris-cxux7
+	exit 0 ;;
+    m88k:*:4*:R4*)
+	echo m88k-motorola-sysv4
+	exit 0 ;;
+    m88k:*:3*:R3*)
+	echo m88k-motorola-sysv3
+	exit 0 ;;
+    AViiON:dgux:*:*)
+        # DG/UX returns AViiON for all architectures
+        UNAME_PROCESSOR=`/usr/bin/uname -p`
+	if [ $UNAME_PROCESSOR = mc88100 ] || [ $UNAME_PROCESSOR = mc88110 ]
+	then
+	    if [ ${TARGET_BINARY_INTERFACE}x = m88kdguxelfx ] || \
+	       [ ${TARGET_BINARY_INTERFACE}x = x ]
+	    then
+		echo m88k-dg-dgux${UNAME_RELEASE}
+	    else
+		echo m88k-dg-dguxbcs${UNAME_RELEASE}
+	    fi
+	else
+	    echo i586-dg-dgux${UNAME_RELEASE}
+	fi
+ 	exit 0 ;;
+    M88*:DolphinOS:*:*)	# DolphinOS (SVR3)
+	echo m88k-dolphin-sysv3
+	exit 0 ;;
+    M88*:*:R3*:*)
+	# Delta 88k system running SVR3
+	echo m88k-motorola-sysv3
+	exit 0 ;;
+    XD88*:*:*:*) # Tektronix XD88 system running UTekV (SVR3)
+	echo m88k-tektronix-sysv3
+	exit 0 ;;
+    Tek43[0-9][0-9]:UTek:*:*) # Tektronix 4300 system running UTek (BSD)
+	echo m68k-tektronix-bsd
+	exit 0 ;;
+    *:IRIX*:*:*)
+	echo mips-sgi-irix`echo ${UNAME_RELEASE}|sed -e 's/-/_/g'`
+	exit 0 ;;
+    ????????:AIX?:[12].1:2)   # AIX 2.2.1 or AIX 2.1.1 is RT/PC AIX.
+	echo romp-ibm-aix      # uname -m gives an 8 hex-code CPU id
+	exit 0 ;;              # Note that: echo "'`uname -s`'" gives 'AIX '
+    i*86:AIX:*:*)
+	echo i386-ibm-aix
+	exit 0 ;;
+    ia64:AIX:*:*)
+	if [ -x /usr/bin/oslevel ] ; then
+		IBM_REV=`/usr/bin/oslevel`
+	else
+		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
+	fi
+	echo ${UNAME_MACHINE}-ibm-aix${IBM_REV}
+	exit 0 ;;
+    *:AIX:2:3)
+	if grep bos325 /usr/include/stdio.h >/dev/null 2>&1; then
+		eval $set_cc_for_build
+		sed 's/^		//' << EOF >$dummy.c
+		#include <sys/systemcfg.h>
+
+		main()
+			{
+			if (!__power_pc())
+				exit(1);
+			puts("powerpc-ibm-aix3.2.5");
+			exit(0);
+			}
+EOF
+		$CC_FOR_BUILD $dummy.c -o $dummy && ./$dummy && rm -f $dummy.c $dummy && exit 0
+		rm -f $dummy.c $dummy
+		echo rs6000-ibm-aix3.2.5
+	elif grep bos324 /usr/include/stdio.h >/dev/null 2>&1; then
+		echo rs6000-ibm-aix3.2.4
+	else
+		echo rs6000-ibm-aix3.2
+	fi
+	exit 0 ;;
+    *:AIX:*:[45])
+	IBM_CPU_ID=`/usr/sbin/lsdev -C -c processor -S available | sed 1q | awk '{ print $1 }'`
+	if /usr/sbin/lsattr -El ${IBM_CPU_ID} | grep ' POWER' >/dev/null 2>&1; then
+		IBM_ARCH=rs6000
+	else
+		IBM_ARCH=powerpc
+	fi
+	if [ -x /usr/bin/oslevel ] ; then
+		IBM_REV=`/usr/bin/oslevel`
+	else
+		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
+	fi
+	echo ${IBM_ARCH}-ibm-aix${IBM_REV}
+	exit 0 ;;
+    *:AIX:*:*)
+	echo rs6000-ibm-aix
+	exit 0 ;;
+    ibmrt:4.4BSD:*|romp-ibm:BSD:*)
+	echo romp-ibm-bsd4.4
+	exit 0 ;;
+    ibmrt:*BSD:*|romp-ibm:BSD:*)            # covers RT/PC BSD and
+	echo romp-ibm-bsd${UNAME_RELEASE}   # 4.3 with uname added to
+	exit 0 ;;                           # report: romp-ibm BSD 4.3
+    *:BOSX:*:*)
+	echo rs6000-bull-bosx
+	exit 0 ;;
+    DPX/2?00:B.O.S.:*:*)
+	echo m68k-bull-sysv3
+	exit 0 ;;
+    9000/[34]??:4.3bsd:1.*:*)
+	echo m68k-hp-bsd
+	exit 0 ;;
+    hp300:4.4BSD:*:* | 9000/[34]??:4.3bsd:2.*:*)
+	echo m68k-hp-bsd4.4
+	exit 0 ;;
+    9000/[34678]??:HP-UX:*:*)
+	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
+	case "${UNAME_MACHINE}" in
+	    9000/31? )            HP_ARCH=m68000 ;;
+	    9000/[34]?? )         HP_ARCH=m68k ;;
+	    9000/[678][0-9][0-9])
+		if [ -x /usr/bin/getconf ]; then
+		    sc_cpu_version=`/usr/bin/getconf SC_CPU_VERSION 2>/dev/null`
+                    sc_kernel_bits=`/usr/bin/getconf SC_KERNEL_BITS 2>/dev/null`
+                    case "${sc_cpu_version}" in
+                      523) HP_ARCH="hppa1.0" ;; # CPU_PA_RISC1_0
+                      528) HP_ARCH="hppa1.1" ;; # CPU_PA_RISC1_1
+                      532)                      # CPU_PA_RISC2_0
+                        case "${sc_kernel_bits}" in
+                          32) HP_ARCH="hppa2.0n" ;;
+                          64) HP_ARCH="hppa2.0w" ;;
+			  '') HP_ARCH="hppa2.0" ;;   # HP-UX 10.20
+                        esac ;;
+                    esac
+		fi
+		if [ "${HP_ARCH}" = "" ]; then
+		    eval $set_cc_for_build
+		    sed 's/^              //' << EOF >$dummy.c
+
+              #define _HPUX_SOURCE
+              #include <stdlib.h>
+              #include <unistd.h>
+
+              int main ()
+              {
+              #if defined(_SC_KERNEL_BITS)
+                  long bits = sysconf(_SC_KERNEL_BITS);
+              #endif
+                  long cpu  = sysconf (_SC_CPU_VERSION);
+
+                  switch (cpu)
+              	{
+              	case CPU_PA_RISC1_0: puts ("hppa1.0"); break;
+              	case CPU_PA_RISC1_1: puts ("hppa1.1"); break;
+              	case CPU_PA_RISC2_0:
+              #if defined(_SC_KERNEL_BITS)
+              	    switch (bits)
+              		{
+              		case 64: puts ("hppa2.0w"); break;
+              		case 32: puts ("hppa2.0n"); break;
+              		default: puts ("hppa2.0"); break;
+              		} break;
+              #else  /* !defined(_SC_KERNEL_BITS) */
+              	    puts ("hppa2.0"); break;
+              #endif
+              	default: puts ("hppa1.0"); break;
+              	}
+                  exit (0);
+              }
+EOF
+		    (CCOPTS= $CC_FOR_BUILD $dummy.c -o $dummy 2>/dev/null) && HP_ARCH=`./$dummy`
+		    if test -z "$HP_ARCH"; then HP_ARCH=hppa; fi
+		    rm -f $dummy.c $dummy
+		fi ;;
+	esac
+	echo ${HP_ARCH}-hp-hpux${HPUX_REV}
+	exit 0 ;;
+    ia64:HP-UX:*:*)
+	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
+	echo ia64-hp-hpux${HPUX_REV}
+	exit 0 ;;
+    3050*:HI-UX:*:*)
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#include <unistd.h>
+	int
+	main ()
+	{
+	  long cpu = sysconf (_SC_CPU_VERSION);
+	  /* The order matters, because CPU_IS_HP_MC68K erroneously returns
+	     true for CPU_PA_RISC1_0.  CPU_IS_PA_RISC returns correct
+	     results, however.  */
+	  if (CPU_IS_PA_RISC (cpu))
+	    {
+	      switch (cpu)
+		{
+		  case CPU_PA_RISC1_0: puts ("hppa1.0-hitachi-hiuxwe2"); break;
+		  case CPU_PA_RISC1_1: puts ("hppa1.1-hitachi-hiuxwe2"); break;
+		  case CPU_PA_RISC2_0: puts ("hppa2.0-hitachi-hiuxwe2"); break;
+		  default: puts ("hppa-hitachi-hiuxwe2"); break;
+		}
+	    }
+	  else if (CPU_IS_HP_MC68K (cpu))
+	    puts ("m68k-hitachi-hiuxwe2");
+	  else puts ("unknown-hitachi-hiuxwe2");
+	  exit (0);
+	}
+EOF
+	$CC_FOR_BUILD $dummy.c -o $dummy && ./$dummy && rm -f $dummy.c $dummy && exit 0
+	rm -f $dummy.c $dummy
+	echo unknown-hitachi-hiuxwe2
+	exit 0 ;;
+    9000/7??:4.3bsd:*:* | 9000/8?[79]:4.3bsd:*:* )
+	echo hppa1.1-hp-bsd
+	exit 0 ;;
+    9000/8??:4.3bsd:*:*)
+	echo hppa1.0-hp-bsd
+	exit 0 ;;
+    *9??*:MPE/iX:*:* | *3000*:MPE/iX:*:*)
+	echo hppa1.0-hp-mpeix
+	exit 0 ;;
+    hp7??:OSF1:*:* | hp8?[79]:OSF1:*:* )
+	echo hppa1.1-hp-osf
+	exit 0 ;;
+    hp8??:OSF1:*:*)
+	echo hppa1.0-hp-osf
+	exit 0 ;;
+    i*86:OSF1:*:*)
+	if [ -x /usr/sbin/sysversion ] ; then
+	    echo ${UNAME_MACHINE}-unknown-osf1mk
+	else
+	    echo ${UNAME_MACHINE}-unknown-osf1
+	fi
+	exit 0 ;;
+    parisc*:Lites*:*:*)
+	echo hppa1.1-hp-lites
+	exit 0 ;;
+    C1*:ConvexOS:*:* | convex:ConvexOS:C1*:*)
+	echo c1-convex-bsd
+        exit 0 ;;
+    C2*:ConvexOS:*:* | convex:ConvexOS:C2*:*)
+	if getsysinfo -f scalar_acc
+	then echo c32-convex-bsd
+	else echo c2-convex-bsd
+	fi
+        exit 0 ;;
+    C34*:ConvexOS:*:* | convex:ConvexOS:C34*:*)
+	echo c34-convex-bsd
+        exit 0 ;;
+    C38*:ConvexOS:*:* | convex:ConvexOS:C38*:*)
+	echo c38-convex-bsd
+        exit 0 ;;
+    C4*:ConvexOS:*:* | convex:ConvexOS:C4*:*)
+	echo c4-convex-bsd
+        exit 0 ;;
+    CRAY*Y-MP:*:*:*)
+	echo ymp-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*[A-Z]90:*:*:*)
+	echo ${UNAME_MACHINE}-cray-unicos${UNAME_RELEASE} \
+	| sed -e 's/CRAY.*\([A-Z]90\)/\1/' \
+	      -e y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/ \
+	      -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*TS:*:*:*)
+	echo t90-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*T3D:*:*:*)
+	echo alpha-cray-unicosmk${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*T3E:*:*:*)
+	echo alphaev5-cray-unicosmk${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*SV1:*:*:*)
+	echo sv1-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    F30[01]:UNIX_System_V:*:* | F700:UNIX_System_V:*:*)
+	FUJITSU_PROC=`uname -m | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
+        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+        FUJITSU_REL=`echo ${UNAME_RELEASE} | sed -e 's/ /_/'`
+        echo "${FUJITSU_PROC}-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+        exit 0 ;;
+    i*86:BSD/386:*:* | i*86:BSD/OS:*:* | *:Ascend\ Embedded/OS:*:*)
+	echo ${UNAME_MACHINE}-pc-bsdi${UNAME_RELEASE}
+	exit 0 ;;
+    sparc*:BSD/OS:*:*)
+	echo sparc-unknown-bsdi${UNAME_RELEASE}
+	exit 0 ;;
+    *:BSD/OS:*:*)
+	echo ${UNAME_MACHINE}-unknown-bsdi${UNAME_RELEASE}
+	exit 0 ;;
+    *:FreeBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
+	exit 0 ;;
+    i*:CYGWIN*:*)
+	echo ${UNAME_MACHINE}-pc-cygwin
+	exit 0 ;;
+    i*:MINGW*:*)
+	echo ${UNAME_MACHINE}-pc-mingw32
+	exit 0 ;;
+    i*:PW*:*)
+	echo ${UNAME_MACHINE}-pc-pw32
+	exit 0 ;;
+    x86:Interix*:3*)
+	echo i386-pc-interix3
+	exit 0 ;;
+    i*:Windows_NT*:* | Pentium*:Windows_NT*:*)
+	# How do we know it's Interix rather than the generic POSIX subsystem?
+	# It also conflicts with pre-2.0 versions of AT&T UWIN. Should we
+	# UNAME_MACHINE based on the output of uname instead of i386?
+	echo i386-pc-interix
+	exit 0 ;;
+    i*:UWIN*:*)
+	echo ${UNAME_MACHINE}-pc-uwin
+	exit 0 ;;
+    p*:CYGWIN*:*)
+	echo powerpcle-unknown-cygwin
+	exit 0 ;;
+    prep*:SunOS:5.*:*)
+	echo powerpcle-unknown-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    *:GNU:*:*)
+	echo `echo ${UNAME_MACHINE}|sed -e 's,[-/].*$,,'`-unknown-gnu`echo ${UNAME_RELEASE}|sed -e 's,/.*$,,'`
+	exit 0 ;;
+    i*86:Minix:*:*)
+	echo ${UNAME_MACHINE}-pc-minix
+	exit 0 ;;
+    arm*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    ia64:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    m68*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    mips:Linux:*:*)
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#undef CPU
+	#undef mips
+	#undef mipsel
+	#if defined(__MIPSEL__) || defined(__MIPSEL) || defined(_MIPSEL) || defined(MIPSEL)
+	CPU=mipsel
+	#else
+	#if defined(__MIPSEB__) || defined(__MIPSEB) || defined(_MIPSEB) || defined(MIPSEB)
+	CPU=mips
+	#else
+	CPU=
+	#endif
+	#endif
+EOF
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^CPU=`
+	rm -f $dummy.c
+	test x"${CPU}" != x && echo "${CPU}-pc-linux-gnu" && exit 0
+	;;
+    ppc:Linux:*:*)
+	echo powerpc-unknown-linux-gnu
+	exit 0 ;;
+    ppc64:Linux:*:*)
+	echo powerpc64-unknown-linux-gnu
+	exit 0 ;;
+    alpha:Linux:*:*)
+	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
+	  EV5)   UNAME_MACHINE=alphaev5 ;;
+	  EV56)  UNAME_MACHINE=alphaev56 ;;
+	  PCA56) UNAME_MACHINE=alphapca56 ;;
+	  PCA57) UNAME_MACHINE=alphapca56 ;;
+	  EV6)   UNAME_MACHINE=alphaev6 ;;
+	  EV67)  UNAME_MACHINE=alphaev67 ;;
+	  EV68*) UNAME_MACHINE=alphaev68 ;;
+        esac
+	objdump --private-headers /bin/sh | grep ld.so.1 >/dev/null
+	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
+	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
+	exit 0 ;;
+    parisc:Linux:*:* | hppa:Linux:*:*)
+	# Look for CPU level
+	case `grep '^cpu[^a-z]*:' /proc/cpuinfo 2>/dev/null | cut -d' ' -f2` in
+	  PA7*) echo hppa1.1-unknown-linux-gnu ;;
+	  PA8*) echo hppa2.0-unknown-linux-gnu ;;
+	  *)    echo hppa-unknown-linux-gnu ;;
+	esac
+	exit 0 ;;
+    parisc64:Linux:*:* | hppa64:Linux:*:*)
+	echo hppa64-unknown-linux-gnu
+	exit 0 ;;
+    s390:Linux:*:* | s390x:Linux:*:*)
+	echo ${UNAME_MACHINE}-ibm-linux
+	exit 0 ;;
+    sh*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    sparc:Linux:*:* | sparc64:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    x86_64:Linux:*:*)
+	echo x86_64-unknown-linux-gnu
+	exit 0 ;;
+    i*86:Linux:*:*)
+	# The BFD linker knows what the default object file format is, so
+	# first see if it will tell us. cd to the root directory to prevent
+	# problems with other programs or directories called `ld' in the path.
+	# Set LC_ALL=C to ensure ld outputs messages in English.
+	ld_supported_targets=`cd /; LC_ALL=C ld --help 2>&1 \
+			 | sed -ne '/supported targets:/!d
+				    s/[ 	][ 	]*/ /g
+				    s/.*supported targets: *//
+				    s/ .*//
+				    p'`
+        case "$ld_supported_targets" in
+	  elf32-i386)
+		TENTATIVE="${UNAME_MACHINE}-pc-linux-gnu"
+		;;
+	  a.out-i386-linux)
+		echo "${UNAME_MACHINE}-pc-linux-gnuaout"
+		exit 0 ;;		
+	  coff-i386)
+		echo "${UNAME_MACHINE}-pc-linux-gnucoff"
+		exit 0 ;;
+	  "")
+		# Either a pre-BFD a.out linker (linux-gnuoldld) or
+		# one that does not give us useful --help.
+		echo "${UNAME_MACHINE}-pc-linux-gnuoldld"
+		exit 0 ;;
+	esac
+	# Determine whether the default compiler is a.out or elf
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#include <features.h>
+	#ifdef __ELF__
+	# ifdef __GLIBC__
+	#  if __GLIBC__ >= 2
+	LIBC=gnu
+	#  else
+	LIBC=gnulibc1
+	#  endif
+	# else
+	LIBC=gnulibc1
+	# endif
+	#else
+	#ifdef __INTEL_COMPILER
+	LIBC=gnu
+	#else
+	LIBC=gnuaout
+	#endif
+	#endif
+EOF
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^LIBC=`
+	rm -f $dummy.c
+	test x"${LIBC}" != x && echo "${UNAME_MACHINE}-pc-linux-${LIBC}" && exit 0
+	test x"${TENTATIVE}" != x && echo "${TENTATIVE}" && exit 0
+	;;
+    i*86:DYNIX/ptx:4*:*)
+	# ptx 4.0 does uname -s correctly, with DYNIX/ptx in there.
+	# earlier versions are messed up and put the nodename in both
+	# sysname and nodename.
+	echo i386-sequent-sysv4
+	exit 0 ;;
+    i*86:UNIX_SV:4.2MP:2.*)
+        # Unixware is an offshoot of SVR4, but it has its own version
+        # number series starting with 2...
+        # I am not positive that other SVR4 systems won't match this,
+	# I just have to hope.  -- rms.
+        # Use sysv4.2uw... so that sysv4* matches it.
+	echo ${UNAME_MACHINE}-pc-sysv4.2uw${UNAME_VERSION}
+	exit 0 ;;
+    i*86:*:4.*:* | i*86:SYSTEM_V:4.*:*)
+	UNAME_REL=`echo ${UNAME_RELEASE} | sed 's/\/MP$//'`
+	if grep Novell /usr/include/link.h >/dev/null 2>/dev/null; then
+		echo ${UNAME_MACHINE}-univel-sysv${UNAME_REL}
+	else
+		echo ${UNAME_MACHINE}-pc-sysv${UNAME_REL}
+	fi
+	exit 0 ;;
+    i*86:*:5:[78]*)
+	case `/bin/uname -X | grep "^Machine"` in
+	    *486*)	     UNAME_MACHINE=i486 ;;
+	    *Pentium)	     UNAME_MACHINE=i586 ;;
+	    *Pent*|*Celeron) UNAME_MACHINE=i686 ;;
+	esac
+	echo ${UNAME_MACHINE}-unknown-sysv${UNAME_RELEASE}${UNAME_SYSTEM}${UNAME_VERSION}
+	exit 0 ;;
+    i*86:*:3.2:*)
+	if test -f /usr/options/cb.name; then
+		UNAME_REL=`sed -n 's/.*Version //p' </usr/options/cb.name`
+		echo ${UNAME_MACHINE}-pc-isc$UNAME_REL
+	elif /bin/uname -X 2>/dev/null >/dev/null ; then
+		UNAME_REL=`(/bin/uname -X|grep Release|sed -e 's/.*= //')`
+		(/bin/uname -X|grep i80486 >/dev/null) && UNAME_MACHINE=i486
+		(/bin/uname -X|grep '^Machine.*Pentium' >/dev/null) \
+			&& UNAME_MACHINE=i586
+		(/bin/uname -X|grep '^Machine.*Pent *II' >/dev/null) \
+			&& UNAME_MACHINE=i686
+		(/bin/uname -X|grep '^Machine.*Pentium Pro' >/dev/null) \
+			&& UNAME_MACHINE=i686
+		echo ${UNAME_MACHINE}-pc-sco$UNAME_REL
+	else
+		echo ${UNAME_MACHINE}-pc-sysv32
+	fi
+	exit 0 ;;
+    i*86:*DOS:*:*)
+	echo ${UNAME_MACHINE}-pc-msdosdjgpp
+	exit 0 ;;
+    pc:*:*:*)
+	# Left here for compatibility:
+        # uname -m prints for DJGPP always 'pc', but it prints nothing about
+        # the processor, so we play safe by assuming i386.
+	echo i386-pc-msdosdjgpp
+        exit 0 ;;
+    Intel:Mach:3*:*)
+	echo i386-pc-mach3
+	exit 0 ;;
+    paragon:*:*:*)
+	echo i860-intel-osf1
+	exit 0 ;;
+    i860:*:4.*:*) # i860-SVR4
+	if grep Stardent /usr/include/sys/uadmin.h >/dev/null 2>&1 ; then
+	  echo i860-stardent-sysv${UNAME_RELEASE} # Stardent Vistra i860-SVR4
+	else # Add other i860-SVR4 vendors below as they are discovered.
+	  echo i860-unknown-sysv${UNAME_RELEASE}  # Unknown i860-SVR4
+	fi
+	exit 0 ;;
+    mini*:CTIX:SYS*5:*)
+	# "miniframe"
+	echo m68010-convergent-sysv
+	exit 0 ;;
+    M68*:*:R3V[567]*:*)
+	test -r /sysV68 && echo 'm68k-motorola-sysv' && exit 0 ;;
+    3[34]??:*:4.0:3.0 | 3[34]??A:*:4.0:3.0 | 3[34]??,*:*:4.0:3.0 | 3[34]??/*:*:4.0:3.0 | 4400:*:4.0:3.0 | 4850:*:4.0:3.0 | SKA40:*:4.0:3.0)
+	OS_REL=''
+	test -r /etc/.relid \
+	&& OS_REL=.`sed -n 's/[^ ]* [^ ]* \([0-9][0-9]\).*/\1/p' < /etc/.relid`
+	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+	  && echo i486-ncr-sysv4.3${OS_REL} && exit 0
+	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
+	  && echo i586-ncr-sysv4.3${OS_REL} && exit 0 ;;
+    3[34]??:*:4.0:* | 3[34]??,*:*:4.0:*)
+        /bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+          && echo i486-ncr-sysv4 && exit 0 ;;
+    m68*:LynxOS:2.*:* | m68*:LynxOS:3.0*:*)
+	echo m68k-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    mc68030:UNIX_System_V:4.*:*)
+	echo m68k-atari-sysv4
+	exit 0 ;;
+    i*86:LynxOS:2.*:* | i*86:LynxOS:3.[01]*:* | i*86:LynxOS:4.0*:*)
+	echo i386-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    TSUNAMI:LynxOS:2.*:*)
+	echo sparc-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    rs6000:LynxOS:2.*:*)
+	echo rs6000-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    PowerPC:LynxOS:2.*:* | PowerPC:LynxOS:3.[01]*:* | PowerPC:LynxOS:4.0*:*)
+	echo powerpc-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    SM[BE]S:UNIX_SV:*:*)
+	echo mips-dde-sysv${UNAME_RELEASE}
+	exit 0 ;;
+    RM*:ReliantUNIX-*:*:*)
+	echo mips-sni-sysv4
+	exit 0 ;;
+    RM*:SINIX-*:*:*)
+	echo mips-sni-sysv4
+	exit 0 ;;
+    *:SINIX-*:*:*)
+	if uname -p 2>/dev/null >/dev/null ; then
+		UNAME_MACHINE=`(uname -p) 2>/dev/null`
+		echo ${UNAME_MACHINE}-sni-sysv4
+	else
+		echo ns32k-sni-sysv
+	fi
+	exit 0 ;;
+    PENTIUM:*:4.0*:*) # Unisys `ClearPath HMP IX 4000' SVR4/MP effort
+                      # says <Richard.M.Bartel@ccMail.Census.GOV>
+        echo i586-unisys-sysv4
+        exit 0 ;;
+    *:UNIX_System_V:4*:FTX*)
+	# From Gerald Hewes <hewes@openmarket.com>.
+	# How about differentiating between stratus architectures? -djm
+	echo hppa1.1-stratus-sysv4
+	exit 0 ;;
+    *:*:*:FTX*)
+	# From seanf@swdc.stratus.com.
+	echo i860-stratus-sysv4
+	exit 0 ;;
+    *:VOS:*:*)
+	# From Paul.Green@stratus.com.
+	echo hppa1.1-stratus-vos
+	exit 0 ;;
+    mc68*:A/UX:*:*)
+	echo m68k-apple-aux${UNAME_RELEASE}
+	exit 0 ;;
+    news*:NEWS-OS:6*:*)
+	echo mips-sony-newsos6
+	exit 0 ;;
+    R[34]000:*System_V*:*:* | R4000:UNIX_SYSV:*:* | R*000:UNIX_SV:*:*)
+	if [ -d /usr/nec ]; then
+	        echo mips-nec-sysv${UNAME_RELEASE}
+	else
+	        echo mips-unknown-sysv${UNAME_RELEASE}
+	fi
+        exit 0 ;;
+    BeBox:BeOS:*:*)	# BeOS running on hardware made by Be, PPC only.
+	echo powerpc-be-beos
+	exit 0 ;;
+    BeMac:BeOS:*:*)	# BeOS running on Mac or Mac clone, PPC only.
+	echo powerpc-apple-beos
+	exit 0 ;;
+    BePC:BeOS:*:*)	# BeOS running on Intel PC compatible.
+	echo i586-pc-beos
+	exit 0 ;;
+    SX-4:SUPER-UX:*:*)
+	echo sx4-nec-superux${UNAME_RELEASE}
+	exit 0 ;;
+    SX-5:SUPER-UX:*:*)
+	echo sx5-nec-superux${UNAME_RELEASE}
+	exit 0 ;;
+    Power*:Rhapsody:*:*)
+	echo powerpc-apple-rhapsody${UNAME_RELEASE}
+	exit 0 ;;
+    *:Rhapsody:*:*)
+	echo ${UNAME_MACHINE}-apple-rhapsody${UNAME_RELEASE}
+	exit 0 ;;
+    *:Darwin:*:*)
+	echo `uname -p`-apple-darwin${UNAME_RELEASE}
+	exit 0 ;;
+    *:procnto*:*:* | *:QNX:[0123456789]*:*)
+	UNAME_PROCESSOR=`uname -p`
+	if test "$UNAME_PROCESSOR" = "x86"; then
+		UNAME_PROCESSOR=i386
+		UNAME_MACHINE=pc
+	fi
+	echo ${UNAME_PROCESSOR}-${UNAME_MACHINE}-nto-qnx${UNAME_RELEASE}
+	exit 0 ;;
+    *:QNX:*:4*)
+	echo i386-pc-qnx
+	exit 0 ;;
+    NSR-[GKLNPTVW]:NONSTOP_KERNEL:*:*)
+	echo nsr-tandem-nsk${UNAME_RELEASE}
+	exit 0 ;;
+    *:NonStop-UX:*:*)
+	echo mips-compaq-nonstopux
+	exit 0 ;;
+    BS2000:POSIX*:*:*)
+	echo bs2000-siemens-sysv
+	exit 0 ;;
+    DS/*:UNIX_System_V:*:*)
+	echo ${UNAME_MACHINE}-${UNAME_SYSTEM}-${UNAME_RELEASE}
+	exit 0 ;;
+    *:Plan9:*:*)
+	# "uname -m" is not consistent, so use $cputype instead. 386
+	# is converted to i386 for consistency with other x86
+	# operating systems.
+	if test "$cputype" = "386"; then
+	    UNAME_MACHINE=i386
+	else
+	    UNAME_MACHINE="$cputype"
+	fi
+	echo ${UNAME_MACHINE}-unknown-plan9
+	exit 0 ;;
+    i*86:OS/2:*:*)
+	# If we were able to find `uname', then EMX Unix compatibility
+	# is probably installed.
+	echo ${UNAME_MACHINE}-pc-os2-emx
+	exit 0 ;;
+    *:TOPS-10:*:*)
+	echo pdp10-unknown-tops10
+	exit 0 ;;
+    *:TENEX:*:*)
+	echo pdp10-unknown-tenex
+	exit 0 ;;
+    KS10:TOPS-20:*:* | KL10:TOPS-20:*:* | TYPE4:TOPS-20:*:*)
+	echo pdp10-dec-tops20
+	exit 0 ;;
+    XKL-1:TOPS-20:*:* | TYPE5:TOPS-20:*:*)
+	echo pdp10-xkl-tops20
+	exit 0 ;;
+    *:TOPS-20:*:*)
+	echo pdp10-unknown-tops20
+	exit 0 ;;
+    *:ITS:*:*)
+	echo pdp10-unknown-its
+	exit 0 ;;
+    i*86:XTS-300:*:STOP)
+	echo ${UNAME_MACHINE}-unknown-stop
+	exit 0 ;;
+    i*86:atheos:*:*)
+	echo ${UNAME_MACHINE}-unknown-atheos
+	exit 0 ;;
+esac
+
+#echo '(No uname command or uname output not recognized.)' 1>&2
+#echo "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" 1>&2
+
+eval $set_cc_for_build
+cat >$dummy.c <<EOF
+#ifdef _SEQUENT_
+# include <sys/types.h>
+# include <sys/utsname.h>
+#endif
+main ()
+{
+#if defined (sony)
+#if defined (MIPSEB)
+  /* BFD wants "bsd" instead of "newsos".  Perhaps BFD should be changed,
+     I don't know....  */
+  printf ("mips-sony-bsd\n"); exit (0);
+#else
+#include <sys/param.h>
+  printf ("m68k-sony-newsos%s\n",
+#ifdef NEWSOS4
+          "4"
+#else
+	  ""
+#endif
+         ); exit (0);
+#endif
+#endif
+
+#if defined (__arm) && defined (__acorn) && defined (__unix)
+  printf ("arm-acorn-riscix"); exit (0);
+#endif
+
+#if defined (hp300) && !defined (hpux)
+  printf ("m68k-hp-bsd\n"); exit (0);
+#endif
+
+#if defined (NeXT)
+#if !defined (__ARCHITECTURE__)
+#define __ARCHITECTURE__ "m68k"
+#endif
+  int version;
+  version=`(hostinfo | sed -n 's/.*NeXT Mach \([0-9]*\).*/\1/p') 2>/dev/null`;
+  if (version < 4)
+    printf ("%s-next-nextstep%d\n", __ARCHITECTURE__, version);
+  else
+    printf ("%s-next-openstep%d\n", __ARCHITECTURE__, version);
+  exit (0);
+#endif
+
+#if defined (MULTIMAX) || defined (n16)
+#if defined (UMAXV)
+  printf ("ns32k-encore-sysv\n"); exit (0);
+#else
+#if defined (CMU)
+  printf ("ns32k-encore-mach\n"); exit (0);
+#else
+  printf ("ns32k-encore-bsd\n"); exit (0);
+#endif
+#endif
+#endif
+
+#if defined (__386BSD__)
+  printf ("i386-pc-bsd\n"); exit (0);
+#endif
+
+#if defined (sequent)
+#if defined (i386)
+  printf ("i386-sequent-dynix\n"); exit (0);
+#endif
+#if defined (ns32000)
+  printf ("ns32k-sequent-dynix\n"); exit (0);
+#endif
+#endif
+
+#if defined (_SEQUENT_)
+    struct utsname un;
+
+    uname(&un);
+
+    if (strncmp(un.version, "V2", 2) == 0) {
+	printf ("i386-sequent-ptx2\n"); exit (0);
+    }
+    if (strncmp(un.version, "V1", 2) == 0) { /* XXX is V1 correct? */
+	printf ("i386-sequent-ptx1\n"); exit (0);
+    }
+    printf ("i386-sequent-ptx\n"); exit (0);
+
+#endif
+
+#if defined (vax)
+# if !defined (ultrix)
+#  include <sys/param.h>
+#  if defined (BSD)
+#   if BSD == 43
+      printf ("vax-dec-bsd4.3\n"); exit (0);
+#   else
+#    if BSD == 199006
+      printf ("vax-dec-bsd4.3reno\n"); exit (0);
+#    else
+      printf ("vax-dec-bsd\n"); exit (0);
+#    endif
+#   endif
+#  else
+    printf ("vax-dec-bsd\n"); exit (0);
+#  endif
+# else
+    printf ("vax-dec-ultrix\n"); exit (0);
+# endif
+#endif
+
+#if defined (alliant) && defined (i860)
+  printf ("i860-alliant-bsd\n"); exit (0);
+#endif
+
+  exit (1);
+}
+EOF
+
+$CC_FOR_BUILD $dummy.c -o $dummy 2>/dev/null && ./$dummy && rm -f $dummy.c $dummy && exit 0
+rm -f $dummy.c $dummy
+
+# Apollos put the system type in the environment.
+
+test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit 0; }
+
+# Convex versions that predate uname can use getsysinfo(1)
+
+if [ -x /usr/convex/getsysinfo ]
+then
+    case `getsysinfo -f cpu_type` in
+    c1*)
+	echo c1-convex-bsd
+	exit 0 ;;
+    c2*)
+	if getsysinfo -f scalar_acc
+	then echo c32-convex-bsd
+	else echo c2-convex-bsd
+	fi
+	exit 0 ;;
+    c34*)
+	echo c34-convex-bsd
+	exit 0 ;;
+    c38*)
+	echo c38-convex-bsd
+	exit 0 ;;
+    c4*)
+	echo c4-convex-bsd
+	exit 0 ;;
+    esac
+fi
+
+cat >&2 <<EOF
+$0: unable to guess system type
+
+This script, last modified $timestamp, has failed to recognize
+the operating system you are using. It is advised that you
+download the most up to date version of the config scripts from
+
+    ftp://ftp.gnu.org/pub/gnu/config/
+
+If the version you run ($0) is already up to date, please
+send the following data and any information you think might be
+pertinent to <config-patches@gnu.org> in order to provide the needed
+information to handle your system.
+
+config.guess timestamp = $timestamp
+
+uname -m = `(uname -m) 2>/dev/null || echo unknown`
+uname -r = `(uname -r) 2>/dev/null || echo unknown`
+uname -s = `(uname -s) 2>/dev/null || echo unknown`
+uname -v = `(uname -v) 2>/dev/null || echo unknown`
+
+/usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null`
+/bin/uname -X     = `(/bin/uname -X) 2>/dev/null`
+
+hostinfo               = `(hostinfo) 2>/dev/null`
+/bin/universe          = `(/bin/universe) 2>/dev/null`
+/usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null`
+/bin/arch              = `(/bin/arch) 2>/dev/null`
+/usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null`
+/usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null`
+
+UNAME_MACHINE = ${UNAME_MACHINE}
+UNAME_RELEASE = ${UNAME_RELEASE}
+UNAME_SYSTEM  = ${UNAME_SYSTEM}
+UNAME_VERSION = ${UNAME_VERSION}
+EOF
+
+exit 1
+
+# Local variables:
+# eval: (add-hook 'write-file-hooks 'time-stamp)
+# time-stamp-start: "timestamp='"
+# time-stamp-format: "%:y-%02m-%02d"
+# time-stamp-end: "'"
+# End:
@@ -0,0 +1,64 @@
+/* config.h.in.  Generated from configure.in by autoheader.  */
+
+/* Define to 1 if you have the <inttypes.h> header file. */
+#undef HAVE_INTTYPES_H
+
+/* Define to 1 if you have the <memory.h> header file. */
+#undef HAVE_MEMORY_H
+
+/* Define to 1 if you have the <stdint.h> header file. */
+#undef HAVE_STDINT_H
+
+/* Define to 1 if you have the <stdlib.h> header file. */
+#undef HAVE_STDLIB_H
+
+/* Define to 1 if you have the <strings.h> header file. */
+#undef HAVE_STRINGS_H
+
+/* Define to 1 if you have the <string.h> header file. */
+#undef HAVE_STRING_H
+
+/* Define to 1 if you have the <sys/stat.h> header file. */
+#undef HAVE_SYS_STAT_H
+
+/* Define to 1 if you have the <sys/types.h> header file. */
+#undef HAVE_SYS_TYPES_H
+
+/* Define to 1 if you have the <unistd.h> header file. */
+#undef HAVE_UNISTD_H
+
+/* Name of package */
+#undef PACKAGE
+
+/* Define to the address where bug reports for this package should be sent. */
+#undef PACKAGE_BUGREPORT
+
+/* Define to the full name of this package. */
+#undef PACKAGE_NAME
+
+/* Define to the full name and version of this package. */
+#undef PACKAGE_STRING
+
+/* Define to the one symbol short name of this package. */
+#undef PACKAGE_TARNAME
+
+/* Define to the version of this package. */
+#undef PACKAGE_VERSION
+
+/* Define to 1 if you have the ANSI C header files. */
+#undef STDC_HEADERS
+
+/* Version number of package */
+#undef VERSION
+
+/* Keyword used by squid for inlining methods */
+#undef _SQUID_INLINE_
+
+/* Include inline methods into header file */
+#undef _USE_INLINE_
+
+/* Define to empty if `const' does not conform to ANSI C. */
+#undef const
+
+/* Define to `unsigned' if <sys/types.h> does not define. */
+#undef size_t
@@ -0,0 +1,1460 @@
+#! /bin/sh
+# Configuration validation subroutine script.
+#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
+#   2000, 2001, 2002 Free Software Foundation, Inc.
+
+timestamp='2002-06-21'
+
+# This file is (in principle) common to ALL GNU software.
+# The presence of a machine in this file suggests that SOME GNU software
+# can handle that machine.  It does not imply ALL GNU software can.
+#
+# This file is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330,
+# Boston, MA 02111-1307, USA.
+
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
+
+# Please send patches to <config-patches@gnu.org>.  Submit a context
+# diff and a properly formatted ChangeLog entry.
+#
+# Configuration subroutine to validate and canonicalize a configuration type.
+# Supply the specified configuration type as an argument.
+# If it is invalid, we print an error message on stderr and exit with code 1.
+# Otherwise, we print the canonical config type on stdout and succeed.
+
+# This file is supposed to be the same for all GNU packages
+# and recognize all the CPU types, system types and aliases
+# that are meaningful with *any* GNU software.
+# Each package is responsible for reporting which valid configurations
+# it does not support.  The user should be able to distinguish
+# a failure to support a valid configuration from a meaningless
+# configuration.
+
+# The goal of this file is to map all the various variations of a given
+# machine specification into a single specification in the form:
+#	CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM
+# or in some cases, the newer four-part form:
+#	CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM
+# It is wrong to echo any other type of specification.
+
+me=`echo "$0" | sed -e 's,.*/,,'`
+
+usage="\
+Usage: $0 [OPTION] CPU-MFR-OPSYS
+       $0 [OPTION] ALIAS
+
+Canonicalize a configuration name.
+
+Operation modes:
+  -h, --help         print this help, then exit
+  -t, --time-stamp   print date of last modification, then exit
+  -v, --version      print version number, then exit
+
+Report bugs and patches to <config-patches@gnu.org>."
+
+version="\
+GNU config.sub ($timestamp)
+
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001
+Free Software Foundation, Inc.
+
+This is free software; see the source for copying conditions.  There is NO
+warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
+
+help="
+Try \`$me --help' for more information."
+
+# Parse command line
+while test $# -gt 0 ; do
+  case $1 in
+    --time-stamp | --time* | -t )
+       echo "$timestamp" ; exit 0 ;;
+    --version | -v )
+       echo "$version" ; exit 0 ;;
+    --help | --h* | -h )
+       echo "$usage"; exit 0 ;;
+    -- )     # Stop option processing
+       shift; break ;;
+    - )	# Use stdin as input.
+       break ;;
+    -* )
+       echo "$me: invalid option $1$help"
+       exit 1 ;;
+
+    *local*)
+       # First pass through any local machine types.
+       echo $1
+       exit 0;;
+
+    * )
+       break ;;
+  esac
+done
+
+case $# in
+ 0) echo "$me: missing argument$help" >&2
+    exit 1;;
+ 1) ;;
+ *) echo "$me: too many arguments$help" >&2
+    exit 1;;
+esac
+
+# Separate what the user gave into CPU-COMPANY and OS or KERNEL-OS (if any).
+# Here we must recognize all the valid KERNEL-OS combinations.
+maybe_os=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\2/'`
+case $maybe_os in
+  nto-qnx* | linux-gnu* | storm-chaos* | os2-emx* | windows32-* | rtmk-nova*)
+    os=-$maybe_os
+    basic_machine=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`
+    ;;
+  *)
+    basic_machine=`echo $1 | sed 's/-[^-]*$//'`
+    if [ $basic_machine != $1 ]
+    then os=`echo $1 | sed 's/.*-/-/'`
+    else os=; fi
+    ;;
+esac
+
+### Let's recognize common machines as not being operating systems so
+### that things like config.sub decstation-3100 work.  We also
+### recognize some manufacturers as not being operating systems, so we
+### can provide default operating systems below.
+case $os in
+	-sun*os*)
+		# Prevent following clause from handling this invalid input.
+		;;
+	-dec* | -mips* | -sequent* | -encore* | -pc532* | -sgi* | -sony* | \
+	-att* | -7300* | -3300* | -delta* | -motorola* | -sun[234]* | \
+	-unicom* | -ibm* | -next | -hp | -isi* | -apollo | -altos* | \
+	-convergent* | -ncr* | -news | -32* | -3600* | -3100* | -hitachi* |\
+	-c[123]* | -convex* | -sun | -crds | -omron* | -dg | -ultra | -tti* | \
+	-harris | -dolphin | -highlevel | -gould | -cbm | -ns | -masscomp | \
+	-apple | -axis)
+		os=
+		basic_machine=$1
+		;;
+	-sim | -cisco | -oki | -wec | -winbond)
+		os=
+		basic_machine=$1
+		;;
+	-scout)
+		;;
+	-wrs)
+		os=-vxworks
+		basic_machine=$1
+		;;
+	-chorusos*)
+		os=-chorusos
+		basic_machine=$1
+		;;
+ 	-chorusrdb)
+ 		os=-chorusrdb
+		basic_machine=$1
+ 		;;
+	-hiux*)
+		os=-hiuxwe2
+		;;
+	-sco5)
+		os=-sco3.2v5
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco4)
+		os=-sco3.2v4
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco3.2.[4-9]*)
+		os=`echo $os | sed -e 's/sco3.2./sco3.2v/'`
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco3.2v[4-9]*)
+		# Don't forget version if it is 3.2v4 or newer.
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco*)
+		os=-sco3.2v2
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-udk*)
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-isc)
+		os=-isc2.2
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-clix*)
+		basic_machine=clipper-intergraph
+		;;
+	-isc*)
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-lynx*)
+		os=-lynxos
+		;;
+	-ptx*)
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-sequent/'`
+		;;
+	-windowsnt*)
+		os=`echo $os | sed -e 's/windowsnt/winnt/'`
+		;;
+	-psos*)
+		os=-psos
+		;;
+	-mint | -mint[0-9]*)
+		basic_machine=m68k-atari
+		os=-mint
+		;;
+esac
+
+# Decode aliases for certain CPU-COMPANY combinations.
+case $basic_machine in
+	# Recognize the basic CPU types without company name.
+	# Some are omitted here because they have special meanings below.
+	1750a | 580 \
+	| a29k \
+	| alpha | alphaev[4-8] | alphaev56 | alphaev6[78] | alphapca5[67] \
+	| alpha64 | alpha64ev[4-8] | alpha64ev56 | alpha64ev6[78] | alpha64pca5[67] \
+	| arc | arm | arm[bl]e | arme[lb] | armv[2345] | armv[345][lb] | avr \
+	| c4x | clipper \
+	| d10v | d30v | dlx | dsp16xx \
+	| fr30 | frv \
+	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
+	| i370 | i860 | i960 | ia64 \
+	| ip2k \
+	| m32r | m68000 | m68k | m88k | mcore \
+	| mips | mipsbe | mipseb | mipsel | mipsle \
+	| mips16 \
+	| mips64 | mips64el \
+	| mips64orion | mips64orionel \
+	| mips64vr4100 | mips64vr4100el \
+	| mips64vr4300 | mips64vr4300el \
+	| mips64vr5000 | mips64vr5000el \
+	| mipsisa32 | mipsisa32el \
+	| mipsisa64 | mipsisa64el \
+	| mipsisa64sb1 | mipsisa64sb1el \
+	| mipstx39 | mipstx39el \
+	| mn10200 | mn10300 \
+	| ns16k | ns32k \
+	| openrisc | or32 \
+	| pdp10 | pdp11 | pj | pjl \
+	| powerpc | powerpc64 | powerpc64le | powerpcle | ppcbe \
+	| pyramid \
+	| sh | sh[1234] | sh3e | sh[34]eb | shbe | shle | sh[1234]le | sh3ele \
+	| sh64 | sh64le \
+	| sparc | sparc64 | sparc86x | sparclet | sparclite | sparcv9 | sparcv9b \
+	| strongarm \
+	| tahoe | thumb | tic80 | tron \
+	| v850 | v850e \
+	| we32k \
+	| x86 | xscale | xstormy16 | xtensa \
+	| z8k)
+		basic_machine=$basic_machine-unknown
+		;;
+	m6811 | m68hc11 | m6812 | m68hc12)
+		# Motorola 68HC11/12.
+		basic_machine=$basic_machine-unknown
+		os=-none
+		;;
+	m88110 | m680[12346]0 | m683?2 | m68360 | m5200 | v70 | w65 | z8k)
+		;;
+
+	# We use `pc' rather than `unknown'
+	# because (1) that's what they normally are, and
+	# (2) the word "unknown" tends to confuse beginning users.
+	i*86 | x86_64)
+	  basic_machine=$basic_machine-pc
+	  ;;
+	# Object if more than one company name word.
+	*-*-*)
+		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
+		exit 1
+		;;
+	# Recognize the basic CPU types with company name.
+	580-* \
+	| a29k-* \
+	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
+	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
+	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* \
+	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
+	| avr-* \
+	| bs2000-* \
+	| c[123]* | c30-* | [cjt]90-* | c54x-* \
+	| clipper-* | cydra-* \
+	| d10v-* | d30v-* | dlx-* \
+	| elxsi-* \
+	| f30[01]-* | f700-* | fr30-* | frv-* | fx80-* \
+	| h8300-* | h8500-* \
+	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
+	| i*86-* | i860-* | i960-* | ia64-* \
+	| ip2k-* \
+	| m32r-* \
+	| m68000-* | m680[012346]0-* | m68360-* | m683?2-* | m68k-* \
+	| m88110-* | m88k-* | mcore-* \
+	| mips-* | mipsbe-* | mipseb-* | mipsel-* | mipsle-* \
+	| mips16-* \
+	| mips64-* | mips64el-* \
+	| mips64orion-* | mips64orionel-* \
+	| mips64vr4100-* | mips64vr4100el-* \
+	| mips64vr4300-* | mips64vr4300el-* \
+	| mips64vr5000-* | mips64vr5000el-* \
+	| mipsisa32-* | mipsisa32el-* \
+	| mipsisa64-* | mipsisa64el-* \
+	| mipsisa64sb1-* | mipsisa64sb1el-* \
+	| mipstx39 | mipstx39el \
+	| none-* | np1-* | ns16k-* | ns32k-* \
+	| orion-* \
+	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
+	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* | ppcbe-* \
+	| pyramid-* \
+	| romp-* | rs6000-* \
+	| sh-* | sh[1234]-* | sh3e-* | sh[34]eb-* | shbe-* \
+	| shle-* | sh[1234]le-* | sh3ele-* | sh64-* | sh64le-* \
+	| sparc-* | sparc64-* | sparc86x-* | sparclet-* | sparclite-* \
+	| sparcv9-* | sparcv9b-* | strongarm-* | sv1-* | sx?-* \
+	| tahoe-* | thumb-* | tic30-* | tic54x-* | tic80-* | tron-* \
+	| v850-* | v850e-* | vax-* \
+	| we32k-* \
+	| x86-* | x86_64-* | xps100-* | xscale-* | xstormy16-* \
+	| xtensa-* \
+	| ymp-* \
+	| z8k-*)
+		;;
+	# Recognize the various machine names and aliases which stand
+	# for a CPU type and a company and sometimes even an OS.
+	386bsd)
+		basic_machine=i386-unknown
+		os=-bsd
+		;;
+	3b1 | 7300 | 7300-att | att-7300 | pc7300 | safari | unixpc)
+		basic_machine=m68000-att
+		;;
+	3b*)
+		basic_machine=we32k-att
+		;;
+	a29khif)
+		basic_machine=a29k-amd
+		os=-udi
+		;;
+	adobe68k)
+		basic_machine=m68010-adobe
+		os=-scout
+		;;
+	alliant | fx80)
+		basic_machine=fx80-alliant
+		;;
+	altos | altos3068)
+		basic_machine=m68k-altos
+		;;
+	am29k)
+		basic_machine=a29k-none
+		os=-bsd
+		;;
+	amdahl)
+		basic_machine=580-amdahl
+		os=-sysv
+		;;
+	amiga | amiga-*)
+		basic_machine=m68k-unknown
+		;;
+	amigaos | amigados)
+		basic_machine=m68k-unknown
+		os=-amigaos
+		;;
+	amigaunix | amix)
+		basic_machine=m68k-unknown
+		os=-sysv4
+		;;
+	apollo68)
+		basic_machine=m68k-apollo
+		os=-sysv
+		;;
+	apollo68bsd)
+		basic_machine=m68k-apollo
+		os=-bsd
+		;;
+	aux)
+		basic_machine=m68k-apple
+		os=-aux
+		;;
+	balance)
+		basic_machine=ns32k-sequent
+		os=-dynix
+		;;
+	c90)
+		basic_machine=c90-cray
+		os=-unicos
+		;;
+	convex-c1)
+		basic_machine=c1-convex
+		os=-bsd
+		;;
+	convex-c2)
+		basic_machine=c2-convex
+		os=-bsd
+		;;
+	convex-c32)
+		basic_machine=c32-convex
+		os=-bsd
+		;;
+	convex-c34)
+		basic_machine=c34-convex
+		os=-bsd
+		;;
+	convex-c38)
+		basic_machine=c38-convex
+		os=-bsd
+		;;
+	cray | j90)
+		basic_machine=j90-cray
+		os=-unicos
+		;;
+	crds | unos)
+		basic_machine=m68k-crds
+		;;
+	cris | cris-* | etrax*)
+		basic_machine=cris-axis
+		;;
+	da30 | da30-*)
+		basic_machine=m68k-da30
+		;;
+	decstation | decstation-3100 | pmax | pmax-* | pmin | dec3100 | decstatn)
+		basic_machine=mips-dec
+		;;
+	decsystem10* | dec10*)
+		basic_machine=pdp10-dec
+		os=-tops10
+		;;
+	decsystem20* | dec20*)
+		basic_machine=pdp10-dec
+		os=-tops20
+		;;
+	delta | 3300 | motorola-3300 | motorola-delta \
+	      | 3300-motorola | delta-motorola)
+		basic_machine=m68k-motorola
+		;;
+	delta88)
+		basic_machine=m88k-motorola
+		os=-sysv3
+		;;
+	dpx20 | dpx20-*)
+		basic_machine=rs6000-bull
+		os=-bosx
+		;;
+	dpx2* | dpx2*-bull)
+		basic_machine=m68k-bull
+		os=-sysv3
+		;;
+	ebmon29k)
+		basic_machine=a29k-amd
+		os=-ebmon
+		;;
+	elxsi)
+		basic_machine=elxsi-elxsi
+		os=-bsd
+		;;
+	encore | umax | mmax)
+		basic_machine=ns32k-encore
+		;;
+	es1800 | OSE68k | ose68k | ose | OSE)
+		basic_machine=m68k-ericsson
+		os=-ose
+		;;
+	fx2800)
+		basic_machine=i860-alliant
+		;;
+	genix)
+		basic_machine=ns32k-ns
+		;;
+	gmicro)
+		basic_machine=tron-gmicro
+		os=-sysv
+		;;
+	go32)
+		basic_machine=i386-pc
+		os=-go32
+		;;
+	h3050r* | hiux*)
+		basic_machine=hppa1.1-hitachi
+		os=-hiuxwe2
+		;;
+	h8300hms)
+		basic_machine=h8300-hitachi
+		os=-hms
+		;;
+	h8300xray)
+		basic_machine=h8300-hitachi
+		os=-xray
+		;;
+	h8500hms)
+		basic_machine=h8500-hitachi
+		os=-hms
+		;;
+	harris)
+		basic_machine=m88k-harris
+		os=-sysv3
+		;;
+	hp300-*)
+		basic_machine=m68k-hp
+		;;
+	hp300bsd)
+		basic_machine=m68k-hp
+		os=-bsd
+		;;
+	hp300hpux)
+		basic_machine=m68k-hp
+		os=-hpux
+		;;
+	hp3k9[0-9][0-9] | hp9[0-9][0-9])
+		basic_machine=hppa1.0-hp
+		;;
+	hp9k2[0-9][0-9] | hp9k31[0-9])
+		basic_machine=m68000-hp
+		;;
+	hp9k3[2-9][0-9])
+		basic_machine=m68k-hp
+		;;
+	hp9k6[0-9][0-9] | hp6[0-9][0-9])
+		basic_machine=hppa1.0-hp
+		;;
+	hp9k7[0-79][0-9] | hp7[0-79][0-9])
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k78[0-9] | hp78[0-9])
+		# FIXME: really hppa2.0-hp
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k8[67]1 | hp8[67]1 | hp9k80[24] | hp80[24] | hp9k8[78]9 | hp8[78]9 | hp9k893 | hp893)
+		# FIXME: really hppa2.0-hp
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k8[0-9][13679] | hp8[0-9][13679])
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k8[0-9][0-9] | hp8[0-9][0-9])
+		basic_machine=hppa1.0-hp
+		;;
+	hppa-next)
+		os=-nextstep3
+		;;
+	hppaosf)
+		basic_machine=hppa1.1-hp
+		os=-osf
+		;;
+	hppro)
+		basic_machine=hppa1.1-hp
+		os=-proelf
+		;;
+	i370-ibm* | ibm*)
+		basic_machine=i370-ibm
+		;;
+# I'm not sure what "Sysv32" means.  Should this be sysv3.2?
+	i*86v32)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-sysv32
+		;;
+	i*86v4*)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-sysv4
+		;;
+	i*86v)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-sysv
+		;;
+	i*86sol2)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-solaris2
+		;;
+	i386mach)
+		basic_machine=i386-mach
+		os=-mach
+		;;
+	i386-vsta | vsta)
+		basic_machine=i386-unknown
+		os=-vsta
+		;;
+	iris | iris4d)
+		basic_machine=mips-sgi
+		case $os in
+		    -irix*)
+			;;
+		    *)
+			os=-irix4
+			;;
+		esac
+		;;
+	isi68 | isi)
+		basic_machine=m68k-isi
+		os=-sysv
+		;;
+	m88k-omron*)
+		basic_machine=m88k-omron
+		;;
+	magnum | m3230)
+		basic_machine=mips-mips
+		os=-sysv
+		;;
+	merlin)
+		basic_machine=ns32k-utek
+		os=-sysv
+		;;
+	mingw32)
+		basic_machine=i386-pc
+		os=-mingw32
+		;;
+	miniframe)
+		basic_machine=m68000-convergent
+		;;
+	*mint | -mint[0-9]* | *MiNT | *MiNT[0-9]*)
+		basic_machine=m68k-atari
+		os=-mint
+		;;
+	mips3*-*)
+		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`
+		;;
+	mips3*)
+		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`-unknown
+		;;
+	mmix*)
+		basic_machine=mmix-knuth
+		os=-mmixware
+		;;
+	monitor)
+		basic_machine=m68k-rom68k
+		os=-coff
+		;;
+	morphos)
+		basic_machine=powerpc-unknown
+		os=-morphos
+		;;
+	msdos)
+		basic_machine=i386-pc
+		os=-msdos
+		;;
+	mvs)
+		basic_machine=i370-ibm
+		os=-mvs
+		;;
+	ncr3000)
+		basic_machine=i486-ncr
+		os=-sysv4
+		;;
+	netbsd386)
+		basic_machine=i386-unknown
+		os=-netbsd
+		;;
+	netwinder)
+		basic_machine=armv4l-rebel
+		os=-linux
+		;;
+	news | news700 | news800 | news900)
+		basic_machine=m68k-sony
+		os=-newsos
+		;;
+	news1000)
+		basic_machine=m68030-sony
+		os=-newsos
+		;;
+	news-3600 | risc-news)
+		basic_machine=mips-sony
+		os=-newsos
+		;;
+	necv70)
+		basic_machine=v70-nec
+		os=-sysv
+		;;
+	next | m*-next )
+		basic_machine=m68k-next
+		case $os in
+		    -nextstep* )
+			;;
+		    -ns2*)
+		      os=-nextstep2
+			;;
+		    *)
+		      os=-nextstep3
+			;;
+		esac
+		;;
+	nh3000)
+		basic_machine=m68k-harris
+		os=-cxux
+		;;
+	nh[45]000)
+		basic_machine=m88k-harris
+		os=-cxux
+		;;
+	nindy960)
+		basic_machine=i960-intel
+		os=-nindy
+		;;
+	mon960)
+		basic_machine=i960-intel
+		os=-mon960
+		;;
+	nonstopux)
+		basic_machine=mips-compaq
+		os=-nonstopux
+		;;
+	np1)
+		basic_machine=np1-gould
+		;;
+	nsr-tandem)
+		basic_machine=nsr-tandem
+		;;
+	op50n-* | op60c-*)
+		basic_machine=hppa1.1-oki
+		os=-proelf
+		;;
+	or32 | or32-*)
+		basic_machine=or32-unknown
+		os=-coff
+		;;
+	OSE68000 | ose68000)
+		basic_machine=m68000-ericsson
+		os=-ose
+		;;
+	os68k)
+		basic_machine=m68k-none
+		os=-os68k
+		;;
+	pa-hitachi)
+		basic_machine=hppa1.1-hitachi
+		os=-hiuxwe2
+		;;
+	paragon)
+		basic_machine=i860-intel
+		os=-osf
+		;;
+	pbd)
+		basic_machine=sparc-tti
+		;;
+	pbb)
+		basic_machine=m68k-tti
+		;;
+        pc532 | pc532-*)
+		basic_machine=ns32k-pc532
+		;;
+	pentium | p5 | k5 | k6 | nexgen | viac3)
+		basic_machine=i586-pc
+		;;
+	pentiumpro | p6 | 6x86 | athlon)
+		basic_machine=i686-pc
+		;;
+	pentiumii | pentium2)
+		basic_machine=i686-pc
+		;;
+	pentium-* | p5-* | k5-* | k6-* | nexgen-* | viac3-*)
+		basic_machine=i586-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	pentiumpro-* | p6-* | 6x86-* | athlon-*)
+		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	pentiumii-* | pentium2-*)
+		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	pn)
+		basic_machine=pn-gould
+		;;
+	power)	basic_machine=power-ibm
+		;;
+	ppc)	basic_machine=powerpc-unknown
+	        ;;
+	ppc-*)	basic_machine=powerpc-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ppcle | powerpclittle | ppc-le | powerpc-little)
+		basic_machine=powerpcle-unknown
+	        ;;
+	ppcle-* | powerpclittle-*)
+		basic_machine=powerpcle-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ppc64)	basic_machine=powerpc64-unknown
+	        ;;
+	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
+		basic_machine=powerpc64le-unknown
+	        ;;
+	ppc64le-* | powerpc64little-*)
+		basic_machine=powerpc64le-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ps2)
+		basic_machine=i386-ibm
+		;;
+	pw32)
+		basic_machine=i586-unknown
+		os=-pw32
+		;;
+	rom68k)
+		basic_machine=m68k-rom68k
+		os=-coff
+		;;
+	rm[46]00)
+		basic_machine=mips-siemens
+		;;
+	rtpc | rtpc-*)
+		basic_machine=romp-ibm
+		;;
+	s390 | s390-*)
+		basic_machine=s390-ibm
+		;;
+	s390x | s390x-*)
+		basic_machine=s390x-ibm
+		;;
+	sa29200)
+		basic_machine=a29k-amd
+		os=-udi
+		;;
+	sequent)
+		basic_machine=i386-sequent
+		;;
+	sh)
+		basic_machine=sh-hitachi
+		os=-hms
+		;;
+	sparclite-wrs | simso-wrs)
+		basic_machine=sparclite-wrs
+		os=-vxworks
+		;;
+	sps7)
+		basic_machine=m68k-bull
+		os=-sysv2
+		;;
+	spur)
+		basic_machine=spur-unknown
+		;;
+	st2000)
+		basic_machine=m68k-tandem
+		;;
+	stratus)
+		basic_machine=i860-stratus
+		os=-sysv4
+		;;
+	sun2)
+		basic_machine=m68000-sun
+		;;
+	sun2os3)
+		basic_machine=m68000-sun
+		os=-sunos3
+		;;
+	sun2os4)
+		basic_machine=m68000-sun
+		os=-sunos4
+		;;
+	sun3os3)
+		basic_machine=m68k-sun
+		os=-sunos3
+		;;
+	sun3os4)
+		basic_machine=m68k-sun
+		os=-sunos4
+		;;
+	sun4os3)
+		basic_machine=sparc-sun
+		os=-sunos3
+		;;
+	sun4os4)
+		basic_machine=sparc-sun
+		os=-sunos4
+		;;
+	sun4sol2)
+		basic_machine=sparc-sun
+		os=-solaris2
+		;;
+	sun3 | sun3-*)
+		basic_machine=m68k-sun
+		;;
+	sun4)
+		basic_machine=sparc-sun
+		;;
+	sun386 | sun386i | roadrunner)
+		basic_machine=i386-sun
+		;;
+        sv1)
+		basic_machine=sv1-cray
+		os=-unicos
+		;;
+	symmetry)
+		basic_machine=i386-sequent
+		os=-dynix
+		;;
+	t3d)
+		basic_machine=alpha-cray
+		os=-unicos
+		;;
+	t3e)
+		basic_machine=alphaev5-cray
+		os=-unicos
+		;;
+	t90)
+		basic_machine=t90-cray
+		os=-unicos
+		;;
+	tic54x | c54x*)
+		basic_machine=tic54x-unknown
+		os=-coff
+		;;
+	tx39)
+		basic_machine=mipstx39-unknown
+		;;
+	tx39el)
+		basic_machine=mipstx39el-unknown
+		;;
+	toad1)
+		basic_machine=pdp10-xkl
+		os=-tops20
+		;;
+	tower | tower-32)
+		basic_machine=m68k-ncr
+		;;
+	udi29k)
+		basic_machine=a29k-amd
+		os=-udi
+		;;
+	ultra3)
+		basic_machine=a29k-nyu
+		os=-sym1
+		;;
+	v810 | necv810)
+		basic_machine=v810-nec
+		os=-none
+		;;
+	vaxv)
+		basic_machine=vax-dec
+		os=-sysv
+		;;
+	vms)
+		basic_machine=vax-dec
+		os=-vms
+		;;
+	vpp*|vx|vx-*)
+               basic_machine=f301-fujitsu
+               ;;
+	vxworks960)
+		basic_machine=i960-wrs
+		os=-vxworks
+		;;
+	vxworks68)
+		basic_machine=m68k-wrs
+		os=-vxworks
+		;;
+	vxworks29k)
+		basic_machine=a29k-wrs
+		os=-vxworks
+		;;
+	w65*)
+		basic_machine=w65-wdc
+		os=-none
+		;;
+	w89k-*)
+		basic_machine=hppa1.1-winbond
+		os=-proelf
+		;;
+	windows32)
+		basic_machine=i386-pc
+		os=-windows32-msvcrt
+		;;
+        xps | xps100)
+		basic_machine=xps100-honeywell
+		;;
+	ymp)
+		basic_machine=ymp-cray
+		os=-unicos
+		;;
+	z8k-*-coff)
+		basic_machine=z8k-unknown
+		os=-sim
+		;;
+	none)
+		basic_machine=none-none
+		os=-none
+		;;
+
+# Here we handle the default manufacturer of certain CPU types.  It is in
+# some cases the only manufacturer, in others, it is the most popular.
+	w89k)
+		basic_machine=hppa1.1-winbond
+		;;
+	op50n)
+		basic_machine=hppa1.1-oki
+		;;
+	op60c)
+		basic_machine=hppa1.1-oki
+		;;
+	romp)
+		basic_machine=romp-ibm
+		;;
+	rs6000)
+		basic_machine=rs6000-ibm
+		;;
+	vax)
+		basic_machine=vax-dec
+		;;
+	pdp10)
+		# there are many clones, so DEC is not a safe bet
+		basic_machine=pdp10-unknown
+		;;
+	pdp11)
+		basic_machine=pdp11-dec
+		;;
+	we32k)
+		basic_machine=we32k-att
+		;;
+	sh3 | sh4 | sh3eb | sh4eb | sh[1234]le | sh3ele)
+		basic_machine=sh-unknown
+		;;
+	sh64)
+		basic_machine=sh64-unknown
+		;;
+	sparc | sparcv9 | sparcv9b)
+		basic_machine=sparc-sun
+		;;
+        cydra)
+		basic_machine=cydra-cydrome
+		;;
+	orion)
+		basic_machine=orion-highlevel
+		;;
+	orion105)
+		basic_machine=clipper-highlevel
+		;;
+	mac | mpw | mac-mpw)
+		basic_machine=m68k-apple
+		;;
+	pmac | pmac-mpw)
+		basic_machine=powerpc-apple
+		;;
+	c4x*)
+		basic_machine=c4x-none
+		os=-coff
+		;;
+	*-unknown)
+		# Make sure to match an already-canonicalized machine name.
+		;;
+	*)
+		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
+		exit 1
+		;;
+esac
+
+# Here we canonicalize certain aliases for manufacturers.
+case $basic_machine in
+	*-digital*)
+		basic_machine=`echo $basic_machine | sed 's/digital.*/dec/'`
+		;;
+	*-commodore*)
+		basic_machine=`echo $basic_machine | sed 's/commodore.*/cbm/'`
+		;;
+	*)
+		;;
+esac
+
+# Decode manufacturer-specific aliases for certain operating systems.
+
+if [ x"$os" != x"" ]
+then
+case $os in
+        # First match some system type aliases
+        # that might get confused with valid system types.
+	# -solaris* is a basic system type, with this one exception.
+	-solaris1 | -solaris1.*)
+		os=`echo $os | sed -e 's|solaris1|sunos4|'`
+		;;
+	-solaris)
+		os=-solaris2
+		;;
+	-svr4*)
+		os=-sysv4
+		;;
+	-unixware*)
+		os=-sysv4.2uw
+		;;
+	-gnu/linux*)
+		os=`echo $os | sed -e 's|gnu/linux|linux-gnu|'`
+		;;
+	# First accept the basic system types.
+	# The portable systems comes first.
+	# Each alternative MUST END IN A *, to match a version number.
+	# -sysv* is not here because it comes later, after sysvr4.
+	-gnu* | -bsd* | -mach* | -minix* | -genix* | -ultrix* | -irix* \
+	      | -*vms* | -sco* | -esix* | -isc* | -aix* | -sunos | -sunos[34]*\
+	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -solaris* | -sym* \
+	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
+	      | -aos* \
+	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
+	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
+	      | -hiux* | -386bsd* | -netbsd* | -openbsd* | -freebsd* | -riscix* \
+	      | -lynxos* | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
+	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
+	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
+	      | -chorusos* | -chorusrdb* \
+	      | -cygwin* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
+	      | -mingw32* | -linux-gnu* | -uxpv* | -beos* | -mpeix* | -udk* \
+	      | -interix* | -uwin* | -rhapsody* | -darwin* | -opened* \
+	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
+	      | -storm-chaos* | -tops10* | -tenex* | -tops20* | -its* \
+	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
+	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* | -powermax*)
+	# Remember, each alternative MUST END IN *, to match a version number.
+		;;
+	-qnx*)
+		case $basic_machine in
+		    x86-* | i*86-*)
+			;;
+		    *)
+			os=-nto$os
+			;;
+		esac
+		;;
+	-nto*)
+		os=-nto-qnx
+		;;
+	-sim | -es1800* | -hms* | -xray | -os68k* | -none* | -v88r* \
+	      | -windows* | -osx | -abug | -netware* | -os9* | -beos* \
+	      | -macos* | -mpw* | -magic* | -mmixware* | -mon960* | -lnews*)
+		;;
+	-mac*)
+		os=`echo $os | sed -e 's|mac|macos|'`
+		;;
+	-linux*)
+		os=`echo $os | sed -e 's|linux|linux-gnu|'`
+		;;
+	-sunos5*)
+		os=`echo $os | sed -e 's|sunos5|solaris2|'`
+		;;
+	-sunos6*)
+		os=`echo $os | sed -e 's|sunos6|solaris3|'`
+		;;
+	-opened*)
+		os=-openedition
+		;;
+	-wince*)
+		os=-wince
+		;;
+	-osfrose*)
+		os=-osfrose
+		;;
+	-osf*)
+		os=-osf
+		;;
+	-utek*)
+		os=-bsd
+		;;
+	-dynix*)
+		os=-bsd
+		;;
+	-acis*)
+		os=-aos
+		;;
+	-atheos*)
+		os=-atheos
+		;;
+	-386bsd)
+		os=-bsd
+		;;
+	-ctix* | -uts*)
+		os=-sysv
+		;;
+	-nova*)
+		os=-rtmk-nova
+		;;
+	-ns2 )
+	        os=-nextstep2
+		;;
+	-nsk*)
+		os=-nsk
+		;;
+	# Preserve the version number of sinix5.
+	-sinix5.*)
+		os=`echo $os | sed -e 's|sinix|sysv|'`
+		;;
+	-sinix*)
+		os=-sysv4
+		;;
+	-triton*)
+		os=-sysv3
+		;;
+	-oss*)
+		os=-sysv3
+		;;
+	-svr4)
+		os=-sysv4
+		;;
+	-svr3)
+		os=-sysv3
+		;;
+	-sysvr4)
+		os=-sysv4
+		;;
+	# This must come after -sysvr4.
+	-sysv*)
+		;;
+	-ose*)
+		os=-ose
+		;;
+	-es1800*)
+		os=-ose
+		;;
+	-xenix)
+		os=-xenix
+		;;
+        -*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
+	        os=-mint
+		;;
+	-none)
+		;;
+	*)
+		# Get rid of the `-' at the beginning of $os.
+		os=`echo $os | sed 's/[^-]*-//'`
+		echo Invalid configuration \`$1\': system \`$os\' not recognized 1>&2
+		exit 1
+		;;
+esac
+else
+
+# Here we handle the default operating systems that come with various machines.
+# The value should be what the vendor currently ships out the door with their
+# machine or put another way, the most popular os provided with the machine.
+
+# Note that if you're going to try to match "-MANUFACTURER" here (say,
+# "-sun"), then you have to tell the case statement up towards the top
+# that MANUFACTURER isn't an operating system.  Otherwise, code above
+# will signal an error saying that MANUFACTURER isn't an operating
+# system, and we'll never get to this point.
+
+case $basic_machine in
+	*-acorn)
+		os=-riscix1.2
+		;;
+	arm*-rebel)
+		os=-linux
+		;;
+	arm*-semi)
+		os=-aout
+		;;
+	# This must come before the *-dec entry.
+	pdp10-*)
+		os=-tops20
+		;;
+        pdp11-*)
+		os=-none
+		;;
+	*-dec | vax-*)
+		os=-ultrix4.2
+		;;
+	m68*-apollo)
+		os=-domain
+		;;
+	i386-sun)
+		os=-sunos4.0.2
+		;;
+	m68000-sun)
+		os=-sunos3
+		# This also exists in the configure program, but was not the
+		# default.
+		# os=-sunos4
+		;;
+	m68*-cisco)
+		os=-aout
+		;;
+	mips*-cisco)
+		os=-elf
+		;;
+	mips*-*)
+		os=-elf
+		;;
+	or32-*)
+		os=-coff
+		;;
+	*-tti)	# must be before sparc entry or we get the wrong os.
+		os=-sysv3
+		;;
+	sparc-* | *-sun)
+		os=-sunos4.1.1
+		;;
+	*-be)
+		os=-beos
+		;;
+	*-ibm)
+		os=-aix
+		;;
+	*-wec)
+		os=-proelf
+		;;
+	*-winbond)
+		os=-proelf
+		;;
+	*-oki)
+		os=-proelf
+		;;
+	*-hp)
+		os=-hpux
+		;;
+	*-hitachi)
+		os=-hiux
+		;;
+	i860-* | *-att | *-ncr | *-altos | *-motorola | *-convergent)
+		os=-sysv
+		;;
+	*-cbm)
+		os=-amigaos
+		;;
+	*-dg)
+		os=-dgux
+		;;
+	*-dolphin)
+		os=-sysv3
+		;;
+	m68k-ccur)
+		os=-rtu
+		;;
+	m88k-omron*)
+		os=-luna
+		;;
+	*-next )
+		os=-nextstep
+		;;
+	*-sequent)
+		os=-ptx
+		;;
+	*-crds)
+		os=-unos
+		;;
+	*-ns)
+		os=-genix
+		;;
+	i370-*)
+		os=-mvs
+		;;
+	*-next)
+		os=-nextstep3
+		;;
+        *-gould)
+		os=-sysv
+		;;
+        *-highlevel)
+		os=-bsd
+		;;
+	*-encore)
+		os=-bsd
+		;;
+        *-sgi)
+		os=-irix
+		;;
+        *-siemens)
+		os=-sysv4
+		;;
+	*-masscomp)
+		os=-rtu
+		;;
+	f30[01]-fujitsu | f700-fujitsu)
+		os=-uxpv
+		;;
+	*-rom68k)
+		os=-coff
+		;;
+	*-*bug)
+		os=-coff
+		;;
+	*-apple)
+		os=-macos
+		;;
+	*-atari*)
+		os=-mint
+		;;
+	*)
+		os=-none
+		;;
+esac
+fi
+
+# Here we handle the case where we know the os, and the CPU type, but not the
+# manufacturer.  We pick the logical manufacturer.
+vendor=unknown
+case $basic_machine in
+	*-unknown)
+		case $os in
+			-riscix*)
+				vendor=acorn
+				;;
+			-sunos*)
+				vendor=sun
+				;;
+			-aix*)
+				vendor=ibm
+				;;
+			-beos*)
+				vendor=be
+				;;
+			-hpux*)
+				vendor=hp
+				;;
+			-mpeix*)
+				vendor=hp
+				;;
+			-hiux*)
+				vendor=hitachi
+				;;
+			-unos*)
+				vendor=crds
+				;;
+			-dgux*)
+				vendor=dg
+				;;
+			-luna*)
+				vendor=omron
+				;;
+			-genix*)
+				vendor=ns
+				;;
+			-mvs* | -opened*)
+				vendor=ibm
+				;;
+			-ptx*)
+				vendor=sequent
+				;;
+			-vxsim* | -vxworks* | -windiss*)
+				vendor=wrs
+				;;
+			-aux*)
+				vendor=apple
+				;;
+			-hms*)
+				vendor=hitachi
+				;;
+			-mpw* | -macos*)
+				vendor=apple
+				;;
+			-*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
+				vendor=atari
+				;;
+			-vos*)
+				vendor=stratus
+				;;
+		esac
+		basic_machine=`echo $basic_machine | sed "s/unknown/$vendor/"`
+		;;
+esac
+
+echo $basic_machine$os
+exit 0
+
+# Local variables:
+# eval: (add-hook 'write-file-hooks 'time-stamp)
+# time-stamp-start: "timestamp='"
+# time-stamp-format: "%:y-%02m-%02d"
+# time-stamp-end: "'"
+# End:
@@ -0,0 +1,50 @@
+# Process this file with autoconf to produce a configure script.
+AC_INIT(libTrie, 0.1, rbtcollins@squid-cache.org)
+AC_CONFIG_SRCDIR([src/Trie.cc])
+AM_CONFIG_HEADER([config.h])
+
+SquidInline="yes"
+AC_ARG_ENABLE(inline,
+[  --disable-inline        Don't compile trivial methods as inline. Squid
+                            is coded with much of the code able to be inlined.<                             Inlining is good for production builds, but not
+                            good for development. During development, use
+                            --disable-inline to reduce compilation times and
+                            allow incremental builds to be quick. For
+                            production builds, or load tests, use
+                            --enable-inline to have squid make all trivial
+                            methods inlinable by the compiler.],
+[ if test "$enableval" = "no" ; then
+     SquidInline="no"
+   fi
+])
+
+if test "$SquidInline" = "yes" ; then
+    AC_DEFINE(_SQUID_INLINE_, inline, [Keyword used by squid for inlining methods])
+    AC_DEFINE(_USE_INLINE_,, [Include inline methods into header file])
+else
+    AC_DEFINE(_SQUID_INLINE_,, [Keyword used by squid for inlining methods])
+fi
+
+# Checks for programs.
+AC_PROG_CXX
+AC_PROG_CC
+AC_PROG_MAKE_SET
+AM_INIT_AUTOMAKE
+AM_MAINTAINER_MODE
+AC_PROG_RANLIB
+
+# Checks for libraries.
+
+# Checks for header files.
+
+# Checks for typedefs, structures, and compiler characteristics.
+AC_C_CONST
+AC_TYPE_SIZE_T
+
+# Checks for library functions.
+
+AC_CONFIG_FILES([Makefile
+		include/Makefile
+                 src/Makefile
+		 test/Makefile])
+AC_OUTPUT
@@ -0,0 +1,423 @@
+#! /bin/sh
+
+# depcomp - compile a program generating dependencies as side-effects
+# Copyright 1999, 2000 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
+
+# Originally written by Alexandre Oliva <oliva@dcc.unicamp.br>.
+
+if test -z "$depmode" || test -z "$source" || test -z "$object"; then
+  echo "depcomp: Variables source, object and depmode must be set" 1>&2
+  exit 1
+fi
+# `libtool' can also be set to `yes' or `no'.
+
+if test -z "$depfile"; then
+   base=`echo "$object" | sed -e 's,^.*/,,' -e 's,\.\([^.]*\)$,.P\1,'`
+   dir=`echo "$object" | sed 's,/.*$,/,'`
+   if test "$dir" = "$object"; then
+      dir=
+   fi
+   # FIXME: should be _deps on DOS.
+   depfile="$dir.deps/$base"
+fi
+
+tmpdepfile=${tmpdepfile-`echo "$depfile" | sed 's/\.\([^.]*\)$/.T\1/'`}
+
+rm -f "$tmpdepfile"
+
+# Some modes work just like other modes, but use different flags.  We
+# parameterize here, but still list the modes in the big case below,
+# to make depend.m4 easier to write.  Note that we *cannot* use a case
+# here, because this file can only contain one case statement.
+if test "$depmode" = hp; then
+  # HP compiler uses -M and no extra arg.
+  gccflag=-M
+  depmode=gcc
+fi
+
+if test "$depmode" = dashXmstdout; then
+   # This is just like dashmstdout with a different argument.
+   dashmflag=-xM
+   depmode=dashmstdout
+fi
+
+case "$depmode" in
+gcc3)
+## gcc 3 implements dependency tracking that does exactly what
+## we want.  Yay!  Note: for some reason libtool 1.4 doesn't like
+## it if -MD -MP comes after the -MF stuff.  Hmm.
+  "$@" -MT "$object" -MD -MP -MF "$tmpdepfile"
+  stat=$?
+  if test $stat -eq 0; then :
+  else
+    rm -f "$tmpdepfile"
+    exit $stat
+  fi
+  mv "$tmpdepfile" "$depfile"
+  ;;
+
+gcc)
+## There are various ways to get dependency output from gcc.  Here's
+## why we pick this rather obscure method:
+## - Don't want to use -MD because we'd like the dependencies to end
+##   up in a subdir.  Having to rename by hand is ugly.
+##   (We might end up doing this anyway to support other compilers.)
+## - The DEPENDENCIES_OUTPUT environment variable makes gcc act like
+##   -MM, not -M (despite what the docs say).
+## - Using -M directly means running the compiler twice (even worse
+##   than renaming).
+  if test -z "$gccflag"; then
+    gccflag=-MD,
+  fi
+  "$@" -Wp,"$gccflag$tmpdepfile"
+  stat=$?
+  if test $stat -eq 0; then :
+  else
+    rm -f "$tmpdepfile"
+    exit $stat
+  fi
+  rm -f "$depfile"
+  echo "$object : \\" > "$depfile"
+  alpha=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
+## The second -e expression handles DOS-style file names with drive letters.
+  sed -e 's/^[^:]*: / /' \
+      -e 's/^['$alpha']:\/[^:]*: / /' < "$tmpdepfile" >> "$depfile"
+## This next piece of magic avoids the `deleted header file' problem.
+## The problem is that when a header file which appears in a .P file
+## is deleted, the dependency causes make to die (because there is
+## typically no way to rebuild the header).  We avoid this by adding
+## dummy dependencies for each header file.  Too bad gcc doesn't do
+## this for us directly.
+  tr ' ' '
+' < "$tmpdepfile" |
+## Some versions of gcc put a space before the `:'.  On the theory
+## that the space means something, we add a space to the output as
+## well.
+## Some versions of the HPUX 10.20 sed can't process this invocation
+## correctly.  Breaking it into two sed invocations is a workaround.
+    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
+  rm -f "$tmpdepfile"
+  ;;
+
+hp)
+  # This case exists only to let depend.m4 do its work.  It works by
+  # looking at the text of this script.  This case will never be run,
+  # since it is checked for above.
+  exit 1
+  ;;
+
+sgi)
+  if test "$libtool" = yes; then
+    "$@" "-Wp,-MDupdate,$tmpdepfile"
+  else
+    "$@" -MDupdate "$tmpdepfile"
+  fi
+  stat=$?
+  if test $stat -eq 0; then :
+  else
+    rm -f "$tmpdepfile"
+    exit $stat
+  fi
+  rm -f "$depfile"
+
+  if test -f "$tmpdepfile"; then  # yes, the sourcefile depend on other files
+    echo "$object : \\" > "$depfile"
+
+    # Clip off the initial element (the dependent).  Don't try to be
+    # clever and replace this with sed code, as IRIX sed won't handle
+    # lines with more than a fixed number of characters (4096 in
+    # IRIX 6.2 sed, 8192 in IRIX 6.5).  We also remove comment lines;
+    # the IRIX cc adds comments like `#:fec' to the end of the
+    # dependency line.
+    tr ' ' '
+' < "$tmpdepfile" \
+    | sed -e 's/^.*\.o://' -e 's/#.*$//' -e '/^$/ d' | \
+    tr '
+' ' ' >> $depfile
+    echo >> $depfile
+
+    # The second pass generates a dummy entry for each header file.
+    tr ' ' '
+' < "$tmpdepfile" \
+   | sed -e 's/^.*\.o://' -e 's/#.*$//' -e '/^$/ d' -e 's/$/:/' \
+   >> $depfile
+  else
+    # The sourcefile does not contain any dependencies, so just
+    # store a dummy comment line, to avoid errors with the Makefile
+    # "include basename.Plo" scheme.
+    echo "#dummy" > "$depfile"
+  fi
+  rm -f "$tmpdepfile"
+  ;;
+
+aix)
+  # The C for AIX Compiler uses -M and outputs the dependencies
+  # in a .u file.  This file always lives in the current directory.
+  # Also, the AIX compiler puts `$object:' at the start of each line;
+  # $object doesn't have directory information.
+  stripped=`echo "$object" | sed -e 's,^.*/,,' -e 's/\(.*\)\..*$/\1/'`
+  tmpdepfile="$stripped.u"
+  outname="$stripped.o"
+  if test "$libtool" = yes; then
+    "$@" -Wc,-M
+  else
+    "$@" -M
+  fi
+
+  stat=$?
+  if test $stat -eq 0; then :
+  else
+    rm -f "$tmpdepfile"
+    exit $stat
+  fi
+
+  if test -f "$tmpdepfile"; then
+    # Each line is of the form `foo.o: dependent.h'.
+    # Do two passes, one to just change these to
+    # `$object: dependent.h' and one to simply `dependent.h:'.
+    sed -e "s,^$outname:,$object :," < "$tmpdepfile" > "$depfile"
+    sed -e "s,^$outname: \(.*\)$,\1:," < "$tmpdepfile" >> "$depfile"
+  else
+    # The sourcefile does not contain any dependencies, so just
+    # store a dummy comment line, to avoid errors with the Makefile
+    # "include basename.Plo" scheme.
+    echo "#dummy" > "$depfile"
+  fi
+  rm -f "$tmpdepfile"
+  ;;
+
+tru64)
+   # The Tru64 compiler uses -MD to generate dependencies as a side
+   # effect.  `cc -MD -o foo.o ...' puts the dependencies into `foo.o.d'.
+   # At least on Alpha/Redhat 6.1, Compaq CCC V6.2-504 seems to put
+   # dependencies in `foo.d' instead, so we check for that too.
+   # Subdirectories are respected.
+   dir=`echo "$object" | sed -e 's|/[^/]*$|/|'`
+   test "x$dir" = "x$object" && dir=
+   base=`echo "$object" | sed -e 's|^.*/||' -e 's/\.o$//' -e 's/\.lo$//'`
+
+   if test "$libtool" = yes; then
+      tmpdepfile1="$dir.libs/$base.lo.d"
+      tmpdepfile2="$dir.libs/$base.d"
+      "$@" -Wc,-MD
+   else
+      tmpdepfile1="$dir$base.o.d"
+      tmpdepfile2="$dir$base.d"
+      "$@" -MD
+   fi
+
+   stat=$?
+   if test $stat -eq 0; then :
+   else
+      rm -f "$tmpdepfile1" "$tmpdepfile2"
+      exit $stat
+   fi
+
+   if test -f "$tmpdepfile1"; then
+      tmpdepfile="$tmpdepfile1"
+   else
+      tmpdepfile="$tmpdepfile2"
+   fi
+   if test -f "$tmpdepfile"; then
+      sed -e "s,^.*\.[a-z]*:,$object:," < "$tmpdepfile" > "$depfile"
+      # That's a space and a tab in the [].
+      sed -e 's,^.*\.[a-z]*:[ 	]*,,' -e 's,$,:,' < "$tmpdepfile" >> "$depfile"
+   else
+      echo "#dummy" > "$depfile"
+   fi
+   rm -f "$tmpdepfile"
+   ;;
+
+#nosideeffect)
+  # This comment above is used by automake to tell side-effect
+  # dependency tracking mechanisms from slower ones.
+
+dashmstdout)
+  # Important note: in order to support this mode, a compiler *must*
+  # always write the proprocessed file to stdout, regardless of -o.
+  "$@" || exit $?
+
+  # Remove the call to Libtool.
+  if test "$libtool" = yes; then
+    while test $1 != '--mode=compile'; do
+      shift
+    done
+    shift
+  fi
+
+  # Remove `-o $object'.  We will use -o /dev/null later,
+  # however we can't do the remplacement now because
+  # `-o $object' might simply not be used
+  IFS=" "
+  for arg
+  do
+    case $arg in
+    -o)
+      shift
+      ;;
+    $object)
+      shift
+      ;;
+    *)
+      set fnord "$@" "$arg"
+      shift # fnord
+      shift # $arg
+      ;;
+    esac
+  done
+
+  test -z "$dashmflag" && dashmflag=-M
+  "$@" -o /dev/null $dashmflag | sed 's:^[^:]*\:[ 	]*:'"$object"'\: :' > "$tmpdepfile"
+  rm -f "$depfile"
+  cat < "$tmpdepfile" > "$depfile"
+  tr ' ' '
+' < "$tmpdepfile" | \
+## Some versions of the HPUX 10.20 sed can't process this invocation
+## correctly.  Breaking it into two sed invocations is a workaround.
+    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
+  rm -f "$tmpdepfile"
+  ;;
+
+dashXmstdout)
+  # This case only exists to satisfy depend.m4.  It is never actually
+  # run, as this mode is specially recognized in the preamble.
+  exit 1
+  ;;
+
+makedepend)
+  "$@" || exit $?
+  # X makedepend
+  shift
+  cleared=no
+  for arg in "$@"; do
+    case $cleared in
+    no)
+      set ""; shift
+      cleared=yes ;;
+    esac
+    case "$arg" in
+    -D*|-I*)
+      set fnord "$@" "$arg"; shift ;;
+    -*)
+      ;;
+    *)
+      set fnord "$@" "$arg"; shift ;;
+    esac
+  done
+  obj_suffix="`echo $object | sed 's/^.*\././'`"
+  touch "$tmpdepfile"
+  ${MAKEDEPEND-makedepend} -o"$obj_suffix" -f"$tmpdepfile" "$@"
+  rm -f "$depfile"
+  cat < "$tmpdepfile" > "$depfile"
+  sed '1,2d' "$tmpdepfile" | tr ' ' '
+' | \
+## Some versions of the HPUX 10.20 sed can't process this invocation
+## correctly.  Breaking it into two sed invocations is a workaround.
+    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
+  rm -f "$tmpdepfile" "$tmpdepfile".bak
+  ;;
+
+cpp)
+  # Important note: in order to support this mode, a compiler *must*
+  # always write the proprocessed file to stdout.
+  "$@" || exit $?
+
+  # Remove the call to Libtool.
+  if test "$libtool" = yes; then
+    while test $1 != '--mode=compile'; do
+      shift
+    done
+    shift
+  fi
+
+  # Remove `-o $object'.
+  IFS=" "
+  for arg
+  do
+    case $arg in
+    -o)
+      shift
+      ;;
+    $object)
+      shift
+      ;;
+    *)
+      set fnord "$@" "$arg"
+      shift # fnord
+      shift # $arg
+      ;;
+    esac
+  done
+
+  "$@" -E |
+    sed -n '/^# [0-9][0-9]* "\([^"]*\)".*/ s:: \1 \\:p' |
+    sed '$ s: \\$::' > "$tmpdepfile"
+  rm -f "$depfile"
+  echo "$object : \\" > "$depfile"
+  cat < "$tmpdepfile" >> "$depfile"
+  sed < "$tmpdepfile" '/^$/d;s/^ //;s/ \\$//;s/$/ :/' >> "$depfile"
+  rm -f "$tmpdepfile"
+  ;;
+
+msvisualcpp)
+  # Important note: in order to support this mode, a compiler *must*
+  # always write the proprocessed file to stdout, regardless of -o,
+  # because we must use -o when running libtool.
+  "$@" || exit $?
+  IFS=" "
+  for arg
+  do
+    case "$arg" in
+    "-Gm"|"/Gm"|"-Gi"|"/Gi"|"-ZI"|"/ZI")
+	set fnord "$@"
+	shift
+	shift
+	;;
+    *)
+	set fnord "$@" "$arg"
+	shift
+	shift
+	;;
+    esac
+  done
+  "$@" -E |
+  sed -n '/^#line [0-9][0-9]* "\([^"]*\)"/ s::echo "`cygpath -u \\"\1\\"`":p' | sort | uniq > "$tmpdepfile"
+  rm -f "$depfile"
+  echo "$object : \\" > "$depfile"
+  . "$tmpdepfile" | sed 's% %\\ %g' | sed -n '/^\(.*\)$/ s::	\1 \\:p' >> "$depfile"
+  echo "	" >> "$depfile"
+  . "$tmpdepfile" | sed 's% %\\ %g' | sed -n '/^\(.*\)$/ s::\1\::p' >> "$depfile"
+  rm -f "$tmpdepfile"
+  ;;
+
+none)
+  exec "$@"
+  ;;
+
+*)
+  echo "Unknown depmode $depmode" 1>&2
+  exit 1
+  ;;
+esac
+
+exit 0
@@ -0,0 +1 @@
+noinst_HEADERS = Trie.h TrieNode.h
@@ -0,0 +1,237 @@
+# Makefile.in generated by automake 1.6.3 from Makefile.am.
+# @configure_input@
+
+# Copyright 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002
+# Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+@SET_MAKE@
+SHELL = @SHELL@
+
+srcdir = @srcdir@
+top_srcdir = @top_srcdir@
+VPATH = @srcdir@
+prefix = @prefix@
+exec_prefix = @exec_prefix@
+
+bindir = @bindir@
+sbindir = @sbindir@
+libexecdir = @libexecdir@
+datadir = @datadir@
+sysconfdir = @sysconfdir@
+sharedstatedir = @sharedstatedir@
+localstatedir = @localstatedir@
+libdir = @libdir@
+infodir = @infodir@
+mandir = @mandir@
+includedir = @includedir@
+oldincludedir = /usr/include
+pkgdatadir = $(datadir)/@PACKAGE@
+pkglibdir = $(libdir)/@PACKAGE@
+pkgincludedir = $(includedir)/@PACKAGE@
+top_builddir = ..
+
+ACLOCAL = @ACLOCAL@
+AUTOCONF = @AUTOCONF@
+AUTOMAKE = @AUTOMAKE@
+AUTOHEADER = @AUTOHEADER@
+
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+INSTALL = @INSTALL@
+INSTALL_PROGRAM = @INSTALL_PROGRAM@
+INSTALL_DATA = @INSTALL_DATA@
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_SCRIPT = @INSTALL_SCRIPT@
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = @program_transform_name@
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+
+EXEEXT = @EXEEXT@
+OBJEXT = @OBJEXT@
+PATH_SEPARATOR = @PATH_SEPARATOR@
+AMTAR = @AMTAR@
+AWK = @AWK@
+CC = @CC@
+CXX = @CXX@
+DEPDIR = @DEPDIR@
+INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+MAINT = @MAINT@
+PACKAGE = @PACKAGE@
+RANLIB = @RANLIB@
+STRIP = @STRIP@
+VERSION = @VERSION@
+am__include = @am__include@
+am__quote = @am__quote@
+install_sh = @install_sh@
+noinst_HEADERS = Trie.h TrieNode.h
+subdir = include
+mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+CONFIG_HEADER = $(top_builddir)/config.h
+CONFIG_CLEAN_FILES =
+DIST_SOURCES =
+HEADERS = $(noinst_HEADERS)
+
+DIST_COMMON = $(noinst_HEADERS) Makefile.am Makefile.in
+all: all-am
+
+.SUFFIXES:
+$(srcdir)/Makefile.in: @MAINTAINER_MODE_TRUE@ Makefile.am  $(top_srcdir)/configure.in $(ACLOCAL_M4)
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --gnu  include/Makefile
+Makefile: @MAINTAINER_MODE_TRUE@ $(srcdir)/Makefile.in  $(top_builddir)/config.status
+	cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)
+uninstall-info-am:
+
+ETAGS = etags
+ETAGSFLAGS =
+
+tags: TAGS
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	mkid -fID $$unique
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	test -z "$(ETAGS_ARGS)$$tags$$unique" \
+	  || $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+
+top_distdir = ..
+distdir = $(top_distdir)/$(PACKAGE)-$(VERSION)
+
+distdir: $(DISTFILES)
+	@list='$(DISTFILES)'; for file in $$list; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  dir=`echo "$$file" | sed -e 's,/[^/]*$$,,'`; \
+	  if test "$$dir" != "$$file" && test "$$dir" != "."; then \
+	    dir="/$$dir"; \
+	    $(mkinstalldirs) "$(distdir)$$dir"; \
+	  else \
+	    dir=''; \
+	  fi; \
+	  if test -d $$d/$$file; then \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(HEADERS)
+
+installdirs:
+
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-rm -f Makefile $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic mostlyclean-am
+
+distclean: distclean-am
+
+distclean-am: clean-am distclean-generic distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-exec-am:
+
+install-info: install-info-am
+
+install-man:
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-generic
+
+uninstall-am: uninstall-info-am
+
+.PHONY: GTAGS all all-am check check-am clean clean-generic distclean \
+	distclean-generic distclean-tags distdir dvi dvi-am info \
+	info-am install install-am install-data install-data-am \
+	install-exec install-exec-am install-info install-info-am \
+	install-man install-strip installcheck installcheck-am \
+	installdirs maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-generic tags uninstall uninstall-am \
+	uninstall-info-am
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
@@ -0,0 +1,39 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifdef __cplusplus
+#include "Trie.h"
+#include "TrieNode.h"
+
+void *
+Trie::find (char const *aString, size_t theLength)
+{
+    if (head)
+	return head->find (aString, theLength);
+    return NULL;
+}
+
+void *
+Trie::findPrefix (char const *aString, size_t theLength)
+{
+    if (head)
+	return head->find (aString, theLength, true);
+    return NULL;
+}
+#endif
@@ -0,0 +1,90 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef   LIBTRIE_SQUID_H
+#define   LIBTRIE_SQUID_H
+
+/* This is the header for libTrie.
+ * libTrie provides both C and C++ 
+ * bindings. libtrie itself is written in C++.
+ */
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#if HAVE_SYS_TYPES_H
+#include <sys/types.h>
+#endif
+
+/* C bindings */
+#ifndef   __cplusplus
+
+void *TrieCreate ();
+void TrieDestroy (void *);
+void *TrieFind (void *, char const *, size_t);
+int TrieAdd (void *, char const *, size_t, void *);
+
+/* C++ bindings */
+#else
+
+class TrieNode;
+
+/* TODO: parameterize this to be more generic -
+* i.e. M-ary internal node sizes etc
+*/
+
+class Trie
+{
+
+public:
+    Trie();
+    ~Trie();
+    Trie (Trie const &);
+    Trie &operator= (Trie const &);
+
+    /* Find an exact match in the trie.
+    * If found, return the private data.
+    * If not found, return NULL.
+    */
+    _SQUID_INLINE_ void *find (char const *, size_t);
+    /* find any element of the trie in the buffer from the
+    * beginning thereof
+    */
+    _SQUID_INLINE_ void *findPrefix (char const *, size_t);
+
+    /* Add a string.
+    * returns false if the string is already
+    * present or cannot be added.
+    */
+
+    bool add
+        (char const *, size_t, void *);
+
+private:
+    TrieNode *head;
+};
+
+#endif /* __cplusplus */
+
+#ifdef _USE_INLINE_
+#include "Trie.cci"
+#endif
+
+#endif /* LIBTRIE_SQUID_H */
@@ -0,0 +1,51 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifdef __cplusplus
+#include "TrieNode.h"
+#ifdef HAVE_UNISTD_H
+#include <unistd.h>
+#endif
+#include <ctype.h>
+
+/* recursive. TODO? make iterative */
+void *
+TrieNode::find (char const *aString, size_t theLength, bool prefix) const
+{
+    if (theLength) {
+	int index = -1;
+	if (internal[*aString])
+	    index = *aString;
+	else if (internal[tolower(*aString)])
+	    index = tolower(*aString);
+	if (index > -1) {
+	    void *result;
+	    result = internal[index]->find(aString + 1, theLength - 1, prefix);
+	    if (result)
+		return result;
+	}
+	if (prefix)
+	    return _privateData;
+	return NULL;
+    } else {
+	/* terminal node */
+	return _privateData;
+    }
+}
+#endif
@@ -0,0 +1,88 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef   LIBTRIE_TRIENODE_H
+#define   LIBTRIE_TRIENODE_H
+
+/* This is an internal header for libTrie.
+ * libTrie provides both C and C++ 
+ * bindings. 
+ * libTrie itself is written in C++.
+ * For C bindings see Trei.h
+ */
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+/* C bindings */
+#ifndef   __cplusplus
+
+/* C++ bindings */
+#else
+#include <sys/types.h>
+#include <utility>
+
+/* TODO: parameterize this to be more generic -
+* i.e. M-ary internal node sizes etc
+*/
+
+class TrieNode
+{
+
+public:
+    TrieNode();
+    ~TrieNode();
+    TrieNode(TrieNode const &);
+    TrieNode &operator= (TrieNode const &);
+
+    /* Find a string.
+    * If found, return the private data.
+    * If not found, return NULL.
+    */
+    _SQUID_INLINE_ void *find (char const *, size_t, bool prefix = false) const;
+
+    /* Add a string.
+    * returns false if the string is already
+    * present or can't be added.
+    */
+
+    bool add
+        (char const *, size_t, void *);
+
+private:
+    /* 256-way Trie */
+    /* The char index into internal is an
+    * 8-bit prefix to a string in the trie.
+    * internal[0] is the terminal node for
+    * a string and may not be used
+    */
+    TrieNode * internal[256];
+
+    /* If a string ends here, non NULL */
+    void *_privateData;
+};
+
+#endif /* __cplusplus */
+
+#ifdef _USE_INLINE_
+#include "TrieNode.cci"
+#endif
+
+#endif /* LIBTRIE_TRIENODE_H */
@@ -0,0 +1,251 @@
+#!/bin/sh
+#
+# install - install a program, script, or datafile
+# This comes from X11R5 (mit/util/scripts/install.sh).
+#
+# Copyright 1991 by the Massachusetts Institute of Technology
+#
+# Permission to use, copy, modify, distribute, and sell this software and its
+# documentation for any purpose is hereby granted without fee, provided that
+# the above copyright notice appear in all copies and that both that
+# copyright notice and this permission notice appear in supporting
+# documentation, and that the name of M.I.T. not be used in advertising or
+# publicity pertaining to distribution of the software without specific,
+# written prior permission.  M.I.T. makes no representations about the
+# suitability of this software for any purpose.  It is provided "as is"
+# without express or implied warranty.
+#
+# Calling this script install-sh is preferred over install.sh, to prevent
+# `make' implicit rules from creating a file called install from it
+# when there is no Makefile.
+#
+# This script is compatible with the BSD install script, but was written
+# from scratch.  It can only install one file at a time, a restriction
+# shared with many OS's install programs.
+
+
+# set DOITPROG to echo to test this script
+
+# Don't use :- since 4.3BSD and earlier shells don't like it.
+doit="${DOITPROG-}"
+
+
+# put in absolute paths if you don't have them in your path; or use env. vars.
+
+mvprog="${MVPROG-mv}"
+cpprog="${CPPROG-cp}"
+chmodprog="${CHMODPROG-chmod}"
+chownprog="${CHOWNPROG-chown}"
+chgrpprog="${CHGRPPROG-chgrp}"
+stripprog="${STRIPPROG-strip}"
+rmprog="${RMPROG-rm}"
+mkdirprog="${MKDIRPROG-mkdir}"
+
+transformbasename=""
+transform_arg=""
+instcmd="$mvprog"
+chmodcmd="$chmodprog 0755"
+chowncmd=""
+chgrpcmd=""
+stripcmd=""
+rmcmd="$rmprog -f"
+mvcmd="$mvprog"
+src=""
+dst=""
+dir_arg=""
+
+while [ x"$1" != x ]; do
+    case $1 in
+	-c) instcmd="$cpprog"
+	    shift
+	    continue;;
+
+	-d) dir_arg=true
+	    shift
+	    continue;;
+
+	-m) chmodcmd="$chmodprog $2"
+	    shift
+	    shift
+	    continue;;
+
+	-o) chowncmd="$chownprog $2"
+	    shift
+	    shift
+	    continue;;
+
+	-g) chgrpcmd="$chgrpprog $2"
+	    shift
+	    shift
+	    continue;;
+
+	-s) stripcmd="$stripprog"
+	    shift
+	    continue;;
+
+	-t=*) transformarg=`echo $1 | sed 's/-t=//'`
+	    shift
+	    continue;;
+
+	-b=*) transformbasename=`echo $1 | sed 's/-b=//'`
+	    shift
+	    continue;;
+
+	*)  if [ x"$src" = x ]
+	    then
+		src=$1
+	    else
+		# this colon is to work around a 386BSD /bin/sh bug
+		:
+		dst=$1
+	    fi
+	    shift
+	    continue;;
+    esac
+done
+
+if [ x"$src" = x ]
+then
+	echo "install:	no input file specified"
+	exit 1
+else
+	:
+fi
+
+if [ x"$dir_arg" != x ]; then
+	dst=$src
+	src=""
+	
+	if [ -d $dst ]; then
+		instcmd=:
+		chmodcmd=""
+	else
+		instcmd=$mkdirprog
+	fi
+else
+
+# Waiting for this to be detected by the "$instcmd $src $dsttmp" command
+# might cause directories to be created, which would be especially bad 
+# if $src (and thus $dsttmp) contains '*'.
+
+	if [ -f "$src" ] || [ -d "$src" ]
+	then
+		:
+	else
+		echo "install:  $src does not exist"
+		exit 1
+	fi
+	
+	if [ x"$dst" = x ]
+	then
+		echo "install:	no destination specified"
+		exit 1
+	else
+		:
+	fi
+
+# If destination is a directory, append the input filename; if your system
+# does not like double slashes in filenames, you may need to add some logic
+
+	if [ -d $dst ]
+	then
+		dst="$dst"/`basename $src`
+	else
+		:
+	fi
+fi
+
+## this sed command emulates the dirname command
+dstdir=`echo $dst | sed -e 's,[^/]*$,,;s,/$,,;s,^$,.,'`
+
+# Make sure that the destination directory exists.
+#  this part is taken from Noah Friedman's mkinstalldirs script
+
+# Skip lots of stat calls in the usual case.
+if [ ! -d "$dstdir" ]; then
+defaultIFS='
+	'
+IFS="${IFS-${defaultIFS}}"
+
+oIFS="${IFS}"
+# Some sh's can't handle IFS=/ for some reason.
+IFS='%'
+set - `echo ${dstdir} | sed -e 's@/@%@g' -e 's@^%@/@'`
+IFS="${oIFS}"
+
+pathcomp=''
+
+while [ $# -ne 0 ] ; do
+	pathcomp="${pathcomp}${1}"
+	shift
+
+	if [ ! -d "${pathcomp}" ] ;
+        then
+		$mkdirprog "${pathcomp}"
+	else
+		:
+	fi
+
+	pathcomp="${pathcomp}/"
+done
+fi
+
+if [ x"$dir_arg" != x ]
+then
+	$doit $instcmd $dst &&
+
+	if [ x"$chowncmd" != x ]; then $doit $chowncmd $dst; else : ; fi &&
+	if [ x"$chgrpcmd" != x ]; then $doit $chgrpcmd $dst; else : ; fi &&
+	if [ x"$stripcmd" != x ]; then $doit $stripcmd $dst; else : ; fi &&
+	if [ x"$chmodcmd" != x ]; then $doit $chmodcmd $dst; else : ; fi
+else
+
+# If we're going to rename the final executable, determine the name now.
+
+	if [ x"$transformarg" = x ] 
+	then
+		dstfile=`basename $dst`
+	else
+		dstfile=`basename $dst $transformbasename | 
+			sed $transformarg`$transformbasename
+	fi
+
+# don't allow the sed command to completely eliminate the filename
+
+	if [ x"$dstfile" = x ] 
+	then
+		dstfile=`basename $dst`
+	else
+		:
+	fi
+
+# Make a temp file name in the proper directory.
+
+	dsttmp=$dstdir/#inst.$$#
+
+# Move or copy the file name to the temp name
+
+	$doit $instcmd $src $dsttmp &&
+
+	trap "rm -f ${dsttmp}" 0 &&
+
+# and set any options; do chmod last to preserve setuid bits
+
+# If any of these fail, we abort the whole thing.  If we want to
+# ignore errors from any of these, just make sure not to ignore
+# errors from the above "$doit $instcmd $src $dsttmp" command.
+
+	if [ x"$chowncmd" != x ]; then $doit $chowncmd $dsttmp; else :;fi &&
+	if [ x"$chgrpcmd" != x ]; then $doit $chgrpcmd $dsttmp; else :;fi &&
+	if [ x"$stripcmd" != x ]; then $doit $stripcmd $dsttmp; else :;fi &&
+	if [ x"$chmodcmd" != x ]; then $doit $chmodcmd $dsttmp; else :;fi &&
+
+# Now rename the file to the real destination.
+
+	$doit $rmcmd -f $dstdir/$dstfile &&
+	$doit $mvcmd $dsttmp $dstdir/$dstfile 
+
+fi &&
+
+
+exit 0
@@ -0,0 +1,336 @@
+#! /bin/sh
+# Common stub for a few missing GNU programs while installing.
+# Copyright (C) 1996, 1997, 1999, 2000, 2002 Free Software Foundation, Inc.
+# Originally by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
+
+if test $# -eq 0; then
+  echo 1>&2 "Try \`$0 --help' for more information"
+  exit 1
+fi
+
+run=:
+
+# In the cases where this matters, `missing' is being run in the
+# srcdir already.
+if test -f configure.ac; then
+  configure_ac=configure.ac
+else
+  configure_ac=configure.in
+fi
+
+case "$1" in
+--run)
+  # Try to run requested program, and just exit if it succeeds.
+  run=
+  shift
+  "$@" && exit 0
+  ;;
+esac
+
+# If it does not exist, or fails to run (possibly an outdated version),
+# try to emulate it.
+case "$1" in
+
+  -h|--h|--he|--hel|--help)
+    echo "\
+$0 [OPTION]... PROGRAM [ARGUMENT]...
+
+Handle \`PROGRAM [ARGUMENT]...' for when PROGRAM is missing, or return an
+error status if there is no known handling for PROGRAM.
+
+Options:
+  -h, --help      display this help and exit
+  -v, --version   output version information and exit
+  --run           try to run the given command, and emulate it if it fails
+
+Supported PROGRAM values:
+  aclocal      touch file \`aclocal.m4'
+  autoconf     touch file \`configure'
+  autoheader   touch file \`config.h.in'
+  automake     touch all \`Makefile.in' files
+  bison        create \`y.tab.[ch]', if possible, from existing .[ch]
+  flex         create \`lex.yy.c', if possible, from existing .c
+  help2man     touch the output file
+  lex          create \`lex.yy.c', if possible, from existing .c
+  makeinfo     touch the output file
+  tar          try tar, gnutar, gtar, then tar without non-portable flags
+  yacc         create \`y.tab.[ch]', if possible, from existing .[ch]"
+    ;;
+
+  -v|--v|--ve|--ver|--vers|--versi|--versio|--version)
+    echo "missing 0.4 - GNU automake"
+    ;;
+
+  -*)
+    echo 1>&2 "$0: Unknown \`$1' option"
+    echo 1>&2 "Try \`$0 --help' for more information"
+    exit 1
+    ;;
+
+  aclocal*)
+    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+       # We have it, but it failed.
+       exit 1
+    fi
+
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`acinclude.m4' or \`${configure_ac}'.  You might want
+         to install the \`Automake' and \`Perl' packages.  Grab them from
+         any GNU archive site."
+    touch aclocal.m4
+    ;;
+
+  autoconf)
+    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+       # We have it, but it failed.
+       exit 1
+    fi
+
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`${configure_ac}'.  You might want to install the
+         \`Autoconf' and \`GNU m4' packages.  Grab them from any GNU
+         archive site."
+    touch configure
+    ;;
+
+  autoheader)
+    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+       # We have it, but it failed.
+       exit 1
+    fi
+
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`acconfig.h' or \`${configure_ac}'.  You might want
+         to install the \`Autoconf' and \`GNU m4' packages.  Grab them
+         from any GNU archive site."
+    files=`sed -n 's/^[ ]*A[CM]_CONFIG_HEADER(\([^)]*\)).*/\1/p' ${configure_ac}`
+    test -z "$files" && files="config.h"
+    touch_files=
+    for f in $files; do
+      case "$f" in
+      *:*) touch_files="$touch_files "`echo "$f" |
+				       sed -e 's/^[^:]*://' -e 's/:.*//'`;;
+      *) touch_files="$touch_files $f.in";;
+      esac
+    done
+    touch $touch_files
+    ;;
+
+  automake*)
+    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+       # We have it, but it failed.
+       exit 1
+    fi
+
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`Makefile.am', \`acinclude.m4' or \`${configure_ac}'.
+         You might want to install the \`Automake' and \`Perl' packages.
+         Grab them from any GNU archive site."
+    find . -type f -name Makefile.am -print |
+	   sed 's/\.am$/.in/' |
+	   while read f; do touch "$f"; done
+    ;;
+
+  autom4te)
+    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+       # We have it, but it failed.
+       exit 1
+    fi
+
+    echo 1>&2 "\
+WARNING: \`$1' is needed, and you do not seem to have it handy on your
+         system.  You might have modified some files without having the
+         proper tools for further handling them.
+         You can get \`$1Help2man' as part of \`Autoconf' from any GNU
+         archive site."
+
+    file=`echo "$*" | sed -n 's/.*--output[ =]*\([^ ]*\).*/\1/p'`
+    test -z "$file" && file=`echo "$*" | sed -n 's/.*-o[ ]*\([^ ]*\).*/\1/p'`
+    if test -f "$file"; then
+	touch $file
+    else
+	test -z "$file" || exec >$file
+	echo "#! /bin/sh"
+	echo "# Created by GNU Automake missing as a replacement of"
+	echo "#  $ $@"
+	echo "exit 0"
+	chmod +x $file
+	exit 1
+    fi
+    ;;
+
+  bison|yacc)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified a \`.y' file.  You may need the \`Bison' package
+         in order for those modifications to take effect.  You can get
+         \`Bison' from any GNU archive site."
+    rm -f y.tab.c y.tab.h
+    if [ $# -ne 1 ]; then
+        eval LASTARG="\${$#}"
+	case "$LASTARG" in
+	*.y)
+	    SRCFILE=`echo "$LASTARG" | sed 's/y$/c/'`
+	    if [ -f "$SRCFILE" ]; then
+	         cp "$SRCFILE" y.tab.c
+	    fi
+	    SRCFILE=`echo "$LASTARG" | sed 's/y$/h/'`
+	    if [ -f "$SRCFILE" ]; then
+	         cp "$SRCFILE" y.tab.h
+	    fi
+	  ;;
+	esac
+    fi
+    if [ ! -f y.tab.h ]; then
+	echo >y.tab.h
+    fi
+    if [ ! -f y.tab.c ]; then
+	echo 'main() { return 0; }' >y.tab.c
+    fi
+    ;;
+
+  lex|flex)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified a \`.l' file.  You may need the \`Flex' package
+         in order for those modifications to take effect.  You can get
+         \`Flex' from any GNU archive site."
+    rm -f lex.yy.c
+    if [ $# -ne 1 ]; then
+        eval LASTARG="\${$#}"
+	case "$LASTARG" in
+	*.l)
+	    SRCFILE=`echo "$LASTARG" | sed 's/l$/c/'`
+	    if [ -f "$SRCFILE" ]; then
+	         cp "$SRCFILE" lex.yy.c
+	    fi
+	  ;;
+	esac
+    fi
+    if [ ! -f lex.yy.c ]; then
+	echo 'main() { return 0; }' >lex.yy.c
+    fi
+    ;;
+
+  help2man)
+    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+       # We have it, but it failed.
+       exit 1
+    fi
+
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+	 you modified a dependency of a manual page.  You may need the
+	 \`Help2man' package in order for those modifications to take
+	 effect.  You can get \`Help2man' from any GNU archive site."
+
+    file=`echo "$*" | sed -n 's/.*-o \([^ ]*\).*/\1/p'`
+    if test -z "$file"; then
+	file=`echo "$*" | sed -n 's/.*--output=\([^ ]*\).*/\1/p'`
+    fi
+    if [ -f "$file" ]; then
+	touch $file
+    else
+	test -z "$file" || exec >$file
+	echo ".ab help2man is required to generate this page"
+	exit 1
+    fi
+    ;;
+
+  makeinfo)
+    if test -z "$run" && (makeinfo --version) > /dev/null 2>&1; then
+       # We have makeinfo, but it failed.
+       exit 1
+    fi
+
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified a \`.texi' or \`.texinfo' file, or any other file
+         indirectly affecting the aspect of the manual.  The spurious
+         call might also be the consequence of using a buggy \`make' (AIX,
+         DU, IRIX).  You might want to install the \`Texinfo' package or
+         the \`GNU make' package.  Grab either from any GNU archive site."
+    file=`echo "$*" | sed -n 's/.*-o \([^ ]*\).*/\1/p'`
+    if test -z "$file"; then
+      file=`echo "$*" | sed 's/.* \([^ ]*\) *$/\1/'`
+      file=`sed -n '/^@setfilename/ { s/.* \([^ ]*\) *$/\1/; p; q; }' $file`
+    fi
+    touch $file
+    ;;
+
+  tar)
+    shift
+    if test -n "$run"; then
+      echo 1>&2 "ERROR: \`tar' requires --run"
+      exit 1
+    fi
+
+    # We have already tried tar in the generic part.
+    # Look for gnutar/gtar before invocation to avoid ugly error
+    # messages.
+    if (gnutar --version > /dev/null 2>&1); then
+       gnutar "$@" && exit 0
+    fi
+    if (gtar --version > /dev/null 2>&1); then
+       gtar "$@" && exit 0
+    fi
+    firstarg="$1"
+    if shift; then
+	case "$firstarg" in
+	*o*)
+	    firstarg=`echo "$firstarg" | sed s/o//`
+	    tar "$firstarg" "$@" && exit 0
+	    ;;
+	esac
+	case "$firstarg" in
+	*h*)
+	    firstarg=`echo "$firstarg" | sed s/h//`
+	    tar "$firstarg" "$@" && exit 0
+	    ;;
+	esac
+    fi
+
+    echo 1>&2 "\
+WARNING: I can't seem to be able to run \`tar' with the given arguments.
+         You may want to install GNU tar or Free paxutils, or check the
+         command line arguments."
+    exit 1
+    ;;
+
+  *)
+    echo 1>&2 "\
+WARNING: \`$1' is needed, and you do not seem to have it handy on your
+         system.  You might have modified some files without having the
+         proper tools for further handling them.  Check the \`README' file,
+         it often tells you about the needed prerequirements for installing
+         this package.  You may also peek at any GNU archive site, in case
+         some other package would contain this missing \`$1' program."
+    exit 1
+    ;;
+esac
+
+exit 0
@@ -0,0 +1,99 @@
+#! /bin/sh
+# mkinstalldirs --- make directory hierarchy
+# Author: Noah Friedman <friedman@prep.ai.mit.edu>
+# Created: 1993-05-16
+# Public domain
+
+errstatus=0
+dirmode=""
+
+usage="\
+Usage: mkinstalldirs [-h] [--help] [-m mode] dir ..."
+
+# process command line arguments
+while test $# -gt 0 ; do
+   case "${1}" in
+     -h | --help | --h* )			# -h for help
+	echo "${usage}" 1>&2; exit 0 ;;
+     -m )					# -m PERM arg
+	shift
+	test $# -eq 0 && { echo "${usage}" 1>&2; exit 1; }
+	dirmode="${1}"
+	shift ;;
+     -- ) shift; break ;;			# stop option processing
+     -* ) echo "${usage}" 1>&2; exit 1 ;;	# unknown option
+     * )  break ;;				# first non-opt arg
+   esac
+done
+
+for file
+do
+  if test -d "$file"; then
+    shift
+  else
+    break
+  fi
+done
+
+case $# in
+0) exit 0 ;;
+esac
+
+case $dirmode in
+'')
+  if mkdir -p -- . 2>/dev/null; then
+    echo "mkdir -p -- $*"
+    exec mkdir -p -- "$@"
+  fi ;;
+*)
+  if mkdir -m "$dirmode" -p -- . 2>/dev/null; then
+    echo "mkdir -m $dirmode -p -- $*"
+    exec mkdir -m "$dirmode" -p -- "$@"
+  fi ;;
+esac
+
+for file
+do
+   set fnord `echo ":$file" | sed -ne 's/^:\//#/;s/^://;s/\// /g;s/^#/\//;p'`
+   shift
+
+   pathcomp=
+   for d
+   do
+     pathcomp="$pathcomp$d"
+     case "$pathcomp" in
+       -* ) pathcomp=./$pathcomp ;;
+     esac
+
+     if test ! -d "$pathcomp"; then
+	echo "mkdir $pathcomp"
+
+	mkdir "$pathcomp" || lasterr=$?
+
+	if test ! -d "$pathcomp"; then
+	  errstatus=$lasterr
+	else
+	  if test ! -z "$dirmode"; then
+	     echo "chmod $dirmode $pathcomp"
+
+	     lasterr=""
+	     chmod "$dirmode" "$pathcomp" || lasterr=$?
+
+	     if test ! -z "$lasterr"; then
+	       errstatus=$lasterr
+	     fi
+	  fi
+	fi
+     fi
+
+     pathcomp="$pathcomp/"
+   done
+done
+
+exit $errstatus
+
+# Local Variables:
+# mode: shell-script
+# sh-indentation: 3
+# End:
+# mkinstalldirs ends here
@@ -0,0 +1,10 @@
+
+INCLUDES = -I$(top_srcdir)/include
+
+noinst_LIBRARIES = libTrie.a
+
+libTrie_a_SOURCES = Trie.cc \
+	TrieNode.cc
+
+noinst_HEADERS = ../include/Trie.cci \
+	../include/TrieNode.cci
@@ -0,0 +1,310 @@
+# Makefile.in generated by automake 1.6.3 from Makefile.am.
+# @configure_input@
+
+# Copyright 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002
+# Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+@SET_MAKE@
+SHELL = @SHELL@
+
+srcdir = @srcdir@
+top_srcdir = @top_srcdir@
+VPATH = @srcdir@
+prefix = @prefix@
+exec_prefix = @exec_prefix@
+
+bindir = @bindir@
+sbindir = @sbindir@
+libexecdir = @libexecdir@
+datadir = @datadir@
+sysconfdir = @sysconfdir@
+sharedstatedir = @sharedstatedir@
+localstatedir = @localstatedir@
+libdir = @libdir@
+infodir = @infodir@
+mandir = @mandir@
+includedir = @includedir@
+oldincludedir = /usr/include
+pkgdatadir = $(datadir)/@PACKAGE@
+pkglibdir = $(libdir)/@PACKAGE@
+pkgincludedir = $(includedir)/@PACKAGE@
+top_builddir = ..
+
+ACLOCAL = @ACLOCAL@
+AUTOCONF = @AUTOCONF@
+AUTOMAKE = @AUTOMAKE@
+AUTOHEADER = @AUTOHEADER@
+
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+INSTALL = @INSTALL@
+INSTALL_PROGRAM = @INSTALL_PROGRAM@
+INSTALL_DATA = @INSTALL_DATA@
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_SCRIPT = @INSTALL_SCRIPT@
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = @program_transform_name@
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+
+EXEEXT = @EXEEXT@
+OBJEXT = @OBJEXT@
+PATH_SEPARATOR = @PATH_SEPARATOR@
+AMTAR = @AMTAR@
+AWK = @AWK@
+CC = @CC@
+CXX = @CXX@
+DEPDIR = @DEPDIR@
+INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+MAINT = @MAINT@
+PACKAGE = @PACKAGE@
+RANLIB = @RANLIB@
+STRIP = @STRIP@
+VERSION = @VERSION@
+am__include = @am__include@
+am__quote = @am__quote@
+install_sh = @install_sh@
+
+INCLUDES = -I$(top_srcdir)/include
+
+noinst_LIBRARIES = libTrie.a
+
+libTrie_a_SOURCES = Trie.cc \
+	TrieNode.cc
+
+
+noinst_HEADERS = ../include/Trie.cci \
+	../include/TrieNode.cci
+
+subdir = src
+mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+CONFIG_HEADER = $(top_builddir)/config.h
+CONFIG_CLEAN_FILES =
+LIBRARIES = $(noinst_LIBRARIES)
+
+libTrie_a_AR = $(AR) cru
+libTrie_a_LIBADD =
+am_libTrie_a_OBJECTS = Trie.$(OBJEXT) TrieNode.$(OBJEXT)
+libTrie_a_OBJECTS = $(am_libTrie_a_OBJECTS)
+
+DEFS = @DEFS@
+DEFAULT_INCLUDES =  -I. -I$(srcdir) -I$(top_builddir)
+CPPFLAGS = @CPPFLAGS@
+LDFLAGS = @LDFLAGS@
+LIBS = @LIBS@
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+@AMDEP_TRUE@DEP_FILES = ./$(DEPDIR)/Trie.Po ./$(DEPDIR)/TrieNode.Po
+CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+CXXLD = $(CXX)
+CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+	-o $@
+CXXFLAGS = @CXXFLAGS@
+DIST_SOURCES = $(libTrie_a_SOURCES)
+HEADERS = $(noinst_HEADERS)
+
+DIST_COMMON = $(noinst_HEADERS) Makefile.am Makefile.in
+SOURCES = $(libTrie_a_SOURCES)
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .cc .o .obj
+$(srcdir)/Makefile.in: @MAINTAINER_MODE_TRUE@ Makefile.am  $(top_srcdir)/configure.in $(ACLOCAL_M4)
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --gnu  src/Makefile
+Makefile: @MAINTAINER_MODE_TRUE@ $(srcdir)/Makefile.in  $(top_builddir)/config.status
+	cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)
+
+AR = ar
+
+clean-noinstLIBRARIES:
+	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+libTrie.a: $(libTrie_a_OBJECTS) $(libTrie_a_DEPENDENCIES) 
+	-rm -f libTrie.a
+	$(libTrie_a_AR) libTrie.a $(libTrie_a_OBJECTS) $(libTrie_a_LIBADD)
+	$(RANLIB) libTrie.a
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT) core *.core
+
+distclean-compile:
+	-rm -f *.tab.c
+
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/Trie.Po@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/TrieNode.Po@am__quote@
+
+distclean-depend:
+	-rm -rf ./$(DEPDIR)
+
+.cc.o:
+@AMDEP_TRUE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@	depfile='$(DEPDIR)/$*.Po' tmpdepfile='$(DEPDIR)/$*.TPo' @AMDEPBACKSLASH@
+@AMDEP_TRUE@	$(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+	$(CXXCOMPILE) -c -o $@ `test -f '$<' || echo '$(srcdir)/'`$<
+
+.cc.obj:
+@AMDEP_TRUE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@	depfile='$(DEPDIR)/$*.Po' tmpdepfile='$(DEPDIR)/$*.TPo' @AMDEPBACKSLASH@
+@AMDEP_TRUE@	$(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+	$(CXXCOMPILE) -c -o $@ `cygpath -w $<`
+CXXDEPMODE = @CXXDEPMODE@
+uninstall-info-am:
+
+ETAGS = etags
+ETAGSFLAGS =
+
+tags: TAGS
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	mkid -fID $$unique
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	test -z "$(ETAGS_ARGS)$$tags$$unique" \
+	  || $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+
+top_distdir = ..
+distdir = $(top_distdir)/$(PACKAGE)-$(VERSION)
+
+distdir: $(DISTFILES)
+	$(mkinstalldirs) $(distdir)/../include
+	@list='$(DISTFILES)'; for file in $$list; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  dir=`echo "$$file" | sed -e 's,/[^/]*$$,,'`; \
+	  if test "$$dir" != "$$file" && test "$$dir" != "."; then \
+	    dir="/$$dir"; \
+	    $(mkinstalldirs) "$(distdir)$$dir"; \
+	  else \
+	    dir=''; \
+	  fi; \
+	  if test -d $$d/$$file; then \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(LIBRARIES) $(HEADERS)
+
+installdirs:
+
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-rm -f Makefile $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+
+distclean: distclean-am
+
+distclean-am: clean-am distclean-compile distclean-depend \
+	distclean-generic distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-exec-am:
+
+install-info: install-info-am
+
+install-man:
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic
+
+uninstall-am: uninstall-info-am
+
+.PHONY: GTAGS all all-am check check-am clean clean-generic \
+	clean-noinstLIBRARIES distclean distclean-compile \
+	distclean-depend distclean-generic distclean-tags distdir dvi \
+	dvi-am info info-am install install-am install-data \
+	install-data-am install-exec install-exec-am install-info \
+	install-info-am install-man install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic tags uninstall uninstall-am \
+	uninstall-info-am
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
@@ -0,0 +1,76 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "Trie.h"
+#ifdef HAVE_UNISTD_H
+#include <unistd.h>
+#endif
+#include "TrieNode.h"
+
+Trie::Trie () : head (0)
+{}
+
+extern "C" void *TrieCreate ()
+{
+    return new Trie;
+}
+
+Trie::~Trie ()
+{
+    delete head;
+}
+
+extern "C" void TrieDestroy (void *aTrie)
+{
+    delete (Trie *)aTrie;
+}
+
+extern "C" void *TrieFind (void *aTrie, char const *aString, size_t theLength)
+{
+    return ((Trie *)aTrie)->find (aString, theLength);
+}
+
+bool
+
+Trie::add
+    (char const *aString, size_t theLength, void *privatedata)
+{
+    if (!privatedata)
+        return false;
+
+    if (head) {
+        if (find (aString, theLength))
+            return false;
+
+        return head->add
+               (aString, theLength, privatedata);
+    }
+
+    head = new TrieNode;
+
+    return head->add
+           (aString, theLength, privatedata);
+}
+
+extern "C" int TrieAdd (void *aTrie, char const *aString, size_t theLength, void *privatedata)
+{
+
+    return ((Trie *)aTrie)->add
+           (aString, theLength, privatedata);
+}
@@ -0,0 +1,71 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "TrieNode.h"
+#ifdef HAVE_UNISTD_H
+#include <unistd.h>
+#endif
+#include <ctype.h>
+
+TrieNode::TrieNode ()
+{
+    for (int i = 0; i < 256; ++i)
+        internal[i] = NULL;
+}
+
+TrieNode::~TrieNode ()
+{
+    for (int i = 0; i < 256; ++i)
+        delete internal[i];
+}
+
+/* as for find */
+bool
+
+TrieNode::add
+    (char const *aString, size_t theLength, void *privatedata)
+{
+    /* We trust that privatedata and existant keys have already been checked */
+
+    if (theLength) {
+        int index;
+
+        if (internal[*aString])
+            index = *aString;
+        else if (internal[tolower(*aString)])
+            index = tolower (*aString);
+        else {
+            index = *aString;
+            internal[index] = new TrieNode;
+        }
+
+        internal[index]->add
+        (aString + 1, theLength - 1, privatedata);
+    } else {
+        /* terminal node */
+
+        if (_privateData)
+            return false;
+
+        _privateData = privatedata;
+
+        return true;
+    }
+}
+
@@ -0,0 +1,12 @@
+INCLUDES = -I$(top_srcdir)/include
+
+TESTS = trie trie-c
+
+check_PROGRAMS = trie trie-c
+
+trie_SOURCES = trie.cc
+trie_LDADD = $(top_builddir)/src/libTrie.a
+
+trie_c_SOURCES = trie-c.c
+trie_c_LDADD = $(top_builddir)/src/libTrie.a -lstdc++
+
@@ -0,0 +1,384 @@
+# Makefile.in generated by automake 1.6.3 from Makefile.am.
+# @configure_input@
+
+# Copyright 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002
+# Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+@SET_MAKE@
+SHELL = @SHELL@
+
+srcdir = @srcdir@
+top_srcdir = @top_srcdir@
+VPATH = @srcdir@
+prefix = @prefix@
+exec_prefix = @exec_prefix@
+
+bindir = @bindir@
+sbindir = @sbindir@
+libexecdir = @libexecdir@
+datadir = @datadir@
+sysconfdir = @sysconfdir@
+sharedstatedir = @sharedstatedir@
+localstatedir = @localstatedir@
+libdir = @libdir@
+infodir = @infodir@
+mandir = @mandir@
+includedir = @includedir@
+oldincludedir = /usr/include
+pkgdatadir = $(datadir)/@PACKAGE@
+pkglibdir = $(libdir)/@PACKAGE@
+pkgincludedir = $(includedir)/@PACKAGE@
+top_builddir = ..
+
+ACLOCAL = @ACLOCAL@
+AUTOCONF = @AUTOCONF@
+AUTOMAKE = @AUTOMAKE@
+AUTOHEADER = @AUTOHEADER@
+
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+INSTALL = @INSTALL@
+INSTALL_PROGRAM = @INSTALL_PROGRAM@
+INSTALL_DATA = @INSTALL_DATA@
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_SCRIPT = @INSTALL_SCRIPT@
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = @program_transform_name@
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+
+EXEEXT = @EXEEXT@
+OBJEXT = @OBJEXT@
+PATH_SEPARATOR = @PATH_SEPARATOR@
+AMTAR = @AMTAR@
+AWK = @AWK@
+CC = @CC@
+CXX = @CXX@
+DEPDIR = @DEPDIR@
+INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+MAINT = @MAINT@
+PACKAGE = @PACKAGE@
+RANLIB = @RANLIB@
+STRIP = @STRIP@
+VERSION = @VERSION@
+am__include = @am__include@
+am__quote = @am__quote@
+install_sh = @install_sh@
+INCLUDES = -I$(top_srcdir)/include
+
+TESTS = trie trie-c
+
+check_PROGRAMS = trie trie-c
+
+trie_SOURCES = trie.cc
+trie_LDADD = $(top_builddir)/src/libTrie.a
+
+trie_c_SOURCES = trie-c.c
+trie_c_LDADD = $(top_builddir)/src/libTrie.a -lstdc++
+subdir = test
+mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+CONFIG_HEADER = $(top_builddir)/config.h
+CONFIG_CLEAN_FILES =
+check_PROGRAMS = trie$(EXEEXT) trie-c$(EXEEXT)
+am_trie_OBJECTS = trie.$(OBJEXT)
+trie_OBJECTS = $(am_trie_OBJECTS)
+trie_DEPENDENCIES = $(top_builddir)/src/libTrie.a
+trie_LDFLAGS =
+am_trie_c_OBJECTS = trie-c.$(OBJEXT)
+trie_c_OBJECTS = $(am_trie_c_OBJECTS)
+trie_c_DEPENDENCIES = $(top_builddir)/src/libTrie.a
+trie_c_LDFLAGS =
+
+DEFS = @DEFS@
+DEFAULT_INCLUDES =  -I. -I$(srcdir) -I$(top_builddir)
+CPPFLAGS = @CPPFLAGS@
+LDFLAGS = @LDFLAGS@
+LIBS = @LIBS@
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+@AMDEP_TRUE@DEP_FILES = ./$(DEPDIR)/trie-c.Po ./$(DEPDIR)/trie.Po
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+CFLAGS = @CFLAGS@
+CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+CXXLD = $(CXX)
+CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+	-o $@
+CXXFLAGS = @CXXFLAGS@
+DIST_SOURCES = $(trie_SOURCES) $(trie_c_SOURCES)
+DIST_COMMON = Makefile.am Makefile.in
+SOURCES = $(trie_SOURCES) $(trie_c_SOURCES)
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .cc .o .obj
+$(srcdir)/Makefile.in: @MAINTAINER_MODE_TRUE@ Makefile.am  $(top_srcdir)/configure.in $(ACLOCAL_M4)
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --gnu  test/Makefile
+Makefile: @MAINTAINER_MODE_TRUE@ $(srcdir)/Makefile.in  $(top_builddir)/config.status
+	cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)
+
+clean-checkPROGRAMS:
+	-test -z "$(check_PROGRAMS)" || rm -f $(check_PROGRAMS)
+trie$(EXEEXT): $(trie_OBJECTS) $(trie_DEPENDENCIES) 
+	@rm -f trie$(EXEEXT)
+	$(CXXLINK) $(trie_LDFLAGS) $(trie_OBJECTS) $(trie_LDADD) $(LIBS)
+trie-c$(EXEEXT): $(trie_c_OBJECTS) $(trie_c_DEPENDENCIES) 
+	@rm -f trie-c$(EXEEXT)
+	$(LINK) $(trie_c_LDFLAGS) $(trie_c_OBJECTS) $(trie_c_LDADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT) core *.core
+
+distclean-compile:
+	-rm -f *.tab.c
+
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/trie-c.Po@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/trie.Po@am__quote@
+
+distclean-depend:
+	-rm -rf ./$(DEPDIR)
+
+.c.o:
+@AMDEP_TRUE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@	depfile='$(DEPDIR)/$*.Po' tmpdepfile='$(DEPDIR)/$*.TPo' @AMDEPBACKSLASH@
+@AMDEP_TRUE@	$(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+	$(COMPILE) -c `test -f '$<' || echo '$(srcdir)/'`$<
+
+.c.obj:
+@AMDEP_TRUE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@	depfile='$(DEPDIR)/$*.Po' tmpdepfile='$(DEPDIR)/$*.TPo' @AMDEPBACKSLASH@
+@AMDEP_TRUE@	$(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+	$(COMPILE) -c `cygpath -w $<`
+CCDEPMODE = @CCDEPMODE@
+
+.cc.o:
+@AMDEP_TRUE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@	depfile='$(DEPDIR)/$*.Po' tmpdepfile='$(DEPDIR)/$*.TPo' @AMDEPBACKSLASH@
+@AMDEP_TRUE@	$(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+	$(CXXCOMPILE) -c -o $@ `test -f '$<' || echo '$(srcdir)/'`$<
+
+.cc.obj:
+@AMDEP_TRUE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@	depfile='$(DEPDIR)/$*.Po' tmpdepfile='$(DEPDIR)/$*.TPo' @AMDEPBACKSLASH@
+@AMDEP_TRUE@	$(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+	$(CXXCOMPILE) -c -o $@ `cygpath -w $<`
+CXXDEPMODE = @CXXDEPMODE@
+uninstall-info-am:
+
+ETAGS = etags
+ETAGSFLAGS =
+
+tags: TAGS
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	mkid -fID $$unique
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
+	test -z "$(ETAGS_ARGS)$$tags$$unique" \
+	  || $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH
+
+check-TESTS: $(TESTS)
+	@failed=0; all=0; xfail=0; xpass=0; \
+	srcdir=$(srcdir); export srcdir; \
+	list='$(TESTS)'; \
+	if test -n "$$list"; then \
+	  for tst in $$list; do \
+	    if test -f ./$$tst; then dir=./; \
+	    elif test -f $$tst; then dir=; \
+	    else dir="$(srcdir)/"; fi; \
+	    if $(TESTS_ENVIRONMENT) $${dir}$$tst; then \
+	      all=`expr $$all + 1`; \
+	      case " $(XFAIL_TESTS) " in \
+	      *" $$tst "*) \
+	        xpass=`expr $$xpass + 1`; \
+	        failed=`expr $$failed + 1`; \
+	        echo "XPASS: $$tst"; \
+	      ;; \
+	      *) \
+	        echo "PASS: $$tst"; \
+	      ;; \
+	      esac; \
+	    elif test $$? -ne 77; then \
+	      all=`expr $$all + 1`; \
+	      case " $(XFAIL_TESTS) " in \
+	      *" $$tst "*) \
+	        xfail=`expr $$xfail + 1`; \
+	        echo "XFAIL: $$tst"; \
+	      ;; \
+	      *) \
+	        failed=`expr $$failed + 1`; \
+	        echo "FAIL: $$tst"; \
+	      ;; \
+	      esac; \
+	    fi; \
+	  done; \
+	  if test "$$failed" -eq 0; then \
+	    if test "$$xfail" -eq 0; then \
+	      banner="All $$all tests passed"; \
+	    else \
+	      banner="All $$all tests behaved as expected ($$xfail expected failures)"; \
+	    fi; \
+	  else \
+	    if test "$$xpass" -eq 0; then \
+	      banner="$$failed of $$all tests failed"; \
+	    else \
+	      banner="$$failed of $$all tests did not behave as expected ($$xpass unexpected passes)"; \
+	    fi; \
+	  fi; \
+	  dashes=`echo "$$banner" | sed s/./=/g`; \
+	  echo "$$dashes"; \
+	  echo "$$banner"; \
+	  echo "$$dashes"; \
+	  test "$$failed" -eq 0; \
+	else :; fi
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+
+top_distdir = ..
+distdir = $(top_distdir)/$(PACKAGE)-$(VERSION)
+
+distdir: $(DISTFILES)
+	@list='$(DISTFILES)'; for file in $$list; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  dir=`echo "$$file" | sed -e 's,/[^/]*$$,,'`; \
+	  if test "$$dir" != "$$file" && test "$$dir" != "."; then \
+	    dir="/$$dir"; \
+	    $(mkinstalldirs) "$(distdir)$$dir"; \
+	  else \
+	    dir=''; \
+	  fi; \
+	  if test -d $$d/$$file; then \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+	$(MAKE) $(AM_MAKEFLAGS) $(check_PROGRAMS)
+	$(MAKE) $(AM_MAKEFLAGS) check-TESTS
+check: check-am
+all-am: Makefile
+
+installdirs:
+
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-rm -f Makefile $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-checkPROGRAMS clean-generic mostlyclean-am
+
+distclean: distclean-am
+
+distclean-am: clean-am distclean-compile distclean-depend \
+	distclean-generic distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-exec-am:
+
+install-info: install-info-am
+
+install-man:
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic
+
+uninstall-am: uninstall-info-am
+
+.PHONY: GTAGS all all-am check check-TESTS check-am clean \
+	clean-checkPROGRAMS clean-generic distclean distclean-compile \
+	distclean-depend distclean-generic distclean-tags distdir dvi \
+	dvi-am info info-am install install-am install-data \
+	install-data-am install-exec install-exec-am install-info \
+	install-info-am install-man install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic tags uninstall uninstall-am \
+	uninstall-info-am
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
@@ -0,0 +1,41 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "Trie.h"
+#include <stdio.h>
+
+int
+main (int argc, char **argv)
+{
+    void *aTrie = TrieCreate();
+    if (!TrieAdd (aTrie, "User-Agent", 10, (void *)1)) {
+	fprintf(stderr,"Could not add User-Agent\n");
+	return 1;
+    }
+    if (TrieAdd (aTrie, "User-Agent", 10, (void *)2)) {
+	fprintf(stderr, "Could add duplicate User-Agent\n");
+	return 1;
+    }
+    if (TrieFind (aTrie, "User-Agent", 10) != (void *)1) {
+	fprintf(stderr, "Could not find User-Agent\n");
+	return 1;
+    }
+    TrieDestroy (aTrie);
+    return 0;
+}
@@ -0,0 +1,48 @@
+/*
+ * Copyright (c) 2002 Robert Collins <rbtcollins@hotmail.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ * 
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "Trie.h"
+#include <iostream>
+
+int main (int argc, char **argv)
+{
+    Trie aTrie;
+
+    if (!aTrie.add ("User-Agent", 10, (void *)1)) {
+        std::cerr << "Could not add User-Agent" << std::endl;
+        return 1;
+    }
+
+    if (aTrie.add ("User-Agent", 10, (void *)2)) {
+        std::cerr << "Could add duplicate User-Agent" << std::endl;
+        return 1;
+    }
+
+    if (!aTrie.add ("Alphabet", 8, (void *)3)) {
+        std::cerr << "Could not add Alphabet" << std::endl;
+        return 1;
+    }
+
+    if (aTrie.find ("User-Agent", 10) != (void *)1) {
+        std::cerr << "Could not find User-Agent" << std::endl;
+        return 1;
+    }
+
+    return 0;
+}
@@ -0,0 +1,46 @@
+
+/*
+ * $Id: ESI.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef SQUID_ESI_H
+#define SQUID_ESI_H
+
+#include "clientStream.h"
+
+/* ESI.c */
+extern CSR esiStreamRead;
+extern CSCB esiProcessStream;
+extern CSD esiStreamDetach;
+extern CSS esiStreamStatus;
+extern int esiEnableProcessing (HttpReply *);
+
+#endif /* SQUID_ESI_H */
@@ -0,0 +1,55 @@
+/*
+ * $Id: ESIAttempt.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ * Copyright (c) 2003, Robert Collins <robertc@squid-cache.org>
+ */
+
+#ifndef SQUID_ESIATTEMPT_H
+#define SQUID_ESIATTEMPT_H
+
+#include "squid.h"
+#include "ESIElement.h"
+#include "ESISequence.h"
+
+/* esiAttempt */
+
+struct esiAttempt : public esiSequence
+{
+    //    void *operator new (size_t byteCount);
+    //    void operator delete (void *address);
+    void deleteSelf() const;
+    esiAttempt(esiTreeParentPtr aParent) : esiSequence (aParent) {}}
+
+;
+
+
+#endif /* SQUID_ESIATTEMPT_H */
@@ -0,0 +1,93 @@
+
+/*
+ * $Id: ESIContext.cc,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+#include "ESIContext.h"
+#include "Store.h"
+#include "client_side_request.h"
+
+void
+ESIContext::updateCachedAST()
+{
+    assert (http);
+    assert (http->entry);
+
+    if (hasCachedAST()) {
+        debug (86,5)("ESIContext::updateCachedAST: not updating AST cache for entry %p from ESI Context %p as there is already a cached AST.\n", http->entry, this);
+        return;
+    }
+
+    ESIElement::Pointer treeToCache = tree->makeCacheable();
+    debug (86,5)("ESIContext::updateCachedAST: Updating AST cache for entry %p with current value %p to new value %p\n", http->entry, http->entry->cachedESITree.getRaw(), treeToCache.getRaw());
+
+    if (http->entry->cachedESITree.getRaw())
+        http->entry->cachedESITree->finish();
+
+    http->entry->cachedESITree = treeToCache;
+
+    treeToCache = NULL;
+}
+
+bool
+ESIContext::hasCachedAST() const
+{
+    assert (http);
+    assert (http->entry);
+
+    if (http->entry->cachedESITree.getRaw()) {
+        debug (86,5)("ESIContext::hasCachedAST: %p - Cached AST present in store entry %p.\n", this, http->entry);
+        return true;
+    } else {
+        debug (86,5)("ESIContext::hasCachedAST: %p - Cached AST not present in store entry %p.\n", this, http->entry);
+        return false;
+    }
+}
+
+void
+ESIContext::getCachedAST()
+{
+    if (cachedASTInUse)
+        return;
+
+    assert (hasCachedAST());
+
+    assert (varState);
+
+    parserState.popAll();
+
+    tree = http->entry->cachedESITree->makeUsable (this, *varState);
+
+    cachedASTInUse = true;
+}
@@ -0,0 +1,192 @@
+/*
+ * $Id: ESIContext.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ * Copyright (c) 2003, Robert Collins <robertc@squid-cache.org>
+ */
+
+#ifndef SQUID_ESICONTEXT_H
+#define SQUID_ESICONTEXT_H
+
+#include "ESIElement.h"
+
+class esiVarState;
+
+class clientStreamNode;
+
+class ClientHttpRequest;
+
+#include "ESIParser.h"
+
+/* ESIContext */
+
+class ESIContext : public esiTreeParent, public ESIParserClient
+{
+
+public:
+    void *operator new (size_t byteCount);
+    void operator delete (void *address);
+    void deleteSelf() const;
+    ESIContext():reading_(true) {}
+
+    ~ESIContext();
+
+    enum esiKick_t {
+        ESI_KICK_FAILED,
+        ESI_KICK_PENDING,
+        ESI_KICK_SENT,
+        ESI_KICK_INPROGRESS
+    };
+
+    /* when esi processing completes */
+    void provideData(ESISegment::Pointer, ESIElement *source);
+    void fail (ESIElement *source);
+    void startRead();
+    void finishRead();
+    bool reading() const;
+    void setError();
+
+    void addStackElement (ESIElement::Pointer element);
+    void addLiteral (const char *s, int len);
+
+    void finishChildren ();
+
+    clientStreamNode *thisNode; /* our stream node */
+    /* the request we are processing. HMM: cbdataReferencing this will result
+     * in a circular reference, so we don't. Note: we are automatically freed
+     * when it is, so thats ok. */
+    ClientHttpRequest *http;
+
+    struct
+    {
+
+int passthrough:
+        1;
+
+int oktosend:
+        1;
+
+int finished:
+        1;
+
+        /* an error has occured, send full body replies
+         * regardless. Note that we don't fail midstream
+         * because we buffer until we can not fail
+         */
+
+int error:
+        1;
+
+int finishedtemplate:
+        1; /* we've read the entire template */
+
+int clientwantsdata:
+        1; /* we need to satisfy a read request */
+
+int kicked:
+        1; /* note on reentering the kick routine */
+
+int detached:
+        1; /* our downstream has detached */
+    }
+
+    flags;
+    err_type errorpage; /* if we error what page to use */
+    http_status errorstatus; /* if we error, what code to return */
+    char *errormessage; /* error to pass to error page */
+    HttpReply *rep; /* buffered until we pass data downstream */
+    ESISegment::Pointer buffered; /* unprocessed data - for whatever reason */
+    ESISegment::Pointer incoming;
+    /* processed data we are waiting to send, or for
+     * potential errors to be resolved 
+     */
+    ESISegment::Pointer outbound;
+    ESISegment::Pointer outboundtail; /* our write segment */
+    /* the offset to the next character to send -
+     * non zero if we haven't sent the entire segment 
+     * for some reason 
+     */
+    size_t outbound_offset;
+    off_t readpos; /* the logical position we are reading from */
+    off_t pos; /* the logical position of outbound_offset in the data stream */
+
+    class ParserState
+    {
+
+    public:
+        ESIElement::Pointer stack[10]; /* a stack of esi elements that are open */
+        int stackdepth; /* self explanatory */
+        ESIParser::Pointer theParser;
+        ESIElement::Pointer top();
+        void init (ESIParserClient *);
+        bool inited() const;
+        ParserState();
+        void freeResources();
+        void popAll();
+
+    int parsing:
+        1; /* libexpat is not reentrant on the same context */
+
+    private:
+        bool inited_;
+    }
+
+    parserState; /* todo factor this off somewhere else; */
+    esiVarState *varState;
+    ESIElement::Pointer tree;
+
+    esiKick_t kick ();
+    RefCount<ESIContext> cbdataLocker;
+    bool failed() const {return flags.error != 0;}
+
+    bool cachedASTInUse;
+
+private:
+    CBDATA_CLASS(ESIContext);
+    void fail ();
+    void freeResources();
+    void fixupOutboundTail();
+    void trimBlanks();
+    size_t send ();
+    bool reading_;
+    void appendOutboundData(ESISegment::Pointer theData);
+    esiProcessResult_t process ();
+    void parse();
+    void parseOneBuffer();
+    void updateCachedAST();
+    bool hasCachedAST() const;
+    void getCachedAST();
+    virtual void start(const char *el, const char **attr, size_t attrCount);
+    virtual void end(const char *el);
+    virtual void parserDefault (const char *s, int len);
+    virtual void parserComment (const char *s);
+    bool processing;
+};
+
+#endif /* SQUID_ESICONTEXT_H */
@@ -0,0 +1,306 @@
+
+/*
+ * $Id: ESICustomParser.cc,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+#include "ESICustomParser.h"
+#include "Trie.h"
+#include "Array.h"
+
+Trie *ESICustomParser::SearchTrie=NULL;
+bool ESICustomParser::TrieInited;
+
+Trie *
+ESICustomParser::GetTrie()
+{
+    if (SearchTrie)
+        return SearchTrie;
+
+    SearchTrie = new Trie;
+
+    assert (SearchTrie->add
+            ("<esi:",5,(void *)ESITAG));
+
+    assert (SearchTrie->add
+            ("</esi:",6,(void *)ESIENDTAG));
+
+    assert (SearchTrie->add
+            ("<!--",4,(void *)ESICOMMENT));
+
+    return SearchTrie;
+}
+
+void
+ESICustomParser::deleteSelf() const
+{
+    delete this;
+}
+
+ESICustomParser::ESICustomParser(ESIParserClient *aClient) : theClient (aClient)
+{}
+
+ESICustomParser::~ESICustomParser()
+{
+    theClient = NULL;
+}
+
+char const *
+ESICustomParser::findTag(char const *a, size_t b)
+{
+    size_t myOffset (0);
+    void *resulttype (NULL);
+
+    while (myOffset < b &&
+            (resulttype =GetTrie()->findPrefix (a + myOffset, b + myOffset)) == NULL)
+        ++myOffset;
+
+    if (myOffset == b)
+        return NULL;
+
+    debug (86,9)("ESICustomParser::findTag: found %p\n", resulttype);
+
+    /* Yuck! */
+    lastTag = static_cast<ESITAG_t>((int)resulttype);
+
+    return a + myOffset;
+}
+
+bool
+ESICustomParser::parse(char const *dataToParse, size_t const lengthOfData, bool const endOfStream)
+{
+    debug (86,9)("ESICustomParser::parse: Appending data to internal buffer\n");
+    content.append (dataToParse, lengthOfData);
+
+    if (!endOfStream) {
+        return true;
+    }
+
+    size_t openESITags (0);
+    char const *currentPos = content.buf();
+    size_t remainingCount = content.size();
+    char const *tag (NULL);
+
+    while ((tag = findTag(currentPos, remainingCount))) {
+        if (tag - currentPos)
+            theClient->parserDefault (currentPos,tag - currentPos);
+
+        switch (lastTag) {
+
+        case ESITAG: {
+                ++openESITags;
+                char *tagEnd = strchr(tag, '>');
+
+                if (!tagEnd) {
+                    error = "Could not find end ('>') of tag";
+                    return false;
+                }
+
+                if (tagEnd - tag > (ssize_t)remainingCount) {
+                    error = "Tag ends beyond the parse buffer.";
+                    return false;
+                }
+
+                if (*(tagEnd - 1) == '/')
+                    --openESITags;
+
+                char * endofName = strpbrk(tag, w_space);
+
+                if (endofName > tagEnd)
+                    endofName = const_cast<char *>(tagEnd);
+
+                *endofName = '\0';
+
+                *tagEnd = '\0';
+
+                Vector<char *>attributes;
+
+                char *attribute = endofName + 1;
+
+                while (attribute > tag && attribute < tagEnd) {
+                    /* leading spaces */
+
+                    while (attribute < tagEnd && (xisspace(*attribute) || (*attribute == '/')))
+                        ++attribute;
+
+                    if (! (attribute < tagEnd))
+                        break;
+
+                    /* attribute name */
+                    attributes.push_back(attribute);
+
+                    char *nextSpace = strpbrk(attribute, w_space);
+
+                    char *equals = strchr(attribute, '=');
+
+                    if (!equals) {
+                        error = "Missing attribute value.";
+                        return false;
+                    }
+
+                    if (nextSpace && nextSpace < equals)
+                        *nextSpace = '\0';
+                    else
+                        *equals = '\0';
+
+                    ++equals;
+
+                    while (equals < tagEnd && xisspace(*equals))
+                        ++equals;
+
+                    char sep = *equals;
+
+                    if (sep != '\'' && sep != '"') {
+                        error = "Unknown identifier (";
+                        error.append (sep);
+                        error.append (")");
+                        return false;
+                    }
+
+                    char *value = equals + 1;
+                    char *end = strchr (value, sep);
+                    attributes.push_back(value);
+                    *end = '\0';
+                    attribute = end + 1;
+                }
+
+                theClient->start (tag + 1, (const char **)attributes.items, attributes.size() >> 1);
+                /* TODO: attributes */
+
+                if (*(tagEnd - 1) == '/')
+                    theClient->end (tag + 1);
+
+                remainingCount -= tagEnd - currentPos + 1;
+
+                currentPos = tagEnd + 1;
+            }
+
+            break;
+
+        case ESIENDTAG: {
+                if (!openESITags)
+                    return false;
+
+                char const *tagEnd = strchr(tag, '>');
+
+                if (!tagEnd)
+                    return false;
+
+                if (tagEnd - tag > (ssize_t)remainingCount)
+                    return false;
+
+                char * endofName = strpbrk(tag, w_space);
+
+                if (endofName > tagEnd)
+                    endofName = const_cast<char *>(tagEnd);
+
+                *endofName = '\0';
+
+                theClient->end (tag + 2);
+
+                --openESITags;
+
+                remainingCount -= tagEnd - currentPos + 1;
+
+                currentPos = tagEnd + 1;
+            }
+
+            break;
+
+        case ESICOMMENT: {
+                /* Further optimisation potential:
+                 * 1) recognize end comments for esi and don't callback on 
+                 * comments.
+                 * 2) provide the comment length to the caller.
+                 */
+                /* Comments must not be nested, without CDATA
+                 * and we don't support CDATA
+                 */
+                char *commentEnd = strstr (tag, "-->");
+
+                if (!commentEnd) {
+                    error = "missing end of comment";
+                    return false;
+                }
+
+                if (commentEnd - tag > (ssize_t)remainingCount) {
+                    error = "comment ends beyond parse buffer";
+                    return false;
+                }
+
+                *commentEnd = '\0';
+                theClient->parserComment (tag + 4);
+                remainingCount -= commentEnd - currentPos + 3;
+                currentPos = commentEnd + 3;
+            }
+
+            break;
+            break;
+
+        default:
+            fatal ("unknown ESI tag type found");
+        };
+
+        /*
+         * Find next esi tag (open or closing) or comment
+         * send tag, or full comment text
+         * rinse
+         */
+    }
+
+    if (remainingCount)
+        theClient->parserDefault (currentPos,remainingCount);
+
+    debug (86,5)("ESICustomParser::parse: Finished parsing, will return %d\n", !openESITags);
+
+    if (openESITags)
+        error = "ESI Tags still open";
+
+    return !openESITags;
+}
+
+size_t
+ESICustomParser::lineNumber() const
+{
+    /* We don't track lines in the body */
+    return 0;
+}
+
+char const *
+ESICustomParser::errorString() const
+{
+    if (error.size())
+        return error.buf();
+    else
+        return "Parsing error strings not implemented";
+}
@@ -0,0 +1,71 @@
+/*
+ * $Id: ESICustomParser.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef SQUID_ESICUSTOMPARSER_H
+#define SQUID_ESICUSTOMPARSER_H
+
+#include "ESIParser.h"
+
+class Trie;
+
+class ESICustomParser : public ESIParser
+{
+
+public:
+    virtual void deleteSelf() const;
+    ESICustomParser(ESIParserClient *);
+    ~ESICustomParser();
+    /* true on success */
+    bool parse(char const *dataToParse, size_t const lengthOfData, bool const endOfStream);
+    size_t lineNumber() const;
+    char const * errorString() const;
+
+private:
+    static Trie *SearchTrie;
+    static bool TrieInited;
+    static Trie *GetTrie();
+    enum ESITAG_t {
+        ESITAG=1,
+        ESIENDTAG=2,
+        ESICOMMENT=3,
+    };
+
+    char const *findTag(char const *a, size_t b);
+    ESIParserClient *theClient;
+    String error;
+    /* cheap n dirty - buffer it all */
+    String content;
+    /* TODO: make a class of this type code */
+    ESITAG_t lastTag;
+};
+
+#endif /* SQUID_ESICUSTOMPARSER_H */
@@ -0,0 +1,114 @@
+/*
+ * $Id: ESIElement.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef SQUID_ESIELEMENT_H
+#define SQUID_ESIELEMENT_H
+
+#include "RefCount.h"
+#include "ESISegment.h"
+
+typedef enum {
+    ESI_PROCESS_COMPLETE = 0,
+    ESI_PROCESS_PENDING_WONTFAIL = 1,
+    ESI_PROCESS_PENDING_MAYFAIL = 2,
+    ESI_PROCESS_FAILED = 3
+} esiProcessResult_t;
+
+class ESIElement;
+
+struct esiTreeParent : public RefCountable
+{
+    virtual void provideData (ESISegment::Pointer data, ESIElement * source)
+    {
+        /* make abstract when all functionality complete */
+        assert (0);
+    }
+
+    virtual void fail(ESIElement * source) {}
+
+    virtual ~esiTreeParent(){}}
+
+;
+
+typedef RefCount<esiTreeParent> esiTreeParentPtr;
+
+class esiVarState;
+
+struct ESIElement : public esiTreeParent
+{
+    typedef RefCount<ESIElement> Pointer;
+
+    /* the types we have */
+    enum ESIElementType_t {
+        ESI_ELEMENT_NONE,
+        ESI_ELEMENT_INCLUDE,
+        ESI_ELEMENT_COMMENT,
+        ESI_ELEMENT_REMOVE,
+        ESI_ELEMENT_TRY,
+        ESI_ELEMENT_ATTEMPT,
+        ESI_ELEMENT_EXCEPT,
+        ESI_ELEMENT_VARS,
+        ESI_ELEMENT_CHOOSE,
+        ESI_ELEMENT_WHEN,
+        ESI_ELEMENT_OTHERWISE
+    };
+    static ESIElementType_t IdentifyElement (const char *);
+    virtual bool addElement(ESIElement::Pointer)
+    {
+        /* Don't accept children */
+        debug (86,5)("ESIElement::addElement: Failed for %p\n",this);
+        return false;
+    }
+
+    virtual void render (ESISegment::Pointer) = 0;
+    /* process this element */
+    virtual esiProcessResult_t process (int dovars)
+    {
+        debug (86,5) ("esiProcessComplete: Processed %p\n",this);
+        return ESI_PROCESS_COMPLETE;
+    }
+
+    virtual void deleteSelf() const = 0;
+
+    virtual bool mayFail() const
+    {
+        return true;
+    }
+
+    virtual Pointer makeCacheable() const = 0;
+    virtual Pointer makeUsable(esiTreeParentPtr, esiVarState &) const = 0;
+
+    /* The top level no longer needs this element */
+    virtual void finish() = 0;
+};
+
+#endif /* SQUID_ESIELEMENT_H */
@@ -0,0 +1,54 @@
+/*
+ * $Id: ESIExcept.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ * Copyright (c) 2003, Robert Collins <robertc@squid-cache.org>
+ */
+
+#ifndef SQUID_ESIEXCEPT_H
+#define SQUID_ESIEXCEPT_H
+
+#include "squid.h"
+#include "ESIElement.h"
+#include "ESISequence.h"
+
+/* esiExcept */
+
+struct esiExcept : public esiSequence
+{
+    //    void *operator new (size_t byteCount);
+    //    void operator delete (void *address);
+    void deleteSelf() const;
+    esiExcept(esiTreeParentPtr aParent) : esiSequence (aParent) {}}
+
+;
+
+#endif /* SQUID_ESIEXCEPT_H */
@@ -0,0 +1,110 @@
+
+/*
+ * $Id: ESIExpatParser.cc,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+#include "ESIExpatParser.h"
+
+void
+ESIExpatParser::deleteSelf() const
+{
+    delete this;
+}
+
+ESIExpatParser::ESIExpatParser(ESIParserClient *aClient) : theClient (aClient)
+{
+    /* TODO: grab the document encoding from the headers */
+    p = XML_ParserCreateNS(NULL,'|');
+    XML_SetUserData (myParser(), static_cast<void *>(this));
+    XML_SetElementHandler(myParser(), Start, End);
+    XML_SetDefaultHandler(myParser(), Default);
+    XML_SetCommentHandler(myParser(), Comment);
+    XML_UseParserAsHandlerArg(myParser());
+}
+
+ESIExpatParser::~ESIExpatParser()
+{
+    XML_ParserFree (myParser());
+    p = NULL;
+}
+
+void
+ESIExpatParser::Start(void *data,const XML_Char *el, const char **attr)
+{
+    XML_Parser parser = static_cast<XML_Parser>(data);
+    ESIExpatParser *me = (ESIExpatParser *)XML_GetUserData(parser);
+    me->theClient->start (el, attr, XML_GetSpecifiedAttributeCount (parser));
+}
+
+void
+ESIExpatParser::End(void *data,const XML_Char *el)
+{
+    XML_Parser parser = static_cast<XML_Parser>(data);
+    ESIExpatParser *me = (ESIExpatParser *)XML_GetUserData(parser);
+    me->theClient->end (el);
+}
+
+void
+ESIExpatParser::Default(void *data, const XML_Char *s, int len)
+{
+    XML_Parser parser = static_cast<XML_Parser>(data);
+    ESIExpatParser *me = (ESIExpatParser *)XML_GetUserData(parser);
+    me->theClient->parserDefault (s, len);
+}
+
+void
+ESIExpatParser::Comment(void *data, const XML_Char *s)
+{
+    XML_Parser parser = static_cast<XML_Parser>(data);
+    ESIExpatParser *me = (ESIExpatParser *)XML_GetUserData(parser);
+    me->theClient->parserComment (s);
+}
+
+bool
+ESIExpatParser::parse(char const *dataToParse, size_t const lengthOfData, bool const endOfStream)
+{
+    return XML_Parse(myParser(), dataToParse, lengthOfData, endOfStream);
+}
+
+size_t
+ESIExpatParser::lineNumber() const
+{
+    return XML_GetCurrentLineNumber(myParser());
+}
+
+char const *
+ESIExpatParser::errorString() const
+{
+    return XML_ErrorString(XML_GetErrorCode(myParser()));
+}
@@ -0,0 +1,62 @@
+/*
+ * $Id: ESIExpatParser.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef SQUID_ESIEXPATPARSER_H
+#define SQUID_ESIEXPATPARSER_H
+
+#include "ESIParser.h"
+#include "expat.h"
+
+class ESIExpatParser : public ESIParser
+{
+
+public:
+    virtual void deleteSelf() const;
+    ESIExpatParser(ESIParserClient *);
+    ~ESIExpatParser();
+    /* true on success */
+    bool parse(char const *dataToParse, size_t const lengthOfData, bool const endOfStream);
+    size_t lineNumber() const;
+    char const * errorString() const;
+
+private:
+    mutable XML_Parser p; /* our parser */
+    static void Start(void *data, const char *el, const char **attr);
+    static void End(void *data, const char *el);
+    static void Default (void *data, const char *s, int len);
+    static void Comment (void *data, const char *s);
+    XML_Parser &myParser() const {return p;}
+
+    ESIParserClient *theClient;
+};
+
+#endif /* SQUID_ESIEXPATPARSER_H */
@@ -0,0 +1,1097 @@
+
+/*
+ * $Id: ESIExpression.cc,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+
+/* stack precedence rules:
+ * before pushing an operator onto the stack, the 
+ * top 2 elements are checked. if either has a higher
+ * or equal precedence than the current operator, they
+ * are evaluated. 
+ * Start of expression has 5 precedence, 
+ * end of expression has 0 precedence
+ * literal has 1 as does expression results
+ * | has 2
+ * & has 3
+ * ! has 4
+ * == != < > <= >= has 5
+ * ( has 5
+ * ) has 0
+ */
+
+typedef struct _stackmember stackmember;
+
+typedef int evaluate (stackmember * stack, int *depth, int whereAmI,
+                      stackmember * candidate);
+
+typedef enum
+{
+    ESI_EXPR_INVALID,
+    ESI_EXPR_LITERAL,
+    ESI_EXPR_OR,
+    ESI_EXPR_AND,
+    ESI_EXPR_NOT,
+    ESI_EXPR_START,
+    ESI_EXPR_END,
+    ESI_EXPR_EQ,
+    ESI_EXPR_NOTEQ,
+    ESI_EXPR_LESS,
+    ESI_EXPR_LESSEQ,
+    ESI_EXPR_MORE,
+    ESI_EXPR_MOREEQ,
+    ESI_EXPR_EXPR			/* the result of an expr PRI 1 */
+}
+evaltype;
+
+typedef enum
+{
+    ESI_LITERAL_STRING,
+    ESI_LITERAL_FLOAT,
+    ESI_LITERAL_INT,
+    ESI_LITERAL_BOOL,
+    ESI_LITERAL_INVALID
+}
+literalhint;
+
+struct _stackmember
+{
+    evaluate *eval;
+    union
+    {
+        char *string;
+        double floating;
+        int integral;
+    }
+    value;
+    literalhint valuestored;
+    evaltype valuetype;
+    int precedence;
+};
+
+static void cleanmember (stackmember *);
+static void stackpop (stackmember * s, int *depth);
+
+void
+cleanmember (stackmember * s)
+{
+    if (s->valuetype == ESI_EXPR_LITERAL
+            && s->valuestored == ESI_LITERAL_STRING) {
+        safe_free (s->value.string);
+        s->value.string = NULL;
+    }
+
+}
+
+void
+stackpop (stackmember * s, int *depth)
+{
+    if (!(*depth)--)
+        return;
+
+    cleanmember (&s[*depth]);
+}
+
+static evaluate evalnegate;
+static evaluate evalliteral;
+static evaluate evalor;
+static evaluate evaland;
+static evaluate evallesseq;
+static evaluate evallessthan;
+static evaluate evalmoreeq;
+static evaluate evalmorethan;
+static evaluate evalequals;
+static evaluate evalnotequals;
+static evaluate evalstartexpr;
+static evaluate evalendexpr;
+static evaluate evalexpr;
+static void dumpstack (stackmember * stack, int depth);
+static int addmember (stackmember * stack, int *stackdepth,
+                      stackmember * candidate);
+static int membercompare (stackmember a, stackmember b);
+static char const *trim (char const *s);
+static stackmember getsymbol (const char *s, char const **endptr);
+static void printliteral (stackmember s);
+static void printmember (stackmember s);
+
+
+
+
+extern int
+    esiExpressionEval (char const *s);
+
+
+/* -2 = failed to compate
+ * -1 = a less than b
+ * 0 = a equal b
+ * 2 - a more than b
+ */
+int
+membercompare (stackmember a, stackmember b)
+{
+    /* we can compare: sub expressions to sub expressions ,
+     * literals to literals
+     */
+
+    if (!((a.valuetype == ESI_EXPR_LITERAL && b.valuetype == ESI_EXPR_LITERAL &&
+            a.valuestored != ESI_LITERAL_INVALID && b.valuestored != ESI_LITERAL_INVALID) ||
+            (a.valuetype == ESI_EXPR_EXPR && b.valuetype == ESI_EXPR_EXPR)))
+        return -2;
+
+    if (a.valuetype == ESI_EXPR_EXPR) {
+        if (a.value.integral == b.value.integral)
+            return 0;
+        else
+            return 1;
+    } else if (a.valuestored == ESI_LITERAL_STRING) {
+        if (b.valuestored == ESI_LITERAL_STRING) {
+            int i =strcmp (a.value.string, b.value.string);
+
+            if (i < 0)
+                return -1;
+
+            if (i > 0)
+                return 1;
+
+            return 0;
+        } else {
+            /* TODO: numeric to string conversion ? */
+            debug (86,1) ("strcmp with non-string\n");
+            return -2;
+        }
+    } else if (a.valuestored == ESI_LITERAL_FLOAT) {
+        if (b.valuestored == ESI_LITERAL_INT) {
+            if (fabs(a.value.floating - b.value.integral) < 0.00001)
+                return 0;
+            else if (a.value.floating < b.value.integral)
+                return -1;
+            else
+                return 1;
+        } else if (b.valuestored == ESI_LITERAL_FLOAT) {
+            if (a.value.floating == b.value.floating)
+                return 0;
+            else if (a.value.floating < b.value.floating)
+                return -1;
+            else
+                return 1;
+        } else {
+            /* TODO: attempt numeric converson again? */
+            debug (86,1) ("floatcomp with non float or int\n");
+            return -2;
+        }
+    } else if (a.valuestored == ESI_LITERAL_INT) {
+        if (b.valuestored == ESI_LITERAL_INT) {
+            if (a.value.integral == b.value.integral)
+                return 0;
+            else if (a.value.integral < b.value.integral)
+                return -1;
+            else
+                return 1;
+        } else if (b.valuestored == ESI_LITERAL_FLOAT) {
+            if (fabs(a.value.integral - b.value.floating) < 0.00001)
+                return 0;
+            else if (a.value.integral < b.value.floating)
+                return -1;
+            else
+                return 1;
+        } else {
+            /* TODO: attempt numeric converson again? */
+            debug (86,1) ("intcomp vs non float non int\n");
+            return -2;
+        }
+    }
+
+    return -2;
+}
+
+/* return 0 on success, 1 on failure */
+int evalnegate
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    if (stack[whereAmI + 1].valuetype != ESI_EXPR_EXPR)
+        /* invalid operand */
+        return 1;
+
+    /* copy down */
+    --(*depth);
+
+    stack[whereAmI] = stack[(*depth)];
+
+    cleanmember (candidate);
+
+    if (stack[whereAmI].value.integral == 1)
+        stack[whereAmI].value.integral = 0;
+    else
+        stack[whereAmI].value.integral = 1;
+
+    return 0;
+}
+
+int evalliteral
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    debug (86,1) ("attempt to evaluate a literal\n");
+    /* literals can't be evaluated */
+    return 1;
+}
+
+int evalexpr
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    debug (86,1) ("attempt to evaluate a sub-expression result\n");
+    /* sub-scpr's can't be evaluated */
+    return 1;
+}
+
+
+int evalor
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    if (stack[whereAmI + 1].valuetype != ESI_EXPR_EXPR ||
+            stack[whereAmI - 1].valuetype != ESI_EXPR_EXPR)
+        /* invalid operand */
+        return 1;
+
+    rv = stack[whereAmI - 1].value.integral || stack[whereAmI + 1].value.integral;
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);      /* arg rhs */
+
+    stackpop (stack, depth);      /* me */
+
+    stackpop (stack, depth);      /* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalliteral;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv ? 1 : 0;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    return 0;
+}
+
+int evaland
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    if (stack[whereAmI + 1].valuetype != ESI_EXPR_EXPR ||
+            stack[whereAmI - 1].valuetype != ESI_EXPR_EXPR)
+        /* invalid operand */
+        return 1;
+
+    rv = stack[whereAmI - 1].value.integral && stack[whereAmI + 1].value.integral;
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);      /* arg rhs */
+
+    stackpop (stack, depth);      /* me */
+
+    stackpop (stack, depth);      /* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalexpr;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv ? 1 : 0;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    return 0;
+}
+
+int evallesseq
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    rv = membercompare (stack[whereAmI - 1], stack[whereAmI + 1]);
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);      /* arg rhs */
+
+    stackpop (stack, depth);      /* me */
+
+    stackpop (stack, depth);      /* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalexpr;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv <= 0 ? 1 : 0;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    /* debug (86,1) ("?= %d \n", srv.value.integral); */
+    return 0;
+
+
+}
+
+int evallessthan
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    rv = membercompare (stack[whereAmI - 1], stack[whereAmI + 1]);
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);      /* arg rhs */
+
+    stackpop (stack, depth);      /* me */
+
+    stackpop (stack, depth);      /* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalexpr;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv < 0 ? 1 : 0;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    /* debug (86,1) ("?= %d \n", srv.value.integral); */
+    return 0;
+
+
+}
+
+int evalmoreeq
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    rv = membercompare (stack[whereAmI - 1], stack[whereAmI + 1]);
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);      /* arg rhs */
+
+    stackpop (stack, depth);      /* me */
+
+    stackpop (stack, depth);      /* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalexpr;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv >= 0 ? 1 : 0;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    /* debug (86,1) ("?= %d \n", srv.value.integral); */
+    return 0;
+
+
+}
+
+int evalmorethan
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    rv = membercompare (stack[whereAmI - 1], stack[whereAmI + 1]);
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);	/* arg rhs */
+
+    stackpop (stack, depth);	/* me */
+
+    stackpop (stack, depth);	/* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalexpr;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv > 0 ? 1 : 0;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    /* debug (86,1) ("?= %d \n", srv.value.integral); */
+    return 0;
+
+}
+
+int
+evalequals (stackmember * stack, int *depth, int whereAmI,
+            stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    rv = membercompare (stack[whereAmI - 1], stack[whereAmI + 1]);
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);	/* arg rhs */
+
+    stackpop (stack, depth);	/* me */
+
+    stackpop (stack, depth);	/* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalexpr;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv ? 0 : 1;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    /* debug (86,1) ("?= %d \n", srv.value.integral); */
+    return 0;
+}
+
+int evalnotequals
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    int rv;
+    stackmember srv;
+
+    if (*depth < 3)
+        /* Not enough operands */
+        return 1;
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    rv = membercompare (stack[whereAmI - 1], stack[whereAmI + 1]);
+
+    if (rv == -2)
+        /* invalid comparison */
+        return 1;
+
+    stackpop (stack, depth);	/* arg rhs */
+
+    stackpop (stack, depth);	/* me */
+
+    stackpop (stack, depth);	/* arg lhs */
+
+    srv.valuetype = ESI_EXPR_EXPR;
+
+    srv.eval = evalexpr;
+
+    srv.valuestored = ESI_LITERAL_BOOL;
+
+    srv.value.integral = rv ? 1 : 0;
+
+    srv.precedence = 1;
+
+    stack[(*depth)++] = srv;
+
+    /* we're out of way, try adding now */
+    if (!addmember (stack, depth, candidate))
+        /* Something wrong upstream */
+        return 1;
+
+    /* debug (86,1) ("?= %d \n", srv.value.integral); */
+    return 0;
+}
+
+int evalstartexpr
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    /* debug (86,1) ("?(\n"); */
+
+    if (whereAmI != *depth - 2)
+        /* invalid stack */
+        return 1;
+
+    /* Only valid when RHS is an end bracket */
+    if (candidate->valuetype != ESI_EXPR_END)
+        return 1;
+
+    --(*depth);
+
+    stack[whereAmI] = stack[(*depth)];
+
+    cleanmember (candidate);
+
+    return 0;
+}
+
+int evalendexpr
+(stackmember * stack, int *depth, int whereAmI, stackmember * candidate)
+{
+    /* Can't evaluate ) brackets */
+    return 1;
+}
+
+char const *
+trim (char const *s)
+{
+    while (*s == ' ')
+        ++s;
+
+    return s;
+}
+
+stackmember
+getsymbol (const char *s, char const **endptr)
+{
+    stackmember rv;
+    char *end;
+    char const *origs = s;
+    /* trim whitespace */
+    s = trim (s);
+    rv.eval = NULL;		/* A literal */
+    rv.valuetype = ESI_EXPR_INVALID;
+    rv.valuestored = ESI_LITERAL_INVALID;
+
+    if (('0' <= *s && *s <= '9') || *s == '-') {
+        size_t length = strspn (s, "0123456789.");
+        char *point;
+
+        if ((point = strchr (s, '.')) && point - s < (ssize_t)length) {
+            /* floating point */
+            rv.value.floating = strtod (s, &end);
+
+            if (s == end || errno) {
+                /* Couldn't convert to float */
+                debug (86,1) ("failed to convert '%s' to float \n", s);
+                *endptr = origs;
+            } else {
+                debug (86,6) ("found %f of length %d\n",rv.value.floating, end - s);
+                *endptr = end;
+                rv.eval = evalliteral;
+                rv.valuestored = ESI_LITERAL_FLOAT;
+                rv.valuetype = ESI_EXPR_LITERAL;
+                rv.precedence = 1;
+            }
+        } else {
+            /* INT */
+            rv.value.integral = strtol (s, &end, 0);
+
+            if (s == end || errno) {
+                /* Couldn't convert to int */
+                debug (86,1) ("failed to convert '%s' to int \n", s);
+                *endptr = origs;
+            } else {
+                debug (86,6) ("found %d of length %d\n",rv.value.integral, end - s);
+                *endptr = end;
+                rv.eval = evalliteral;
+                rv.valuestored = ESI_LITERAL_INT;
+                rv.valuetype = ESI_EXPR_LITERAL;
+                rv.precedence = 1;
+            }
+        }
+    } else if ('!' == *s) {
+        if ('=' == *(s + 1)) {
+            debug (86,6) ("found !=\n");
+            *endptr = s + 2;
+            rv.eval = evalnotequals;
+            rv.valuetype = ESI_EXPR_NOTEQ;
+            rv.precedence = 5;
+        } else {
+            debug (86,6) ("found !\n");
+            *endptr = s + 1;
+            rv.valuetype = ESI_EXPR_NOT;
+            rv.precedence = 4;
+            rv.eval = evalnegate;
+        }
+    } else if ('\'' == *s) {
+        char const *t = s + 1;
+        debug (86,6) ("found \'\n");
+
+        while (*t != '\'' && *t)
+            ++t;
+
+        if (!*t) {
+            debug (86,1) ("missing end \' in '%s'\n", s);
+            *endptr = origs;
+        } else {
+            *endptr = t + 1;
+            rv.value.string = xstrndup (s + 1, t - s - 1);
+            rv.eval = evalliteral;
+            rv.valuestored = ESI_LITERAL_STRING;
+            rv.valuetype = ESI_EXPR_LITERAL;
+            rv.precedence = 1;
+            debug (86,6) ("found  string '%s'\n", rv.value.string);
+        }
+    } else if ('(' == *s) {
+        debug (86,6)("found subexpr start\n");
+        *endptr = s + 1;
+        rv.valuetype = ESI_EXPR_START;
+        rv.precedence = 5;
+        rv.eval = evalstartexpr;
+    } else if (')' == *s) {
+        debug (86,6)("found subexpr end\n");
+        *endptr = s + 1;
+        rv.valuetype = ESI_EXPR_END;
+        rv.precedence = 0;
+        rv.eval = evalendexpr;
+    } else if ('&' == *s) {
+        debug (86,6) ("found AND\n");
+        *endptr = s + 1;
+        rv.valuetype = ESI_EXPR_AND;
+        rv.precedence = 3;
+        rv.eval = evaland;
+    } else if ('|' == *s) {
+        debug (86,6) ("found OR\n");
+        *endptr = s + 1;
+        rv.valuetype = ESI_EXPR_OR;
+        rv.precedence = 2;
+        rv.eval = evalor;
+    } else if ('=' == *s) {
+        if ('=' == *(s + 1)) {
+            debug (86,6) ("found equals\n");
+            *endptr = s + 2;
+            rv.valuetype = ESI_EXPR_EQ;
+            rv.precedence = 5;
+            rv.eval = evalequals;
+        } else {
+            debug (86,1) ("invalid expr '%s'\n", s);
+            *endptr = origs;
+        }
+    } else if ('<' == *s) {
+        if ('=' == *(s + 1)) {
+            debug (86,6) ("found less-equals\n");
+            *endptr = s + 2;
+            rv.valuetype = ESI_EXPR_LESSEQ;
+            rv.precedence = 5;
+            rv.eval = evallesseq;
+        } else {
+            debug (86,6) ("found less than\n");
+            *endptr = s + 1;
+            rv.valuetype = ESI_EXPR_LESS;
+            rv.precedence = 5;
+            rv.eval = evallessthan;
+        }
+    } else if ('>' == *s) {
+        if ('=' == *(s + 1)) {
+            debug (86,6) ("found more-equals\n");
+            *endptr = s + 2;
+            rv.valuetype = ESI_EXPR_MOREEQ;
+            rv.precedence = 5;
+            rv.eval = evalmoreeq;
+        } else {
+            debug (86,6) ("found more than\n");
+            *endptr = s + 1;
+            rv.valuetype = ESI_EXPR_MORE;
+            rv.precedence = 5;
+            rv.eval = evalmorethan;
+        }
+    } else if (!strncmp (s, "false", 5)) {
+        debug (86,5)("getsymbol: found variable result 'false'\n");
+        *endptr = s + 5;
+        rv.valuetype = ESI_EXPR_EXPR;
+        rv.valuestored = ESI_LITERAL_BOOL;
+        rv.value.integral = 0;
+        rv.precedence = 1;
+        rv.eval = evalexpr;
+    } else if (!strncmp (s, "true", 4)) {
+        debug (86,5)("getsymbol: found variable result 'true'\n");
+        *endptr = s + 4;
+        rv.valuetype = ESI_EXPR_EXPR;
+        rv.valuestored = ESI_LITERAL_BOOL;
+        rv.value.integral = 1;
+        rv.precedence = 1;
+        rv.eval = evalexpr;
+    } else {
+        debug (86,1) ("invalid expr '%s'\n", s);
+        *endptr = origs;
+    }
+
+    return rv;
+}
+
+void
+printliteral (stackmember s)
+{
+    switch (s.valuestored) {
+
+    case ESI_LITERAL_INVALID:
+        debug (86,1) (" Invalid ");
+        break;
+
+    case ESI_LITERAL_FLOAT:
+        debug (86,1) ("%f", s.value.floating);
+        break;
+
+    case ESI_LITERAL_STRING:
+        debug (86,1) ("'%s'", s.value.string);
+        break;
+
+    case ESI_LITERAL_INT:
+        debug (86,1) ("%d", s.value.integral);
+        break;
+
+    case ESI_LITERAL_BOOL:
+        debug (86,1)("%s",s.value.integral ? "true" : "false");
+    }
+}
+
+void
+printmember (stackmember s)
+{
+    switch (s.valuetype) {
+
+    case ESI_EXPR_INVALID:
+        debug (86,1) (" Invalid ");
+        break;
+
+    case ESI_EXPR_LITERAL:
+        printliteral (s);
+        break;
+
+    case ESI_EXPR_EXPR:
+        debug (86,1) ("%s", s.value.integral ? "true" : "false");
+        break;
+
+    case ESI_EXPR_OR:
+        debug (86,1) ("|");
+        break;
+
+    case ESI_EXPR_AND:
+        debug (86,1) ("&");
+        break;
+
+    case ESI_EXPR_NOT:
+        debug (86,1) ("!");
+        break;
+
+    case ESI_EXPR_START:
+        debug (86,1) ("(");
+        break;
+
+    case ESI_EXPR_END:
+        debug (86,1) (")");
+        break;
+
+    case ESI_EXPR_EQ:
+        debug (86,1) ("==");
+        break;
+
+    case ESI_EXPR_NOTEQ:
+        debug (86,1) ("!=");
+        break;
+
+    case ESI_EXPR_LESS:
+        debug (86,1) ("<");
+        break;
+
+    case ESI_EXPR_LESSEQ:
+        debug (86,1) ("<=");
+        break;
+
+    case ESI_EXPR_MORE:
+        debug (86,1) (">");
+        break;
+
+    case ESI_EXPR_MOREEQ:
+        debug (86,1) (">=");
+        break;
+    }
+}
+
+void
+dumpstack (stackmember * stack, int depth)
+{
+    int i;
+
+    for (i = 0; i < depth; ++i)
+        printmember (stack[i]);
+
+    if (depth)
+        debug (86,1) ("\n");
+}
+
+int
+addmember (stackmember * stack, int *stackdepth, stackmember * candidate)
+{
+    if (candidate->valuetype != ESI_EXPR_LITERAL && *stackdepth > 1) {
+        /* !(!(a==b))) is why thats safe */
+        /* strictly less than until we unwind */
+
+        if (candidate->precedence < stack[*stackdepth - 1].precedence ||
+                candidate->precedence < stack[*stackdepth - 2].precedence) {
+            /* must be an operator */
+
+            if (stack[*stackdepth - 2].valuetype == ESI_EXPR_LITERAL ||
+                    stack[*stackdepth - 2].valuetype == ESI_EXPR_INVALID ||
+                    stack[*stackdepth - 2].eval (stack, stackdepth,
+                                                 *stackdepth - 2, candidate)) {
+                /* cleanup candidate and stack */
+                dumpstack (stack, *stackdepth);
+                cleanmember (candidate);
+                debug (86,1) ("invalid expression\n");
+                return 0;
+            }
+        } else {
+            stack[(*stackdepth)++] = *candidate;
+        }
+    } else if (candidate->valuetype != ESI_EXPR_INVALID)
+        stack[(*stackdepth)++] = *candidate;
+
+    return 1;
+}
+
+int
+esiExpressionEval (char const *s)
+{
+    stackmember stack[20];
+    int stackdepth = 0;
+    char const *end;
+    PROF_start(esiExpressionEval);
+
+    while (*s) {
+        stackmember candidate = getsymbol (s, &end);
+
+        if (candidate.valuetype != ESI_EXPR_INVALID) {
+            assert (s != end);
+
+            if (!addmember (stack, &stackdepth, &candidate)) {
+                PROF_stop(esiExpressionEval);
+                return 0;
+            }
+
+            s = end;
+        } else {
+            assert (s == end);
+            debug (86,1) ("failed parsing expression\n");
+            PROF_stop(esiExpressionEval);
+            return 0;
+        }
+    }
+
+    if (stackdepth > 1) {
+        stackmember rv;
+        rv.valuetype = ESI_EXPR_INVALID;
+        rv.precedence = 0;
+
+        if (stack[stackdepth - 2].
+                eval (stack, &stackdepth, stackdepth - 2, &rv)) {
+            /* special case - leading operator failed */
+            debug (86,1) ("invalid expression\n");
+            PROF_stop(esiExpressionEval);
+            return 0;
+        }
+    }
+
+    if (stackdepth == 0) {
+        /* Empty expression - evaluate to false */
+        PROF_stop(esiExpressionEval);
+        return 0;
+    }
+
+    /* if we hit here, we think we have a valid result */
+    assert (stackdepth == 1);
+
+    assert (stack[0].valuetype == ESI_EXPR_EXPR);
+
+    PROF_stop(esiExpressionEval);
+
+    return stack[0].value.integral ? 1 : 0;
+}
+
+#if TESTING
+int
+main ()
+{
+    char const *expressions[] = {
+                                    "!(1==1)", "!(1!=1)", "1!=1", "!1==1", "1==1",
+                                    "1 <=1","2<=1", "1 < 1", "1 < 2", "-1 < 1","!-1<1",
+                                    "1>2","2>1","2>=2", "2>3", "1==1&1==1","1==1&1==0",
+                                    "!('a'<='c')",
+                                    "(1==1)|('abc'=='def')",
+                                    "(4!=5)&(4==5)",
+                                    "(1==1)|(2==3)&(3==4)",	/* should be true because of precedence */
+                                    "(1 & 4)",
+                                    "(\"abc\" | \"edf\")", "1==1==1",
+                                };
+
+    int i = 0;
+
+    while (strlen (expressions[i])) {
+        printf("Expr '%s' = '%s'\n", expressions[i],
+               expreval (expressions[i]) ? "true" : "false");
+        ++i;
+    }
+
+    return 0;
+}
+
+#endif
@@ -0,0 +1,78 @@
+/*
+ * $Id: ESILiteral.h,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ * Copyright (c) 2003, Robert Collins <robertc@squid-cache.org>
+ */
+
+#ifndef SQUID_ESILITERAL_H
+#define SQUID_ESILITERAL_H
+
+#include "squid.h"
+#include "ESIElement.h"
+
+class ESIContext;
+/* esiLiteral */
+
+struct esiLiteral : public ESIElement
+{
+    void *operator new (size_t byteCount);
+    void operator delete (void *address);
+    void deleteSelf() const;
+
+    esiLiteral(ESISegment::Pointer);
+    esiLiteral(ESIContext *, const char *s, int len);
+    ~esiLiteral();
+
+    void render(ESISegment::Pointer);
+    esiProcessResult_t process (int dovars);
+    Pointer makeCacheable() const;
+    Pointer makeUsable(esiTreeParentPtr, esiVarState &) const;
+    /* optimise copies away later */
+    ESISegment::Pointer buffer;
+
+    struct
+    {
+
+int donevars:
+        1;
+    }
+
+    flags;
+    esiVarState *varState;
+    void finish();
+
+private:
+    static MemPool *pool;
+    esiLiteral(esiLiteral const &);
+};
+
+#endif /* SQUID_ESILITERAL_H */
@@ -0,0 +1,55 @@
+
+/*
+ * $Id: ESIParser.cc,v 1.1 2003/03/10 04:56:35 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+#include "ESIParser.h"
+#include "ESIExpatParser.h"
+#include "ESICustomParser.h"
+
+char *ESIParser::Type = NULL;
+
+ESIParser::Pointer
+ESIParser::NewParser(ESIParserClient *aClient)
+{
+    if (!strcasecmp("expat", Type))
+        return new ESIExpatParser (aClient);
+
+    if (!strcasecmp("custom", Type))
+        return new ESICustomParser (aClient);
+
+    fatal ("Unknown ESI Parser type");
+
+    return NULL;
+}
@@ -0,0 +1,65 @@
+/*
+ * $Id: ESIParser.h,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef SQUID_ESIPARSER_H
+#define SQUID_ESIPARSER_H
+
+class ESIParserClient
+{
+
+public:
+    virtual void start(const char *el, const char **attr, size_t attrCount) = 0;
+    virtual void end(const char *el) = 0;
+    virtual void parserDefault (const char *s, int len) =0;
+    virtual void parserComment (const char *s) = 0;
+};
+
+class ESIParser : public RefCountable
+{
+
+public:
+    typedef RefCount<ESIParser> Pointer;
+    static Pointer NewParser(ESIParserClient *aClient);
+    static char *Type;
+    virtual void deleteSelf() const =0;
+    /* true on success */
+    virtual bool parse(char const *dataToParse, size_t const lengthOfData, bool const endOfStream) = 0;
+    virtual size_t lineNumber() const =0;
+    virtual char const * errorString() const =0;
+
+protected:
+    ESIParser(){};
+
+private:
+};
+
+#endif /* SQUID_ESIPARSER_H */
@@ -0,0 +1,246 @@
+
+/*
+ * $Id: ESISegment.cc,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+#include "ESISegment.h"
+#include "SquidString.h"
+
+CBDATA_TYPE(ESISegment);
+
+/* ESISegment */
+void
+ESISegmentFreeList (ESISegment::Pointer &head)
+{
+    while (head.getRaw()) {
+        ESISegment::Pointer temp = head;
+        head = head->next;
+        temp->next = NULL;
+    }
+}
+
+size_t
+ESISegment::space() const
+{
+    assert (len <= sizeof(buf));
+    return sizeof (buf) - len;
+}
+
+void
+ESISegment::adsorbList (ESISegment::Pointer from)
+{
+    assert (next.getRaw() == NULL);
+    assert (from.getRaw() != NULL);
+    /* prevent worst case */
+    assert (!(len == 0 && from->len == space() ));
+    Pointer copyFrom = from;
+
+    while (copyFrom.getRaw() && space() >= copyFrom->len) {
+        assert (append (copyFrom) == copyFrom->len);
+        copyFrom = copyFrom->next;
+    }
+
+    next = copyFrom;
+}
+
+void
+ESISegment::ListTransfer (ESISegment::Pointer &from, ESISegment::Pointer &to)
+{
+    if (!to.getRaw()) {
+        to = from;
+        from = NULL;
+        return;
+    }
+
+    ESISegment::Pointer temp = to->tail();
+    temp->adsorbList (from);
+    from = NULL;
+}
+
+size_t
+ESISegment::listLength() const
+{
+    size_t result = 0;
+    ESISegment const* temp = this;
+
+    while (temp) {
+        result += temp->len;
+        temp = temp->next.getRaw();
+    }
+
+    return result;
+}
+
+char *
+ESISegment::listToChar() const
+{
+    size_t length = listLength();
+    char *rv = (char *)xmalloc (length + 1);
+    assert (rv);
+    rv [length] = '\0';
+
+    ESISegment::Pointer temp = this;
+    size_t pos = 0;
+
+    while (temp.getRaw()) {
+        xmemcpy (&rv[pos], temp->buf, temp->len);
+        pos += temp->len;
+        temp = temp->next;
+    }
+
+    return rv;
+}
+
+void
+ESISegment::listAppend (char const *s, size_t length)
+{
+    assert (next.getRaw() == NULL);
+    ESISegment::Pointer output = this;
+    /* copy the string to output */
+    size_t pos=0;
+
+    while (pos < length) {
+        if (output->space() == 0) {
+            assert (output->next.getRaw() == NULL);
+            output->next = new ESISegment;
+            output = output->next;
+        }
+
+        pos += output->append(s + pos, length - pos);
+    }
+}
+
+void
+ESISegment::ListAppend (ESISegment::Pointer &head, char const *s, size_t len)
+{
+    if (!head.getRaw())
+        head = new ESISegment;
+
+    head->tail()->listAppend (s, len);
+}
+
+void *
+ESISegment::operator new(size_t byteCount)
+{
+    assert (byteCount == sizeof (ESISegment));
+    void *rv;
+    CBDATA_INIT_TYPE(ESISegment);
+    rv = (void *)cbdataAlloc (ESISegment);
+    return rv;
+}
+
+void
+ESISegment::operator delete (void *address)
+{
+    cbdataFree ((ESISegment *)address);
+}
+
+void
+ESISegment::deleteSelf() const
+{
+    delete this;
+}
+
+/* XXX: if needed, make this iterative */
+ESISegment::Pointer
+ESISegment::cloneList () const
+{
+    ESISegment::Pointer result = new ESISegment (*this);
+    result->next = next.getRaw() ? next->cloneList() : NULL;
+    return result;
+}
+
+size_t
+ESISegment::append(char const *appendBuffer, size_t appendLength)
+{
+    size_t toCopy = min(appendLength, space());
+    xmemcpy (&buf[len], appendBuffer, toCopy);
+    len += toCopy;
+    return toCopy;
+}
+
+size_t
+ESISegment::append(ESISegment::Pointer from)
+{
+    return append (from->buf, from->len);
+}
+
+ESISegment const *
+ESISegment::tail() const
+{
+    ESISegment const *result = this;
+
+    while (result->next.getRaw())
+        result = result->next.getRaw();
+
+    return result;
+}
+
+ESISegment *
+ESISegment::tail()
+{
+    ESISegment::Pointer result = this;
+
+    while (result->next.getRaw())
+        result = result->next;
+
+    return result.getRaw();
+}
+
+ESISegment::ESISegment() : len(0), next(NULL)
+{}
+
+ESISegment::ESISegment(ESISegment const &old) : len (0), next(NULL)
+{
+    append (old.buf, old.len);
+}
+
+void
+ESISegment::dumpToLog() const
+{
+    ESISegment::Pointer temp = this;
+
+    while (temp.getRaw()) {
+        temp->dumpOne();
+        temp = temp->next;
+    }
+}
+
+void
+ESISegment::dumpOne() const
+{
+    String temp;
+    temp.limitInit(buf, len);
+    debug (86, 9) ("ESISegment::dumpOne: \"%s\"\n", temp.buf());
+}
@@ -0,0 +1,78 @@
+/*
+ * $Id: ESISegment.h,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#ifndef SQUID_ESISEGMENT_H
+#define SQUID_ESISEGMENT_H
+
+/* TODO: Factor the store memory segment management into a reusable code block
+ * or perhaps use membuffers here?
+ */
+
+#include "RefCount.h"
+
+class ESISegment : public RefCountable
+{
+
+public:
+    typedef RefCount<ESISegment> Pointer;
+    static void ListAppend (Pointer &, char const *, size_t);
+    static void ListTransfer (Pointer &from, Pointer &to);
+    void *operator new (size_t byteCount);
+    void operator delete (void *address);
+    void deleteSelf() const;
+
+    ESISegment();
+    ESISegment(ESISegment const &);
+    ESISegment::Pointer cloneList() const;
+    char *listToChar() const;
+    void listAppend (char const *s, size_t length);
+    void adsorbList (ESISegment::Pointer from);
+    size_t space() const;
+
+
+    char buf[HTTP_REQBUF_SZ];
+    size_t len; /* how much data has been pushed into this */
+    Pointer next;
+    size_t append(char const *, size_t);
+    size_t append (Pointer);
+    ESISegment const *tail() const;
+    ESISegment *tail();
+    void dumpToLog() const;
+
+private:
+    size_t listLength()const;
+    void dumpOne() const;
+};
+
+extern void ESISegmentFreeList (ESISegment::Pointer &head);
+
+#endif /* SQUID_ESISEGMENT_H */
@@ -0,0 +1,417 @@
+/*
+ * $Id: ESISequence.cc,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ * Copyright (c) 2003, Robert Collins <robertc@squid-cache.org>
+ */
+
+#include "squid.h"
+#include "ESISequence.h"
+#include "ESILiteral.h"
+#include "ESIAttempt.h"
+#include "ESIExcept.h"
+
+class esiExcept;
+
+MemPool *esiSequence::Pool = NULL;
+
+void
+esiSequence::deleteSelf() const
+{
+    delete this;
+}
+
+esiSequence::~esiSequence ()
+{
+    debug (86,5)("esiSequence::~esiSequence %p\n", this);
+}
+
+void *
+esiSequence::operator new(size_t byteCount)
+{
+    assert (byteCount == sizeof (esiSequence));
+
+    if (!Pool)
+        Pool = memPoolCreate ("esiSequence", sizeof (esiSequence));
+
+    return memPoolAlloc (Pool);
+}
+
+void
+esiSequence::operator delete (void *address)
+{
+    memPoolFree (Pool, address);
+}
+
+
+esiSequence::esiSequence(esiTreeParentPtr aParent, bool incrementalFlag) : elements(), parent (aParent), mayFail_(true), failed (false), provideIncrementalData (incrementalFlag), processing (false), processingResult (ESI_PROCESS_COMPLETE), nextElementToProcess_ (0)
+{}
+
+size_t
+esiSequence::nextElementToProcess() const
+{
+    return nextElementToProcess_;
+}
+
+void
+esiSequence::nextElementToProcess(size_t const &aSizeT)
+{
+    nextElementToProcess_ = aSizeT;
+}
+
+bool
+esiSequence::finishedProcessing() const
+{
+    return nextElementToProcess() >= elements.size();
+}
+
+bool
+esiSequence::mayFail () const
+{
+    if (failed)
+        return true;
+
+    return mayFail_;
+}
+
+void
+esiSequence::wontFail()
+{
+    assert (!failed);
+    mayFail_ = false;
+}
+
+void
+esiSequence::render(ESISegment::Pointer output)
+{
+    /* append all processed elements, and trim processed
+     * and rendered elements 
+     */
+    assert (output->next == NULL);
+    debug (86,5)("esiSequenceRender: rendering %d elements\n", processedcount);
+
+    for (size_t i = 0; i < processedcount; ++i) {
+        elements[i]->render(output);
+        elements.setNULL(i,i+1);
+        /* FIXME: pass a ESISegment ** ? */
+        output = output->tail();
+    }
+
+    elements.pop_front (processedcount);
+    processedcount = 0;
+    assert (output->next == NULL);
+}
+
+void
+esiSequence::finish()
+{
+    debug (86,5) ("esiSequence::finish: %p is finished\n", this);
+    elements.setNULL(0, elements.size());
+    parent = NULL;
+}
+
+
+void
+esiSequence::provideData (ESISegment::Pointer data, ESIElement *source)
+{
+    ESIElement::Pointer lockthis = this;
+
+    if (processing)
+        debug (86,5) ("esiSequence::provideData: %p data provided during processing\n", this);
+
+    debug (86,5) ("esiSequence::provideData %p %p %p\n", this, data.getRaw(), source);
+
+    /* when data is provided, the element *must* be completed */
+    /* XXX: when the callback model is complete,
+     * we can introduce 'finished'. And then this rule can be 
+     * relaxed
+     */
+    /* find the index */
+    int index = elementIndex (source);
+
+    assert (index >= 0);
+
+    /* remove the current node */
+    elements.setNULL(index, index+1);
+
+    /* create a literal */
+    esiLiteral *temp = new esiLiteral (data);
+
+    /* insert the literal */
+    elements[index] = temp;
+
+    /* XXX: TODO push any pushable data upwards */
+    /* fail() not done */
+    if (processing)
+        return;
+
+    assert (process (flags.dovars) != ESI_PROCESS_FAILED);
+}
+
+bool
+esiSequence::addElement (ESIElement::Pointer element)
+{
+    /* add an element to the output list */
+    /* Some elements require specific parents */
+
+    if (dynamic_cast<esiAttempt*>(element.getRaw()) ||
+            dynamic_cast<esiExcept*>(element.getRaw())) {
+        debug (86,0)("esiSequenceAdd: misparented Attempt or Except element (section 3.4)\n");
+        return false;
+    }
+
+    /* Tie literals together for efficiency */
+    if (elements.size() && dynamic_cast<esiLiteral*>(element.getRaw()) &&
+            dynamic_cast<esiLiteral*>(elements[elements.size() - 1].getRaw())) {
+        debug (86,5)("esiSequenceAdd: tying Literals %p and %p together\n", elements[elements.size() - 1].getRaw(),
+                     element.getRaw());
+        ESISegment::ListTransfer (((esiLiteral *)element.getRaw())->buffer,
+                                  ((esiLiteral *)elements[elements.size() - 1].getRaw())->buffer);
+        return true;
+    }
+
+    elements.push_back(element);
+    debug (86,3)("esiSequenceAdd: Added a new element, elements = %d\n", elements.size());
+    return true;
+}
+
+int
+esiSequence::elementIndex(ESIElement::Pointer anElement) const
+{
+    for (size_t i = 0; i < elements.size(); ++i)
+        if (elements[i] == anElement)
+            return i;
+
+    return -1;
+}
+
+void
+esiSequence::processStep(int dovars)
+{
+    size_t elementToProcess = nextElementToProcess();
+    nextElementToProcess(elementToProcess + 1);
+    esiProcessResult_t tempResult = processOne(dovars, elementToProcess);
+
+    if (processingResult < tempResult) {
+        debug (86,5)("esiSequence::process: processingResult was %d, increasing to %d\n", processingResult, tempResult);
+        processingResult = tempResult;
+    }
+}
+
+esiProcessResult_t
+esiSequence::processOne(int dovars, size_t index)
+{
+    debug (86,5)("esiSequence::process %p about to process element[%d] %p\n", this, index, elements[index].getRaw());
+
+    switch (elements[index]->process(dovars)) {
+
+    case ESI_PROCESS_COMPLETE:
+        debug (86,5)("esiSequenceProcess: %p element %p Processed OK\n",
+                     this, elements[index].getRaw());
+
+        if (index == processedcount)
+            /* another completely ready */
+            ++processedcount;
+
+        return ESI_PROCESS_COMPLETE;
+
+    case ESI_PROCESS_PENDING_WONTFAIL:
+        debug (86,5)("esiSequenceProcess: element Processed PENDING OK\n");
+
+        return ESI_PROCESS_PENDING_WONTFAIL;
+
+    case ESI_PROCESS_PENDING_MAYFAIL:
+        debug (86,5)("eseSequenceProcess: element Processed PENDING UNKNOWN\n");
+
+        return ESI_PROCESS_PENDING_MAYFAIL;
+
+    case ESI_PROCESS_FAILED:
+        debug (86,5)("esiSequenceProcess: element Processed FAILED\n");
+
+        return ESI_PROCESS_FAILED;
+
+    default:
+        fatal ("unexpected code in esiSequence::processOne\n");
+
+        return ESI_PROCESS_FAILED;
+    }
+}
+
+esiProcessResult_t
+esiSequence::process (int inheritedVarsFlag)
+{
+    debug (86,5) ("esiSequence::process: %p processing\n", this);
+
+    if (processing) {
+        debug (86,5)("esiSequence::process: %p reentry attempt during processing\n", this);
+    }
+
+    /* process as much of the list as we can, stopping only on
+     * faliures
+     */
+    if (!processing || processedcount == 0)
+        processingResult = ESI_PROCESS_COMPLETE;
+
+    int dovars = inheritedVarsFlag;
+
+    if (flags.dovars)
+        dovars = 1;
+
+    debug (86,5)("esiSequence::process: Processing %p with%s variable processing\n", this, dovars ? "" : "out");
+
+    processing = true;
+
+    nextElementToProcess(processedcount);
+
+    while (!finishedProcessing()) {
+        processStep(dovars);
+
+        if (!processing)
+            return processingResult;
+
+        if (processingResult == ESI_PROCESS_FAILED) {
+            elements.setNULL (0, elements.size());
+            failed = true;
+            parent = NULL;
+            processing = false;
+            return processingResult;
+        }
+    }
+
+    assert (processingResult != ESI_PROCESS_COMPLETE || processedcount == elements.size());
+
+    if (processingResult == ESI_PROCESS_COMPLETE || processingResult == ESI_PROCESS_PENDING_WONTFAIL)
+        wontFail();
+
+    if (processedcount == elements.size() || provideIncrementalData) {
+        ESISegment::Pointer temp(new ESISegment);
+        render (temp);
+
+        if (temp->next.getRaw() || temp->len)
+            parent->provideData(temp, this);
+        else
+            ESISegmentFreeList (temp);
+    }
+
+    /* Depends on full parsing before processing */
+    if (processedcount == elements.size())
+        parent = NULL;
+
+    debug (86,5)("esiSequence::process: %p completed\n", this);
+
+    processing = false;
+
+    return processingResult;
+}
+
+void
+esiSequence::fail (ESIElement *source)
+{
+    failed = true;
+
+    if (processing) {
+        debug (86,5) ("esiSequence::fail: %p failure callback during processing\n", this);
+        return;
+    }
+
+    debug (86,5)("esiSequence::fail: %p has failed.\n", this);
+    parent->fail (this);
+    elements.setNULL(0, elements.size());
+    parent = NULL;
+}
+
+esiSequence::esiSequence(esiSequence const &old)
+        : processedcount (0), mayFail_(old.mayFail_), failed (old.failed), provideIncrementalData (old.provideIncrementalData), processing (false), nextElementToProcess_ (0)
+{
+    flags.dovars = old.flags.dovars;
+    parent = NULL;
+}
+
+void
+esiSequence::makeCachableElements(esiSequence const &old)
+{
+    for (size_t counter = 0; counter < old.elements.size(); ++counter) {
+        ESIElement::Pointer newElement = old.elements[counter]->makeCacheable();
+
+        if (newElement.getRaw())
+            assert (addElement(newElement));
+    }
+}
+
+void
+esiSequence::makeUsableElements(esiSequence const &old, esiVarState &newVarState)
+{
+    for (size_t counter = 0; counter < old.elements.size(); ++counter) {
+        ESIElement::Pointer newElement = old.elements[counter]->makeUsable (this, newVarState);
+
+        if (newElement.getRaw())
+            assert (addElement(newElement));
+    }
+}
+
+ESIElement::Pointer
+esiSequence::makeCacheable() const
+{
+    debug (86,5)("esiSequence::makeCacheable: Making cachable sequence from %p\n", this);
+    assert (processedcount == 0);
+    assert (!failed);
+
+    if (elements.size() == 0) {
+        debug (86,5)("esiSequence::makeCacheable: No elements in sequence %p, returning NULL\n", this);
+        return NULL;
+    }
+
+    esiSequence * resultS = new esiSequence (*this);
+    ESIElement::Pointer result = resultS;
+    resultS->makeCachableElements(*this);
+    debug (86,5)("esiSequence::makeCacheable: %p created %p\n", this, result.getRaw());
+    return result;
+}
+
+ESIElement::Pointer
+esiSequence::makeUsable(esiTreeParentPtr newParent, esiVarState &newVarState) const
+{
+    debug (86,5)("esiSequence::makeUsable: Creating usable Sequence\n");
+    assert (processedcount == 0);
+    assert (!failed);
+
+    if (elements.size() == 0) {
+        debug (86,5)("esiSequence::makeUsable: No elements in sequence %p, returning NULL\n", this);
+        return NULL;
+    }
+
+    esiSequence * resultS = new esiSequence (*this);
+    ESIElement::Pointer result = resultS;
+    resultS->parent = newParent;
+    resultS->makeUsableElements(*this, newVarState);
+    return result;
+}
+
@@ -0,0 +1,101 @@
+/*
+ * $Id: ESISequence.h,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ * Copyright (c) 2003, Robert Collins <robertc@squid-cache.org>
+ */
+
+#ifndef SQUID_ESISEQUENCE_H
+#define SQUID_ESISEQUENCE_H
+
+#include "squid.h"
+#include "ESIElement.h"
+#include "ElementList.h"
+
+/* esiSequence */
+
+class esiSequence : public ESIElement
+{
+
+public:
+    void *operator new (size_t byteCount);
+    void operator delete (void *address);
+    void deleteSelf() const;
+
+    esiSequence(esiTreeParentPtr, bool = false);
+    ~esiSequence();
+
+    void render(ESISegment::Pointer);
+    bool addElement (ESIElement::Pointer);
+    esiProcessResult_t process (int dovars);
+    void provideData (ESISegment::Pointer, ESIElement*);
+    bool mayFail () const;
+    void wontFail();
+    void fail(ESIElement *);
+    void makeCachableElements(esiSequence const &old);
+    Pointer makeCacheable() const;
+    void makeUsableElements(esiSequence const &old, esiVarState &);
+    Pointer makeUsable(esiTreeParentPtr, esiVarState &) const;
+
+    ElementList elements; /* unprocessed or rendered nodes */
+    size_t processedcount;
+
+    struct
+    {
+
+int dovars:
+        1; /* for esiVar */
+    }
+
+    flags;
+    void finish();
+
+protected:
+    esiSequence(esiSequence const &);
+    esiTreeParentPtr parent;
+
+private:
+    static MemPool *Pool;
+    int elementIndex (ESIElement::Pointer anElement) const;
+    bool mayFail_;
+    bool failed;
+    esiProcessResult_t processOne(int, size_t);
+    bool const provideIncrementalData;
+    bool processing;
+    esiProcessResult_t processingResult;
+    size_t nextElementToProcess_;
+    size_t nextElementToProcess() const;
+    void nextElementToProcess(size_t const &);
+    bool finishedProcessing() const;
+    void processStep(int dovars);
+};
+
+#endif /* SQUID_ESISEQUENCE_H */
@@ -0,0 +1,67 @@
+/*
+ * $Id: ElementList.h,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ * DEBUG: section 86    ESI processing
+ * AUTHOR: Robert Collins
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ * Copyright (c) 2003, Robert Collins <robertc@squid-cache.org>
+ */
+
+#ifndef SQUID_ELEMENTLIST_H
+#define SQUID_ELEMENTLIST_H
+
+#include "squid.h"
+#include "ESIElement.h"
+
+class ElementList
+{
+
+public:
+    ElementList();
+    ~ElementList();
+
+    ESIElement::Pointer &operator[](int);
+    ESIElement::Pointer const &operator[](int)const;
+    ESIElement::Pointer * elements; /* unprocessed or rendered nodes */
+    void pop_front (size_t const);
+    void push_back(ESIElement::Pointer &);
+    size_t size() const;
+    void setNULL (int start, int end);
+
+    int allocedcount;
+    size_t allocedsize;
+    int elementcount;
+
+private:
+    ElementList(ElementList const &);
+    ElementList &operator=(ElementList const&);
+};
+
+
+#endif /* SQUID_ELEMENTLIST_H */
@@ -0,0 +1,402 @@
+
+/*
+ * $Id: HttpHdrSc.cc,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ * DEBUG: section 90    HTTP Cache Control Header
+ * AUTHOR: Alex Rousskov
+ *         Robert Collins (Surrogate-Control is derived from
+ *         		   Cache-Control).
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+#include "Store.h"
+#include "HttpHeader.h"
+
+/* this table is used for parsing surrogate control header */
+static const HttpHeaderFieldAttrs ScAttrs[SC_ENUM_END] =
+    {
+        {"no-store", (http_hdr_type)SC_NO_STORE},
+
+        {"no-store-remote", (http_hdr_type)SC_NO_STORE_REMOTE},
+        {"max-age", (http_hdr_type)SC_MAX_AGE},
+        {"content", (http_hdr_type)SC_CONTENT},
+        {"Other,", (http_hdr_type)SC_OTHER}	/* ',' will protect from matches */
+    };
+
+HttpHeaderFieldInfo *ScFieldsInfo = NULL;
+
+http_hdr_sc_type &operator++ (http_hdr_sc_type &aHeader)
+{
+    aHeader = (http_hdr_sc_type)(++(int)aHeader);
+    return aHeader;
+}
+
+int operator - (http_hdr_sc_type const &anSc, http_hdr_sc_type const &anSc2)
+{
+    return (int)anSc - (int)anSc2;
+}
+
+
+/* local prototypes */
+static int httpHdrScParseInit(HttpHdrSc * sc, const String * str);
+
+/* module initialization */
+
+void
+httpHdrScInitModule(void)
+{
+    ScFieldsInfo = httpHeaderBuildFieldsInfo(ScAttrs, SC_ENUM_END);
+}
+
+void
+httpHdrScCleanModule(void)
+{
+    httpHeaderDestroyFieldsInfo(ScFieldsInfo, SC_ENUM_END);
+    ScFieldsInfo = NULL;
+}
+
+/* implementation */
+
+HttpHdrSc *
+httpHdrScCreate(void)
+{
+    HttpHdrSc *sc = (HttpHdrSc *)memAllocate(MEM_HTTP_HDR_SC);
+    return sc;
+}
+
+/* creates an sc object from a 0-terminating string */
+HttpHdrSc *
+httpHdrScParseCreate(const String * str)
+{
+    HttpHdrSc *sc = httpHdrScCreate();
+
+    if (!httpHdrScParseInit(sc, str)) {
+        httpHdrScDestroy(sc);
+        sc = NULL;
+    }
+
+    return sc;
+}
+
+/* parses a 0-terminating string and inits sc */
+static int
+httpHdrScParseInit(HttpHdrSc * sc, const String * str)
+{
+    const char *item;
+    const char *p;		/* '=' parameter */
+    const char *pos = NULL;
+    const char *target = NULL; /* ;foo */
+    const char *temp = NULL; /* temp buffer */
+    int type;
+    int ilen;
+    int initiallen;
+    HttpHdrScTarget *sct;
+    assert(sc && str);
+
+    /* iterate through comma separated list */
+
+    while (strListGetItem(str, ',', &item, &ilen, &pos)) {
+        initiallen = ilen;
+        /* decrease ilen to still match the token for  '=' statements */
+
+        if ((p = strchr(item, '=')) && (p - item < ilen))
+            ilen = p++ - item;
+
+        /* decrease ilen to still match the token for ';' qualified non '=' statments */
+        else if ((p = strchr(item, ';')) && (p - item < ilen))
+            ilen = p++ - item;
+
+        /* find type */
+        type = httpHeaderIdByName(item, ilen,
+                                  ScFieldsInfo, SC_ENUM_END);
+
+        if (type < 0) {
+            debug(90, 2) ("hdr sc: unknown control-directive: near '%s' in '%s'\n", item, str->buf());
+            type = SC_OTHER;
+        }
+
+        /* Is this a targeted directive? */
+        /* TODO sometime: implement a strnrchr that looks at a substring */
+        temp = xstrndup (item, initiallen + 1);
+
+        if (!((target = strrchr (temp, ';')) && !strchr (target, '"') && *(target + 1) != '\0'))
+            target = NULL;
+        else
+            ++target;
+
+        sct = httpHdrScFindTarget (sc, target);
+
+        if (!sct) {
+            sct = httpHdrScTargetCreate (target);
+            dlinkAdd(sct, &sct->node, &sc->targets);
+        }
+
+        safe_free (temp);
+
+        if (EBIT_TEST(sct->mask, type)) {
+            if (type != SC_OTHER)
+                debug(90, 2) ("hdr sc: ignoring duplicate control-directive: near '%s' in '%s'\n", item, str->buf());
+
+            ScFieldsInfo[type].stat.repCount++;
+
+            continue;
+        }
+
+        /* update mask */
+        EBIT_SET(sct->mask, type);
+
+        /* post-processing special cases */
+        switch (type) {
+
+        case SC_MAX_AGE:
+
+            if (!p || !httpHeaderParseInt(p, &sct->max_age)) {
+                debug(90, 2) ("sc: invalid max-age specs near '%s'\n", item);
+                sct->max_age = -1;
+                EBIT_CLR(sct->mask, type);
+            }
+
+            if ((p = strchr (p, '+')))
+                if (!httpHeaderParseInt(++p, &sct->max_stale)) {
+                    debug(90, 2) ("sc: invalid max-stale specs near '%s'\n", item);
+                    sct->max_stale = 0;
+                    /* leave the max-age alone */
+                }
+
+            break;
+
+        case SC_CONTENT:
+
+            if (!p || !httpHeaderParseQuotedString(p, &sct->content)) {
+                debug (90, 2) ("sc: invalid content= quoted string near '%s'\n",item);
+                sct->content.clean();
+                EBIT_CLR(sct->mask, type);
+            }
+
+        default:
+            break;
+        }
+    }
+
+    return sc->targets.head != NULL;
+}
+
+void
+httpHdrScDestroy(HttpHdrSc * sc)
+{
+    assert(sc);
+
+    if (sc->targets.head) {
+        dlink_node *sct = sc->targets.head;
+
+        while (sct) {
+            HttpHdrScTarget *t = (HttpHdrScTarget *)sct->data;
+            sct = sct->next;
+            dlinkDelete (&t->node, &sc->targets);
+            httpHdrScTargetDestroy (t);
+        }
+    }
+
+    memFree(sc, MEM_HTTP_HDR_SC);
+}
+
+HttpHdrSc *
+httpHdrScDup(const HttpHdrSc * sc)
+{
+    HttpHdrSc *dup;
+    dlink_node *node;
+    assert(sc);
+    node = sc->targets.head;
+    dup = httpHdrScCreate();
+
+    while (node) {
+        HttpHdrScTarget *dupsct;
+        dupsct = httpHdrScTargetDup ((HttpHdrScTarget *)node->data);
+        dlinkAddTail (dupsct, &dupsct->node, &dup->targets);
+        node = node->next;
+    }
+
+    return dup;
+}
+
+void
+httpHdrScTargetPackInto(const HttpHdrScTarget * sc, Packer * p)
+{
+    http_hdr_sc_type flag;
+    int pcount = 0;
+    assert(sc && p);
+
+    for (flag = SC_NO_STORE; flag < SC_ENUM_END; ++flag) {
+        if (EBIT_TEST(sc->mask, flag) && flag != SC_OTHER) {
+
+            /* print option name */
+            packerPrintf(p, (pcount ? ", %s" : "%s"), ScFieldsInfo[flag].name.buf());
+
+            /* handle options with values */
+
+            if (flag == SC_MAX_AGE)
+                packerPrintf(p, "=%d", (int) sc->max_age);
+
+            if (flag == SC_CONTENT)
+                packerPrintf(p, "=\"%s\"", sc->content.buf());
+
+            pcount++;
+        }
+    }
+
+    if (sc->target.size())
+        packerPrintf (p, ";%s", sc->target.buf());
+}
+
+void
+httpHdrScPackInto(const HttpHdrSc * sc, Packer * p)
+{
+    dlink_node *node;
+    assert(sc && p);
+    node = sc->targets.head;
+
+    while (node) {
+        httpHdrScTargetPackInto((HttpHdrScTarget *)node->data, p);
+        node = node->next;
+    }
+}
+
+void
+httpHdrScJoinWith(HttpHdrSc * sc, const HttpHdrSc * new_sc)
+{
+    assert(sc && new_sc);
+#if 0
+    /* RC TODO: check that both have the same target */
+
+    if (sc->max_age < 0)
+        sc->max_age = new_sc->max_age;
+
+    /* RC TODO: copy unique missing stringlist entries */
+    cc->mask |= new_cc->mask;
+
+#endif
+}
+
+/* negative max_age will clean old max_Age setting */
+void
+httpHdrScSetMaxAge(HttpHdrSc * sc, char const *target, int max_age)
+{
+    HttpHdrScTarget *sct;
+    assert(sc);
+    sct = httpHdrScFindTarget (sc, target);
+
+    if (!sct) {
+        sct = httpHdrScTargetCreate (target);
+        dlinkAddTail (sct, &sct->node, &sc->targets);
+    }
+
+    httpHdrScTargetSetMaxAge(sct, max_age);
+}
+
+void
+httpHdrScUpdateStats(const HttpHdrSc * sc, StatHist * hist)
+{
+    dlink_node *sct;
+    assert(sc);
+    sct = sc->targets.head;
+
+    while (sct) {
+        httpHdrScTargetUpdateStats((HttpHdrScTarget *)sct->data, hist);
+        sct = sct->next;
+    }
+}
+
+void
+httpHdrScTargetStatDumper(StoreEntry * sentry, int idx, double val, double size, int count)
+{
+    extern const HttpHeaderStat *dump_stat;     /* argh! */
+    const int id = (int) val;
+    const int valid_id = id >= 0 && id < SC_ENUM_END;
+    const char *name = valid_id ? ScFieldsInfo[id].name.buf() : "INVALID";
+
+    if (count || valid_id)
+        storeAppendPrintf(sentry, "%2d\t %-20s\t %5d\t %6.2f\n",
+                          id, name, count, xdiv(count, dump_stat->scParsedCount));
+}
+
+void
+httpHdrScStatDumper(StoreEntry * sentry, int idx, double val, double size, int count)
+{
+    extern const HttpHeaderStat *dump_stat;	/* argh! */
+    const int id = (int) val;
+    const int valid_id = id >= 0 && id < SC_ENUM_END;
+    const char *name = valid_id ? ScFieldsInfo[id].name.buf() : "INVALID";
+
+    if (count || valid_id)
+        storeAppendPrintf(sentry, "%2d\t %-20s\t %5d\t %6.2f\n",
+                          id, name, count, xdiv(count, dump_stat->scParsedCount));
+}
+
+HttpHdrScTarget *
+httpHdrScFindTarget (HttpHdrSc *sc, const char *target)
+{
+    dlink_node *node;
+    assert (sc);
+    node = sc->targets.head;
+
+    while (node) {
+        HttpHdrScTarget *sct = (HttpHdrScTarget *)node->data;
+
+        if (target && sct->target.buf() && !strcmp (target, sct->target.buf()))
+            return sct;
+        else if (!target && !sct->target.buf())
+            return sct;
+
+        node = node->next;
+    }
+
+    return NULL;
+}
+
+HttpHdrScTarget *
+httpHdrScGetMergedTarget (HttpHdrSc *sc, const char *ourtarget)
+{
+    HttpHdrScTarget *sctus = httpHdrScFindTarget (sc, ourtarget);
+    HttpHdrScTarget *sctgeneric = httpHdrScFindTarget (sc, NULL);
+
+    if (sctgeneric || sctus) {
+        HttpHdrScTarget *sctusable = httpHdrScTargetCreate (NULL);
+
+        if (sctgeneric)
+            httpHdrScTargetMergeWith (sctusable, sctgeneric);
+
+        if (sctus)
+            httpHdrScTargetMergeWith (sctusable, sctus);
+
+        return sctusable;
+    }
+
+    return NULL;
+}
@@ -0,0 +1,150 @@
+
+/*
+ * $Id: HttpHdrScTarget.cc,v 1.1 2003/03/10 04:56:36 robertc Exp $
+ *
+ * DEBUG: section 90    HTTP Cache Control Header
+ * AUTHOR: Alex Rousskov
+ *         Robert Collins (Surrogate-Control is derived from
+ *         		   Cache-Control).
+ *
+ * SQUID Web Proxy Cache          http://www.squid-cache.org/
+ * ----------------------------------------------------------
+ *
+ *  Squid is the result of efforts by numerous individuals from
+ *  the Internet community; see the CONTRIBUTORS file for full
+ *  details.   Many organizations have provided support for Squid's
+ *  development; see the SPONSORS file for full details.  Squid is
+ *  Copyrighted (C) 2001 by the Regents of the University of
+ *  California; see the COPYRIGHT file for full details.  Squid
+ *  incorporates software developed and/or copyrighted by other
+ *  sources; see the CREDITS file for full details.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *  
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *  
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111, USA.
+ *
+ */
+
+#include "squid.h"
+
+/* local prototypes */
+
+/* module initialization */
+
+/* implementation */
+
+HttpHdrScTarget *
+httpHdrScTargetCreate(char const *target)
+{
+    HttpHdrScTarget *sc = (HttpHdrScTarget *)memAllocate(MEM_HTTP_HDR_SCTARGET);
+    sc->max_age = -1;
+    /* max_stale is specified as 0 if not specified in the header */
+    sc->target = target;
+    return sc;
+}
+
+void
+httpHdrScTargetDestroy(HttpHdrScTarget * sc)
+{
+    assert(sc);
+    sc->target.clean();
+    sc->content.clean();
+    memFree(sc, MEM_HTTP_HDR_SCTARGET);
+}
+
+HttpHdrScTarget *
+httpHdrScTargetDup(const HttpHdrScTarget * sc)
+{
+    HttpHdrScTarget *dup;
+    assert(sc);
+    dup = httpHdrScTargetCreate(sc->target.buf());
+    dup->mask = sc->mask;
+    dup->max_age = sc->max_age;
+    dup->content = sc->content;
+    return dup;
+}
+
+/* union of two targets */
+void
+httpHdrScTargetJoinWith(HttpHdrScTarget * sc, const HttpHdrScTarget * new_sc)
+{
+    assert(sc && new_sc);
+    /* TODO: check both targets are the same */
+
+    if (sc->max_age < 0)
+        sc->max_age = new_sc->max_age;
+
+    if (sc->max_stale < new_sc->max_stale)
+        sc->max_stale = new_sc->max_stale;
+
+    /* RC TODO: copy unique missing content stringlist entries */
+    sc->mask |= new_sc->mask;
+}
+
+extern http_hdr_sc_type &operator++ (http_hdr_sc_type &aHeader);
+extern int operator - (http_hdr_sc_type const &anSc, http_hdr_sc_type const &anSc2);
+/* copies non-extant fields from new_sc to this sc */
+void
+httpHdrScTargetMergeWith(HttpHdrScTarget * sc, const HttpHdrScTarget * new_sc)
+{
+    http_hdr_sc_type c;
+    assert(sc && new_sc);
+    /* Don't touch the target - this is used to get the operations for a
+     * single surrogate
+     */
+
+    for (c = SC_NO_STORE; c < SC_ENUM_END; ++c)
+        if (!EBIT_TEST(sc->mask, c) && EBIT_TEST(new_sc->mask,c)) {
+            EBIT_SET(sc->mask, c);
+
+            switch (c) {
+
+            case SC_MAX_AGE:
+                sc->max_age = new_sc->max_age;
+                sc->max_stale = new_sc->max_stale;
+                break;
+
+            case SC_CONTENT:
+                assert (sc->content.size() == 0);
+                sc->content = new_sc->content;
+                break;
+
+            default:
+                break;
+            }
+        }
+}
+
+/* negative max_age will clean old max_Age setting */
+void
+httpHdrScTargetSetMaxAge(HttpHdrScTarget * sc, int max_age)
+{
+    assert(sc);
+    sc->max_age = max_age;
+
+    if (max_age >= 0)
+        EBIT_SET(sc->mask, SC_MAX_AGE);
+    else
+        EBIT_CLR(sc->mask, SC_MAX_AGE);
+}
+
+void
+httpHdrScTargetUpdateStats(const HttpHdrScTarget * sc, StatHist * hist)
+{
+    http_hdr_sc_type c;
+    assert(sc);
+
+    for (c = SC_NO_STORE; c < SC_ENUM_END; ++c)
+        if (EBIT_TEST(sc->mask, c))
+            statHistCount(hist, c);
+}
@@ -1,6 +1,6 @@
 
 /*
- * $Id: HttpHeader.cc,v 1.88 2003/03/09 12:29:40 robertc Exp $
+ * $Id: HttpHeader.cc,v 1.89 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 55    HTTP Header
  * AUTHOR: Alex Rousskov
@@ -133,6 +133,8 @@ static const HttpHeaderFieldAttrs HeadersAttrs[] =
 #if X_ACCELERATOR_VARY
         {"X-Accelerator-Vary", HDR_X_ACCELERATOR_VARY, ftStr},
 #endif
+        {"Surrogate-Capability", HDR_SURROGATE_CAPABILITY, ftStr},
+        {"Surrogate-Control", HDR_SURROGATE_CONTROL, ftPSc},
         {"Front-End-Https", HDR_FRONT_END_HTTPS, ftStr},
         {"Other:", HDR_OTHER, ftStr}	/* ':' will not allow matches */
     };
@@ -176,6 +178,8 @@ static http_hdr_type ListHeadersArr[] =
 #if X_ACCELERATOR_VARY
         HDR_X_ACCELERATOR_VARY,
 #endif
+        HDR_SURROGATE_CAPABILITY,
+        HDR_SURROGATE_CONTROL,
         HDR_X_FORWARDED_FOR
     };
 
@@ -186,7 +190,7 @@ static http_hdr_type GeneralHeadersArr[] =
         HDR_TRANSFER_ENCODING,
         HDR_UPGRADE,
         /* HDR_TRAILER, */
-        HDR_VIA
+        HDR_VIA,
     };
 
 /* entity-headers */
@@ -212,7 +216,8 @@ static http_hdr_type ReplyHeadersArr[] =
 #if X_ACCELERATOR_VARY
         HDR_X_ACCELERATOR_VARY,
 #endif
-        HDR_X_SQUID_ERROR
+        HDR_X_SQUID_ERROR,
+        HDR_SURROGATE_CONTROL
     };
 
 static HttpHeaderMask RequestHeadersMask;	/* set run-time using RequestHeaders */
@@ -222,7 +227,7 @@ static http_hdr_type RequestHeadersArr[] =
         HDR_IF_MATCH, HDR_IF_MODIFIED_SINCE, HDR_IF_NONE_MATCH,
         HDR_IF_RANGE, HDR_MAX_FORWARDS, HDR_PROXY_CONNECTION,
         HDR_PROXY_AUTHORIZATION, HDR_RANGE, HDR_REFERER, HDR_REQUEST_RANGE,
-        HDR_USER_AGENT, HDR_X_FORWARDED_FOR
+        HDR_USER_AGENT, HDR_X_FORWARDED_FOR, HDR_SURROGATE_CAPABILITY
     };
 
 /* header accounting */
@@ -308,6 +313,8 @@ httpHeaderInitModule(void)
     /* init dependent modules */
     httpHdrCcInitModule();
 
+    httpHdrScInitModule();
+
     /* register with cache manager */
     cachemgrRegister("http_headers",
                      "HTTP Header Statistics", httpHeaderStoreReport, 0, 1);
@@ -319,6 +326,7 @@ httpHeaderCleanModule(void)
     httpHeaderDestroyFieldsInfo(Headers, HDR_ENUM_END);
     Headers = NULL;
     httpHdrCcCleanModule();
+    httpHdrScCleanModule();
 }
 
 static void
@@ -331,6 +339,7 @@ httpHeaderStatInit(HttpHeaderStat * hs, const char *label)
     statHistEnumInit(&hs->hdrUCountDistr, 32);	/* not a real enum */
     statHistEnumInit(&hs->fieldTypeDistr, HDR_ENUM_END);
     statHistEnumInit(&hs->ccTypeDistr, CC_ENUM_END);
+    statHistEnumInit(&hs->scTypeDistr, SC_ENUM_END);
 }
 
 /*
@@ -898,6 +907,25 @@ httpHeaderPutRange(HttpHeader * hdr, const HttpHdrRange * range)
     memBufClean(&mb);
 }
 
+void
+httpHeaderPutSc(HttpHeader *hdr, const HttpHdrSc *sc)
+{
+    MemBuf mb;
+    Packer p;
+    assert(hdr && sc);
+    /* remove old directives if any */
+    httpHeaderDelById(hdr, HDR_RANGE);
+    /* pack into mb */
+    memBufDefInit(&mb);
+    packerToMemInit(&p, &mb);
+    httpHdrScPackInto(sc, &p);
+    /* put */
+    httpHeaderAddEntry(hdr, httpHeaderEntryCreate(HDR_SURROGATE_CONTROL, NULL, mb.buf));
+    /* cleanup */
+    packerClean(&p);
+    memBufClean(&mb);
+}
+
 /* add extension header (these fields are not parsed/analyzed/joined, etc.) */
 void
 httpHeaderPutExt(HttpHeader * hdr, const char *name, const char *value)
@@ -1028,6 +1056,26 @@ httpHeaderGetRange(const HttpHeader * hdr)
     return r;
 }
 
+HttpHdrSc *
+httpHeaderGetSc(const HttpHeader *hdr)
+{
+    if (!CBIT_TEST(hdr->mask, HDR_SURROGATE_CONTROL))
+        return NULL;
+
+    String s (httpHeaderGetList(hdr, HDR_SURROGATE_CONTROL));
+
+    HttpHdrSc *sc = httpHdrScParseCreate(&s);
+
+    HttpHeaderStats[hdr->owner].ccParsedCount++;
+
+    if (sc)
+        httpHdrScUpdateStats(sc, &HttpHeaderStats[hdr->owner].scTypeDistr);
+
+    httpHeaderNoteParsedEntry(HDR_SURROGATE_CONTROL, s, !sc);
+
+    return sc;
+}
+
 HttpHdrContRange *
 httpHeaderGetContRange(const HttpHeader * hdr)
 {
@@ -1314,6 +1362,10 @@ httpHeaderStatDump(const HttpHeaderStat * hs, StoreEntry * e)
     storeAppendPrintf(e, "%2s\t %-20s\t %5s\t %6s\n",
                       "id", "name", "count", "#/cc_field");
     statHistDump(&hs->ccTypeDistr, e, httpHdrCcStatDumper);
+    storeAppendPrintf(e, "\nSurrogate-control directives distribution\n");
+    storeAppendPrintf(e, "%2s\t %-20s\t %5s\t %6s\n",
+                      "id", "name", "count", "#/sc_field");
+    statHistDump(&hs->scTypeDistr, e, httpHdrScStatDumper);
     storeAppendPrintf(e, "\nNumber of fields per header distribution\n");
     storeAppendPrintf(e, "%2s\t %-5s\t %5s\t %6s\n",
                       "id", "#flds", "count", "%total");
@@ -1,6 +1,6 @@
 
 /*
- * $Id: HttpHeader.h,v 1.3 2003/02/21 22:50:05 robertc Exp $
+ * $Id: HttpHeader.h,v 1.4 2003/03/10 04:56:36 robertc Exp $
  *
  *
  * SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -46,6 +46,9 @@ struct _HttpHeaderFieldAttrs
     field_type type;
 };
 
+extern int httpHeaderParseQuotedString (const char *start, String *val);
+extern void httpHeaderPutSc(HttpHeader *hdr, const HttpHdrSc *sc);
+extern HttpHdrSc *httpHeaderGetSc(const HttpHeader *hdr);
 SQUIDCEXTERN void httpHeaderAddContRange(HttpHeader *, HttpHdrRangeSpec, ssize_t);
 
 #endif /* SQUID_HTTPHEADER_H */
@@ -1,6 +1,6 @@
 
 /*
- * $Id: HttpHeaderTools.cc,v 1.40 2003/03/06 11:51:55 robertc Exp $
+ * $Id: HttpHeaderTools.cc,v 1.41 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 66    HTTP Header Tools
  * AUTHOR: Alex Rousskov
@@ -338,6 +338,37 @@ httpHeaderParseSize(const char *start, ssize_t * value)
 }
 
 
+/* Parses a quoted-string field (RFC 2616 section 2.2), complains if
+ * something went wrong, returns non-zero on success.
+ * start should point at the first ".
+ * RC TODO: This is too looose. We should honour the BNF and exclude CTL's
+ */
+int
+httpHeaderParseQuotedString (const char *start, String *val)
+{
+    const char *end, *pos;
+    val->clean();
+    assert (*start == '"');
+    pos = start + 1;
+
+    while (1) {
+        if (!(end = index (pos,'"'))) {
+            debug (66, 2) ("failed to parse a quoted-string header field near '%s'\n", start);
+            return 0;
+        }
+
+        /* check for quoted-chars */
+        if (*(end - 1) != '\\') {
+            /* done */
+            val->append(start + 1, end-start-1);
+            return 1;
+        }
+
+        /* try for the end again */
+        pos = end + 1;
+    }
+}
+
 /*
  * parses a given string then packs compiled headers and compares the result
  * with the original, reports discrepancies
@@ -1,6 +1,6 @@
 
 /*
- * $Id: HttpReply.cc,v 1.57 2003/03/09 12:29:40 robertc Exp $
+ * $Id: HttpReply.cc,v 1.58 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 58    HTTP Reply (Response)
  * AUTHOR: Alex Rousskov
@@ -462,6 +462,8 @@ httpReplyHdrCacheInit(HttpReply * rep)
 
     rep->cache_control = httpHeaderGetCc(hdr);
 
+    rep->surrogate_control = httpHeaderGetSc(hdr);
+
     rep->content_range = httpHeaderGetContRange(hdr);
 
     rep->keep_alive = httpMsgIsPersistent(rep->sline.version, &rep->header);
@@ -479,6 +481,9 @@ httpReplyHdrCacheClean(HttpReply * rep)
     if (rep->cache_control)
         httpHdrCcDestroy(rep->cache_control);
 
+    if (rep->surrogate_control)
+        httpHdrScDestroy(rep->surrogate_control);
+
     if (rep->content_range)
         httpHdrContRangeDestroy(rep->content_range);
 }
@@ -1,7 +1,7 @@
 #
 #  Makefile for the Squid Object Cache server
 #
-#  $Id: Makefile.am,v 1.64 2003/03/08 09:43:49 robertc Exp $
+#  $Id: Makefile.am,v 1.65 2003/03/10 04:56:36 robertc Exp $
 #
 #  Uncomment and customize the following to suit your needs:
 #
@@ -48,6 +48,33 @@ else
 DELAY_POOL_SOURCE = 
 endif
 
+ESI_ALL_SOURCE = \
+	ElementList.h \
+	ESI.cc \
+	ESI.h \
+	ESIAttempt.h \
+	ESIContext.cc \
+	ESIContext.h \
+	ESICustomParser.cc \
+	ESICustomParser.h \
+	ESIElement.h \
+	ESIExcept.h \
+	ESIExpatParser.cc \
+	ESIExpatParser.h \
+	ESIExpression.cc \
+	ESILiteral.h \
+	ESIParser.cc \
+	ESIParser.h \
+	ESISegment.cc \
+	ESISegment.h \
+	ESISequence.cc \
+	ESISequence.h
+if USE_ESI
+  ESI_SOURCE = $(ESI_ALL_SOURCE)
+else
+  ESI_SOURCE = 
+endif
+
 if ENABLE_XPROF_STATS
 XPROF_STATS_SOURCE = ProfStats.cc
 else
@@ -107,12 +134,12 @@ else
 ARP_ACL_SOURCE =
 endif
 
-AM_CFLAGS = -Werror -Wall
-AM_CXXFLAGS = -Werror -Wall
+AM_CFLAGS = -Werror -Wall -Wpointer-arith -Wwrite-strings -Wmissing-prototypes -Wmissing-declarations -Wcomments
+AM_CXXFLAGS = -Werror -Wall -Wpointer-arith -Wwrite-strings -Wmissing-prototypes -Wmissing-declarations -Wcomments
 
 SUBDIRS		= fs repl auth
 
-INCLUDES        = -I. -I$(srcdir) -I$(top_builddir)/include -I$(top_srcdir)/include
+INCLUDES        = -I. -I$(srcdir) -I$(top_builddir)/include -I$(top_srcdir)/include -I$(top_srcdir)/lib/libTrie/include
 
 EXTRA_PROGRAMS = \
 	unlinkd \
@@ -150,6 +177,7 @@ EXTRA_squid_SOURCES = \
 	dnsserver.cc \
 	dns_internal.cc \
 	htcp.cc \
+	$(ESI_ALL_SOURCE) \
 	ProfStats.cc \
 	leakfinder.cc \
 	snmp_core.cc \
@@ -268,6 +296,7 @@ squid_SOURCES = \
 	$(DNSSOURCE) \
 	enums.h \
 	errorpage.cc \
+	$(ESI_SOURCE) \
 	ETag.cc \
 	event.cc \
 	external_acl.cc \
@@ -289,6 +318,8 @@ squid_SOURCES = \
 	HttpStatusLine.cc \
 	HttpHdrCc.cc \
 	HttpHdrRange.cc \
+	HttpHdrSc.cc \
+	HttpHdrScTarget.cc \
 	HttpHdrContRange.cc \
 	HttpHdrContRange.h \
 	HttpHeader.cc \
@@ -448,6 +479,7 @@ ufsdump_SOURCES = debug.cc \
 	StoreMetaVary.h \
 	access_log.cc \
 	acl.cc \
+	ACLChecklist.cc \
 	$(squid_ACLSOURCES) \
 	ACLChecklist.cc \
 	asn.cc \
@@ -476,6 +508,7 @@ ufsdump_SOURCES = debug.cc \
 	$(DNSSOURCE) \
 	enums.h \
 	errorpage.cc \
+	$(ESI_SOURCE) \
 	ETag.cc \
 	event.cc \
 	external_acl.cc \
@@ -493,6 +526,8 @@ ufsdump_SOURCES = debug.cc \
 	HttpStatusLine.cc \
 	HttpHdrCc.cc \
 	HttpHdrRange.cc \
+	HttpHdrSc.cc \
+	HttpHdrScTarget.cc \
 	HttpHdrContRange.cc \
 	HttpHeader.cc \
 	HttpHeaderTools.cc \
@@ -535,8 +570,8 @@ ufsdump_SOURCES = debug.cc \
 	send-announce.cc \
 	$(SNMPSOURCE) \
 	squid.h \
-	tunnel.cc \
 	$(SSLSOURCE) \
+	tunnel.cc \
 	stat.cc \
 	StatHist.cc \
 	String.cc \
@@ -1,6 +1,6 @@
 
 /*
- * $Id: ProfStats.cc,v 1.4 2003/02/21 22:50:06 robertc Exp $
+ * $Id: ProfStats.cc,v 1.5 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 81     CPU Profiling Routines
  * AUTHOR: Andres Kroonmaa
@@ -61,6 +61,7 @@ static TimersArray *xprof_stats_avg5hour = NULL;
 static TimersArray *xprof_stats_avg24hour = NULL;
 
 static xprof_stats_node *sortlist[XPROF_LAST + 2];
+static void xprof_summary(StoreEntry * sentry);
 
 static void
 xprof_reset(xprof_stats_data * head)
@@ -122,7 +123,7 @@ xprof_show_item(StoreEntry * sentry, const char *name, xprof_stats_data * hist)
 }
 
 static void
-xprof_summary_item(StoreEntry * sentry, char *descr, TimersArray * list)
+xprof_summary_item(StoreEntry * sentry, char const *descr, TimersArray * list)
 {
     int i;
     xprof_stats_node **hist;
@@ -1,6 +1,6 @@
 
 /*
- * $Id: SquidString.h,v 1.4 2003/03/06 11:51:55 robertc Exp $
+ * $Id: SquidString.h,v 1.5 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 67    String
  * AUTHOR: Duane Wessels
@@ -95,6 +95,7 @@ class String
     void reset(char const *str);
     void append(char const *buf, int len);
     void append(char const *buf);
+    void append(char const);
     void append (String const &);
     void absorb(String &old);
     _SQUID_INLINE_ const char * pos(char const *) const;
@@ -1,6 +1,6 @@
 
 /*
- * $Id: Store.h,v 1.8 2003/03/04 01:40:25 robertc Exp $
+ * $Id: Store.h,v 1.9 2003/03/10 04:56:36 robertc Exp $
  *
  *
  * SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -38,6 +38,10 @@
 #include "Range.h"
 #include "CommRead.h"
 
+#if ESI
+#include "ESIElement.h"
+#endif
+
 class StoreClient;
 
 class MemObject;
@@ -53,6 +57,8 @@ class StoreEntry : public hash_link
     bool checkDeferRead(int fd) const;
 
     virtual const char *getMD5Text() const;
+    virtual ~StoreEntry(){}
+
     virtual HttpReply const *getReply() const;
     virtual void write (StoreIOBuffer);
     virtual _SQUID_INLINE_ bool isEmpty() const;
@@ -64,6 +70,7 @@ class StoreEntry : public hash_link
     virtual void trimMemory();
 
     void delayAwareRead(int fd, char *buf, int len, IOCB *handler, void *data);
+
     void setNoDelay (bool const);
 
     MemObject *mem_obj;
@@ -110,6 +117,11 @@ swap_status_t swap_status:
 
     void *operator new(size_t byteCount);
     void operator delete(void *address);
+    void setReleaseFlag();
+#if ESI
+
+    ESIElement::Pointer cachedESITree;
+#endif
 
 private:
     static MemPool *pool;
@@ -150,6 +162,7 @@ class NullStoreEntry:public StoreEntry
     static NullStoreEntry _instance;
 };
 
+SQUIDCEXTERN size_t storeEntryInUse();
 SQUIDCEXTERN off_t storeLowestMemReaderOffset(const StoreEntry * entry);
 SQUIDCEXTERN const char *storeEntryFlags(const StoreEntry *);
 SQUIDCEXTERN int storeEntryLocked(const StoreEntry *);
@@ -1,6 +1,6 @@
 
 /*
- * $Id: String.cc,v 1.16 2003/03/08 09:35:15 robertc Exp $
+ * $Id: String.cc,v 1.17 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 67    String
  * AUTHOR: Duane Wessels
@@ -166,6 +166,15 @@ String::append(char const *str)
     append (str, strlen(str));
 }
 
+void
+String::append (char chr)
+{
+    char myString[2];
+    myString[0]=chr;
+    myString[1]='\0';
+    append (myString, 1);
+}
+
 void
 String::append(String const &old)
 {
@@ -1,6 +1,6 @@
 
 /*
- * $Id: cache_cf.cc,v 1.437 2003/03/08 09:43:49 robertc Exp $
+ * $Id: cache_cf.cc,v 1.438 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 3     Configuration File Parsing
  * AUTHOR: Harvest Derived
@@ -43,6 +43,9 @@
 #if SQUID_SNMP
 #include "snmp.h"
 #endif
+#if ESI
+#include "ESIParser.h"
+#endif
 
 static const char *const T_SECOND_STR = "second";
 static const char *const T_MINUTE_STR = "minute";
@@ -1,6 +1,6 @@
 
 /*
- * $Id: cbdata.cc,v 1.55 2003/03/04 01:40:25 robertc Exp $
+ * $Id: cbdata.cc,v 1.56 2003/03/10 04:56:36 robertc Exp $
  *
  * DEBUG: section 45    Callback Data Registry
  * ORIGINAL AUTHOR: Duane Wessels
@@ -72,9 +72,14 @@ class CBDataCall
 
 #endif
 
-typedef struct _cbdata
+#define OFFSET_OF(TYPE, MEMBER) ((size_t) &(((TYPE) *)0)->(MEMBER))
+
+class cbdata
 {
+
+public:
 #if CBDATA_DEBUG
+
     void dump(StoreEntry *)const;
 #endif
 
@@ -86,7 +91,7 @@ typedef struct _cbdata
 
     void addHistory(char const *label, char const *file, int line) const
     {
-        if (calls->count > 100)
+        if (calls->count > 1000)
             return;
 
         stackPush (calls, new CBDataCall(label, file, line));
@@ -98,15 +103,28 @@ typedef struct _cbdata
     Stack *calls;
 #endif
 
-    long y;			/* cookie used while debugging */
-    union {
-        void *pointer;
-        double double_float;
-        int integer;
-    } data;
-}
+    /* cookie used while debugging */
+    long cookie;
+    /* MUST be the last per-instance member */
+    void *data;
+void check() const { assert(cookie == ((long)this ^ Cookie));}
+
+    size_t dataSize() const { return sizeof(data);}
 
-cbdata;
+    static const long Cookie = (long)0xDEADBEEF;
+    static long MakeOffset();
+    static const long Offset;
+};
+
+const long cbdata::Offset(MakeOffset());
+
+long
+cbdata::MakeOffset()
+{
+    cbdata *zero = (cbdata *)0L;
+    void **dataOffset = &zero->data;
+    return (long)dataOffset;
+}
 
 static OBJH cbdataDump;
 #ifdef CBDATA_DEBUG
@@ -122,12 +140,8 @@ struct CBDataIndex
 *cbdata_index = NULL;
 int cbdata_types = 0;
 
-#define OFFSET_OF(type, member) ((int)(char *)&((type *)0L)->member)
-#define CBDATA_COOKIE	(long)0xDEADBEEF
-#define CBDATA_CHECK(c) assert(c->y == ((long)c ^ CBDATA_COOKIE))
-
 void
-_cbdata::deleteSelf()
+cbdata::deleteSelf()
 {
 #if CBDATA_DEBUG
     CBDataCall *aCall;
@@ -166,9 +180,9 @@ cbdataInternalInitType(cbdata_type type, const char *name, int size, FREE * free
 
     snprintf(label, strlen(name) + 20, "cbdata %s (%d)", name, (int) type);
 
-    assert(OFFSET_OF(cbdata, data) == (sizeof(cbdata) - sizeof(((cbdata *) NULL)->data)));
+    assert((size_t)cbdata::Offset == (sizeof(cbdata) - ((cbdata *)NULL)->dataSize()));
 
-    cbdata_index[type].pool = memPoolCreate(label, size + OFFSET_OF(cbdata, data));
+    cbdata_index[type].pool = memPoolCreate(label, size + cbdata::Offset);
 
     cbdata_index[type].free_func = free_func;
 }
@@ -231,7 +245,7 @@ cbdataInternalAlloc(cbdata_type type)
     p->type = type;
     p->valid = 1;
     p->locks = 0;
-    p->y = (long) p ^ CBDATA_COOKIE;
+    p->cookie = (long) p ^ cbdata::Cookie;
     cbdataCount++;
 #if CBDATA_DEBUG
 
@@ -254,7 +268,7 @@ cbdataInternalFree(void *p)
 #endif
 {
     cbdata *c;
-    c = (cbdata *) (((char *) p) - OFFSET_OF(cbdata, data));
+    c = (cbdata *) (((char *) p) - cbdata::Offset);
 #if CBDATA_DEBUG
 
     debug(45, 3) ("cbdataFree: %p %s:%d\n", p, file, line);
@@ -263,7 +277,7 @@ cbdataInternalFree(void *p)
     debug(45, 3) ("cbdataFree: %p\n", p);
 #endif
 
-    CBDATA_CHECK(c);
+    c->check();
     c->valid = 0;
 #if CBDATA_DEBUG
 
@@ -299,7 +313,7 @@ cbdataInternalLock(const void *p)
     if (p == NULL)
         return;
 
-    c = (cbdata *) (((char *) p) - OFFSET_OF(cbdata, data));
+    c = (cbdata *) (((char *) p) - cbdata::Offset);
 
 #if CBDATA_DEBUG
 
@@ -313,7 +327,7 @@ cbdataInternalLock(const void *p)
 
 #endif
 
-    CBDATA_CHECK(c);
+    c->check();
 
     assert(c->locks < 65535);
 
@@ -332,7 +346,7 @@ cbdataInternalUnlock(const void *p)
     if (p == NULL)
         return;
 
-    c = (cbdata *) (((char *) p) - OFFSET_OF(cbdata, data));
+    c = (cbdata *) (((char *) p) - cbdata::Offset);
 
 #if CBDATA_DEBUG
 
@@ -346,7 +360,7 @@ cbdataInternalUnlock(const void *p)
 
 #endif
 
-    CBDATA_CHECK(c);
+    c->check();
 
     assert(c != NULL);
 
@@ -380,9 +394,9 @@ cbdataReferenceValid(const void *p)
 
     debug(45, 3) ("cbdataReferenceValid: %p\n", p);
 
-    c = (cbdata *) (((char *) p) - OFFSET_OF(cbdata, data));
+    c = (cbdata *) (((char *) p) - cbdata::Offset);
 
-    CBDATA_CHECK(c);
+    c->check();
 
     assert(c->locks > 0);
 
@@ -418,17 +432,17 @@ cbdataInternalReferenceDoneValid(void **pp, void **tp)
 
 #if CBDATA_DEBUG
 void
-_cbdata::dump(StoreEntry *sentry) const
+cbdata::dump(StoreEntry *sentry) const
 {
     storeAppendPrintf(sentry, "%c%p\t%d\t%d\t%20s:%-5d\n", valid ? ' ' :
                       '!', &data, type, locks, file, line);
 }
 
-struct CBDataDumper : public unary_function<_cbdata, void>
+struct CBDataDumper : public unary_function<cbdata, void>
 {
     CBDataDumper(StoreEntry *anEntry):where(anEntry){}
 
-    void operator()(_cbdata const &x)
+    void operator()(cbdata const &x)
     {
         x.dump(where);
     }
@@ -454,7 +468,7 @@ cbdataDump(StoreEntry * sentry)
         MemPool *pool = cbdata_index[i].pool;
 
         if (pool) {
-            int obj_size = pool->obj_size - OFFSET_OF(cbdata, data);
+            int obj_size = pool->obj_size - cbdata::Offset;
             storeAppendPrintf(sentry, "%s\t%d\t%d\t%d\n", pool->label + 7, obj_size, pool->meter.inuse.level, obj_size * pool->meter.inuse.level);
         }
     }
@@ -494,7 +508,7 @@ struct CBDataHistoryDumper : public CBDataDumper
 {
     CBDataHistoryDumper(StoreEntry *anEntry):CBDataDumper(anEntry),where(anEntry), callDumper(anEntry){}
 
-    void operator()(_cbdata const &x)
+    void operator()(cbdata const &x)
     {
         CBDataDumper::operator()(x);
         storeAppendPrintf(where, "\n");
@@ -1,6 +1,6 @@
 
 #
-# $Id: cf.data.pre,v 1.306 2003/02/22 14:59:33 hno Exp $
+# $Id: cf.data.pre,v 1.307 2003/03/10 04:56:36 robertc Exp $
 #
 #
 # SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -2703,6 +2703,41 @@ DOC_START
 	message.
 DOC_END
 
+NAME: httpd_accel_surrogate_id
+IFDEF: ESI
+TYPE:  string
+LOC: Config.Accel.surrogate_id
+DEFAULT: none
+DOC_START
+	Surrogates (http://www.esi.org/architecture_spec_1.0.html)
+	need an identification token to allow control targeting. Because
+	a farm of surrogates may all perform the same tasks, they may share
+	an identification token.
+DOC_END
+
+NAME: http_accel_surrogate_remote
+IFDEF: ESI
+COMMENT: on|off
+TYPE: onoff
+DEFAULT: off
+LOC: Config.onoff.surrogate_is_remote
+DOC_START
+	Remote surrogates (such as those in a CDN) honour Surrogate-Control: no-store-remote.
+	Set this to on to have squid behave as a remote surrogate.
+DOC_END
+
+NAME: esi_parser
+IFDEF: ESI
+COMMENT: expat|custom
+TYPE: string
+LOC: ESIParser::Type
+DEFAULT: custom
+DOC_START
+	ESI markup is not strictly XML compatible. The custom ESI parser
+	will give higher performance, but cannot handle non ASCII character
+	encodings.
+DOC_END
+
 COMMENT_START
  MISCELLANEOUS
  -----------------------------------------------------------------------------
@@ -1,6 +1,6 @@
 
 /*
- * $Id: clientStream.cc,v 1.5 2003/02/21 22:50:07 robertc Exp $
+ * $Id: clientStream.cc,v 1.6 2003/03/10 04:56:37 robertc Exp $
  *
  * DEBUG: section 87    Client-side Stream routines.
  * AUTHOR: Robert Collins
@@ -146,8 +146,6 @@ clientStreamInit(dlink_list * list, CSR * func, CSD * rdetach, CSS * readstatus,
  * Doesn't actually insert at head. Instead it inserts one *after*
  * head. This is because HEAD is a special node, as is tail
  * This function is not suitable for inserting the real HEAD.
- * TODO: should we always initalise the buffers and length, to 
- * allow safe insertion of elements in the downstream cycle?
  */
 void
 clientStreamInsertHead(dlink_list * list, CSR * func, CSCB * callback,
@@ -163,7 +161,12 @@ clientStreamInsertHead(dlink_list * list, CSR * func, CSCB * callback,
     debug(87, 3)
     ("clientStreamInsertHead: Inserted node %p with data %p after head\n",
      temp, data);
+
+    if (list->head->next)
+        temp->readBuffer = ((clientStreamNode *)list->head->next->data)->readBuffer;
+
     dlinkAddAfter(temp, &temp->node, list->head, list);
+
     cbdataReference(temp);
 }
 
@@ -276,22 +279,23 @@ clientStreamFree(void *foo)
     if (thisObject->node.next || thisObject->node.prev) {
         dlinkDelete(&thisObject->node, thisObject->head);
     }
+
 }
 
-_clientStreamNode *
-_clientStreamNode::prev() const
+clientStreamNode *
+clientStreamNode::prev() const
 {
     if (node.prev)
-        return (_clientStreamNode *)node.prev->data;
+        return (clientStreamNode *)node.prev->data;
     else
         return NULL;
 }
 
-_clientStreamNode *
-_clientStreamNode::next() const
+clientStreamNode *
+clientStreamNode::next() const
 {
     if (node.next)
-        return (_clientStreamNode *)node.next->data;
+        return (clientStreamNode *)node.next->data;
     else
         return NULL;
 }
@@ -1,6 +1,6 @@
 
 /*
- * $Id: clientStream.h,v 1.4 2003/02/21 22:50:07 robertc Exp $
+ * $Id: clientStream.h,v 1.5 2003/03/10 04:56:37 robertc Exp $
  *
  *
  * SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -36,7 +36,7 @@
 
 #include "StoreIOBuffer.h"
 
-typedef struct _clientStreamNode clientStreamNode;
+class clientStreamNode;
 
 class ClientHttpRequest;
 /* client stream read callback */
@@ -48,15 +48,12 @@ typedef void CSD(clientStreamNode *, ClientHttpRequest *);
 typedef clientStream_status_t CSS(clientStreamNode *, ClientHttpRequest *);
 
 
-struct _clientStreamNode
+class clientStreamNode
 {
-#ifdef __cplusplus
 
 public:
-    _clientStreamNode *prev() const;
-    _clientStreamNode *next() const;
-#endif
-
+    clientStreamNode *prev() const;
+    clientStreamNode *next() const;
     dlink_node node;
     dlink_list *head;		/* sucks I know, but hey, the interface is limited */
     CSR *readfunc;
@@ -1,6 +1,6 @@
 
 /*
- * $Id: client_side.cc,v 1.630 2003/03/07 04:40:59 adrian Exp $
+ * $Id: client_side.cc,v 1.631 2003/03/10 04:56:37 robertc Exp $
  *
  * DEBUG: section 33    Client-side Routines
  * AUTHOR: Duane Wessels
@@ -2445,7 +2445,7 @@ clientAbortBody(request_t * request)
         requestUnlink(request);
     }
 
-    clientReadBodyAbortHandler(NULL, -1, conn);		/* Install abort handler */
+    clientReadBodyAbortHandler(NULL, -1, conn);	/* Install abort handler */
     /* clientProcessBody() */
     return 1;			/* Aborted */
 }
@@ -1,6 +1,6 @@
 
 /*
- * $Id: client_side_reply.cc,v 1.44 2003/03/06 11:51:55 robertc Exp $
+ * $Id: client_side_reply.cc,v 1.45 2003/03/10 04:56:37 robertc Exp $
  *
  * DEBUG: section 88    Client-side Reply Routines
  * AUTHOR: Robert Collins (Originally Duane Wessels in client_side.c)
@@ -41,6 +41,9 @@
 
 #include "clientStream.h"
 #include "authenticate.h"
+#if ESI
+#include "ESI.h"
+#endif
 #include "MemObject.h"
 #include "client_side_request.h"
 #include "ACLChecklist.h"
@@ -1920,14 +1923,12 @@ clientReplyContext::pushStreamData(StoreIOBuffer const &result, char *source)
         flags.complete = 1;
     }
 
-    /* REMOVE ME: Only useful for two node streams */
-    assert(result.offset - headers_sz == ((clientStreamNode *) http->client_stream.tail->data)->readBuffer.offset);
-
+    assert(result.offset - headers_sz == next()->readBuffer.offset);
     tempBuffer.offset = result.offset - headers_sz;
-
     tempBuffer.length = result.length;
 
-    tempBuffer.data = source;
+    if (tempBuffer.length)
+        tempBuffer.data = source;
 
     clientStreamCallback((clientStreamNode*)http->client_stream.head->data, http, NULL,
                          tempBuffer);
@@ -2030,7 +2031,17 @@ clientReplyContext::processReply(bool accessAllowed)
     debug(88,3)
     ("clientSendMoreData: Appending %d bytes after %d bytes of headers\n",
      (int) body_size, rep->hdr_sz);
+#if ESI
 
+    if (http->flags.accel && rep->sline.status != HTTP_FORBIDDEN &&
+            !clientAlwaysAllowResponse(rep->sline.status) &&
+            esiEnableProcessing(rep)) {
+        debug(88, 2) ("Enabling ESI processing for %s\n", http->uri);
+        clientStreamInsertHead(&http->client_stream, esiStreamRead,
+                               esiProcessStream, esiStreamDetach, esiStreamStatus, NULL);
+    }
+
+#endif
     if (http->request->method == METHOD_HEAD) {
         /* do not forward body for HEAD replies */
         body_size = 0;
@@ -2157,6 +2168,7 @@ clientReplyContext::sendMoreData (StoreIOBuffer result)
         holdingBuffer = result;
         processReplyAccess ();
         return;
+
     } else if (reqofs < HTTP_REQBUF_SZ && entry->store_status == STORE_PENDING) {
         waitForMoreData(result);
         return;
@@ -1,6 +1,6 @@
 
 /*
- * $Id: comm.cc,v 1.371 2003/03/08 16:18:45 robertc Exp $
+ * $Id: comm.cc,v 1.372 2003/03/10 04:56:37 robertc Exp $
  *
  * DEBUG: section 5     Socket Functions
  * AUTHOR: Harvest Derived
@@ -217,7 +217,7 @@ class CommCallbackData
 
 protected:
     CommCommonCallback result;
-    friend void _comm_close(int fd, char *file, int line);
+    friend void _comm_close(int fd, char const *file, int line);
     friend void comm_calliocallback(void);
 
 private:
@@ -294,7 +294,7 @@ class CommWriteCallbackData : public CommCallbackData
 
 struct _fd_debug_t
 {
-    char *close_file;
+    char const *close_file;
     int close_line;
 };
 
@@ -839,7 +839,7 @@ comm_read_cancel(int fd, IOCB *callback, void *data)
  * + accept() poll time is 250ms
  */
 void
-fdc_open(int fd, unsigned int type, char *desc)
+fdc_open(int fd, unsigned int type, char const *desc)
 {
     assert(fdc_table[fd].active == 0);
 
@@ -1732,7 +1732,7 @@ AcceptFD::doCallback(int fd, int newfd, comm_err_t errcode, int xerrno, Connecti
  * DeferredReadManager.
  */
 void
-_comm_close(int fd, char *file, int line)
+_comm_close(int fd, char const *file, int line)
 {
     fde *F = NULL;
     dlink_node *node;
@@ -18,7 +18,7 @@ extern int comm_has_pending_read_callback(int fd);
 extern bool comm_has_pending_read(int fd);
 extern void comm_read(int fd, char *buf, int len, IOCB *handler, void *data);
 extern void comm_read_cancel(int fd, IOCB *callback, void *data);
-extern void fdc_open(int fd, unsigned int type, char *desc);
+extern void fdc_open(int fd, unsigned int type, char const *desc);
 extern int comm_udp_recvfrom(int fd, void *buf, size_t len, int flags,
 
                                  struct sockaddr *from, socklen_t *fromlen);
@@ -1,6 +1,6 @@
 
 /*
- * $Id: enums.h,v 1.229 2003/03/06 11:51:55 robertc Exp $
+ * $Id: enums.h,v 1.230 2003/03/10 04:56:38 robertc Exp $
  *
  *
  * SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -93,6 +93,7 @@ typedef enum {
     ERR_ONLY_IF_CACHED_MISS,	/* failure to satisfy only-if-cached request */
     ERR_TOO_BIG,
     TCP_RESET,
+    ERR_ESI,                    /* Failure to perform ESI processing */
     ERR_MAX
 } err_type;
 
@@ -189,6 +190,8 @@ typedef enum {
 #if X_ACCELERATOR_VARY
     HDR_X_ACCELERATOR_VARY,
 #endif
+    HDR_SURROGATE_CAPABILITY,
+    HDR_SURROGATE_CONTROL,
     HDR_FRONT_END_HTTPS,
     HDR_OTHER,
     HDR_ENUM_END
@@ -211,6 +214,15 @@ typedef enum {
     CC_ENUM_END
 } http_hdr_cc_type;
 
+typedef enum {
+    SC_NO_STORE,
+    SC_NO_STORE_REMOTE,
+    SC_MAX_AGE,
+    SC_CONTENT,
+    SC_OTHER,
+    SC_ENUM_END
+} http_hdr_sc_type;
+
 /* possible types for http header fields */
 typedef enum {
     ftInvalid = HDR_ENUM_END,	/* to catch nasty errors with hdr_id<->fld_type clashes */
@@ -221,6 +233,7 @@ typedef enum {
     ftPCc,
     ftPContRange,
     ftPRange,
+    ftPSc,
     ftDate_1123_or_ETag
 } field_type;
 
@@ -549,6 +562,8 @@ typedef enum {
     MEM_HELPER_STATEFUL_REQUEST,
     MEM_HTTP_HDR_CC,
     MEM_HTTP_HDR_CONTENT_RANGE,
+    MEM_HTTP_HDR_SC,
+    MEM_HTTP_HDR_SCTARGET,
     MEM_IPCACHE_ENTRY,
     MEM_MD5_DIGEST,
     MEM_NETDBENTRY,
@@ -1,6 +1,6 @@
 
 /*
- * $Id: errorpage.cc,v 1.187 2003/03/09 12:29:41 robertc Exp $
+ * $Id: errorpage.cc,v 1.188 2003/03/10 04:56:38 robertc Exp $
  *
  * DEBUG: section 4     Error Generation
  * AUTHOR: Duane Wessels
@@ -475,6 +475,8 @@ errorStateFree(ErrorState * err)
 
     err->auth_user_request = NULL;
 
+    safe_free(err->err_msg);
+
     cbdataFree(err);
 }
 
@@ -584,6 +586,7 @@ errorDump(ErrorState * err, MemBuf * mb)
  * w - cachemgr email address                   x
  * W - error data (to be included in the mailto links)
  * z - dns server error message                 x
+ * Z - Preformatted error message               x
  */
 
 static const char *
@@ -779,6 +782,14 @@ errorConvert(char token, ErrorState * err)
 
         break;
 
+    case 'Z':
+        if (err->err_msg)
+            p = err->err_msg;
+        else
+            p = "[unknown]";
+
+        break;
+
     case '%':
         p = "%";
 
@@ -1,6 +1,6 @@
 
 /*
- * $Id: http.cc,v 1.412 2003/03/06 06:21:38 robertc Exp $
+ * $Id: http.cc,v 1.413 2003/03/10 04:56:38 robertc Exp $
  *
  * DEBUG: section 11    Hypertext Transfer Protocol (HTTP)
  * AUTHOR: Harvest Derived
@@ -287,6 +287,48 @@ httpMaybeRemovePublic(StoreEntry * e, http_status status)
     }
 }
 
+void
+HttpStateData::processSurrogateControl(HttpReply *reply)
+{
+#if ESI
+
+    if (request->flags.accelerated && reply->surrogate_control) {
+        HttpHdrScTarget *sctusable =
+            httpHdrScGetMergedTarget(reply->surrogate_control,
+                                     Config.Accel.surrogate_id);
+
+        if (sctusable) {
+            if (EBIT_TEST(sctusable->mask, SC_NO_STORE) ||
+                    (Config.onoff.surrogate_is_remote
+                     && EBIT_TEST(sctusable->mask, SC_NO_STORE_REMOTE))) {
+                surrogateNoStore = true;
+                httpMakePrivate(entry);
+            }
+
+            /* The HttpHeader logic cannot tell if the header it's parsing is a reply to an
+             * accelerated request or not...
+             * Still, this is an abtraction breach. - RC
+             */
+            if (sctusable->max_age != -1) {
+                if (sctusable->max_age < sctusable->max_stale)
+                    reply->expires = reply->date + sctusable->max_age;
+                else
+                    reply->expires = reply->date + sctusable->max_stale;
+
+                /* And update the timestamps */
+                storeTimestampsSet(entry);
+            }
+
+            /* We ignore cache-control directives as per the Surrogate specification */
+            ignoreCacheControl = true;
+
+            httpHdrScTargetDestroy(sctusable);
+        }
+    }
+
+#endif
+}
+
 int
 cacheControlAllowsCaching(HttpHdrCc *cc)
 {
@@ -314,9 +356,23 @@ httpCachableReply(HttpStateData * httpState)
     const int cc_mask = (rep->cache_control) ? rep->cache_control->mask : 0;
     const char *v;
 
+    if (httpState->surrogateNoStore)
+        return 0;
+
     if (!cacheControlAllowsCaching(rep->cache_control))
         return 0;
 
+    if (!httpState->ignoreCacheControl) {
+        if (EBIT_TEST(cc_mask, CC_PRIVATE))
+            return 0;
+
+        if (EBIT_TEST(cc_mask, CC_NO_CACHE))
+            return 0;
+
+        if (EBIT_TEST(cc_mask, CC_NO_STORE))
+            return 0;
+    }
+
     if (httpState->request->flags.auth) {
         /*
          * Responses to requests with authorization may be cached
@@ -596,6 +652,7 @@ HttpStateData::processReplyHeader(const char *buf, int size)
     /* Parse headers into reply structure */
     /* what happens if we fail to parse here? */
     httpReplyParse(reply, reply_hdr, hdr_len);
+    processSurrogateControl (reply);
     /* TODO: we need our own reply * in the httpState, as we probably don't want to replace
      * the storeEntry with interim headers
      */
@@ -656,7 +713,7 @@ HttpStateData::processReplyHeader(const char *buf, int size)
         break;
     }
 
-    if (entry->getReply()->cache_control) {
+    if (!ignoreCacheControl && entry->getReply()->cache_control) {
         if (EBIT_TEST(entry->getReply()->cache_control->mask, CC_PROXY_REVALIDATE))
             EBIT_SET(entry->flags, ENTRY_REVALIDATE);
         else if (EBIT_TEST(entry->getReply()->cache_control->mask, CC_MUST_REVALIDATE))
@@ -1068,7 +1125,7 @@ httpBuildRequestHeader(request_t * request,
     while ((e = httpHeaderGetEntry(hdr_in, &pos)))
         copyOneHeaderFromClientsideRequestToUpstreamRequest(e, strConnection, request, orig_request, hdr_out, we_do_ranges, flags);
 
-    /* Abstraction break: We should interpret myultipart/byterange responses
+    /* Abstraction break: We should interpret multipart/byterange responses
      * into offset-length data, and this works around our inability to do so.
      */
     if (!we_do_ranges && orig_request->multipartRangeRequest()) {
@@ -1083,7 +1140,8 @@ httpBuildRequestHeader(request_t * request,
 
     /* append Via */
     if (Config.onoff.via) {
-        String strVia = httpHeaderGetList(hdr_in, HDR_VIA);
+        String strVia;
+        strVia = httpHeaderGetList(hdr_in, HDR_VIA);
         snprintf(bbuf, BBUF_SZ, "%d.%d %s",
                  orig_request->http_ver.major,
                  orig_request->http_ver.minor, ThisCache);
@@ -1092,6 +1150,17 @@ httpBuildRequestHeader(request_t * request,
         strVia.clean();
     }
 
+#if ESI
+    {
+        /* Append Surrogate-Capabilities */
+        String strSurrogate (httpHeaderGetList(hdr_in, HDR_SURROGATE_CAPABILITY));
+        snprintf(bbuf, BBUF_SZ, "%s=Surrogate/1.0 ESI/1.0",
+                 Config.Accel.surrogate_id);
+        strListAdd(&strSurrogate, bbuf, ',');
+        httpHeaderPutStr(hdr_out, HDR_SURROGATE_CAPABILITY, strSurrogate.buf());
+    }
+#endif
+
     /* append X-Forwarded-For */
     strFwd = httpHeaderGetList(hdr_in, HDR_X_FORWARDED_FOR);
 
@@ -1190,7 +1259,8 @@ httpBuildRequestHeader(request_t * request,
             cc = httpHdrCcCreate();
 
         if (!EBIT_TEST(cc->mask, CC_MAX_AGE)) {
-            const char *url = entry ? storeUrl(entry) : urlCanonical(orig_request);
+            const char *url =
+                entry ? storeUrl(entry) : urlCanonical(orig_request);
             httpHdrCcSetMaxAge(cc, getMaxAge(url));
 
             if (request->urlpath.size())
@@ -1409,7 +1479,8 @@ httpSendRequest(HttpStateData * httpState)
     peer *p = httpState->_peer;
     CWCB *sendHeaderDone;
 
-    debug(11, 5) ("httpSendRequest: FD %d: httpState %p.\n", httpState->fd, httpState);
+    debug(11, 5) ("httpSendRequest: FD %d: httpState %p.\n", httpState->fd,
+                  httpState);
 
     if (httpState->orig_request->body_connection)
         sendHeaderDone = httpSendRequestEntity;
@@ -1438,7 +1509,8 @@ httpSendRequest(HttpStateData * httpState)
         httpState->flags.keepalive = 1;
     else if (p->stats.n_keepalives_sent < 10)
         httpState->flags.keepalive = 1;
-    else if ((double) p->stats.n_keepalives_recv / (double) p->stats.n_keepalives_sent > 0.50)
+    else if ((double) p->stats.n_keepalives_recv /
+             (double) p->stats.n_keepalives_sent > 0.50)
         httpState->flags.keepalive = 1;
 
     if (httpState->_peer) {
@@ -1471,6 +1543,8 @@ httpStart(FwdState * fwd)
                   storeUrl(fwd->entry));
     CBDATA_INIT_TYPE(HttpStateData);
     httpState = cbdataAlloc(HttpStateData);
+    httpState->ignoreCacheControl = false;
+    httpState->surrogateNoStore = false;
     storeLockObject(fwd->entry);
     httpState->fwd = fwd;
     httpState->entry = fwd->entry;
@@ -1546,8 +1620,7 @@ httpSendRequestEntityDone(int fd, void *data)
 {
     HttpStateData *httpState = static_cast<HttpStateData *>(data);
     ACLChecklist ch;
-    debug(11, 5) ("httpSendRequestEntityDone: FD %d\n",
-                  fd);
+    debug(11, 5) ("httpSendRequestEntityDone: FD %d\n", fd);
     ch.request = requestLink(httpState->request);
 
     if (!Config.accessList.brokenPosts) {
@@ -1,6 +1,6 @@
 
 /*
- * $Id: http.h,v 1.6 2003/03/04 01:40:28 robertc Exp $
+ * $Id: http.h,v 1.7 2003/03/10 04:56:38 robertc Exp $
  *
  *
  * SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -62,6 +62,9 @@ class HttpStateData
     int do_next_read;
     size_t read_sz;
     char buf[SQUID_TCP_SO_RCVBUF];
+    bool ignoreCacheControl;
+    bool surrogateNoStore;
+    void processSurrogateControl(HttpReply *);
 
 private:
     enum ConnectionStatus {
@@ -1,6 +1,6 @@
 
 /*
- * $Id: mem.cc,v 1.77 2003/03/09 12:29:41 robertc Exp $
+ * $Id: mem.cc,v 1.78 2003/03/10 04:56:38 robertc Exp $
  *
  * DEBUG: section 13    High Level Memory Pool Management
  * AUTHOR: Harvest Derived
@@ -401,6 +401,8 @@ Mem::Init(void)
     memDataInit(MEM_DWRITE_Q, "dwrite_q", sizeof(dwrite_q), 0);
     memDataInit(MEM_FWD_SERVER, "FwdServer", sizeof(FwdServer), 0);
     memDataInit(MEM_HTTP_HDR_CC, "HttpHdrCc", sizeof(HttpHdrCc), 0);
+    memDataInit(MEM_HTTP_HDR_SC, "HttpHdrSc", sizeof(HttpHdrSc), 0);
+    memDataInit(MEM_HTTP_HDR_SCTARGET, "HttpHdrScTarget", sizeof(HttpHdrScTarget), 0);
     memDataInit(MEM_HTTP_HDR_CONTENT_RANGE, "HttpHdrContRange", sizeof(HttpHdrContRange), 0);
     memDataInit(MEM_NETDBENTRY, "netdbEntry", sizeof(netdbEntry), 0);
     memDataInit(MEM_NET_DB_NAME, "net_db_name", sizeof(net_db_name), 0);
@@ -1,6 +1,6 @@
 
 /*
- * $Id: protos.h,v 1.472 2003/03/08 09:35:15 robertc Exp $
+ * $Id: protos.h,v 1.473 2003/03/10 04:56:38 robertc Exp $
  *
  *
  * SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -132,7 +132,7 @@ extern int comm_listen(int fd);
 SQUIDCEXTERN int commSetNonBlocking(int fd);
 SQUIDCEXTERN int commUnsetNonBlocking(int fd);
 SQUIDCEXTERN void commSetCloseOnExec(int fd);
-extern void _comm_close(int fd, char *file, int line);
+extern void _comm_close(int fd, char const *file, int line);
 #define comm_close(fd) (_comm_close((fd), __FILE__, __LINE__))
 SQUIDCEXTERN void comm_reset_close(int fd);
 #if LINGERING_CLOSE
@@ -345,6 +345,33 @@ SQUIDCEXTERN void httpHdrCcSetSMaxAge(HttpHdrCc * cc, int s_maxage);
 SQUIDCEXTERN void httpHdrCcUpdateStats(const HttpHdrCc * cc, StatHist * hist);
 SQUIDCEXTERN void httpHdrCcStatDumper(StoreEntry * sentry, int idx, double val, double size, int count);
 
+/* Http Surrogate Control Header Field */
+extern void httpHdrScStatDumper(StoreEntry * sentry, int idx, double val, double size, int count);
+extern void httpHdrScInitModule (void);
+extern void httpHdrScCleanModule (void);
+extern HttpHdrSc *httpHdrScCreate(void);
+extern HttpHdrSc *httpHdrScParseCreate(String const *);
+extern void httpHdrScDestroy(HttpHdrSc * sc);
+extern HttpHdrSc *httpHdrScDup(const HttpHdrSc * sc);
+extern void httpHdrScPackInto(const HttpHdrSc * sc, Packer * p);
+extern void httpHdrScJoinWith(HttpHdrSc *, const HttpHdrSc *);
+extern void httpHdrScSetMaxAge(HttpHdrSc *, char const *, int);
+extern void httpHdrScUpdateStats(const HttpHdrSc *, StatHist *);
+extern HttpHdrScTarget * httpHdrScFindTarget (HttpHdrSc *sc, const char *target);
+extern HttpHdrScTarget * httpHdrScGetMergedTarget (HttpHdrSc *sc, const char *ourtarget);
+
+/* Http Surrogate control header field 'targets' */
+extern HttpHdrScTarget * httpHdrScTargetCreate (const char *);
+extern void httpHdrScTargetDestroy(HttpHdrScTarget *);
+extern HttpHdrScTarget *httpHdrScTargetDup(const HttpHdrScTarget *);
+extern void httpHdrScTargetPackInto(const HttpHdrScTarget *, Packer *);
+extern void httpHdrScTargetSetMaxAge(HttpHdrScTarget *, int);
+extern void httpHdrScTargetUpdateStats(const HttpHdrScTarget *, StatHist *);
+extern void httpHdrScTargetJoinWith(HttpHdrScTarget *, const HttpHdrScTarget *);
+extern void httpHdrScTargetMergeWith(HttpHdrScTarget *, const HttpHdrScTarget *);
+extern void httpHdrScTargetStatDumper(StoreEntry * sentry, int idx, double val, double size, int count);
+
+
 /* Http Header Tools */
 SQUIDCEXTERN HttpHeaderFieldInfo *httpHeaderBuildFieldsInfo(const HttpHeaderFieldAttrs * attrs, int count);
 SQUIDCEXTERN void httpHeaderDestroyFieldsInfo(HttpHeaderFieldInfo * info, int count);
@@ -1,6 +1,6 @@
 
 /*
- * $Id: squid.h,v 1.231 2003/02/23 00:08:04 robertc Exp $
+ * $Id: squid.h,v 1.232 2003/03/10 04:56:38 robertc Exp $
  *
  * AUTHOR: Duane Wessels
  *
@@ -366,8 +366,28 @@ extern "C"
 #include "snprintf.h"
 #endif
 
-#define XMIN(x,y) ((x)<(y)? (x) : (y))
-#define XMAX(a,b) ((a)>(b)? (a) : (b))
+template<class A>
+inline A const &
+min(A const & lhs, A const & rhs)
+{
+    if (rhs < lhs)
+        return rhs;
+
+    return lhs;
+}
+
+#define XMIN(x,y) (min (x,y))
+template<class A>
+inline A const &
+max(A const & lhs, A const & rhs)
+{
+    if (rhs > lhs)
+        return rhs;
+
+    return lhs;
+}
+
+#define XMAX(a,b) (max (a,b))
 
 /*
  * Squid source files should not call these functions directly.
@@ -1,6 +1,6 @@
 
 /*
- * $Id: store.cc,v 1.563 2003/03/08 09:35:15 robertc Exp $
+ * $Id: store.cc,v 1.564 2003/03/10 04:56:38 robertc Exp $
  *
  * DEBUG: section 20    Storage Manager
  * AUTHOR: Harvest Derived
@@ -401,15 +401,24 @@ storeLockObject(StoreEntry * e)
     storeEntryReferenced(e);
 }
 
+void
+StoreEntry::setReleaseFlag()
+{
+    if (EBIT_TEST(flags, RELEASE_REQUEST))
+        return;
+
+    debug(20, 3) ("StoreEntry::setReleaseFlag: '%s'\n", getMD5Text());
+
+    EBIT_SET(flags, RELEASE_REQUEST);
+}
+
 void
 storeReleaseRequest(StoreEntry * e)
 {
     if (EBIT_TEST(e->flags, RELEASE_REQUEST))
         return;
 
-    debug(20, 3) ("storeReleaseRequest: '%s'\n", e->getMD5Text());
-
-    EBIT_SET(e->flags, RELEASE_REQUEST);
+    e->setReleaseFlag();
 
     /*
      * Clear cachable flag here because we might get called before
@@ -434,7 +443,7 @@ storeUnlockObject(StoreEntry * e)
         return (int) e->lock_count;
 
     if (e->store_status == STORE_PENDING)
-        EBIT_SET(e->flags, RELEASE_REQUEST);
+        e->setReleaseFlag();
 
     assert(storePendingNClients(e) == 0);
 
@@ -1178,7 +1187,7 @@ storeRelease(StoreEntry * e)
              * we'll just call storeUnlockObject() on these.
              */
             e->lock_count++;
-            EBIT_SET(e->flags, RELEASE_REQUEST);
+            e->setReleaseFlag();
             stackPush(&LateReleaseStack, e);
             PROF_stop(storeRelease);
             return;
@@ -1864,6 +1873,12 @@ NullStoreEntry::getMD5Text() const
     return "N/A";
 }
 
+void
+NullStoreEntry::operator delete(void*)
+{
+    fatal ("Attempt to delete NullStoreEntry\n");
+}
+
 char const *
 NullStoreEntry::getSerialisedMetaData()
 {
@@ -1,6 +1,6 @@
 
 /*
- * $Id: structs.h,v 1.458 2003/03/08 09:35:16 robertc Exp $
+ * $Id: structs.h,v 1.459 2003/03/10 04:56:39 robertc Exp $
  *
  *
  * SQUID Web Proxy Cache          http://www.squid-cache.org/
@@ -400,6 +400,16 @@ struct _SquidConfig
     time_t authenticateGCInterval;
     time_t authenticateTTL;
     time_t authenticateIpTTL;
+
+    struct
+    {
+#if ESI
+        char *surrogate_id;
+#endif
+
+    }
+
+    Accel;
     char *appendDomain;
     size_t appendDomainLen;
     char *debugOptions;
@@ -534,6 +544,11 @@ struct _SquidConfig
         int ie_refresh;
         int vary_ignore_expire;
         int pipeline_prefetch;
+#if ESI
+
+        int surrogate_is_remote;
+#endif
+
         int request_entities;
         int check_hostnames;
         int via;
@@ -905,6 +920,25 @@ struct _HttpHeader
     int len;			/* length when packed, not counting terminating '\0' */
 };
 
+/* http surogate control header field */
+
+struct _HttpHdrScTarget
+{
+    dlink_node node;
+    int mask;
+    int max_age;
+    int max_stale;
+    String content;
+    String target;
+};
+
+struct _HttpHdrSc
+{
+    dlink_list targets;
+};
+
+/* Sync changes here with HttpReply.c */
+
 class HttpHdrContRange;
 
 class HttpReply
@@ -923,6 +957,7 @@ class HttpReply
     time_t expires;
     String content_type;
     HttpHdrCc *cache_control;
+    HttpHdrSc *surrogate_control;
     HttpHdrContRange *content_range;
     short int keep_alive;
 
@@ -1749,6 +1784,7 @@ unsigned int flag_cbdata:
 
     ftp;
     char *request_hdrs;
+    char *err_msg; /* Preformatted error message from the cache */
 };
 
 /*
@@ -1949,9 +1985,11 @@ struct _HttpHeaderStat
     StatHist hdrUCountDistr;
     StatHist fieldTypeDistr;
     StatHist ccTypeDistr;
+    StatHist scTypeDistr;
 
     int parsedCount;
     int ccParsedCount;
+    int scParsedCount;
     int destroyedCount;
     int busyDestroyedCount;
 };
@@ -1,6 +1,6 @@
 
 /*
- * $Id: http_range_test.cc,v 1.4 2003/02/12 06:11:41 robertc Exp $
+ * $Id: http_range_test.cc,v 1.5 2003/03/10 04:57:29 robertc Exp $
  *
  * DEBUG: section 64    HTTP Range Header
  * AUTHOR: Alex Rousskov
@@ -41,9 +41,9 @@
 #include "ACLChecklist.h"
 
 /* Stub routines */
-SQUIDCEXTERN void 
-cachemgrRegister(const char *, const char *, OBJH *, int, int){
-}
+SQUIDCEXTERN void
+cachemgrRegister(const char *, const char *, OBJH *, int, int)
+{}
 
 SQUIDCEXTERN void httpHeaderPutStr(HttpHeader * hdr, http_hdr_type type, const char *str)
 {
@@ -119,8 +119,8 @@ SQUIDCEXTERN void fatal (char const *msg)
 }
 
 SQUIDCEXTERN ACLChecklist *aclChecklistCreate(const acl_access *,
-    request_t *,
-    const char *ident)
+        request_t *,
+        const char *ident)
 {
     fatal ("dummy function\n");
     return NULL;
@@ -129,7 +129,7 @@ SQUIDCEXTERN ACLChecklist *aclChecklistCreate(const acl_access *,
 SQUIDCEXTERN String httpHeaderGetList(const HttpHeader * hdr, http_hdr_type id)
 {
     fatal ("dummy function\n");
-    return StringNull;
+    return String();
 }
 
 SQUIDCEXTERN int httpHeaderHas(const HttpHeader * hdr, http_hdr_type type)
@@ -164,14 +164,18 @@ testRangeParser(char const *rangestring)
 {
     String aString (rangestring);
     HttpHdrRange *range = HttpHdrRange::ParseCreate (&aString);
+
     if (!range)
-	exit (1);
+        exit (1);
+
     HttpHdrRange copy(*range);
+
     assert (copy.specs.count == range->specs.count);
 
     HttpHdrRange::iterator pos = range->begin();
+
     assert (*pos);
-    
+
     range->deleteSelf();
 }
 
@@ -180,8 +184,10 @@ rangeFromString(char const *rangestring)
 {
     String aString (rangestring);
     HttpHdrRange *range = HttpHdrRange::ParseCreate (&aString);
+
     if (!range)
-	exit (1);
+        exit (1);
+
     return range;
 }
 
@@ -192,10 +198,12 @@ testRangeIter ()
     assert (range->specs.count == 3);
     size_t counter = 0;
     HttpHdrRange::iterator i = range->begin();
+
     while (i != range->end()) {
-	++counter;
-	++i;
+        ++counter;
+        ++i;
     }
+
     assert (counter == 3);
     i = range->begin();
     assert (i - range->begin() == 0);
@@ -212,37 +220,53 @@ testRangeCanonization()
 
     /* 0-3 needs a content length of 4 */
     /* This passes in the extant code - but should it? */
+
     if (!range->canonize(3))
-	exit(1);
+        exit(1);
+
     assert (range->specs.count == 3);
+
     range->deleteSelf();
-    
+
     range=rangeFromString("bytes=0-3, 1-, -2");
+
     assert (range->specs.count == 3);
+
     /* 0-3 needs a content length of 4 */
     if (!range->canonize(4))
-	exit(1);
+        exit(1);
+
     range->deleteSelf();
-    
+
     range=rangeFromString("bytes=3-6");
+
     assert (range->specs.count == 1);
+
     /* 3-6 needs a content length of 4 or more */
     if (range->canonize(3))
-	exit(1);
+        exit(1);
+
     range->deleteSelf();
 
     range=rangeFromString("bytes=3-6");
+
     assert (range->specs.count == 1);
+
     /* 3-6 needs a content length of 4 or more */
     if (!range->canonize(4))
-	exit(1);
+        exit(1);
+
     range->deleteSelf();
-    
+
     range=rangeFromString("bytes=1-1,2-3");
+
     assert (range->specs.count == 2);
+
     if (!range->canonize(4))
-	exit(1);
+        exit(1);
+
     assert (range->specs.count == 2);
+
     range->deleteSelf();
 }
 
@@ -251,8 +275,8 @@ main (int argc, char **argv)
 {
     Mem::Init();
     /* enable for debugging to console */
-//    _db_init (NULL, NULL);
-//    Debug::Levels[64] = 9;
+    //    _db_init (NULL, NULL);
+    //    Debug::Levels[64] = 9;
     testRangeParser ("bytes=0-3");
     testRangeParser ("bytes=-3");
     testRangeParser ("bytes=1-");
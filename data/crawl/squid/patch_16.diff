----++++src/auth/digest/LDAP/ldap_backend.cc
@@ -63,6 +63,7 @@ static const char *usersearchfilter = NULL;
 static const char *binddn = NULL;
 static const char *bindpasswd = NULL;
 static const char *delimiter = &quot;:&quot;;
+static const char *frealm = &quot;&quot;;
 static int encrpass = 0;
 static int searchscope = LDAP_SCOPE_SUBTREE;
 static int persistent = 0;
@@ -267,7 +268,7 @@ getpassword(char *login, char *realm)
             }
             value = values;
             while (*value) {
-                if (encrpass) {
+                if (encrpass &amp;&amp; *delimiter ) {
                     const char *t = strtok(*value, delimiter);
                     if (t &amp;&amp; strcmp(t, realm) == 0) {
                         password = strtok(NULL, delimiter);
@@ -451,6 +452,9 @@ LDAPArguments(int argc, char **argv)
         case &#39;l&#39;:
             delimiter = value;
             break;
+        case &#39;r&#39;:
+            frealm = value;
+            break;
         case &#39;b&#39;:
             userbasedn = value;
             break;
@@ -574,10 +578,11 @@ LDAPArguments(int argc, char **argv)
     if (!ldapServer)
         ldapServer = (char *) &quot;localhost&quot;;
 
-    if (!userbasedn || !passattr) {
-        fprintf(stderr, "Usage: " PROGRAM_NAME " -b basedn -f filter [options] ldap_server_name\n\n");
+    if (!userbasedn || !passattr || (!*delimiter &amp;&amp; !*frealm)) {
+        fprintf(stderr, "Usage: " PROGRAM_NAME " -b basedn -F filter [options] ldap_server_name\n\n");
         fprintf(stderr, &quot;\t-A password attribute(REQUIRED)\t\tUser attribute that contains the password\n&quot;);
-        fprintf(stderr, &quot;\t-l password realm delimiter(REQUIRED)\tCharater(s) that devides the password attribute\n\t\t\t\t\t\tin realm and password tokens, default &#39;:&#39; realm:password\n&quot;);
+        fprintf(stderr, &quot;\t-l password realm delimiter(REQUIRED)\tCharacter(s) that divides the password attribute\n\t\t\t\t\t\tin realm and password tokens, default &#39;:&#39; realm:password, could be\n\t\t\t\t\t\tempty string if the password is alone in the password attribute\n&quot;);
+        fprintf(stderr, &quot;\t-r filtered realm\t\t\tonly honor Squid requests for this realm. Mandatory if the password is alone in\n\t\t\t\t\t\tthe password attribute, acting as the implicit realm\n&quot;);
         fprintf(stderr, &quot;\t-b basedn (REQUIRED)\t\t\tbase dn under where to search for users\n&quot;);
         fprintf(stderr, &quot;\t-e Encrypted passwords(REQUIRED)\tPassword are stored encrypted using HHA1\n&quot;);
         fprintf(stderr, &quot;\t-F filter\t\t\t\tuser search filter pattern. %%s = login\n&quot;);
@@ -644,9 +649,17 @@ readSecret(const char *filename)
 void
 LDAPHHA1(RequestData * requestData)
 {
-    char *password;
+    char *password = NULL;
     ldapconnect();
-    password = getpassword(requestData-&gt;user, requestData-&gt;realm);
+
+    // use the -l delimiter to find realm, or
+    // only honor the -r specified realm
+    const bool lookup = (!*frealm &amp;&amp; *delimiter) ||
+                        (*frealm &amp;&amp; strcmp(requestData-&gt;realm, frealm) != 0);
+
+    if (lookup)
+        password = getpassword(requestData-&gt;user, requestData-&gt;realm);
+
     if (password != NULL) {
         if (encrpass)
             xstrncpy(requestData-&gt;HHA1, password, sizeof(requestData-&gt;HHA1));
----++++GitHub